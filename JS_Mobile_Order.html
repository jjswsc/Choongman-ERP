<script>

 function renderLists(){
      if(!allItems) return;
      renderCategoryView("orderMenuWrapper", "order");
      renderCategoryView("stockListWrapper", "stock");
    }
    
    // [ìˆ˜ì •] ëª©ë¡ ê·¸ë¦¬ê¸° (ë°°ì—´ ë°ì´í„° ì¸ì‹ + ìŠ¬ë¦¼ ë””ìì¸)
    function renderCategoryView(target, mode){
      var w=document.getElementById(target); if(!w) return; 
      var noItemMsg = (typeof I18N !== "undefined" && I18N[currentLang] && I18N[currentLang].m_no_items) ? I18N[currentLang].m_no_items : "ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤. í’ˆëª© ì‹œíŠ¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.";
      if (!allItems || allItems.length === 0) { w.innerHTML = "<div class=\"text-center text-muted py-4\">" + noItemMsg + "</div>"; return; }
      w.innerHTML=""; 
      
      // â˜… í•µì‹¬ ìˆ˜ì •: ë°ì´í„°ê°€ ë°°ì—´(Array)ì´ë¯€ë¡œ ì¸ë±ìŠ¤[1]ë¡œ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      var g={}; 
      allItems.forEach(r=>{ 
        var cat = r[1]; // 1ë²ˆ ì¹¸ì´ ì¹´í…Œê³ ë¦¬
        if(!g[cat]) g[cat]=[]; 
        g[cat].push(r); 
      });
      
      // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
      var keys = Object.keys(g).sort();

      keys.forEach(c => {
        var h=document.createElement("div"); h.className="category-header"; h.innerHTML=`<span>${c}</span><span>â–¼</span>`;
        var con=document.createElement("div"); con.className="menu-container"; con.style.display="none"; 
        var grid=document.createElement("div"); grid.className="menu-grid";
        
        g[c].forEach(r=>{
          var i=document.createElement("div"); i.className="menu-item";
          
          // ë°ì´í„° ë§¤í•‘ (Code.gs V108 ë°°ì—´ ìˆœì„œ ê¸°ì¤€)
          // 0:ì½”ë“œ, 1:ì¹´í…Œê³ ë¦¬, 2:ì´ë¦„, 3:ê·œê²©, 4:ê°€ê²©, 6:ì´ë¯¸ì§€, 8:ì•ˆì „ì¬ê³ , 9:ê³¼ì„¸
          var code = r[0], name = r[2], spec = r[3], price = r[4], imgUrl = r[6], safe = r[8], tax = r[9];
          var qty = Number(currentStock[code])||0;
          
          var isLow = qty <= Number(safe||0);
          var badgeColor = isLow ? "#F44336" : "#4CAF50";
          var badgeText = isLow ? `Low:${qty}` : `Stock:${qty}`;
          
          // ì‚¬ì§„ ë²„íŠ¼
          var photoBtn = "";
          if(imgUrl && imgUrl.length > 5) {
             photoBtn = `<button class="btn-photo" onclick="event.stopPropagation(); window.open('${imgUrl}', '_blank')">ğŸ“·</button>`;
          }

          var rightHtml = "";
          if(mode==='order') rightHtml = `<div class="item-price">${Number(price).toLocaleString()} à¸¿</div>`;

          i.innerHTML = `
            <div class="item-left">
               ${photoBtn}
               <span class="item-name">${name}</span>
               <span class="item-spec">${spec ? '('+spec+')' : ''}</span>
               <span class="stock-badge" style="background:${badgeColor}">${badgeText}</span>
               ${(tax==='ë©´ì„¸') ? '<span class="stock-badge" style="background:#9E9E9E">ë©´ì„¸</span>' : ''}
            </div>
            <div class="item-right">
               ${rightHtml}
            </div>
          `;
          
          i.onclick=function(){ 
             document.querySelectorAll('#'+target+' .menu-item').forEach(e=>e.classList.remove('selected')); 
             i.classList.add('selected'); 
             if(mode==='order') selectedItem={code:code, name:name, price:price, tax:tax}; 
             else selectedUsageItem={code:code, name:name}; 
          };
          grid.appendChild(i);
        });
        
        con.appendChild(grid); 
        h.onclick=(function(ct){ return function(){ ct.style.display=ct.style.display==='none'?'block':'none'; } })(con);
        w.appendChild(h); w.appendChild(con);
      });
    }

    // [ê¸°íƒ€ íƒ­ ì „í™˜ ë° ê¸°ëŠ¥ë“¤

    function loadMyLeaveInfo() {
      google.script.run.withSuccessHandler(function(d) {
        document.getElementById("my-ann").innerText = d.stats.usedAnn;
        document.getElementById("my-sick").innerText = d.stats.usedSick;
        document.getElementById("my-remain").innerText = d.stats.remain;
        var listDiv = document.getElementById("my-leave-list");
        listDiv.innerHTML = "";
        var noRec = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_no_records : "No records found.";
        if (!d.history || d.history.length === 0) { listDiv.innerHTML = "<div style='text-align:center; color:#999; padding:10px;'>" + noRec + "</div>"; return; }
        var texts = d.history.map(function(item){ return item.reason || ""; });
        var targetLang = typeof getTranslationLang === "function" ? getTranslationLang() : "ko";
        if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
          d.history.forEach(function(item){ renderLeaveItem(listDiv, item, item.reason); });
          return;
        }
        google.script.run.withSuccessHandler(function(translated) {
          d.history.forEach(function(item, i){ renderLeaveItem(listDiv, item, (translated && translated[i] !== undefined) ? translated[i] : item.reason); });
        }).translateBatch(texts, targetLang);
      }).getMyLeaveInfo(loggedInStore, loggedInUser);
    }
    function renderLeaveItem(listDiv, item, reasonText) {
      var badgeColor = item.status === "ìŠ¹ì¸" ? "#4CAF50" : (item.status === "ë°˜ë ¤" ? "#F44336" : "#9E9E9E");
      listDiv.innerHTML += "<div class=\"leave-item\"><div><div style=\"font-weight:bold; font-size:14px;\">" + item.date + " (" + item.type + ")</div><div style=\"font-size:12px; color:#666;\">" + (reasonText || "") + "</div></div><span style=\"background:" + badgeColor + "; color:white; padding:3px 8px; border-radius:5px; font-size:11px;\">" + item.status + "</span></div>";
    }
    function switchOrderTab(t){ document.getElementById('order-new-area').style.display = t==='new'?'block':'none'; document.getElementById('order-hist-area').style.display = t==='hist'?'block':'none'; document.getElementById('ord-sub-new').classList.toggle('active', t==='new'); document.getElementById('ord-sub-hist').classList.toggle('active', t==='hist'); if(t==='hist') loadHistory(); }
    
    function changeLanguage() { }
    function adjustQty(type, delta){ var id = type==='order' ? 'qtyInputOrder' : 'qtyInputUsage'; var el = document.getElementById(id); if(el) { var val = Number(el.value) + delta; if(val < 1) val = 1; el.value = val; } }
    function addToCart(type){ var msg = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_select_item : "Select an Item first!"; if(type==='order'){ if(!selectedItem) return alert(msg); var q=document.getElementById("qtyInputOrder").value; cart.push({...selectedItem, qty:q}); updateCart('order'); } else { if(!selectedUsageItem) return alert(msg); var q=document.getElementById("qtyInputUsage").value; usageCart.push({...selectedUsageItem, qty:q}); updateCart('usage'); } }

    /* [ìˆ˜ì •] updateCart í•¨ìˆ˜ ë‚´ë¶€ì˜ ê³„ì‚° ë¶€ë¶„ (ì•½ 275~280ì¤„) */
function updateCart(type){ 
  if(type==='order'){ 
    var b=document.querySelector("#cartTable tbody"); 
    b.innerHTML=""; 
    var sub=0; 
    var vatTotal=0; // ë¶€ê°€ì„¸ ëˆ„ì  ë³€ìˆ˜

    cart.forEach((i,idx)=>{ 
      var t=i.price*i.qty; 
      sub+=t; 
      
      // â˜… í•µì‹¬: ê³¼ì„¸(VAT) í’ˆëª©ë§Œ 7% ê³„ì‚°, ë©´ì„¸ëŠ” 0ì›
      var itemTax = (i.tax === 'ë©´ì„¸') ? 0 : Math.round(t * 0.07);
      vatTotal += itemTax;

      b.innerHTML+=`<tr><td>${i.name}<br><small style='color:#999'>${i.tax||'VAT'}</small></td><td class="text-right">${Number(i.price).toLocaleString()}</td><td class="text-right">${i.qty}</td><td class="text-right">${t.toLocaleString()}</td><td onclick="cart.splice(${idx},1);updateCart('order')">âŒ</td></tr>`; 
    }); 
    
    // í•©ê³„ í‘œì‹œ
    document.getElementById("displaySub").textContent=sub.toLocaleString()+" à¸¿"; 
    document.getElementById("displayVat").textContent=vatTotal.toLocaleString()+" à¸¿"; 
    document.getElementById("displayTotal").textContent=(sub+vatTotal).toLocaleString()+" à¸¿"; 
  } else { 
    // (Usage ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”)
    var b=document.querySelector("#usageCartTable tbody"); b.innerHTML=""; usageCart.forEach((i,idx)=>{ b.innerHTML+=`<tr><td>${i.name}</td><td class="text-right">${i.qty}</td><td class="text-right" onclick="usageCart.splice(${idx},1);updateCart('usage')">âŒ</td></tr>`; }); 
  } 
}
    function submitOrder(){ if(!cart.length) return; google.script.run.withSuccessHandler(m=>{alert(m); cart=[]; updateCart('order');}).processOrder({storeName:loggedInStore,userName:loggedInUser,cart:cart}); }

  /** ë°°ì†¡ ì¼ìë¥¼ ì£¼ë¬¸ ì¼ìì™€ ë™ì¼í•œ yyyy-MM-dd í˜•ì‹ìœ¼ë¡œ ë³€í™˜ */
  function formatDateOnly(val) {
    if (!val) return "";
    var s = String(val).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    var d = new Date(val);
    if (isNaN(d.getTime())) return s;
    var y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(-2), day = ("0" + d.getDate()).slice(-2);
    return y + "-" + m + "-" + day;
  }

/* 1. ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° */
  function loadHistory() { 
    var s = document.getElementById("hist-start").value; 
    var e = document.getElementById("hist-end").value; 
    var loadingTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_loading_items : "Loading...";
    document.getElementById("history-list-container").innerHTML = loadingTxt; 
    
    google.script.run.withSuccessHandler(function(l) { 
      var c = document.getElementById("history-list-container"); 
      c.innerHTML = ""; 
      var noHist = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_no_history : "No history";
      if(!l || !l.length){ c.innerHTML = noHist; return; } 
      var recTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive : "ğŸ“¥ Receive";
      var statusInTransit = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_status_in_transit : "ë°°ì†¡ì¤‘";
      var statusDelivered = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_status_delivered : "ë°°ì†¡ ì™„ë£Œ";
      l.forEach(function(o) { 
        var deliveryStatusBadge = "";
        if (o.deliveryStatus === "ë°°ì†¡ì™„ë£Œ" || o.deliveryStatus === "ë°°ì†¡ ì™„ë£Œ") deliveryStatusBadge = "<span class=\"status-badge st-Received\" style=\"margin-left:4px;\">" + statusDelivered + "</span>";
        else if (o.status === "Approved" && o.deliveryStatus === "ë°°ì†¡ì¤‘") deliveryStatusBadge = "<span class=\"status-badge\" style=\"background:#2196F3;margin-left:4px;\">" + statusInTransit + "</span>";
        var btn = o.status == "Approved" && o.deliveryStatus !== "ë°°ì†¡ì™„ë£Œ" && o.deliveryStatus !== "ë°°ì†¡ ì™„ë£Œ" ? "<button class=\"login-btn\" style=\"padding:8px;margin-top:5px;background:#E91E63;\" onclick=\"doReceive(" + o.id + ")\">" + recTxt + "</button>" : ""; 
        var items = "<div class='detail-list'>"; 
        o.items.forEach(function(i) { items += "<div class='detail-item'><span>" + i.name + "</span><span>x" + i.qty + "</span></div>"; }); 
        items += "</div>"; 
        var orderDateLabel = (typeof I18N !== "undefined" && I18N[currentLang] && I18N[currentLang].m_order_date) ? I18N[currentLang].m_order_date : "ì£¼ë¬¸ ì¼ì";
        var deliveryDateLabel = (typeof I18N !== "undefined" && I18N[currentLang] && I18N[currentLang].m_delivery_date) ? I18N[currentLang].m_delivery_date : "ë°°ì†¡ ì¼ì";
        var deliveryDateStr = formatDateOnly(o.deliveryDate);
        var dateLine = "<span>" + orderDateLabel + " " + o.date + "</span>";
        if (deliveryDateStr) dateLine += " <span style=\"margin-left:8px;\">" + deliveryDateLabel + " " + deliveryDateStr + "</span>";
        var orderedByLabel = (typeof I18N !== "undefined" && I18N[currentLang] && I18N[currentLang].m_ordered_by) ? I18N[currentLang].m_ordered_by : "ë°œì£¼ì";
        if (o.userName) dateLine += " <span style=\"margin-left:8px;font-size:11px;color:#666;\">" + orderedByLabel + " " + o.userName + "</span>";
        c.innerHTML += "<div class=\"history-card\"><div class=\"history-header\">" + dateLine + "<span class=\"status-badge st-" + o.status + "\">" + o.status + "</span>" + deliveryStatusBadge + "</div>" + items + "<div style=\"text-align:right;font-weight:bold;color:#E65100;\">" + Number(o.total).toLocaleString() + " à¸¿</div>" + btn + "</div>"; 
      }); 
    }).getMyOrderHistory(loggedInStore, s, e); 
  }

  /* 2. ë¬¼í’ˆ ìˆ˜ë ¹ í™•ì¸: ì‚¬ì§„ ì´¬ì˜ + íŒŒì¼ ì„ íƒ(ì²¨ë¶€) ëª¨ë‹¬ */
  var pendingReceiveOrderId = null;
  var receivePhotoCurrentFile = null;
  function doReceive(id) { 
    pendingReceiveOrderId = id;
    receivePhotoCurrentFile = null;
    var title = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive_photo_title : "ìˆ˜ë ¹ í™•ì¸";
    var hint = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive_photo_hint : "ë¬¼í’ˆ ìˆ˜ë ¹ í™•ì¸ì„ ìœ„í•´ ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    var takePhoto = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_take_photo : "ì‚¬ì§„ ì´¬ì˜";
    var chooseFile = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_choose_file : "íŒŒì¼ ì„ íƒ";
    var cancelTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_cancel : "ì·¨ì†Œ";
    var confirmTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_confirm_receive : "ìˆ˜ë ¹ ì™„ë£Œ";
    var box = document.getElementById("receive-photo-modal-box");
    if (!box) {
      box = document.createElement("div");
      box.id = "receive-photo-modal-box";
      box.style.cssText = "position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;";
      box.innerHTML = "<div id=\"receive-photo-modal\" style=\"background:#fff;border-radius:12px;padding:20px;max-width:360px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,0.2);\">" +
        "<div id=\"receive-photo-title\" class=\"fw-bold mb-2\"></div>" +
        "<p id=\"receive-photo-hint\" class=\"small text-muted mb-3\"></p>" +
        "<div class=\"mb-3 d-flex gap-2 flex-wrap\">" +
        "<input type=\"file\" id=\"receive-photo-camera\" accept=\"image/*\" capture=\"environment\" style=\"position:absolute;opacity:0;width:0;height:0;\">" +
        "<input type=\"file\" id=\"receive-photo-file\" accept=\"image/*\" style=\"position:absolute;opacity:0;width:0;height:0;\">" +
        "<button type=\"button\" id=\"receive-photo-btn-camera\" class=\"btn btn-outline-primary btn-sm flex-grow-1\"></button>" +
        "<button type=\"button\" id=\"receive-photo-btn-file\" class=\"btn btn-outline-secondary btn-sm flex-grow-1\"></button>" +
        "</div>" +
        "<div id=\"receive-photo-preview\" class=\"mb-3\" style=\"min-height:60px;\"></div>" +
        "<div class=\"d-flex gap-2 justify-content-end\">" +
        "<button type=\"button\" id=\"receive-photo-cancel\" class=\"btn btn-outline-secondary btn-sm\"></button>" +
        "<button type=\"button\" id=\"receive-photo-submit\" class=\"btn btn-primary btn-sm\"></button></div></div>";
      document.body.appendChild(box);
      document.getElementById("receive-photo-cancel").onclick = function() { box.style.display = "none"; pendingReceiveOrderId = null; receivePhotoCurrentFile = null; };
      function onFileSelected(file) {
        receivePhotoCurrentFile = file;
        var preview = document.getElementById("receive-photo-preview");
        preview.innerHTML = "";
        if (file) {
          var img = document.createElement("img");
          img.style.maxWidth = "100%"; img.style.maxHeight = "120px"; img.style.borderRadius = "8px";
          img.src = URL.createObjectURL(file);
          preview.appendChild(img);
        }
      }
      document.getElementById("receive-photo-camera").onchange = function() { if (this.files && this.files[0]) onFileSelected(this.files[0]); };
      document.getElementById("receive-photo-file").onchange = function() { if (this.files && this.files[0]) onFileSelected(this.files[0]); };
      document.getElementById("receive-photo-btn-camera").onclick = function() { document.getElementById("receive-photo-camera").click(); };
      document.getElementById("receive-photo-btn-file").onclick = function() { document.getElementById("receive-photo-file").click(); };
      document.getElementById("receive-photo-submit").onclick = function() {
        if (!receivePhotoCurrentFile) {
          var msg = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive_photo_required : "ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.";
          alert(msg); return;
        }
        var file = receivePhotoCurrentFile;
        function sendToServer(base64) {
          box.style.display = "none";
          document.getElementById("receive-photo-modal-box").style.display = "none";
          var doneMsg = (typeof I18N !== "undefined" && I18N[currentLang]) ? (I18N[currentLang].m_receive_done || "ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.") : "ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
          google.script.run.withSuccessHandler(function(r) {
            alert(r && r.trim() ? r : doneMsg);
            loadHistory();
            refreshStock();
          }).withFailureHandler(function(err) {
            alert(err && err.message ? err.message : "ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ìŠµë‹ˆë‹¤.");
          }).processOrderReceive(pendingReceiveOrderId, base64);
          pendingReceiveOrderId = null;
          receivePhotoCurrentFile = null;
          document.getElementById("receive-photo-camera").value = "";
          document.getElementById("receive-photo-file").value = "";
        }
        function compressAndSend() {
          var reader = new FileReader();
          reader.onload = function(e) {
            var img = new Image();
            img.onerror = function() { sendToServer(e.target.result); };
            img.onload = function() {
              var maxPx = 400, w = img.width, h = img.height;
              if (w > maxPx || h > maxPx) {
                if (w >= h) { h = Math.round(h * maxPx / w); w = maxPx; } else { w = Math.round(w * maxPx / h); h = maxPx; }
              }
              var canvas = document.createElement("canvas");
              canvas.width = w; canvas.height = h;
              var ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, w, h);
              try { sendToServer(canvas.toDataURL("image/jpeg", 0.5)); } catch (err) { sendToServer(e.target.result); }
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
        compressAndSend();
      };
    }
    document.getElementById("receive-photo-title").textContent = title;
    document.getElementById("receive-photo-hint").textContent = hint;
    document.getElementById("receive-photo-btn-camera").textContent = takePhoto;
    document.getElementById("receive-photo-btn-file").textContent = chooseFile;
    document.getElementById("receive-photo-cancel").textContent = cancelTxt;
    document.getElementById("receive-photo-submit").textContent = confirmTxt;
    document.getElementById("receive-photo-camera").value = "";
    document.getElementById("receive-photo-file").value = "";
    document.getElementById("receive-photo-preview").innerHTML = "";
    box.style.display = "flex";
  }


 </script>