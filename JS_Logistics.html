<script>

  /* =================================================================
     ë¬¼ë¥˜/ì¬ê³  ê´€ë¦¬
     ================================================================= */ 

/* =========================================================
     [ê³µí†µ] í’ˆëª© ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŠ¸
     ========================================================= */
  function openFinder(mode) {
      finderMode = mode;
      if(!itemModal) itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
      itemModal.show();
      document.getElementById("itm-finder-search").value = "";
      document.getElementById("itm-finder-list").innerHTML = "<tr><td colspan='3' class='text-muted p-4'>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•œ ë’¤ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
      if (!itemCache || itemCache.length === 0) {
          load(1);
          google.script.run.withSuccessHandler(function(l) {
              load(0);
              // ì„œë²„ ë°˜í™˜ê°’ì„ code/category/name ë¬¸ìì—´ë¡œ í†µì¼ (ìˆ«ìÂ·ë¹ˆê°’ ëŒ€ë¹„)
              itemCache = (l || []).map(function(i) {
                  return {
                      code: String(i.code != null ? i.code : ''),
                      category: String(i.category != null ? i.category : ''),
                      name: String(i.name != null ? i.name : ''),
                      price: Number(i.price) || 0
                  };
              });
              fillItemFinderCategoryDropdown();
              // ëª¨ë‹¬ ì—´ë¦¼ ì‹œì—ëŠ” ëª©ë¡ ë¹„ì›€ ìœ ì§€(ê²€ìƒ‰ í›„ì—ë§Œ ê²°ê³¼ í‘œì‹œ)
          }).getAdminItemsList();
      } else {
          fillItemFinderCategoryDropdown();
          // ìºì‹œ ìˆì–´ë„ ëª©ë¡ì€ ì•ˆë‚´ ë¬¸êµ¬ ìœ ì§€
      }
  }
  /** í’ˆëª© ê²€ìƒ‰ ëª¨ë‹¬ ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ì„ itemCache ê¸°ì¤€ìœ¼ë¡œ ì±„ì›€ */
  function fillItemFinderCategoryDropdown() {
      var catSel = document.getElementById("itm-finder-cat");
      if (!catSel) return;
      var cats = {};
      (itemCache || []).forEach(function(i) { var cat = (i.category || '').trim(); if (cat) cats[cat] = true; });
      catSel.innerHTML = "<option value=''>ì „ì²´ ì¹´í…Œê³ ë¦¬</option>";
      Object.keys(cats).sort().forEach(function(c) { catSel.add(new Option(c, c)); });
  }
  function filterModalItems() {
      var k = (document.getElementById("itm-finder-search").value || "").toLowerCase().trim();
      var c = (document.getElementById("itm-finder-cat").value || "").trim();
      var b = document.getElementById("itm-finder-list"); b.innerHTML = "";
      // ì¹´í…Œê³ ë¦¬Â·ê²€ìƒ‰ì–´ ë‘˜ ë‹¤ ë¹„ë©´ ì•ˆë‚´ë§Œ í‘œì‹œ(ì „ì²´ í’ˆëª© ë…¸ì¶œ ì•ˆ í•¨)
      if (k === "" && c === "") {
          b.innerHTML = "<tr><td colspan='3' class='text-muted p-4'>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•œ ë’¤ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
          return;
      }
      var count = 0;
      (itemCache || []).forEach(function(item) {
          if (count > 50) return;
          var itemCat = String(item.category != null ? item.category : '').trim();
          var itemCode = String(item.code != null ? item.code : '');
          var itemName = String(item.name != null ? item.name : '');
          var matchCat = (c === "" || itemCat === c);
          var matchKey = (k === "" || itemCode.toLowerCase().includes(k) || itemName.toLowerCase().includes(k));
          if (matchCat && matchKey) {
              var escCode = (itemCode || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              var escName = (itemName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
              b.innerHTML += "<tr style=\"cursor:pointer;\" onclick=\"selectModalItem('" + escCode + "', '" + escName + "')\"><td>" + escCode + "</td><td class=\"text-start fw-bold\">" + escName + "</td><td class=\"text-end\">" + (Number(item.price) || 0).toLocaleString() + "</td></tr>";
              count++;
          }
      });
      if (count === 0) b.innerHTML = "<tr><td colspan='3' class='text-center p-3'>ê²°ê³¼ ì—†ìŒ</td></tr>";
  }
  function selectModalItem(code, name) {
      if (finderMode === 'force') { document.getElementById("f-code").value = code; document.getElementById("f-name").value = name; document.getElementById("f-qty").focus(); }
      else if (finderMode === 'inbound') { document.getElementById("i-code").value = code; document.getElementById("i-name").value = name; document.getElementById("i-qty").focus(); }
      else if (finderMode === 'adj') { document.getElementById("a-code").value = code; document.getElementById("a-name").value = name; document.getElementById("a-new").focus(); }
      itemModal.hide();
  }
  /* [ìˆ˜ì •ë¨] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì¡°ì • ëª©ë¡ ë‚ ì§œ í‘œì‹œ ì¶”ê°€) */
function renderList(id, list) {
    var b = document.getElementById(id);
    b.innerHTML = "";
    
    list.forEach((i, idx) => {
        var rowHtml = "";
        
        if (id === 'force-cart') { // ì¶œê³ 
            rowHtml = `<td>${i.store}</td><td>${i.name}</td><td>${i.qty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        } else if (id === 'adj-cart') { // â˜… ì¡°ì • (ë‚ ì§œ ì¶”ê°€)
            rowHtml = `<td>${i.date}</td><td>${i.name}</td><td>${i.newQty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        } else { // ì…ê³  ë“±
            rowHtml = `<td>${i.name}</td><td>${i.qty||i.newQty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        }
        b.innerHTML += `<tr>${rowHtml}</tr>`;
    });
    
    var c = document.getElementById(id.replace("cart", "count"));
    if (c) c.innerText = list.length;
}
  function delList(id, idx){ 
      if(id=='inbound-cart') inboundList.splice(idx,1); else if(id=='force-cart') forceList.splice(idx,1); else adjList.splice(idx,1); 
      renderList(id, id=='inbound-cart'?inboundList:(id=='force-cart'?forceList:adjList)); 
  }

  /* =========================================================
     [ê¸°ëŠ¥ 6] ê¸°íƒ€ ê´€ë¦¬ (ì§ì›, ê±°ë˜ì²˜, ê³µì§€) - 6ì¹¸/8ì¹¸ ë§ì¶¤
     ========================================================= */


/* [ìˆ˜ì •] ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (í•„í„°ë§ ì•ˆì „ì¥ì¹˜ ì¶”ê°€) */
function renderVendors(list) { 
    var b = document.getElementById("vnd-list-body"); 
    b.innerHTML = ""; 
    
    // 1. í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 'All'ë¡œ ê°„ì£¼)
    var filterEl = document.getElementById("filter-vnd-type");
    var f = filterEl ? filterEl.value : "All"; 
    
    // 2. í•„í„°ë§ (ì „ì²´ì´ê±°ë‚˜, íƒ€ì…ì´ ì¼ì¹˜í•˜ë©´ í†µê³¼)
    var fl = list.filter(function(v) {
        return (f === "All" || v.type === f);
    });
    
    // 3. ê²°ê³¼ ì—†ìŒ ì²˜ë¦¬
    if (!fl || fl.length === 0) { 
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>ê²€ìƒ‰ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    // 4. ëª©ë¡ ê·¸ë¦¬ê¸° (êµ¬ë¶„/ìˆ˜ì •/ì‚­ì œ ë‹¤êµ­ì–´)
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var lblBuy = lang.vendor_type_buy || "ë§¤ì…ì²˜";
    var lblSell = lang.vendor_type_sell || "ë§¤ì¶œì²˜";
    var lblEtc = lang.vendor_type_etc || "ê¸°íƒ€";
    var editTxt = lang.btn_edit || "ìˆ˜ì •";
    var delTxt = lang.btn_delete || "ì‚­ì œ";
    fl.forEach(function(v) { 
        var badge = '<span class="badge bg-secondary">' + lblEtc + '</span>';
        if(v.type === 'ë§¤ì…ì²˜') badge = '<span class="badge bg-primary">' + lblBuy + '</span>';
        if(v.type === 'ë§¤ì¶œì²˜') badge = '<span class="badge bg-danger">' + lblSell + '</span>';
        
        var idx = vendorCache.findIndex(x => x.row === v.row);
        
        b.innerHTML += `
            <tr>
                <td>${badge}</td>
                <td class='fw-bold text-danger'>${v.code}</td>
                <td class='text-start ps-3'>${v.name}</td>
                <td>${v.manager}</td>
                <td class='text-end'>${Number(v.balance).toLocaleString()}</td>
                <td>
                    <button class='btn btn-sm btn-primary' onclick='editVendor(${idx})'>${editTxt}</button> 
                    <button class='btn btn-sm btn-danger' onclick='delVendor(${v.row})'>${delTxt}</button>
                </td>
            </tr>`; 
    }); 
}
  function saveVendor() { 
      var d={ row:document.getElementById("vnd-row").value, type:document.getElementById("vnd-type").value, code:document.getElementById("vnd-code").value, name:document.getElementById("vnd-name").value, taxId:document.getElementById("vnd-tax").value, ceo:document.getElementById("vnd-ceo").value, addr:document.getElementById("vnd-addr").value, manager:document.getElementById("vnd-manager").value, phone:document.getElementById("vnd-phone").value, balance:document.getElementById("vnd-balance").value, memo:document.getElementById("vnd-memo").value }; 
      google.script.run.withSuccessHandler(r=>{alert(r);loadVendors();}).saveVendor(d); 
  }
  function editVendor(i) { var v=vendorCache[i]; document.getElementById("vnd-row").value=v.row; document.getElementById("vnd-type").value=v.type; document.getElementById("vnd-code").value=v.code; document.getElementById("vnd-name").value=v.name; document.getElementById("vnd-tax").value=v.taxId; document.getElementById("vnd-ceo").value=v.ceo; document.getElementById("vnd-addr").value=v.addr; document.getElementById("vnd-manager").value=v.manager; document.getElementById("vnd-phone").value=v.phone; document.getElementById("vnd-balance").value=v.balance; document.getElementById("vnd-memo").value=v.memo; }
  function delVendor(r) { if(confirm("ì‚­ì œ?")){load(1);google.script.run.withSuccessHandler(r=>{load(0);alert(r);loadVendors();}).deleteVendor(r);} }
  function createNewVendor() { document.getElementById("vnd-row").value="0"; document.getElementById("vnd-name").value=""; }

/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ì €ì¥ ë²„íŠ¼ (ë°˜ì‘ í™•ì¸ìš© ì•ˆì „ì¥ì¹˜ í¬í•¨) */
function saveAdjBatch() {
    // 1ë‹¨ê³„: ë²„íŠ¼ì´ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸
    // alert("ë²„íŠ¼ì´ ëˆŒë ¸ìŠµë‹ˆë‹¤! (ì—°ê²° ì„±ê³µ)"); // <-- ì´ ì°½ì´ ì•ˆ ëœ¨ë©´ ì˜¤íƒ€ê°€ ìˆëŠ” ê²ë‹ˆë‹¤.

    // 2ë‹¨ê³„: ëª©ë¡ í™•ì¸
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    if (typeof adjList === 'undefined' || adjList.length === 0) {
        return alert("âŒ " + (lang.stock_alert_empty_list || "ì¡°ì •í•  í’ˆëª©ì´ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'ë‹´ê¸°'ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”."));
    }

    // 3ë‹¨ê³„: ì‚¬ìš©ì í™•ì¸
    var confirmMsg = (lang.stock_adj_confirm_msg || "ì´ Nê±´ì˜ ì¬ê³ ë¥¼ ì •ë§ë¡œ ì¡°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤)").replace("N", adjList.length);
    if (!confirm(confirmMsg)) {
        return;
    }

    load(1); // ë¡œë”©í™”ë©´ ì¼œê¸°

    // 4ë‹¨ê³„: ì„œë²„ë¡œ ì „ì†¡
    google.script.run
        .withSuccessHandler(function(res) {
            load(0); // ë¡œë”© ë„ê¸°
            alert(res); // ê²°ê³¼ ë©”ì‹œì§€ (âœ… ì €ì¥ ì™„ë£Œ ë“±)

            // ì„±ê³µ ì‹œ ëª©ë¡ ë¹„ìš°ê¸°
            if (res && (res.includes("ì™„ë£Œ") || res.includes("âœ…") || res.includes("ì„±ê³µ"))) {
                adjList = [];
                renderList("adj-cart", []);
                
                // ì¬ê³  í˜„í™©íŒì´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                if(typeof loadStock === 'function') {
                    loadStock(false);
                }
            }
        })
        .withFailureHandler(function(err) {
            load(0); // ë¡œë”© ë„ê¸°
            var lang2 = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
            alert("ğŸ”¥ " + (lang2.stock_server_error || "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ") + ":\n" + err.message);
        })
        .adjustStockBatch(adjList, userRole || "Unknown", typeof userStore !== "undefined" ? userStore : "");
}
// [ìˆ˜ì •] í’ˆëª© ë°ì´í„° ë¡œë“œ (í™”ë©´ í‘œì‹œ X, ê²€ìƒ‰ ëŒ€ê¸° ìƒíƒœ)
function loadAdminItems() {
    load(1);
    google.script.run.withSuccessHandler(function(list) {
        load(0);
        itemCache = list || []; // ë°ì´í„°ëŠ” ë³€ìˆ˜ì— ì €ì¥ (ê²€ìƒ‰ìš©)
        
        // â˜… í•µì‹¬ ë³€ê²½: ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ì§€ ì•Šê³  ì•ˆë‚´ ë¬¸êµ¬ë§Œ í‘œì‹œ (ë‹¤êµ­ì–´)
        var b = document.getElementById("itm-list-body");
        var itemGuideText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].item_guide) ? I18N[currentLang].item_guide : "ğŸ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        if(b) b.innerHTML = "<tr><td colspan='6' class='text-center p-5 text-muted'>ğŸ” " + itemGuideText + "</td></tr>";
        
        // (í•„ìˆ˜) ê²€ìƒ‰ì°½ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì€ ì±„ì›Œë†”ì•¼ ê²€ìƒ‰ì„ í•˜ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ìœ ì§€
        var cats = {};
        itemCache.forEach(i => { if(i.category) cats[i.category] = true; });
        
        // 1. ì…ë ¥ì°½ìš© ë°ì´í„°ë¦¬ìŠ¤íŠ¸
        var dl = document.getElementById("cat-list");
        if(dl) {
            dl.innerHTML = "";
            Object.keys(cats).sort().forEach(c => { 
                var op = document.createElement("option"); op.value = c; dl.appendChild(op); 
            });
        }
        // 2. ê²€ìƒ‰ì°½ìš© ì…€ë ‰íŠ¸ë°•ìŠ¤
        var searchCat = document.getElementById("itm-search-cat");
        if(searchCat) {
            var catAllText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].item_cat_all) ? I18N[currentLang].item_cat_all : "ì „ì²´ ì¹´í…Œê³ ë¦¬";
            searchCat.innerHTML = "<option value=''>" + catAllText + "</option>"; 
            Object.keys(cats).sort().forEach(c => searchCat.add(new Option(c, c)));
        }
        
    }).getAdminItemsList();
}

/* [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€ ì•„ì´ì½˜ í‘œì‹œ) */
function renderAdminItems(list) {
    var b = document.getElementById("itm-list-body"); 
    b.innerHTML = "";
    
    if (!list || list.length === 0) { 
        b.innerHTML = "<tr><td colspan='6' class='text-center p-3 text-muted'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var editTxt = lang.btn_edit || "ìˆ˜ì •";
    var delTxt = lang.btn_delete || "ì‚­ì œ";
    list.forEach(i => {
        var idx = itemCache.findIndex(x => x.row === i.row);
        var taxBadge = String(i.tax).includes("ë©´") ? '<span class="badge bg-secondary ms-1">ë©´ì„¸</span>' : '';
        
        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ 'ğŸ“·', ì—†ìœ¼ë©´ '-'
        var imgDisplay = i.image ? `<a href="${i.image}" target="_blank" style="text-decoration:none;">ğŸ“·</a>` : '-';

        b.innerHTML += `
            <tr>
                <td>${i.code}</td>
                <td>${imgDisplay}</td> <td class="text-start ps-3 fw-bold">${i.name} ${taxBadge}</td>
                <td>${i.spec||'-'}</td>
                <td class="text-end">${Number(i.price).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editItem(${idx})">${editTxt}</button> 
                    <button class="btn btn-sm btn-danger" onclick="delItem(${i.row})">${delTxt}</button>
                </td>
            </tr>`;
    });
}

/* [ìˆ˜ì •] ìˆ˜ì • ëª¨ë“œ (ì´ë¯¸ì§€ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°) */
function editItem(idx) {
    var item = itemCache[idx];
    document.getElementById("itm-row").value = item.row;
    document.getElementById("itm-code").value = item.code;
    document.getElementById("itm-cat").value = item.category;
    document.getElementById("itm-name").value = item.name;
    document.getElementById("itm-spec").value = item.spec;
    document.getElementById("itm-price").value = item.price;
    document.getElementById("itm-cost").value = item.cost;
    
    // â˜… ì¶”ê°€ëœ ë¶€ë¶„
    document.getElementById("itm-image").value = item.image || "";   // Gì—´
    document.getElementById("itm-vendor").value = item.vendor || ""; // Hì—´
    var outEl = document.getElementById("itm-outbound");
    if (outEl) outEl.value = item.outbound_location || "";
    
    document.getElementById("itm-tax").value = String(item.tax).includes("ë©´") ? "ë©´ì„¸" : "ê³¼ì„¸";
}

/* [ìˆ˜ì •] ì €ì¥ í•¨ìˆ˜ (ì´ë¯¸ì§€ ê°’ ì „ì†¡) */
function saveItem() {
    var taxVal = document.getElementById("itm-tax").value;
    var d = { 
        row: document.getElementById("itm-row").value, 
        code: document.getElementById("itm-code").value, 
        category: document.getElementById("itm-cat").value, 
        name: document.getElementById("itm-name").value, 
        spec: document.getElementById("itm-spec").value, 
        price: document.getElementById("itm-price").value, 
        cost: document.getElementById("itm-cost").value, 
        
        // â˜… ì¶”ê°€ëœ ë¶€ë¶„
        image: document.getElementById("itm-image").value,   // Gì—´
        vendor: document.getElementById("itm-vendor").value, // Hì—´
        outbound_location: (document.getElementById("itm-outbound") || {}).value || "",
        
        tax: taxVal 
    };

    if (!d.code || !d.name) return alert("ì½”ë“œì™€ í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    
    load(1);
    google.script.run.withSuccessHandler(res => { 
        load(0); 
        alert(res); 
        loadAdminItems(); 
        createNewItem(); 
    }).saveAdminItem(d);
}

/* [ìˆ˜ì •] ì´ˆê¸°í™” (ì´ë¯¸ì§€ ì¹¸ ë¹„ìš°ê¸°) */
function createNewItem() {
    document.getElementById("itm-row").value = "0"; 
    document.getElementById("itm-code").value = ""; 
    document.getElementById("itm-name").value = ""; 
    document.getElementById("itm-cat").value = ""; 
    document.getElementById("itm-spec").value = ""; 
    document.getElementById("itm-price").value = ""; 
    document.getElementById("itm-cost").value = ""; 
    
    // â˜… ì¶”ê°€ëœ ë¶€ë¶„
    document.getElementById("itm-image").value = ""; 
    document.getElementById("itm-vendor").value = ""; 
    var outEl = document.getElementById("itm-outbound");
    if (outEl) outEl.value = "";
    
    document.getElementById("itm-tax").value = "ê³¼ì„¸";
}

/* [ìˆ˜ì •] í’ˆëª© ê²€ìƒ‰ (ë¹ˆì¹¸ ì•ˆì „ì¥ì¹˜ ì¶”ê°€ ë²„ì „) */
function filterAdminItems() {
    var searchInput = document.getElementById("itm-search");
    var catInput = document.getElementById("itm-search-cat");
    
    // ì…ë ¥ì°½ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì—ëŸ¬ ë°©ì§€)
    if (!searchInput || !catInput) return;

    var k = searchInput.value.toLowerCase().trim(); // ê²€ìƒ‰ì–´ (ì†Œë¬¸ì, ê³µë°±ì œê±°)
    var c = catInput.value; // ì¹´í…Œê³ ë¦¬ ì„ íƒê°’
    
    // ë°ì´í„°ê°€ ì•„ì§ ë¡œë”© ì•ˆ ëìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
    if (!itemCache) itemCache = []; 

    var filtered = itemCache.filter(function(i) {
        // â˜… í•µì‹¬: ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆ ë¬¸ìì—´("")ë¡œ ëŒ€ì²´
        var iCat = String(i.category || ""); 
        var iName = String(i.name || "").toLowerCase();
        var iCode = String(i.code || "").toLowerCase();
        
        // 1. ì¹´í…Œê³ ë¦¬ ê²€ì‚¬ (ì „ì²´ì´ê±°ë‚˜ ì¼ì¹˜í•˜ë©´ í†µê³¼)
        var matchCat = (c === "" || c === "All" || iCat === c);
        
        // 2. ê²€ìƒ‰ì–´ ê²€ì‚¬ (ì´ë¦„ì´ë‚˜ ì½”ë“œì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ë©´ í†µê³¼)
        var matchKey = (k === "" || iName.includes(k) || iCode.includes(k));
        
        return matchCat && matchKey;
    });
    
    renderAdminItems(filtered);
}

// 2. ì €ì¥ ë²„íŠ¼ (í•œê¸€ ê°’ 'ê³¼ì„¸'/'ë©´ì„¸' ê·¸ëŒ€ë¡œ ì „ì†¡)
/* [ìˆ˜ì •ë¨] ì €ì¥ ë²„íŠ¼ (ë³´ë‚´ëŠ” ê°’ í™•ì¸) */
function saveItem() {
    var taxEl = document.getElementById("itm-tax");
    var taxVal = taxEl.value; // "ê³¼ì„¸" ë˜ëŠ” "ë©´ì„¸"

    // â˜… ì•ˆì „ì¥ì¹˜: í˜¹ì‹œë¼ë„ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ë³´ê³  íŒë‹¨
    if (!taxVal) {
        var text = taxEl.options[taxEl.selectedIndex].text;
        if (text.includes("ë©´ì„¸")) taxVal = "ë©´ì„¸";
        else taxVal = "ê³¼ì„¸";
    }

    var d = {
        row: document.getElementById("itm-row").value,
        code: document.getElementById("itm-code").value,
        category: document.getElementById("itm-cat").value,
        name: document.getElementById("itm-name").value,
        spec: document.getElementById("itm-spec").value,
        price: document.getElementById("itm-price").value,
        cost: document.getElementById("itm-cost").value,
        image: (document.getElementById("itm-image") || {}).value || "",
        vendor: (document.getElementById("itm-vendor") || {}).value || "",
        outbound_location: (document.getElementById("itm-outbound") || {}).value || "",
        tax: taxVal
    };
    
    if (!d.code || !d.name) return alert("ì½”ë“œì™€ í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    
    // ì €ì¥ ì‹œì‘ ì•Œë¦¼ (ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)
    load(1);
    
    google.script.run.withSuccessHandler(function(res) {
        load(0);
        alert(res); // ì—¬ê¸°ì— "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ë©´ì„¸)" ë¼ê³  ë– ì•¼ ì„±ê³µì…ë‹ˆë‹¤.
        loadAdminItems(); 
        createNewItem();
    }).saveAdminItem(d);
}

// 3. ìˆ˜ì • ë²„íŠ¼ (ì…ë ¥ì°½ì— ê°’ ì •í™•íˆ ì„¸íŒ…)
function editItem(idx) {
    var item = itemCache[idx];
    document.getElementById("itm-row").value = item.row;
    document.getElementById("itm-code").value = item.code;
    document.getElementById("itm-cat").value = item.category;
    document.getElementById("itm-name").value = item.name;
    document.getElementById("itm-spec").value = item.spec;
    document.getElementById("itm-price").value = item.price;
    document.getElementById("itm-cost").value = item.cost;
    var outEl = document.getElementById("itm-outbound");
    if (outEl && item.outbound_location) outEl.value = item.outbound_location;
    if (document.getElementById("itm-image")) document.getElementById("itm-image").value = item.image || "";
    if (document.getElementById("itm-vendor")) document.getElementById("itm-vendor").value = item.vendor || "";
    
    // â˜… í•µì‹¬: ê°€ì ¸ì˜¨ ê°’ì´ 'ë©´ì„¸'ë©´ ë©´ì„¸ ì„ íƒ, ì•„ë‹ˆë©´ ë¬´ì¡°ê±´ 'ê³¼ì„¸' ì„ íƒ
    // (ì‹œíŠ¸ì— ë¹ˆì¹¸ì´ì–´ë„ 'ê³¼ì„¸'ë¡œ ê°„ì£¼í•˜ì—¬ ì„ íƒë˜ê²Œ í•¨)
    if (item.tax && item.tax.trim() === "ë©´ì„¸") {
        document.getElementById("itm-tax").value = "ë©´ì„¸";
    } else {
        document.getElementById("itm-tax").value = "ê³¼ì„¸";
    }
}

// 6. ì‹ ê·œ ë“±ë¡ ë²„íŠ¼ (ì´ˆê¸°í™”)
function createNewItem() {
    document.getElementById("itm-row").value = "0";
    document.getElementById("itm-code").value = "";
    document.getElementById("itm-name").value = "";
    document.getElementById("itm-spec").value = "";
    document.getElementById("itm-price").value = "";
    document.getElementById("itm-cost").value = "";
    document.getElementById("itm-cat").value = "";
    document.getElementById("itm-tax").value = "VAT";
}
/* [Code.gs] í’ˆëª© ì €ì¥ (Jì—´ ê°•ì œ ì €ì¥ ê°•í™” ë²„ì „) */
function saveAdminItem(data) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("í’ˆëª©");
  if (!sheet) return "âŒ ì˜¤ë¥˜: 'í’ˆëª©' ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
  
  try {
    var row = Number(data.row);
    
    // 1. ì‹ ê·œ ë“±ë¡ì¸ ê²½ìš° (ë§¨ ì•„ë˜ ì¤„ ì¶”ê°€)
    if (row === 0) {
      row = sheet.getLastRow() + 1;
    }
    
    // 2. ê¸°ë³¸ ì •ë³´ ì €ì¥ (Aì—´ ~ Fì—´)
    // ìˆœì„œ: ì½”ë“œ(1), ì¹´í…Œê³ ë¦¬(2), í’ˆëª©ëª…(3), ê·œê²©(4), íŒë§¤ê°€(5), ì›ê°€(6)
    sheet.getRange(row, 1, 1, 6).setValues([[
      data.code,
      data.category,
      data.name,
      data.spec,
      Number(data.price) || 0,
      Number(data.cost) || 0
    ]]);

    // 3. ê³¼ì„¸ ì •ë³´ ì €ì¥ (â˜… Jì—´: 10ë²ˆì§¸ ì¹¸)
    // ì‹œíŠ¸ì˜ ì»¬ëŸ¼ì´ 10ê°œë³´ë‹¤ ì ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¹¸ì„ ëŠ˜ë ¤ì„œë¼ë„ ì €ì¥
    if (sheet.getMaxColumns() < 10) {
      sheet.insertColumnsAfter(sheet.getMaxColumns(), 10 - sheet.getMaxColumns());
    }
    
    // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ "ê³¼ì„¸"ë¡œ ì²˜ë¦¬
    var taxValue = (data.tax && data.tax !== "") ? String(data.tax) : "ê³¼ì„¸";
    
    // Jì—´ì— í™•ì‹¤í•˜ê²Œ ì“°ê¸°
    sheet.getRange(row, 10).setValue(taxValue);
    
    // ì €ì¥ í›„ ê²°ê³¼ ë©”ì‹œì§€ì— ê³¼ì„¸ ì •ë³´ë¥¼ í¬í•¨í•´ì„œ ë³´ì—¬ì¤Œ (í™•ì¸ìš©)
    return "âœ… ì €ì¥ ì™„ë£Œ! (" + taxValue + ")";
    
  } catch (e) {
    return "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
  }
}

/* [ìˆ˜ì •] ê±°ë˜ì²˜ ë°ì´í„° ë¡œë“œ (ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ëª©ë¡ í‘œì‹œ) */
function loadVendors(isSearch) { 
    load(1); // ë¡œë”© ì‹œì‘
    
    google.script.run.withSuccessHandler(function(list) { 
        load(0); // ë¡œë”© ë
        
        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚¬ì„ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
        vendorCache = list || []; 
        
        // â˜… í•µì‹¬: isSearchê°€ true(ë²„íŠ¼ í´ë¦­)ì¼ ë•Œë§Œ ëª©ë¡ì„ ê·¸ë¦¼
        if (isSearch) {
            renderVendors(vendorCache);
        } else {
            // ë©”ë‰´ ì²˜ìŒ ë“¤ì–´ê°”ì„ ë• ì•ˆë‚´ ë¬¸êµ¬ë§Œ
            var b = document.getElementById("vnd-list-body");
            if(b) b.innerHTML = "<tr><td colspan='6' class='text-center p-5 text-muted'>ğŸ”„ êµ¬ë¶„ ì„ íƒ ë˜ëŠ” [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
        }
    }).getVendorManagementList(); 
}
/* [ìµœì¢… ìˆ˜ì •] íƒ­ ì „í™˜ í•¨ìˆ˜ (í™”ë©´ ì„ì„ ë°©ì§€ + ë²„íŠ¼ í™œì„±í™”) */
  function showStockTab(t){ 
      // 1. ëª¨ë“  íƒ­ í™”ë©´ì„ ê°•ì œë¡œ ìˆ¨ê¹€ (IDë¡œ ì§ì ‘ ì§€ì • -> ê°€ì¥ ì•ˆì „í•¨)
      document.getElementById("stock-tab-status").style.display = "none";
      document.getElementById("stock-tab-adjust").style.display = "none";
      document.getElementById("stock-tab-history").style.display = "none";
      
      // 2. ì„ íƒí•œ íƒ­ë§Œ ë³´ì´ê¸°
      var target = document.getElementById("stock-tab-" + t);
      if(target) target.style.display = "block";
      
      // 3. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active ìƒíƒœ)
      // ìš°ì„  ëª¨ë“  ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœë¥¼ ë”
      document.getElementById("stock-nav-status").classList.remove("active");
      document.getElementById("stock-nav-adjust").classList.remove("active");
      document.getElementById("stock-nav-history").classList.remove("active");
      
      // í´ë¦­í•œ ë²„íŠ¼ë§Œ í™œì„±í™” (ìƒ‰ìƒ ì¼œê¸°)
      var btn = document.getElementById("stock-nav-" + t);
      if(btn) btn.classList.add("active");

      // 4. ë°ì´í„° ë¡œë“œ (í•„ìš”í•  ë•Œë§Œ)
      if(t==='history') loadAdjHistory();
      if(t==='status') loadStock(false);
  }

  /* [ìˆ˜ì •] ì¬ê³  í˜„í™© ë¡œë“œ (ì—´ ë„ˆë¹„ ê°•ì œ ê³ ì •) */
  function loadStock(useDate) { 
      var s=document.getElementById("stock-store-selector").value; 
      if(!s) return;
      
      load(1); 
      google.script.run.withSuccessHandler(d=>{ 
          load(0); 
          var c=document.getElementById("stock-container"); 
          c.innerHTML=""; 
          
          var gt=0; var g={}; 
          d.forEach(i=>{
              gt+=i.total; 
              if(!g[i.category]) g[i.category]=[]; 
              g[i.category].push(i); 
          }); 
          
          document.getElementById("stock-grand-total").innerText=gt.toLocaleString()+" à¸¿"; 
          
          // ì¹´í…Œê³ ë¦¬ë³„ í…Œì´ë¸” ìƒì„±
          for(var cat in g){ 
              // ì ‘ê¸°/í´ê¸° í—¤ë”
              var h = `<div class="p-2 bg-secondary text-white fw-bold d-flex justify-content-between" onclick="toggleCat('${cat}')" style="cursor:pointer; border-bottom:1px solid #ddd;">
                          <span>${cat} (${g[cat].length})</span> <span>â–¼</span>
                       </div>
                       <div id="cat-${cat}" style="display:block;">
                       <table class="table table-bordered text-center mb-0 align-middle" style="table-layout: fixed;">
                           <tbody>`; 
              
              g[cat].forEach(i=>{ 
                  var safeInput = `<div class="input-group input-group-sm justify-content-center"><input type="number" id="safe-${i.code}" class="form-control text-center p-0" value="${i.safe}" placeholder="0" style="max-width:60px;"><button class="btn btn-outline-dark" onclick="saveSafeQty('${s}', '${i.code}', document.getElementById('safe-${i.code}').value)">ğŸ’¾</button></div>`; 
                  
                  // â˜… í•µì‹¬: style="width: XX%"ë¡œ ì¹¸ í¬ê¸° ê°•ì œ ê³ ì • (í—¤ë”ì™€ ë™ì¼í•˜ê²Œ)
                  h+=`<tr>
                          <td style="width: 15%;" class="text-muted small">${i.code}</td>
                          <td style="width: 35%;" class="text-start ps-2 text-truncate">${i.name}</td>
                          <td style="width: 20%;">${safeInput}</td>
                          <td style="width: 15%; font-weight:bold; color:${i.qty<=i.safe?'red':'blue'}">${i.qty}</td>
                          <td style="width: 15%;" class="text-end pe-2 small">${Number(i.total).toLocaleString()}</td>
                      </tr>`; 
              }); 
              h+=`</tbody></table></div>`; 
              c.innerHTML+=h; 
          } 
      }).getStockStatusAdmin(s, useDate?document.getElementById("stock-date").value:""); 
  }
  
  // (ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸° ê¸°ëŠ¥)
  function toggleCat(id){ 
      var el=document.getElementById("cat-"+id); 
      el.style.display = (el.style.display==='none' ? 'block' : 'none'); 
  }
 
  function saveSafeQty(s,c,v){
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var msgOk = lang.stock_safe_saved || "ì ì •ì¬ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
    var msgFail = lang.stock_safe_failed || "ì ì •ì¬ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
    google.script.run
      .withSuccessHandler(function(){ alert(msgOk); })
      .withFailureHandler(function(err){ alert(msgFail + (err && err.message ? " " + err.message : "")); })
      .saveStoreSafetyStock(s,c,v);
  }

/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ë‚´ì—­ í™”ë©´ (ê·œê²© ì¶”ê°€) */
function loadAdjHistory() {
    var s = document.getElementById("adj-start").value;
    var e = document.getElementById("adj-end").value;
    var st = document.getElementById("adj-store-selector").value;
    if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; }

    load(1);
    google.script.run.withSuccessHandler(list => {
        load(0); 
        var b = document.getElementById("adj-list"); 
        b.innerHTML = "";
        var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
        var noDataTxt = lang.stock_hist_no_data || "ë‚´ì—­ ì—†ìŒ";
        var summaryTxt = lang.stock_hist_summary || "ì™¸";
        var countSuffix = lang.stock_hist_count_suffix || "ê±´ ì¡°ì •";
        var errorTxt = lang.stock_error || "ì˜¤ë¥˜";
        var detailItem = lang.stock_hist_detail_item || "í’ˆëª©";
        var detailSpec = lang.stock_hist_detail_spec || "ê·œê²©";
        var detailAdj = lang.stock_hist_detail_adj || "ì¡°ì •";
        var detailReason = lang.stock_hist_detail_reason || "ì‚¬ìœ ";
        var countUnit = (lang.eval_list_count || "ê±´").trim();
        if(!list.length){ b.innerHTML="<tr><td colspan='5'>" + noDataTxt + "</td></tr>"; return; }
        
        var groups={}; 
        list.forEach(i=>{ 
            var k=i.date+"_"+i.store; 
            if(!groups[k]) groups[k]={date:i.date, store:i.store, items:[]}; 
            groups[k].items.push(i); 
        });
        
        var idx=0;
        for(var k in groups){
            var g=groups[k]; 
            var rid="adj-row-"+idx;
            var extCount = g.items.length - 1;
            var summaryLabel = extCount > 0 ? " â–¼ " + g.items[0].item + " " + summaryTxt + " " + extCount + countUnit : " â–¼ " + g.items[0].item;
            var countLabel = g.items.length + (countSuffix.charAt(0) === " " ? countSuffix : " " + countSuffix);
            // ë©”ì¸ í–‰
            b.innerHTML+=`
                <tr style="cursor:pointer;" onclick="toggleRow('${rid}')">
                    <td>${g.date}</td>
                    <td class="fw-bold">${g.store}</td>
                    <td class="text-start ps-3">${summaryLabel}</td>
                    <td colspan="2">${countLabel}</td>
                </tr>`;
            
            // â˜… ìƒì„¸ í–‰ (ê·œê²© ì¶”ê°€ë¨)
            var dets = g.items.map(i => {
                var diffVal = Number(i.diff);
                var diffStr = isNaN(diffVal) ? errorTxt : (diffVal>0 ? "+"+diffVal : diffVal);
                var diffClass = diffVal>0 ? "text-primary" : "text-danger";
                
                return `
                    <tr>
                        <td class="text-start ps-4">${i.item}</td>
                        <td class="text-muted small">${i.spec}</td> <td class="fw-bold ${diffClass}">${diffStr}</td>
                        <td class="small text-muted">${i.reason}</td>
                    </tr>`;
            }).join("");
            
            b.innerHTML+=`
                <tr id="${rid}" style="display:none; background-color:#f8f9fa;">
                    <td colspan="5">
                        <table class="table table-sm table-bordered bg-white w-90 mx-auto mb-2">
                            <thead class="table-light"><tr><th>${detailItem}</th><th>${detailSpec}</th><th>${detailAdj}</th><th>${detailReason}</th></tr></thead>
                            <tbody>${dets}</tbody>
                        </table>
                    </td>
                </tr>`;
            idx++;
        }
    }).getAdjustmentHistory(s, e, st);
}
/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ë‹´ê¸° (ë‚ ì§œ í¬í•¨) */
function addAdjList() {
    // 1. ê°’ ê°€ì ¸ì˜¤ê¸°
    var dateVal = document.getElementById("a-date").value;
    var store = document.getElementById("a-store").value;
    var code = document.getElementById("a-code").value;
    var name = document.getElementById("a-name").value;
    var curQty = document.getElementById("a-cur").value; 
    var newQty = document.getElementById("a-new").value; 
    var reason = document.getElementById("a-reason").value;

    // 2. ë‚ ì§œ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ì±„ì›€
    if (!dateVal) {
        dateVal = new Date().toISOString().substring(0,10);
        document.getElementById("a-date").value = dateVal;
    }

    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    if (!code) return alert(lang.stock_alert_select_item || "í’ˆëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (newQty === "") return alert(lang.stock_alert_enter_qty || "ì‹¤ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    // 3. ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸°
    adjList.push({
        date: dateVal, // â˜… ë‚ ì§œ ì¶”ê°€ë¨
        store: store,
        code: code,
        name: name,
        curQty: curQty,
        newQty: newQty,
        reason: reason
    });

    renderList("adj-cart", adjList);
    
    // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    document.getElementById("a-new").value = "";
    document.getElementById("a-reason").value = "";
    document.getElementById("a-new").focus();
}
  /* =========================================================
     [ê¸°ëŠ¥ 3] ì£¼ë¬¸ ìŠ¹ì¸ ê´€ë¦¬ (ë§¤ì¥ í•„í„°ë§ í¬í•¨)
     ========================================================= */
  var officeStockCache = {};
  function loadOrders() {
      var s=document.getElementById("ord-start").value, e=document.getElementById("ord-end").value;
      if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; document.getElementById("ord-start").value=t; document.getElementById("ord-end").value=t; }
      load(1);
      google.script.run.withSuccessHandler(function(res){
          load(0);
          orderListCache = (res && res.list) ? res.list : (Array.isArray(res) ? res : []);
          officeStockCache = (res && res.officeStock) ? res.officeStock : {};
          renderOrderList();
      }).getAdminOrders(s, e);
  }

  /** ì£¼ë¬¸/ë°°ì†¡ ì¼ìë¥¼ yyyy-MM-dd í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì£¼ë¬¸ ìŠ¹ì¸ ê´€ë¦¬ ëª©ë¡ìš©) */
  function formatOrderDateOnly(val) {
    if (!val) return "-";
    var s = String(val).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    var d = new Date(val);
    if (isNaN(d.getTime())) return "-";
    var y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(-2), day = ("0" + d.getDate()).slice(-2);
    return y + "-" + m + "-" + day;
  }
  
  function renderOrderList() { 
      var k=document.getElementById("ord-search-keyword").value.toLowerCase();
      var st=document.getElementById("ord-status-filter").value;
      var storeEl=document.getElementById("ord-store-selector");
      var sf=storeEl?storeEl.value:"All";
      
      var b=document.getElementById("order-list"); b.innerHTML=""; 
      if(!orderListCache || !orderListCache.length) { b.innerHTML="<tr><td colspan='8' class='text-center p-4 text-muted'>ë°ì´í„° ì—†ìŒ</td></tr>"; return; }
      
      var f=orderListCache.filter(o=>(sf==="All"||o.store===sf)&&(st==="All"||o.status===st)&&o.store.toLowerCase().includes(k));
      if(!f.length) { b.innerHTML="<tr><td colspan='8' class='text-center p-4 text-muted'>ê²°ê³¼ ì—†ìŒ</td></tr>"; return; }

      f.forEach(o=>{ 
          var bc = o.status==='Pending'?'bg-warning text-dark':(o.status==='Approved'?'bg-success':'bg-danger');
          var delDate = formatOrderDateOnly(o.deliveryDate);
          b.innerHTML+=`<tr class="ord-data-row" style="cursor:pointer;" data-row="${o.row}"><td class="text-center" onclick="event.stopPropagation()"><input type="checkbox" class="form-check-input ord-invoice-chk" checked title="ì¸ì‡„ í¬í•¨"></td><td class="text-center" onclick="toggleRow('ord-row-${o.row}')">â–¼</td><td class="text-center">${o.date}</td><td class="text-center">${delDate}</td><td class="fw-bold text-center">${o.store}</td><td>${o.summary}</td><td class="text-end fw-bold text-primary">${Number(o.total).toLocaleString()} à¸¿</td><td class="text-center"><span class="badge ${bc}">${o.status}</span></td></tr><tr id="ord-row-${o.row}" class="ord-detail-row" style="display:none; background-color:#f8f9fa;"><td colspan="8" class="p-3">${buildOrderDetailHtml(o)}</td></tr>`; 
      });
      var allChk = document.getElementById("ord-print-all");
      if (allChk) allChk.checked = true;
  }
/* [ìˆ˜ì •ë¨] ì£¼ë¬¸ ìƒì„¸ í™”ë©´ (ê³¼ì„¸/ë©´ì„¸ í‘œì‹œ ë° ê³„ì‚°) */
function buildOrderDetailHtml(o) {
    if (!o.items || o.items.length === 0) {
        return `<div class="p-3 text-center text-muted">ìƒì„¸ í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    var itemRows = "";
    o.items.forEach((item, idx) => {
        var taxBadge = (item.taxType === "ë©´ì„¸") ? '<span class="badge bg-secondary" style="font-size:10px;">ë©´ì„¸</span>' : '';
        var finalAmt = Math.round(item.lineTotal);
        var officeQty = (typeof officeStockCache !== "undefined" && item.code && officeStockCache[item.code] != null) ? Number(officeStockCache[item.code]) : "-";

        itemRows += `
            <tr>
                <td class="text-center align-middle">
                    <input type="checkbox" class="form-check-input order-item-check-${o.row}" data-idx="${idx}" checked>
                </td>
                <td class="align-middle text-start">
                    ${item.name}${taxBadge ? ' <br>' + taxBadge : ''}
                </td>
                <td class="align-middle text-center text-muted small">${(item.spec || '').trim() || '-'}</td>
                <td class="align-middle text-end">${Number(item.price).toLocaleString()}</td>
                <td class="align-middle text-center fw-bold">${item.qty}</td>
                <td class="align-middle text-center office-stock-cell">${officeQty}</td>
                <td class="align-middle text-end fw-bold">${finalAmt.toLocaleString()}</td>
            </tr>`;
    });

    var deliveryDateId = "ord-delivery-date-" + o.row;
    var deliveryLabel = (typeof invT !== "undefined" && invT("ord_delivery_date")) ? invT("ord_delivery_date") : "ë°°ì†¡ ì¼ì";
    var changeBtnLabel = (typeof invT !== "undefined" && invT("ord_delivery_change_btn")) ? invT("ord_delivery_change_btn") : "ë³€ê²½";
    var isApproved = (o.status === "Approved");
    var currentDeliveryDate = (o.deliveryDate && String(o.deliveryDate).trim()) ? (o.deliveryDate.length === 10 ? o.deliveryDate : formatOrderDateOnly(o.deliveryDate)) : "";
    var btns;
    if (isApproved) {
      btns = `
        <div class="d-flex flex-wrap align-items-end gap-2 mt-3 pt-2 border-top">
            <div class="mb-0"><label class="form-label small mb-1">` + deliveryLabel + `</label><input type="date" id="` + deliveryDateId + `" class="form-control form-control-sm" style="min-width:140px;" value="` + (currentDeliveryDate || "") + `"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="changeOrderDeliveryDate('${o.row}')">` + changeBtnLabel + `</button>
            </div>
        </div>`;
    } else {
      btns = `
        <div class="d-flex flex-wrap align-items-end gap-2 mt-3 pt-2 border-top">
            <div class="mb-0"><label class="form-label small mb-1">` + deliveryLabel + `</label><input type="date" id="` + deliveryDateId + `" class="form-control form-control-sm" style="min-width:140px;"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-secondary btn-sm" onclick="processOrderInline('${o.row}','Hold')">ë³´ë¥˜</button>
                <button class="btn btn-danger btn-sm" onclick="processOrderInline('${o.row}','Rejected')">ê±°ì ˆ</button>
                <button class="btn btn-success btn-sm fw-bold" onclick="processOrderInline('${o.row}','Approved')">ìŠ¹ì¸</button>
            </div>
        </div>`;
    }

    return `
        <div class="card p-3 border-0 shadow-sm" style="background-color: #fff;">
            <h6 class="fw-bold mb-2">ğŸ“‹ ì£¼ë¬¸ ìƒì„¸ (ë¶€ê°€ì„¸ í¬í•¨)</h6>
            <table class="table table-sm table-bordered bg-white mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th style="width:30px;">V</th>
                        <th>í’ˆëª©ëª…</th>
                        <th style="width:10%;">ê·œê²©</th>
                        <th style="width:10%;">ë‹¨ê°€(ì„¸ì „)</th>
                        <th style="width:8%;">ìˆ˜ëŸ‰</th>
                        <th class="office-stock-header" style="width:9%;">Office ì¬ê³ </th>
                        <th style="width:14%;">í•©ê³„(ì„¸í›„)</th>
                    </tr>
                </thead>
                <tbody>${itemRows}</tbody>
            </table>
            ${btns}
        </div>`;
}
  function processOrderInline(row, decision) {
      var t = function(k, d){ if (typeof invT === "undefined") return d; var v = invT(k); return (v && v !== k) ? v : d; };
      var rejectReason = "";
      if (decision === "Rejected") {
          rejectReason = prompt(t("orderRejectReasonPh", "ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)") || "ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)", "") || "";
          if (rejectReason === null) return;
      }
      var confirmMsg = decision === "Hold" ? t("ord_confirm_hold", "Process as Hold?") : decision === "Rejected" ? t("ord_confirm_rejected", "Process as Rejected?") : (decision + "?");
      if(decision!=='Approved' && !confirm(confirmMsg)) return;
      var checkboxes = document.querySelectorAll('.order-item-check-' + row);
      var originalOrder = orderListCache.find(x => String(x.row) === String(row));
      var newCart = [];
      checkboxes.forEach(cb => { if(cb.checked) newCart.push(originalOrder.items[cb.getAttribute("data-idx")]); });
      var deliveryDateEl = document.getElementById("ord-delivery-date-" + row);
      var deliveryDate = (deliveryDateEl && deliveryDateEl.value) ? deliveryDateEl.value : "";
      if (decision === "Approved" && !deliveryDate) {
          var noDeliveryMsg = t("ord_confirm_approve_no_delivery", "No delivery date entered. Approve anyway?");
          if (!confirm(noDeliveryMsg)) return;
      }
      load(1);
      google.script.run.withSuccessHandler(function(res) { load(0); alert(typeof invT !== "undefined" && invT(res) ? invT(res) : res); loadOrders(); }).processOrderDecision(row, decision, newCart, deliveryDate, rejectReason);
  }

  /** ìŠ¹ì¸ëœ ì£¼ë¬¸ì˜ ë°°ì†¡ ì¼ìë§Œ ë³€ê²½ */
  function changeOrderDeliveryDate(row) {
      var deliveryDateEl = document.getElementById("ord-delivery-date-" + row);
      var deliveryDate = (deliveryDateEl && deliveryDateEl.value) ? deliveryDateEl.value.trim() : "";
      if (!deliveryDate) {
          alert(typeof invT !== "undefined" && invT("ord_delivery_required") ? invT("ord_delivery_required") : "ë°°ì†¡ ì¼ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
          return;
      }
      load(1);
      google.script.run.withSuccessHandler(function(res) { load(0); alert(typeof invT !== "undefined" && invT(res) ? invT(res) : res); loadOrders(); }).withFailureHandler(function(err) { load(0); var msg = err && err.message ? err.message : String(err); alert(typeof invT !== "undefined" && invT(msg) ? invT(msg) : msg); }).updateOrderDeliveryDate(row, deliveryDate);
  }
  function toggleRow(id) { var el = document.getElementById(id); if(el) el.style.display = (el.style.display === 'none') ? 'table-row' : 'none'; }

  /** ë°°ì†¡ ì™„ë£Œ ê±´ì—ì„œ URL ì—†ì´ ì‚¬ì§„ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì—ì„œ URL ì¡°íšŒ í›„ ëª¨ë‹¬ ì—´ê¸° */
  function fetchAndOpenReceivePhoto(orderRowId) {
    if (!orderRowId) return;
    google.script.run.withSuccessHandler(function(url) {
      if (url && url.trim()) openReceivePhotoModal(url);
      else alert("ìˆ˜ë ¹ ì‚¬ì§„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }).getOrderReceiveImageUrl(orderRowId);
  }

  /** ì¶œê³  ë‚´ì—­ ìˆ˜ë ¹ ì‚¬ì§„ ë³´ê¸° ëª¨ë‹¬ (URLì€ ì¸ë¼ì¸ì— ë„£ì§€ ì•Šê³  ì¸ë±ìŠ¤ë¡œ ì „ë‹¬í•´ ê¸´ data URLë¡œ ì¸í•œ ë©ˆì¶¤ ë°©ì§€) */
  function openReceivePhotoModalByIndex(idx) {
    var url = (window._receivePhotoUrlByIndex && window._receivePhotoUrlByIndex[idx]) ? window._receivePhotoUrlByIndex[idx] : null;
    if (url && (url + "").trim()) {
      openReceivePhotoModal(url);
      return;
    }
    var g = (window.forceHistoryGroupsCache && window.forceHistoryGroupsCache[idx]) ? window.forceHistoryGroupsCache[idx] : null;
    if (g && g.orderRowId) {
      fetchAndOpenReceivePhoto(g.orderRowId);
      return;
    }
    alert("ìˆ˜ë ¹ ì‚¬ì§„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  function openReceivePhotoModal(url) {
    if (!url || !(url + "").trim()) return;
    var imgEl = document.getElementById("receivePhotoModalImg");
    var linkEl = document.getElementById("receivePhotoModalLink");
    var modalEl = document.getElementById("receivePhotoModal");
    var openInTabTxt = (typeof invT !== "undefined" ? invT("force_hist_open_in_tab") : "ìƒˆ íƒ­ì—ì„œ ë³´ê¸°");
    var closeTxt = (typeof invT !== "undefined" ? invT("btn_close") : "ë‹«ê¸°");
    if (imgEl) { imgEl.src = url; imgEl.style.display = ""; imgEl.onerror = function() { imgEl.style.display = "none"; if (linkEl) linkEl.style.display = "inline-block"; }; }
    if (linkEl) { linkEl.href = url; linkEl.textContent = openInTabTxt; linkEl.style.display = "none"; }
    var closeBtn = document.getElementById("receivePhotoModalCloseBtn");
    if (closeBtn) closeBtn.textContent = closeTxt;
    if (modalEl && typeof bootstrap !== "undefined") {
      var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modalEl.addEventListener("hidden.bs.modal", function onHidden() {
        if (imgEl) imgEl.src = "";
        modalEl.removeEventListener("hidden.bs.modal", onHidden);
      }, { once: true });
      modal.show();
    } else if (modalEl && modalEl.classList) {
      modalEl.classList.add("show");
      modalEl.style.display = "block";
    }
  }

  function toggleAllOrderPrint(headerChk) {
    var list = document.getElementById("order-list");
    if (!list) return;
    list.querySelectorAll(".ord-invoice-chk").forEach(function(cb) { cb.checked = !!headerChk.checked; });
  }

  /** Delivery Note/Tax Invoice í•œ ê±´ HTML ìƒì„± (ì¸ì‡„ ì–‘ì‹). clientInfo=ê±°ë˜ì²˜ ì‹œíŠ¸ ë§¤ì¶œì²˜, isFirstPage=trueë©´ í˜ì´ì§€ ëŠê¸° ì—†ìŒ */
  function buildDeliveryNoteInvoiceHtml(order, companyInfo, clientInfo, isFirstPage) {
    var docNo = order.orderId || ("IV" + (order.date || "").replace(/\D/g, "").slice(0, 8) + String(order.row).padStart(2, "0")) || "IV-";
    var dateStr = (order.date || "").split(" ")[0] || new Date().toISOString().slice(0, 10);
    var d = dateStr.replace(/-/g, "/");
    if (d.length === 10) d = d.slice(5, 7) + "/" + d.slice(8, 10) + "/" + d.slice(0, 4);
    // totalBaht(=order.total)ëŠ” "VAT ì œì™¸ ê¸ˆì•¡(ì„¸ì „)" ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
    var totalBaht = Number(order.total) || 0;
    var exclVat = totalBaht;
    var vat7 = Math.round(exclVat * 0.07);
    var grandTotalInclVat = exclVat + vat7; /* Grand Total = VAT 7% í•©ì‚° ê¸ˆì•¡ */
    var discount = 0;
    var totalAfterDiscount = totalBaht;
    var companyName = (companyInfo && companyInfo.companyName) || "à¸šà¸£à¸´à¸©à¸±à¸— à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥ à¸ˆà¸³à¸à¸±à¸” (Head Office)";
    var address = (companyInfo && companyInfo.address) || "";
    var taxId = (companyInfo && companyInfo.taxId) || "";
    var phone = (companyInfo && companyInfo.phone) || "";
    var bankInfo = (companyInfo && companyInfo.bankInfo) || "à¸˜à¸™à¸²à¸„à¸²à¸£à¸à¸ªà¸´à¸à¸£à¹„à¸—à¸¢ à¹€à¸¥à¸‚à¸—à¸µà¹ˆ 166-2-97079-0 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸šà¸ˆà¸. à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥";
    var projectName = (companyInfo && companyInfo.projectName) || "CM True Digital Park";
    var clientName = (clientInfo && clientInfo.companyName) || order.store || "-";
    var clientAddr = (clientInfo && clientInfo.address) ? (clientInfo.address + "") : "";
    var clientTaxId = (clientInfo && clientInfo.taxId) ? (clientInfo.taxId + "") : "";
    var clientPhone = (clientInfo && clientInfo.phone) ? (clientInfo.phone + "") : "";

    var rows = "";
    (order.items || []).forEach(function(it, idx) {
      var amt = Math.round(Number(it.lineTotal) || 0);
      rows += "<tr><td class=\"text-center\">" + (idx + 1) + "</td><td>" + (it.name || "-") + "</td><td class=\"text-center\">" + (it.qty || 0) + "</td><td class=\"text-end\">" + Number(it.price || 0).toLocaleString() + "</td><td class=\"text-end\">0</td><td class=\"text-end\">" + amt.toLocaleString() + "</td></tr>";
    });

    var grandWords = "( " + grandTotalInclVat.toLocaleString() + " baht only )";
    var tableStyle = "width:100%; border-collapse: collapse; border: 1px solid #e2e8f0; margin: 8px 0;";
    var thStyle = "background: #0369a1; color: #fff; padding: 6px 8px; text-align: center; border: 1px solid #0369a1;";
    var pageBreak = isFirstPage ? "" : " page-break-before: always;";

    return "<div class=\"delivery-note-invoice\" style=\"max-width:210mm; margin:0 auto 24px; padding:16px; background:#fff; border:1px solid #e2e8f0; page-break-after:always;" + pageBreak + " font-family:'Noto Sans KR','Noto Sans Thai',sans-serif; font-size:12px; color:#0f172a;\">" +
      "<div style=\"display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;\">" +
        "<h2 style=\"margin:0; font-size:1.25rem;\">Delivery Note / Tax Invoice</h2>" +
        "<div style=\"text-align:right; font-size:11px;\">" +
          "<div>Copy (Set Document)</div>" +
          "<div><strong>Document No.:</strong> " + docNo + "</div>" +
          "<div><strong>Date:</strong> " + d + "</div>" +
          "<div><strong>Due Date:</strong> " + d + "</div>" +
          "<div><strong>Reference:</strong> " + (order.orderId || "-") + "</div>" +
          "<div><strong>Project Name:</strong> " + projectName + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">" +
        "<div style=\"flex:1; padding-left:5mm;\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">" + companyName + "</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + (address || "-") + "<br>Tax ID " + taxId + " | " + phone + "</div>" +
        "</div>" +
        "<div style=\"flex:1; padding-left:calc(16px + 5mm);\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">Client (ë§¤ì¶œì²˜)</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + clientName + (clientAddr ? "<br>" + clientAddr : "") + (clientTaxId || clientPhone ? "<br>Tax ID " + clientTaxId + (clientPhone ? " | " + clientPhone : "") : "") + "</div>" +
        "</div>" +
      "</div>" +
      "<table class=\"table table-bordered\" style=\"" + tableStyle + "\">" +
        "<thead><tr>" +
          "<th style=\"" + thStyle + "\">#</th>" +
          "<th style=\"" + thStyle + "\">Description</th>" +
          "<th style=\"" + thStyle + "\">Qty.</th>" +
          "<th style=\"" + thStyle + "\">U/P</th>" +
          "<th style=\"" + thStyle + "\">Disc.</th>" +
          "<th style=\"" + thStyle + "\">Amount</th>" +
        "</tr></thead><tbody>" + rows + "</tbody></table>" +
      "<div style=\"display:flex; justify-content:flex-end;\">" +
        "<div style=\"text-align:right; font-size:12px; min-width:200px;\">" +
          "<div>Total: " + exclVat.toLocaleString() + " THB</div>" +
          "<div>Discount: " + discount.toLocaleString() + " THB</div>" +
          "<div>Total after discount: " + totalAfterDiscount.toLocaleString() + " THB</div>" +
          "<div>VAT 7%: " + vat7.toLocaleString() + " THB</div>" +
          "<div>Total Excluding VAT: " + exclVat.toLocaleString() + " THB</div>" +
          "<div style=\"font-weight:700;\">Grand Total: " + grandTotalInclVat.toLocaleString() + " THB</div>" +
          "<div style=\"font-size:11px; margin-top:4px;\">" + grandWords + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"margin-top:16px; font-size:11px; color:#475569;\"><strong>Remarks:</strong> " + bankInfo + "</div>" +
      "<div style=\"margin-top:20px; display:flex; justify-content:space-between; font-size:11px;\">" +
        "<div><strong>" + clientName + "</strong><br>Received by ________________  Date ________________</div>" +
        "<div><strong>" + companyName.split(" ")[0] + "</strong><br>Approved by ________________  Date ________________</div>" +
      "</div>" +
    "</div>";
  }

  /** ì¸ë³´ì´ìŠ¤ ì¸ì‡„ ì‹œ ì™¼ìª½ì´ í•˜ì–—ê²Œ ê°€ë ¤ì§€ëŠ” í˜„ìƒ ë°©ì§€: ì˜ì—­ì„ body ì§ê³„ë¡œ ì˜®ê¹€ */
  function moveInvoicePrintAreaToBody() {
    var area = document.getElementById("invoice-print-area");
    if (!area || area.parentNode === document.body) return area;
    area._invoicePrintRestore = { parent: area.parentNode, next: area.nextSibling };
    document.body.appendChild(area);
    return area;
  }
  function restoreInvoicePrintArea(area) {
    if (!area || !area._invoicePrintRestore) return;
    var r = area._invoicePrintRestore;
    if (r.parent && r.parent !== document.body) r.parent.insertBefore(area, r.next);
    area._invoicePrintRestore = null;
  }

  function printOrderDeliveryNoteInvoice() {
    var list = document.getElementById("order-list");
    if (!list) { alert("ì£¼ë¬¸ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    var checkedRows = [];
    list.querySelectorAll("tr.ord-data-row").forEach(function(tr) {
      var chk = tr.querySelector(".ord-invoice-chk");
      if (chk && chk.checked) checkedRows.push(tr.getAttribute("data-row"));
    });
    if (checkedRows.length === 0) { alert("ì¸ì‡„í•  ì£¼ë¬¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. (ëª©ë¡ì—ì„œ ì²´í¬)"); return; }
    var ordersToPrint = (orderListCache || []).filter(function(o) { return checkedRows.indexOf(String(o.row)) !== -1; });
    if (ordersToPrint.length === 0) { alert("ì„ íƒí•œ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°íšŒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."); return; }

    google.script.run.withSuccessHandler(function(data) {
      var area = document.getElementById("invoice-print-area");
      if (!area) { alert("ì¸ë³´ì´ìŠ¤ ì¸ì‡„ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      area = moveInvoicePrintAreaToBody() || area;
      var companyInfo = (data && data.company) ? data.company : {};
      var clientsMap = (data && data.clients) ? data.clients : {};
      var html = "";
      ordersToPrint.forEach(function(o, idx) {
        var clientInfo = clientsMap[o.store] || { companyName: o.store || "-" };
        html += buildDeliveryNoteInvoiceHtml(o, companyInfo, clientInfo, idx === 0);
      });
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() {
        document.body.classList.remove("invoice-printing");
        area.classList.add("d-none");
        area.innerHTML = "";
        restoreInvoicePrintArea(area);
        window.onafterprint = null;
      };
      window.print();
    }).withFailureHandler(function(err) {
      var area = document.getElementById("invoice-print-area");
      if (!area) { window.print(); return; }
      area = moveInvoicePrintAreaToBody() || area;
      var companyInfo = {};
      var clientsMap = {};
      var html = "";
      ordersToPrint.forEach(function(o, idx) {
        var clientInfo = clientsMap[o.store] || { companyName: o.store || "-" };
        html += buildDeliveryNoteInvoiceHtml(o, companyInfo, clientInfo, idx === 0);
      });
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() {
        document.body.classList.remove("invoice-printing");
        area.classList.add("d-none");
        area.innerHTML = "";
        restoreInvoicePrintArea(area);
        window.onafterprint = null;
      };
      window.print();
    }).getInvoiceData();
  }

  /* =========================================================
     [ê¸°ëŠ¥ 4] ì…ê³  ë“±ë¡ ë° ë‚´ì—­
     ========================================================= */
  /* [ìˆ˜ì •ë¨] ì…ê³  ëª©ë¡ ë‹´ê¸° (ë§¤ì…ì²˜ í¬í•¨) */
function addInboundList() {
    // 1. í™”ë©´ì˜ ì…ë ¥ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    var dateVal = document.getElementById("i-date").value;
    var vendorVal = document.getElementById("i-vendor").value; // â˜… ë§¤ì…ì²˜ ê°’ ê°€ì ¸ì˜¤ê¸°
    var codeVal = document.getElementById("i-code").value;
    var nameVal = document.getElementById("i-name").value;
    var qtyVal = document.getElementById("i-qty").value;

    // 2. í•„ìˆ˜ ì…ë ¥ ì²´í¬
    if (!codeVal) return alert("í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!qtyVal) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!vendorVal) return alert("ë§¤ì…ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); // â˜… ë§¤ì…ì²˜ ì„ íƒ ê°•ì œ

    // 3. ëª©ë¡ì— ë‹´ê¸° (vendor ì†ì„± ì¶”ê°€)
    inboundList.push({
        date: dateVal,
        vendor: vendorVal, // â˜… ì—¬ê¸°ì— ë§¤ì…ì²˜ë¥¼ ê¼­ ë„£ì–´ì¤˜ì•¼ ì €ì¥ë©ë‹ˆë‹¤!
        code: codeVal,
        name: nameVal,
        qty: qtyVal
    });

    // 4. í™”ë©´ ê°±ì‹ 
    renderList("inbound-cart", inboundList);
    
    // 5. í¸ì˜ ê¸°ëŠ¥: ì…ë ¥ í›„ í’ˆëª©/ìˆ˜ëŸ‰ë§Œ ë¹„ìš°ê¸° (ë§¤ì…ì²˜ëŠ” ìœ ì§€)
    document.getElementById("i-name").value = "";
    document.getElementById("i-code").value = "";
    document.getElementById("i-qty").value = "";
    document.getElementById("i-name").focus(); // ë°”ë¡œ ë‹¤ìŒ í’ˆëª© ê²€ìƒ‰í•˜ë„ë¡ í¬ì»¤ìŠ¤ ì´ë™
}
  function saveInboundBatch(){ if(confirm("ì €ì¥?")) google.script.run.withSuccessHandler(r=>{alert(r);inboundList=[];renderList("inbound-cart",[]);}).registerInboundBatch(inboundList); }
/** ë§¤ì¥ ë¡œê·¸ì¸ ì‹œ ì…ê³  = ë³¸ì‚¬ì—ì„œ ë³´ë‚¸ ìˆ˜ë ¹ ë‚´ì—­ë§Œ í‘œì‹œ (ì‹ ê·œ ì…ê³  íƒ­ ìˆ¨ê¹€) */
function initInboundSection() {
  if (typeof isStoreLogin === "function" && isStoreLogin()) {
    var navNew = document.getElementById("in-nav-new");
    if (navNew) navNew.style.display = "none";
    showInTab("hist");
  }
}
/* [ìˆ˜ì •] ì…ê³  íƒ­ ì „í™˜ (ë²„íŠ¼ í™œì„±í™” ì¶”ê°€) */
function showInTab(t) { 
    // 1. í™”ë©´ ì „í™˜
    document.getElementById("in-tab-new").style.display = "none";
    document.getElementById("in-tab-hist").style.display = "none";
    document.getElementById("in-tab-" + t).style.display = "block";
    
    // 2. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active)
    document.getElementById("in-nav-new").classList.remove("active");
    document.getElementById("in-nav-hist").classList.remove("active");
    document.getElementById("in-nav-" + t).classList.add("active");

    // 3. ë°ì´í„° ë¡œë“œ (ë‚´ì—­ íƒ­ì¼ ë•Œë§Œ)
    if(t === 'hist') loadInboundHistory(); 
}

/* [ìˆ˜ì •ë¨] ì…ê³  ì €ì¥ ë²„íŠ¼ (ìˆ«ì ë³€í™˜ + ìƒˆë¡œê³ ì¹¨) */
function saveInboundBatch() {
    if (inboundList.length === 0) return alert("ì €ì¥í•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    if (!confirm("ì´ " + inboundList.length + "ê±´ì„ ì…ê³  ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    load(1);
    google.script.run.withSuccessHandler(function(res) {
        load(0);
        alert(res);
        // ì„±ê³µ ì‹œ ëª©ë¡ ë¹„ìš°ê³  ì´ˆê¸°í™”
        if(res.includes("âœ…") || res.includes("ì™„ë£Œ")) {
            inboundList = [];
            renderList("inbound-cart", []);
            // ì €ì¥ í›„ ë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™í•´ì„œ ë³´ì—¬ì¤„ê¹Œìš”? (ì„ íƒì‚¬í•­)
            // showInTab('hist'); 
        }
    }).registerInboundBatch(inboundList);
}
  
  /* [ìˆ˜ì •ë¨] ì…ê³  ë‚´ì—­ í™”ë©´ (ê¸ˆì•¡ ì—´ ì¶”ê°€ + ê¸°ê°„ ì´ì•¡ + ì›”ë³„ ê²€ìƒ‰) */
function loadInboundHistory() {
    var monthEl = document.getElementById("ih-month");
    var startEl = document.getElementById("ih-start");
    var endEl = document.getElementById("ih-end");
    if (monthEl && monthEl.value) {
        var y = parseInt(monthEl.value.substring(0, 4), 10);
        var m = parseInt(monthEl.value.substring(5, 7), 10);
        var first = new Date(y, m - 1, 1);
        var last = new Date(y, m, 0);
        var s1 = first.toISOString().substring(0, 10);
        var e1 = last.toISOString().substring(0, 10);
        if (startEl) startEl.value = s1;
        if (endEl) endEl.value = e1;
    }
    var s = startEl ? startEl.value : "";
    var e = endEl ? endEl.value : "";
    var v = document.getElementById("ih-vendor-selector").value;

    if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; if(startEl) startEl.value=t; if(endEl) endEl.value=t; }
    
    function renderInboundList(list) {
        load(0); 
        var b = document.getElementById("ih-list"); 
        var sumEl = document.getElementById("ih-total-summary");
        b.innerHTML = "";
        if(!list.length){ b.innerHTML="<tr><td colspan='5'>ë‚´ì—­ ì—†ìŒ</td></tr>"; if (sumEl) sumEl.textContent = "ê¸°ê°„ ì´ì•¡: 0 THB"; return; }
        var groups={}; 
        list.forEach(i=>{ var k=i.date+"_"+i.vendor; if(!groups[k]) groups[k]={date:i.date, vendor:i.vendor, totalQty:0, totalAmt:0, items:[]}; groups[k].items.push(i); groups[k].totalQty += Number(i.qty); groups[k].totalAmt += Number(i.amount || 0); });
        var periodTotalAmt = 0, idx=0;
        for(var k in groups){ var g=groups[k]; periodTotalAmt += g.totalAmt; var rid="ib-row-"+idx;
            b.innerHTML += "<tr style=\"cursor:pointer;\" onclick=\"toggleRow('"+rid+"')\"><td>"+g.date+"</td><td class=\"fw-bold\">"+g.vendor+"</td><td class=\"text-start ps-3\">â–¼ "+g.items[0].name+" ì™¸ "+(g.items.length-1)+"ê±´</td><td class=\"fw-bold\">"+g.totalQty.toLocaleString()+"</td><td class=\"fw-bold text-primary\">"+(g.totalAmt||0).toLocaleString()+"</td></tr>";
            var dets = g.items.map(i=>"<tr><td class=\"text-start ps-4\">"+i.name+"</td><td class=\"small text-muted\">"+(i.spec||'-')+"</td><td class=\"fw-bold\">"+Number(i.qty).toLocaleString()+"</td><td class=\"text-end pe-3\">"+Number(i.amount||0).toLocaleString()+"</td></tr>").join("");
            b.innerHTML += "<tr id=\""+rid+"\" style=\"display:none; background-color:#f8f9fa;\"><td colspan=\"5\"><table class=\"table table-sm table-bordered bg-white w-90 mx-auto mb-2\"><thead class=\"table-light\"><tr><th>í’ˆëª©</th><th>ê·œê²©</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr></thead><tbody>"+dets+"</tbody></table></td></tr>";
            idx++;
        }
        if (sumEl) sumEl.textContent = "ê¸°ê°„ ì´ì•¡: " + periodTotalAmt.toLocaleString() + " THB";
    }
    load(1);
    if (typeof isStoreLogin === "function" && isStoreLogin() && typeof userStore !== "undefined")
        google.script.run.withSuccessHandler(renderInboundList).getInboundForStore(userStore, s, e);
    else
        google.script.run.withSuccessHandler(renderInboundList).getInboundHistory(s, e, v);
}

  /* =========================================================
     [ê¸°ëŠ¥ 5] ì¶œê³  ë‚´ì—­ (ê°•ì œ+ì£¼ë¬¸ìŠ¹ì¸ í†µí•©). ë§¤ì¥ ë¡œê·¸ì¸ ì‹œ = ëª¨ë°”ì¼ ì‚¬ìš© ë‚´ì—­
     ========================================================= */
  function initForceSection() {
      if (typeof isStoreLogin === "function" && isStoreLogin()) {
          var navNew = document.getElementById("force-nav-new");
          var navOrder = document.getElementById("force-nav-order");
          if (navNew) navNew.style.display = "none";
          if (navOrder) navOrder.style.display = "none";
          showForceTab("hist");
          loadForceHistory();
          return;
      }
      google.script.run.withSuccessHandler(function(list) {
          var s = document.getElementById("f-store");
          var sh = document.getElementById("fh-vendor");
          s.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
          if(sh) sh.innerHTML = "<option value='All'>ì „ì²´ ë§¤ì¶œì²˜</option>";
          list.forEach(function(name) {
              s.add(new Option(name, name));
              if(sh) sh.add(new Option(name, name));
          });
      }).getAllOutboundTargets();
  }
  /* [ìˆ˜ì •] ì¶œê³  íƒ­ ì „í™˜ (ë²„íŠ¼ í™œì„±í™” ì¶”ê°€ + ë°œì£¼í˜„í™©ì¡°íšŒ íƒ­) */
function showForceTab(t) { 
    // 1. í™”ë©´ ì „í™˜
    document.getElementById("force-tab-new").style.display = "none";
    document.getElementById("force-tab-hist").style.display = "none";
    var orderTab = document.getElementById("force-tab-order");
    if (orderTab) orderTab.style.display = "none";
    var tabEl = document.getElementById("force-tab-" + t);
    if (tabEl) tabEl.style.display = "block";
    
    // 2. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active)
    document.getElementById("force-nav-new").classList.remove("active");
    document.getElementById("force-nav-hist").classList.remove("active");
    var navOrder = document.getElementById("force-nav-order");
    if (navOrder) navOrder.classList.remove("active");
    var navEl = document.getElementById("force-nav-" + t);
    if (navEl) navEl.classList.add("active");

    // 3. ë°ì´í„° ë¡œë“œ (ë‚´ì—­ íƒ­ì¼ ë•Œë§Œ)
    if(t === 'hist') loadForceHistory();
    if(t === 'order') {
      var os = document.getElementById("order-start");
      var oe = document.getElementById("order-end");
      if (os && !os.value) {
        var now = new Date();
        var first = new Date(now.getFullYear(), now.getMonth(), 1);
        os.value = first.toISOString().substring(0, 10);
      }
      if (oe && !oe.value) oe.value = new Date().toISOString().substring(0, 10);
      if (document.getElementById("order-vendor") && document.getElementById("order-vendor").options.length <= 1)
        loadOrderVendorOptions();
    }
}
/* [ìˆ˜ì •ë¨] ì¶œê³  ë‚´ì—­ í™”ë©´ (í‘œ í˜•íƒœ ì •ë ¬ + ë”ë¸” ë§ˆì´ë„ˆìŠ¤ í•´ê²° + ê¸°ê°„ ì´ì•¡ + ì›”ë³„ ê²€ìƒ‰) */
function loadForceHistory() {
    var monthEl = document.getElementById("fh-month");
    var startEl = document.getElementById("fh-start");
    var endEl = document.getElementById("fh-end");
    if (monthEl && monthEl.value) {
        var y = parseInt(monthEl.value.substring(0, 4), 10);
        var m = parseInt(monthEl.value.substring(5, 7), 10);
        var first = new Date(y, m - 1, 1);
        var last = new Date(y, m, 0);
        var s1 = first.toISOString().substring(0, 10);
        var e1 = last.toISOString().substring(0, 10);
        if (startEl) startEl.value = s1;
        if (endEl) endEl.value = e1;
    }
    var s = startEl ? startEl.value : "";
    var e = endEl ? endEl.value : "";
    var v = document.getElementById("fh-vendor").value;
    var t = document.getElementById("fh-type") ? document.getElementById("fh-type").value : "All";
    
    if(!s){ var today = new Date().toISOString().substring(0,10); s=today; e=today; if(startEl) startEl.value=today; if(endEl) endEl.value=today; }
    
    if (typeof isStoreLogin === "function" && isStoreLogin() && typeof userStore !== "undefined") {
        load(1);
        google.script.run.withSuccessHandler(function(list) {
            load(0);
            var b = document.getElementById("fh-list");
            var sumEl = document.getElementById("fh-total-summary");
            b.innerHTML = "";
            if (!list || list.length === 0) {
                b.innerHTML = "<tr><td colspan='10' class='text-center p-4 text-muted'>ë‚´ì—­ ì—†ìŒ</td></tr>";
                if (sumEl) sumEl.textContent = (typeof invT !== "undefined" ? invT("force_period_total") : "ê¸°ê°„ ì´ì•¡") + ": 0 THB";
                return;
            }
            var periodTotal = 0;
            list.forEach(function(i) {
                var deliveryDisplay = (i.dateTime && String(i.dateTime).trim()) ? i.dateTime : (i.date || "-");
                periodTotal += Number(i.amount) || 0;
                b.innerHTML += "<tr class=\"fh-data-row\">" +
                    "<td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input fh-invoice-chk\" checked></td>" +
                    "<td>" + (i.date || "-") + "</td>" +
                    "<td>" + deliveryDisplay + "</td>" +
                    "<td class=\"text-nowrap\">-</td>" +
                    "<td><span class=\"badge bg-secondary\">" + (typeof invT === "function" ? invT("type_force_out") : "ê°•ì œì¶œê³ ") + "</span></td>" +
                    "<td>-</td>" +
                    "<td class=\"fw-bold\">" + (userStore || "-") + "</td>" +
                    "<td class=\"text-start ps-3\">" + (i.item || "-") + "</td>" +
                    "<td class=\"fw-bold\">" + Number(i.qty).toLocaleString() + "</td>" +
                    "<td class=\"fw-bold text-primary\">" + Number(i.amount || 0).toLocaleString() + "</td>" +
                    "</tr>";
            });
            if (sumEl) sumEl.textContent = (typeof invT !== "undefined" ? invT("force_period_total") : "ê¸°ê°„ ì´ì•¡") + ": " + periodTotal.toLocaleString() + " THB (ì‚¬ìš© " + list.length + "ê±´)";
        }).getMyUsageHistory(userStore, s, e);
        return;
    }
    
    load(1);
    google.script.run.withSuccessHandler(function(list) {
        load(0); 
        var b = document.getElementById("fh-list"); 
        var sumEl = document.getElementById("fh-total-summary");
        b.innerHTML = "";
        
        if (!list || list.length === 0) { 
            b.innerHTML = "<tr><td colspan='10' class='text-center p-4 text-muted'>ë‚´ì—­ ì—†ìŒ</td></tr>"; 
            window.forceHistoryGroupsCache = [];
            if (sumEl) sumEl.textContent = (typeof invT !== "undefined" ? invT("force_period_total") : "ê¸°ê°„ ì´ì•¡") + ": 0 THB";
            return; 
        }
        
        var groups = {};
        list.forEach(item => {
            var key = item.date + "_" + item.target + "_" + item.type + (item.orderRowId ? "_" + item.orderRowId : "");
            if (!groups[key]) groups[key] = { 
                date: item.date, target: item.target, type: item.type, deliveryStatus: item.deliveryStatus || "",
                deliveryDate: item.deliveryDate || "",
                orderDate: item.orderDate || item.date,
                totalQty: 0, totalAmt: 0, items: [], invoiceNo: (item.invoiceNo && String(item.invoiceNo).trim()) ? String(item.invoiceNo).trim() : "",
                orderRowId: item.orderRowId || null
            };
            groups[key].items.push(item); 
            if (!groups[key].invoiceNo && item.invoiceNo) groups[key].invoiceNo = String(item.invoiceNo).trim();
            if (item.deliveryStatus) groups[key].deliveryStatus = item.deliveryStatus;
            if (item.deliveryDate) groups[key].deliveryDate = item.deliveryDate;
            if (item.orderDate) groups[key].orderDate = item.orderDate;
            if (item.receiveImageUrl) groups[key].receiveImageUrl = item.receiveImageUrl;
            if (item.receivedIndices) groups[key].receivedIndices = item.receivedIndices;
            if (item.totalOrderItems) groups[key].totalOrderItems = item.totalOrderItems;
            if (item.orderRowId != null) groups[key].orderRowId = item.orderRowId;
            groups[key].totalQty += Math.abs(Number(item.qty));
            groups[key].totalAmt += Math.abs(Number(item.amount));
        });

        var periodTotalAmt = 0;
        var groupList = [];
        window._receivePhotoUrlByIndex = window._receivePhotoUrlByIndex || {};
        var idx = 0;
        Object.keys(groups).sort().reverse().forEach(key => {
            var g = groups[key];
            periodTotalAmt += g.totalAmt;
            groupList.push(g);
            if (g.receiveImageUrl) window._receivePhotoUrlByIndex[idx] = g.receiveImageUrl;
            var typeLabel = (g.type === "Outbound") ? (typeof invT !== "undefined" ? invT("type_order_approval") : "ì£¼ë¬¸ìŠ¹ì¸") : (typeof invT !== "undefined" ? invT("type_force_out") : "ê°•ì œì¶œê³ ");
            var badgeClass = (g.type === "Force") ? "bg-danger" : "bg-success";
            var summary = (g.receivedIndices && g.receivedIndices.length > 0 && g.items.length > 0) ? g.items.map(function(it){ return it.name; }).join(", ") + " (" + g.items.length + "/" + (g.totalOrderItems || g.items.length) + ")" : (g.items[0].name + (g.items.length > 1 ? " ì™¸ " + (g.items.length - 1) + "ê±´" : ""));
            var rowId = "force-row-" + idx;
            var invDisplay = g.invoiceNo || "-";
            var statusLabel = (g.deliveryStatus === "ë°°ì†¡ì™„ë£Œ") ? (typeof invT !== "undefined" ? invT("status_delivered") : "ë°°ì†¡ì™„ë£Œ") : (g.deliveryStatus === "ì¼ë¶€ë°°ì†¡ì™„ë£Œ" || g.deliveryStatus === "ì¼ë¶€ ë°°ì†¡ ì™„ë£Œ") ? "ì¼ë¶€ë°°ì†¡ì™„ë£Œ" : (g.type === "Outbound" ? (typeof invT !== "undefined" ? invT("status_in_transit") : "ë°°ì†¡ì¤‘") : "-");
            var statusBadge = (g.deliveryStatus === "ë°°ì†¡ì™„ë£Œ") ? "bg-success" : (g.deliveryStatus === "ì¼ë¶€ë°°ì†¡ì™„ë£Œ" || g.deliveryStatus === "ì¼ë¶€ ë°°ì†¡ ì™„ë£Œ") ? "bg-warning text-dark" : (g.type === "Outbound" ? "bg-info" : "");
            var showPhotoBtn = (g.type === "Outbound" && (g.deliveryStatus === "ë°°ì†¡ì™„ë£Œ" || g.deliveryStatus === "ì¼ë¶€ë°°ì†¡ì™„ë£Œ" || g.deliveryStatus === "ì¼ë¶€ ë°°ì†¡ ì™„ë£Œ") && (g.receiveImageUrl || g.orderRowId));
            var photoBtn = "";
            if (showPhotoBtn) {
              photoBtn = "<button type=\"button\" class=\"btn btn-sm btn-outline-secondary ms-1\" title=\"" + (typeof invT !== "undefined" ? invT("force_hist_view_photo") : "ìˆ˜ë ¹ ì‚¬ì§„ ë³´ê¸°") + "\" onclick=\"event.stopPropagation(); openReceivePhotoModalByIndex(" + idx + ")\">ğŸ“·</button>";
            }
            
            var orderDateDisplay = (g.orderDate && String(g.orderDate).trim()) ? g.orderDate : (g.date || "-");
            var deliveryDateDisplay = (g.deliveryDate && String(g.deliveryDate).trim()) ? g.deliveryDate : "-";
            b.innerHTML += `
                <tr class="fh-data-row" style="cursor:pointer;" data-rowid="${rowId}" data-group-index="${idx}" data-invoice-no="${(g.invoiceNo || "").replace(/"/g, "&quot;")}">
                    <td class="text-center" onclick="event.stopPropagation()"><input type="checkbox" class="form-check-input fh-invoice-chk" checked title="ì¸ì‡„ í¬í•¨"></td>
                    <td onclick="toggleRow('${rowId}')">${orderDateDisplay}</td>
                    <td onclick="toggleRow('${rowId}')">${deliveryDateDisplay}</td>
                    <td class="text-nowrap" onclick="toggleRow('${rowId}')">${invDisplay}</td>
                    <td onclick="toggleRow('${rowId}')"><span class="badge ${badgeClass}">${typeLabel}</span></td>
                    <td onclick="toggleRow('${rowId}')"><span class="badge ${statusBadge}">${statusLabel}</span>${photoBtn}</td>
                    <td class="fw-bold" onclick="toggleRow('${rowId}')">${g.target}</td>
                    <td class="text-start ps-3" onclick="toggleRow('${rowId}')">â–¼ ${summary}</td>
                    <td class="fw-bold" onclick="toggleRow('${rowId}')">${g.totalQty.toLocaleString()}</td>
                    <td class="fw-bold text-primary" onclick="toggleRow('${rowId}')">${g.totalAmt.toLocaleString()}</td>
                </tr>`;
            
            var detailRows = g.items.map(i => {
                var absQty = Math.abs(Number(i.qty));
                var absAmt = Math.abs(Number(i.amount));
                return `
                    <tr>
                        <td class="text-start ps-4">${i.name}</td>
                        <td class="text-center text-muted small">${i.spec || '-'}</td>
                        <td class="text-end fw-bold">${absQty.toLocaleString()}</td>
                        <td class="text-end pe-3 text-muted">${absAmt.toLocaleString()}</td>
                    </tr>`;
            }).join("");
                
            b.innerHTML += `
                <tr id="${rowId}" class="fh-detail-row" style="display:none; background-color: #f8f9fa;">
                    <td colspan="10" class="p-0">
                        <div class="p-3">
                            <table class="table table-sm table-bordered bg-white mb-0" style="width: 95%; margin: 0 auto;">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th style="width: 40%;">í’ˆëª©ëª…</th>
                                        <th style="width: 20%;">ê·œê²©</th>
                                        <th style="width: 15%;">ìˆ˜ëŸ‰</th>
                                        <th style="width: 25%;">ê¸ˆì•¡</th>
                                    </tr>
                                </thead>
                                <tbody class="align-middle">
                                    ${detailRows}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>`;
            idx++;
        });
        window.forceHistoryGroupsCache = groupList;
        if (sumEl) sumEl.textContent = (typeof invT !== "undefined" ? invT("force_period_total") : "ê¸°ê°„ ì´ì•¡") + ": " + periodTotalAmt.toLocaleString() + " THB";
    }).getCombinedOutboundHistory(s, e, v, t);
}

  function filterForceHistoryByInvoice() {
    var q = (document.getElementById("fh-invoice-search") || {}).value ? String(document.getElementById("fh-invoice-search").value).trim().toLowerCase() : "";
    var tbody = document.getElementById("fh-list");
    if (!tbody) return;
    tbody.querySelectorAll("tr.fh-data-row").forEach(function(tr) {
      var inv = (tr.getAttribute("data-invoice-no") || "").toLowerCase();
      var show = !q || inv.indexOf(q) !== -1;
      tr.style.display = show ? "" : "none";
      var next = tr.nextElementSibling;
      if (next && next.classList.contains("fh-detail-row")) next.style.display = show ? "" : "none";
    });
  }

  /** ì¶œê³  ë‚´ì—­ ì¸ë³´ì´ìŠ¤ ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ/í•´ì œ */
  function toggleAllForceInvoiceChk(headerChk) {
    var list = document.getElementById("fh-list");
    if (!list) return;
    list.querySelectorAll(".fh-invoice-chk").forEach(function(cb) { cb.checked = !!headerChk.checked; });
  }

  /** ì¶œê³  ë‚´ì—­ ì¡°íšŒ ê²°ê³¼ë¥¼ ì—‘ì…€(CSV)ë¡œ ë‹¤ìš´ë¡œë“œ */
  function downloadForceHistoryExcel() {
    var tbody = document.getElementById("fh-list");
    if (!tbody) return;
    var table = tbody.closest("table");
    var thead = table ? table.querySelector("thead tr") : null;
    var headers = [];
    if (thead) {
      thead.querySelectorAll("th").forEach(function(th) {
        var t = (th.textContent || "").trim();
        if (th.querySelector("input[type=checkbox]")) t = "ì„ íƒ";
        headers.push(t);
      });
    } else {
      headers = ["ì£¼ë¬¸ ì¼ì", "ë°°ì†¡ ì¼ì", "ì¸ë³´ì´ìŠ¤ë²ˆí˜¸", "ìœ í˜•", "ìƒíƒœ", "ì¶œê³ ì²˜", "í’ˆëª©ëª…", "ìˆ˜ëŸ‰", "ê¸ˆì•¡"];
    }
    function csvEscape(s) {
      if (s == null) return "";
      var t = String(s).trim().replace(/\r?\n/g, " ");
      return t.indexOf(",") !== -1 || t.indexOf('"') !== -1 ? '"' + t.replace(/"/g, '""') + '"' : t;
    }
    var rows = [headers.map(csvEscape).join(",")];
    tbody.querySelectorAll("tr.fh-data-row").forEach(function(tr) {
      if (tr.style.display === "none") return;
      var cells = [];
      tr.querySelectorAll("td").forEach(function(td, i) {
        var chk = td.querySelector(".fh-invoice-chk");
        if (chk) cells.push(chk.checked ? "Y" : "N");
        else cells.push(td.textContent || "");
      });
      rows.push(cells.map(csvEscape).join(","));
    });
    var csv = "\uFEFF" + rows.join("\r\n");
    var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "outbound_history_" + new Date().toISOString().slice(0, 10) + ".csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /** ì…ê³  ë‚´ì—­ ì¡°íšŒ ê²°ê³¼ë¥¼ ì—‘ì…€(CSV)ë¡œ ë‹¤ìš´ë¡œë“œ */
  function downloadInboundHistoryExcel() {
    var tbody = document.getElementById("ih-list");
    if (!tbody) return;
    var table = tbody.closest("table");
    var thead = table ? table.querySelector("thead tr") : null;
    var headers = thead ? [] : ["ë‚ ì§œ", "ë§¤ì…ì²˜", "ë‚´ìš©", "ìˆ˜ëŸ‰", "ê¸ˆì•¡"];
    if (thead) thead.querySelectorAll("th").forEach(function(th) { headers.push((th.textContent || "").trim()); });
    function csvEscape(s) {
      if (s == null) return "";
      var t = String(s).trim().replace(/\r?\n/g, " ");
      return t.indexOf(",") !== -1 || t.indexOf('"') !== -1 ? '"' + t.replace(/"/g, '""') + '"' : t;
    }
    var rows = [headers.map(csvEscape).join(",")];
    tbody.querySelectorAll("tr").forEach(function(tr) {
      if (tr.style.display === "none") return;
      if (tr.querySelector("td[colspan]")) return;
      var cells = [];
      tr.querySelectorAll("td").forEach(function(td) { cells.push(td.textContent || ""); });
      if (cells.length) rows.push(cells.map(csvEscape).join(","));
    });
    var csv = "\uFEFF" + rows.join("\r\n");
    var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "inbound_history_" + new Date().toISOString().slice(0, 10) + ".csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /** ì¸ë³´ì´ìŠ¤ ì¸ì‡„ìš© í˜„ì¬ ì–¸ì–´ ë¼ë²¨ (ì„ íƒ ì–¸ì–´ì— ë”°ë¼ ì¸ì‡„) */
  function invT(key) {
    var L = (typeof currentLang !== "undefined" ? currentLang : "ko");
    return (typeof I18N !== "undefined" && I18N[L] && I18N[L][key]) ? I18N[L][key] : key;
  }

  /** ì¶œê³  ë‚´ì—­ ê·¸ë£¹ í•œ ê±´ì„ Delivery Note/Tax Invoice HTMLë¡œ ìƒì„± (ë³¸ì‚¬=ì„¤ì • ì •ë³´, ë§¤ì¶œì²˜=ê±°ë˜ì²˜ Dì—´Â·Fì—´, ì„ íƒ ì–¸ì–´ ì ìš©) */
  function buildForceDeliveryNoteInvoiceHtml(group, companyInfo, clientInfo, isFirstPage) {
    var docNo = (group.invoiceNo && String(group.invoiceNo).trim()) ? group.invoiceNo : ("IV-" + (group.date || "").replace(/\D/g, ""));
    var dateStr = (group.date || "").split(" ")[0] || new Date().toISOString().slice(0, 10);
    var d = dateStr.replace(/-/g, "/");
    if (d.length === 10) d = d.slice(5, 7) + "/" + d.slice(8, 10) + "/" + d.slice(0, 4);
    // totalBaht(=group.totalAmt)ëŠ” "VAT ì œì™¸ ê¸ˆì•¡(ì„¸ì „)" ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
    var totalBaht = Math.round(Math.abs(Number(group.totalAmt) || 0));
    var exclVat = totalBaht;
    var vat7 = Math.round(exclVat * 0.07);
    var grandTotalInclVat = exclVat + vat7; /* Grand Total = VAT 7% í•©ì‚° ê¸ˆì•¡ */
    var companyName = (companyInfo && companyInfo.companyName) || "à¸šà¸£à¸´à¸©à¸±à¸— à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥ à¸ˆà¸³à¸à¸±à¸” (Head Office)";
    var address = (companyInfo && companyInfo.address) || "";
    var taxId = (companyInfo && companyInfo.taxId) || "";
    var phone = (companyInfo && companyInfo.phone) || "";
    var bankInfo = (companyInfo && companyInfo.bankInfo) || "à¸˜à¸™à¸²à¸„à¸²à¸£à¸à¸ªà¸´à¸à¸£à¹„à¸—à¸¢ à¹€à¸¥à¸‚à¸—à¸µà¹ˆ 166-2-97079-0 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸šà¸ˆà¸. à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥";
    var clientName = (clientInfo && clientInfo.companyName) || group.target || "-";
    var clientAddr = (clientInfo && clientInfo.address) ? String(clientInfo.address).trim() : "";
    var clientTaxId = (clientInfo && clientInfo.taxId) ? String(clientInfo.taxId).trim() : "";
    var clientPhone = (clientInfo && clientInfo.phone) ? String(clientInfo.phone).trim() : "";
    var rows = "";
    (group.items || []).forEach(function(it, idx) {
      var amt = Math.round(Math.abs(Number(it.amount) || 0));
      var qty = Math.abs(Number(it.qty) || 0);
      var price = (it.spec && Number(it.amount) && qty) ? (Math.abs(Number(it.amount)) / qty) : 0;
      rows += "<tr><td class=\"text-center\">" + (idx + 1) + "</td><td>" + (it.name || "-") + (it.spec ? " " + it.spec : "") + "</td><td class=\"text-center\">" + qty + "</td><td class=\"text-end\">" + Number(price).toLocaleString() + "</td><td class=\"text-end\">0</td><td class=\"text-end\">" + amt.toLocaleString() + "</td></tr>";
    });
    var grandWords = "( " + grandTotalInclVat.toLocaleString() + " " + invT("inv_baht_only") + " )";
    var tableStyle = "width:100%; border-collapse: collapse; border: 1px solid #e2e8f0; margin: 8px 0;";
    var thStyle = "background: #0369a1; color: #fff; padding: 6px 8px; text-align: center; border: 1px solid #0369a1;";
    var pageBreak = isFirstPage ? "" : " page-break-before: always;";
    return "<div class=\"delivery-note-invoice\" style=\"max-width:210mm; margin:0 auto 24px; padding:16px; background:#fff; border:1px solid #e2e8f0; page-break-after:always;" + pageBreak + " font-family:'Noto Sans KR','Noto Sans Thai',sans-serif; font-size:12px; color:#0f172a;\">" +
      "<div style=\"display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;\">" +
        "<h2 style=\"margin:0; font-size:1.25rem;\">" + invT("inv_title") + "</h2>" +
        "<div style=\"text-align:right; font-size:11px;\">" +
          "<div>" + invT("inv_original_doc") + "</div>" +
          "<div><strong>" + invT("inv_doc_no") + ":</strong> " + docNo + "</div>" +
          "<div><strong>" + invT("inv_date") + ":</strong> " + d + "</div>" +
          "<div><strong>" + invT("inv_due_date") + ":</strong> " + d + "</div>" +
          "<div><strong>" + invT("inv_reference") + ":</strong> " + (group.invoiceNo || "-") + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">" +
        "<div style=\"flex:1; padding-left:5mm;\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">" + companyName + "</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + (address || "-") + "<br>" + invT("inv_tax_id") + " " + taxId + " | " + phone + "</div>" +
        "</div>" +
        "<div style=\"flex:1; padding-left:calc(16px + 5mm);\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">" + invT("inv_client") + "</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + clientName +
          (clientTaxId ? "<br>" + invT("inv_tax_id") + ": " + clientTaxId : "") +
          (clientAddr ? "<br>" + invT("inv_address") + ": " + clientAddr : "") +
          (clientPhone ? "<br>" + invT("inv_phone") + ": " + clientPhone : "") + "</div>" +
        "</div>" +
      "</div>" +
      "<table class=\"table table-bordered\" style=\"" + tableStyle + "\">" +
        "<thead><tr>" +
          "<th style=\"" + thStyle + "\">#</th>" +
          "<th style=\"" + thStyle + "\">" + invT("inv_description") + "</th>" +
          "<th style=\"" + thStyle + "\">Qty.</th>" +
          "<th style=\"" + thStyle + "\">U/P</th>" +
          "<th style=\"" + thStyle + "\">Disc.</th>" +
          "<th style=\"" + thStyle + "\">" + invT("inv_amount") + "</th>" +
        "</tr></thead><tbody>" + rows + "</tbody></table>" +
      "<div style=\"display:flex; justify-content:flex-end;\">" +
        "<div style=\"text-align:right; font-size:12px; min-width:200px;\">" +
          "<div>" + invT("inv_total") + ": " + exclVat.toLocaleString() + " THB</div>" +
          "<div>" + invT("inv_vat7") + ": " + vat7.toLocaleString() + " THB</div>" +
          "<div style=\"font-weight:700;\">" + invT("inv_grand_total") + ": " + grandTotalInclVat.toLocaleString() + " THB</div>" +
          "<div style=\"font-size:11px; margin-top:4px;\">" + grandWords + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"margin-top:16px; font-size:11px; color:#475569;\"><strong>" + invT("inv_remarks") + ":</strong> " + bankInfo + "</div>" +
      "<div style=\"margin-top:20px; display:flex; justify-content:space-between; font-size:11px;\">" +
        "<div><strong>" + clientName + "</strong><br>" + invT("inv_received_by") + " ________________  " + invT("inv_date") + " ________________</div>" +
        "<div><strong>" + companyName.split(" ")[0] + "</strong><br>" + invT("inv_approved_by") + " ________________  " + invT("inv_date") + " ________________</div>" +
      "</div>" +
    "</div>";
  }

  function printForceHistoryInvoice() {
    var list = document.getElementById("fh-list");
    if (!list) { alert("ì¶œê³  ë‚´ì—­ì„ ë¨¼ì € ì¡°íšŒí•œ ë’¤ ì¸ë³´ì´ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    var checked = [];
    list.querySelectorAll("tr.fh-data-row").forEach(function(tr) {
      var chk = tr.querySelector(".fh-invoice-chk");
      if (chk && chk.checked) {
        var idx = parseInt(tr.getAttribute("data-group-index"), 10);
        if (!isNaN(idx) && window.forceHistoryGroupsCache && window.forceHistoryGroupsCache[idx]) checked.push(window.forceHistoryGroupsCache[idx]);
      }
    });
    if (checked.length === 0) { alert("ì¸ì‡„í•  ì¶œê³  ë‚´ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. (ëª©ë¡ì—ì„œ ì²´í¬)"); return; }
    var area = document.getElementById("invoice-print-area");
    if (!area) { alert("ì¸ë³´ì´ìŠ¤ ì¸ì‡„ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    google.script.run.withSuccessHandler(function(data) {
      area = moveInvoicePrintAreaToBody() || area;
      var companyInfo = (data && data.company) ? data.company : {};
      var clientsMap = (data && data.clients) ? data.clients : {};
      var html = "";
      var prevTarget = null;
      checked.forEach(function(g, idx) {
        var isFirstPage = (idx === 0 || g.target === prevTarget);
        prevTarget = g.target;
        var clientInfo = clientsMap[g.target] || { companyName: g.target || "-" };
        html += buildForceDeliveryNoteInvoiceHtml(g, companyInfo, clientInfo, isFirstPage);
      });
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() { document.body.classList.remove("invoice-printing"); area.classList.add("d-none"); area.innerHTML = ""; restoreInvoicePrintArea(area); window.onafterprint = null; };
      window.print();
    }).withFailureHandler(function() {
      area = moveInvoicePrintAreaToBody() || area;
      var html = "";
      var prevTarget = null;
      checked.forEach(function(g, idx) {
        var isFirstPage = (idx === 0 || g.target === prevTarget);
        prevTarget = g.target;
        html += buildForceDeliveryNoteInvoiceHtml(g, {}, { companyName: g.target || "-" }, isFirstPage);
      });
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() { document.body.classList.remove("invoice-printing"); area.classList.add("d-none"); area.innerHTML = ""; restoreInvoicePrintArea(area); window.onafterprint = null; };
      window.print();
    }).getInvoiceData();
  }

  function addForceList() { 
      var st = document.getElementById("f-store").value, cd = document.getElementById("f-code").value, nm = document.getElementById("f-name").value, qt = document.getElementById("f-qty").value, dt = document.getElementById("f-date").value, ddt = document.getElementById("f-delivery-date");
      if(!st || !cd || !qt) return alert("í•„ìˆ˜ í•­ëª© ì…ë ¥");
      var deliveryDateVal = (ddt && ddt.value) ? ddt.value : "";
      forceList.push({ date: dt, deliveryDate: deliveryDateVal, store: st, code: cd, name: nm, qty: qt }); renderList("force-cart", forceList); 
      document.getElementById("f-name").value = ""; document.getElementById("f-code").value = ""; document.getElementById("f-qty").value = "";
  }
  function saveForceBatch() { if(confirm("ì¶œê³  í™•ì •?")){ load(1); google.script.run.withSuccessHandler(r=>{load(0);alert(r);forceList=[];renderList("force-cart",[]);}).forceOutboundBatch(forceList); } }

/* [ìˆ˜ì • 2] ì¶œê³ ì²˜(ë§¤ì¶œì²˜) ëª©ë¡ ì±„ìš°ê¸° í•¨ìˆ˜ */
function loadOutboundDropdowns() {
    // ë¡œë”© í‘œì‹œ (ì„ íƒí•˜ì„¸ìš” ëŒ€ì‹  'ë¡œë”©ì¤‘...' í‘œì‹œ)
    var fStore = document.getElementById("f-store");
    if(fStore) fStore.innerHTML = "<option>ë¡œë”© ì¤‘...</option>";

    google.script.run.withSuccessHandler(function(list) {
        console.log("ê°€ì ¸ì˜¨ ë§¤ì¶œì²˜ ëª©ë¡:", list); // F12 ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥

        // 1. ì¶œê³  ì…ë ¥ íƒ­ (#f-store)
        if (fStore) {
            fStore.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
            list.forEach(function(v) {
                fStore.add(new Option(v, v));
            });
        }

        // 2. ë‚´ì—­ ì¡°íšŒ íƒ­ (#fh-vendor)
        var fhVendor = document.getElementById("fh-vendor");
        if (fhVendor) {
            var allOutTxt = (typeof invT === "function" && invT("force_all_outbound")) ? invT("force_all_outbound") : "ì „ì²´ ì¶œê³ ì²˜";
            fhVendor.innerHTML = "<option value='All'>" + allOutTxt + "</option>";
            list.forEach(function(v) {
                fhVendor.add(new Option(v, v));
            });
        }
    }).getVendorNamesByType("ë§¤ì¶œì²˜"); // ì„œë²„ì— "ë§¤ì¶œì²˜" ë‹¬ë¼ê³  ìš”ì²­
}

/** ë°œì£¼í˜„í™©ì¡°íšŒ íƒ­: ë§¤ì…ì²˜ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° */
function loadOrderVendorOptions() {
  var sel = document.getElementById("order-vendor");
  if (!sel) return;
  sel.innerHTML = "<option value='All'>" + (typeof invT === "function" ? invT("label_all") : "ì „ì²´") + "</option>";
  google.script.run.withSuccessHandler(function(list) {
    if (!sel) return;
    (list || []).forEach(function(v) { sel.add(new Option(v, v)); });
  }).getVendorNamesByType("ë§¤ì…ì²˜");
}

/** ë°œì£¼í˜„í™©ì¡°íšŒ: ê¸°ê°„/ê±°ë˜ì²˜/í’ˆëª© í•„í„°ë¡œ ì§‘ê³„ ì¡°íšŒ */
function loadOrderSummary() {
  var startEl = document.getElementById("order-start");
  var endEl = document.getElementById("order-end");
  var viewBy = document.getElementById("order-view-by") ? document.getElementById("order-view-by").value : "vendor";
  var vendorFilter = document.getElementById("order-vendor") ? document.getElementById("order-vendor").value : "All";
  var itemFilter = document.getElementById("order-item-filter") ? document.getElementById("order-item-filter").value.trim() : "";
  var startStr = startEl && startEl.value ? startEl.value : "";
  var endStr = endEl && endEl.value ? endEl.value : "";
  if (!startStr || !endStr) {
    alert(typeof invT === "function" ? invT("mgr_prompt_date") : "ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
    return;
  }
  if (typeof load === "function") load(1);
  google.script.run.withSuccessHandler(function(res) {
    if (typeof load === "function") load(0);
    window.orderSummaryCache = res;
    renderOrderSummary(res, viewBy);
  }).withFailureHandler(function() {
    if (typeof load === "function") load(0);
    document.getElementById("order-by-vendor-table-wrap").style.display = "none";
    document.getElementById("order-by-item-table-wrap").style.display = "none";
    var empty = document.getElementById("order-summary-empty");
    if (empty) { empty.style.display = "block"; empty.textContent = (typeof invT === "function" ? invT("mgr_no_data") : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
  }).getOrderSummaryForPurchase(startStr, endStr, viewBy, vendorFilter, itemFilter || null);
}

function renderOrderSummary(res, viewBy) {
  var byVendorWrap = document.getElementById("order-by-vendor-table-wrap");
  var byItemWrap = document.getElementById("order-by-item-table-wrap");
  var byVendorBody = document.getElementById("order-by-vendor-body");
  var byItemBody = document.getElementById("order-by-item-body");
  var emptyEl = document.getElementById("order-summary-empty");
  if (!byVendorWrap || !byItemWrap) return;
  byVendorWrap.style.display = "none";
  byItemWrap.style.display = "none";
  if (emptyEl) emptyEl.style.display = "none";
  byVendorBody.innerHTML = "";
  byItemBody.innerHTML = "";
  var isVendor = (viewBy === "vendor");
  if (isVendor && res.byVendor && res.byVendor.length > 0) {
    byVendorWrap.style.display = "block";
    res.byVendor.forEach(function(g) {
      var items = g.items || [];
      items.forEach(function(it, i) {
        var tr = document.createElement("tr");
        var code = (it.code || "").replace(/</g, "&lt;");
        var name = (it.name || "").replace(/</g, "&lt;");
        var spec = (it.spec || "-").replace(/</g, "&lt;");
        var qty = Number(it.qty) || 0;
        if (i === 0) {
          tr.innerHTML = "<td class=\"align-middle fw-bold\" rowspan=\"" + items.length + "\">" + (g.vendor || "-").replace(/</g, "&lt;") + "</td><td>" + code + "</td><td>" + name + "</td><td>" + spec + "</td><td class=\"text-end\">" + qty + "</td>";
        } else {
          tr.innerHTML = "<td>" + code + "</td><td>" + name + "</td><td>" + spec + "</td><td class=\"text-end\">" + qty + "</td>";
        }
        byVendorBody.appendChild(tr);
      });
    });
  } else if (!isVendor && res.byItem && res.byItem.length > 0) {
    byItemWrap.style.display = "block";
    res.byItem.forEach(function(it) {
      var tr = document.createElement("tr");
      tr.innerHTML = "<td>" + (it.code || "").replace(/</g, "&lt;") + "</td><td>" + (it.name || "").replace(/</g, "&lt;") + "</td><td>" + (it.vendor || "-").replace(/</g, "&lt;") + "</td><td>" + (it.spec || "-").replace(/</g, "&lt;") + "</td><td class=\"text-end\">" + (Number(it.qty) || 0) + "</td>";
      byItemBody.appendChild(tr);
    });
  } else {
    if (emptyEl) { emptyEl.style.display = "block"; emptyEl.textContent = (typeof invT === "function" ? invT("order_no_data") : "ì¡°íšŒ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); }
  }
}

/** ë°œì£¼í˜„í™© ì¸ì‡„ (ì¡°íšŒ ê²°ê³¼ ì˜ì—­ë§Œ) */
function printOrderSummary() {
  var res = window.orderSummaryCache;
  if (!res) {
    alert((typeof invT === "function" ? invT("order_no_data") : "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒí•´ ì£¼ì„¸ìš”."));
    return;
  }
  var viewBy = document.getElementById("order-view-by") ? document.getElementById("order-view-by").value : "vendor";
  var area = document.getElementById("order-summary-result");
  if (!area) return;
  var title = document.createElement("div");
  title.className = "mb-2 fw-bold";
  title.setAttribute("data-i18n", "tab_order_status");
  title.textContent = (typeof invT === "function" ? invT("tab_order_status") : "ë°œì£¼í˜„í™©ì¡°íšŒ") + " (" + (res.period && res.period.start ? res.period.start : "") + " ~ " + (res.period && res.period.end ? res.period.end : "") + ")";
  var clone = area.cloneNode(true);
  var wrap = document.createElement("div");
  wrap.className = "p-3";
  wrap.appendChild(title);
  wrap.appendChild(clone);
  wrap.style.background = "#fff";
  document.body.appendChild(wrap);
  var beforePrint = function() { document.body.classList.add("invoice-printing"); };
  var afterPrint = function() { document.body.classList.remove("invoice-printing"); if (wrap.parentNode) wrap.parentNode.removeChild(wrap); };
  window.onafterprint = afterPrint;
  window.print();
}

/** ë°œì£¼í˜„í™© ì¡°íšŒ ê²°ê³¼ë§Œ ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ */
function downloadOrderSummaryExcel() {
  var res = window.orderSummaryCache;
  if (!res) {
    alert((typeof invT === "function" ? invT("order_no_data") : "ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒí•´ ì£¼ì„¸ìš”."));
    return;
  }
  var viewBy = document.getElementById("order-view-by") ? document.getElementById("order-view-by").value : "vendor";
  var headerVendor = (typeof invT === "function" ? invT("order_vendor") : "ê±°ë˜ì²˜");
  var headerCode = (typeof invT === "function" ? invT("item_col_code") : "ì½”ë“œ");
  var headerName = (typeof invT === "function" ? invT("force_col_item") : "í’ˆëª©ëª…");
  var headerSpec = (typeof invT === "function" ? invT("item_spec") : "ê·œê²©");
  var headerQty = (typeof invT === "function" ? invT("force_col_qty") : "ìˆ˜ëŸ‰");

  function escapeCsv(s) {
    var t = String(s == null ? "" : s);
    if (t.indexOf(",") !== -1 || t.indexOf('"') !== -1 || t.indexOf("\n") !== -1 || t.indexOf("\r") !== -1)
      return '"' + t.replace(/"/g, '""') + '"';
    return t;
  }

  var periodLabel = (typeof invT === "function" ? invT("label_period") : "ê¸°ê°„");
  var start = (res.period && res.period.start) ? res.period.start : "";
  var end = (res.period && res.period.end) ? res.period.end : "";
  var titleLabel = (typeof invT === "function" ? invT("tab_order_status") : "ë°œì£¼í˜„í™©ì¡°íšŒ");

  var rows = [];
  rows.push([titleLabel]);
  rows.push([periodLabel + ": " + start + " ~ " + end]);
  rows.push([]);
  if (viewBy === "vendor" && res.byVendor && res.byVendor.length > 0) {
    rows.push([headerVendor, headerCode, headerName, headerSpec, headerQty]);
    res.byVendor.forEach(function(g) {
      (g.items || []).forEach(function(it) {
        rows.push([g.vendor || "", it.code || "", it.name || "", it.spec || "", Number(it.qty) || 0]);
      });
    });
  } else if (res.byItem && res.byItem.length > 0) {
    rows.push([headerCode, headerName, headerVendor, headerSpec, headerQty]);
    res.byItem.forEach(function(it) {
      rows.push([it.code || "", it.name || "", it.vendor || "", it.spec || "", Number(it.qty) || 0]);
    });
  }
  if (rows.length <= 1) {
    alert((typeof invT === "function" ? invT("order_no_data") : "ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
    return;
  }
  var csv = "\uFEFF" + rows.map(function(r) { return r.map(escapeCsv).join(","); }).join("\r\n");
  var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  var start = (res.period && res.period.start) ? res.period.start : new Date().toISOString().slice(0, 10);
  var end = (res.period && res.period.end) ? res.period.end : start;
  a.download = "order_summary_" + start + "_" + end + ".csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

/* [ë³µêµ¬] ë§¤ì…ì²˜ ëª©ë¡ ì±„ìš°ê¸° (ì…ê³  ë“±ë¡ + í’ˆëª© ê´€ë¦¬ìš©) */
function loadVendorDropdowns() {
    // ë¡œë”© í‘œì‹œ
    var iVendor = document.getElementById("i-vendor");
    if(iVendor) iVendor.innerHTML = "<option>ë¡œë”© ì¤‘...</option>";

    google.script.run.withSuccessHandler(function(list) {
        console.log("ê°€ì ¸ì˜¨ ë§¤ì…ì²˜ ëª©ë¡:", list); // í™•ì¸ìš© ë¡œê·¸

        // 1. ì…ê³  ë“±ë¡ í™”ë©´ (#i-vendor)
        if(iVendor) {
            iVendor.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
            list.forEach(function(v) { iVendor.add(new Option(v, v)); });
        }
        
        // â˜… ë§¤ë‹ˆì € ë¡œê·¸ì¸ ì‹œ ì…ê³  ê´€ë¦¬ì—ì„œ ë³¸ì‚¬ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ "ë³¸ì‚¬" ì¶”ê°€ (í‘œì‹œëŠ” ë‹¤êµ­ì–´)
        var vendorList = list || [];
        if (typeof userRole !== "undefined" && userRole === "manager" && vendorList.indexOf("ë³¸ì‚¬") === -1) vendorList = ["ë³¸ì‚¬"].concat(vendorList);
        var hqLabel = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].in_vendor_hq) ? I18N[currentLang].in_vendor_hq : "ë³¸ì‚¬";
        function vendorDisplayName(v) { return (v === "ë³¸ì‚¬") ? hqLabel : v; }

        // 2. ì…ê³  ë‚´ì—­ ì¡°íšŒ í™”ë©´ (#ih-vendor-selector)
        var ihVendor = document.getElementById("ih-vendor-selector");
        if(ihVendor) {
            ihVendor.innerHTML = "<option value='All'>" + (typeof invT === "function" ? invT("in_vendor_all") : "ì „ì²´ ë§¤ì…ì²˜") + "</option>";
            vendorList.forEach(function(v) { ihVendor.add(new Option(vendorDisplayName(v), v)); });
        }

        // 3. í’ˆëª© ê´€ë¦¬ í™”ë©´ ìë™ì™„ì„± (#vendor-options) + ì…ê³  ì‹ ê·œ ë“±ë¡ìš© (#in-vendor ë“±)
        var itmVendorList = document.getElementById("vendor-options");
        if(itmVendorList) {
            itmVendorList.innerHTML = ""; 
            vendorList.forEach(function(v) {
                var op = document.createElement("option");
                op.value = v;
                op.textContent = vendorDisplayName(v);
                itmVendorList.appendChild(op);
            });
        }
        var iVendor = document.getElementById("i-vendor");
        if(iVendor) {
            iVendor.innerHTML = "";
            vendorList.forEach(function(v) { iVendor.add(new Option(vendorDisplayName(v), v)); });
        }
    }).getVendorNamesByType("ë§¤ì…ì²˜"); // â˜… ì„œë²„ì— "ë§¤ì…ì²˜" ìš”ì²­ (ì¶œê³ ëŠ” "ë§¤ì¶œì²˜")
}

function loadStoreOptions(elementId) {
    var select = document.getElementById(elementId);
    if (!select) return;
    if (select.classList.contains('loaded')) return;

    // ì„¤ì • > ë©”ë‰´ë³„ ê¶Œí•œ: ì§ì› ëª©ë¡ê³¼ ë§¤ì¹­ë˜ë„ë¡ ì§ì›ì •ë³´ ì‹œíŠ¸ ê¸°ì¤€ ë§¤ì¥ ëª©ë¡ ì‚¬ìš©
    if (elementId === 'perm-store') {
        loadPermStoreOptions();
        return;
    }
    if (elementId === 'py-history-store') {
        var role = (typeof userRole !== "undefined") ? userRole : "";
        google.script.run.withSuccessHandler(function(list) {
            select.innerHTML = "";
            var allText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].label_all) ? I18N[currentLang].label_all : "ì „ì²´";
            select.add(new Option(allText, "All"));
            (list || []).forEach(function(s) { select.add(new Option(s, s)); });
            select.classList.add('loaded');
        }).getPayrollStoreList(role);
        return;
    }
    if (elementId === 'att-store-filter' || elementId === 'att-today-store' || elementId === 'view-store-select') {
        google.script.run.withSuccessHandler(function(list) {
            select.innerHTML = "";
            var isManager = (typeof userRole !== "undefined") ? userRole === "manager" : false;
            var managerStoreOnly = (typeof userStore !== "undefined") ? userStore : "";
            var restrictStores = isManager && managerStoreOnly;
            var listToUse = restrictStores ? [managerStoreOnly] : (list || []);
            var allStoresText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
            var attAllStores = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].att_all_stores) ? I18N[currentLang].att_all_stores : allStoresText;
            if (!restrictStores && (elementId.includes('filter') || elementId === 'att-today-store' || elementId === 'view-store-select')) {
                select.add(new Option(elementId === 'att-today-store' ? attAllStores : allStoresText, "All"));
            } else if (!restrictStores) {
                var selectPhText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_select_ph) ? I18N[currentLang].store_select_ph : "ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”";
                select.add(new Option(selectPhText, ""));
            }
            listToUse.forEach(function(s) { select.add(new Option(s, s)); });
            if (restrictStores && listToUse.length > 0) { select.value = userStore; select.disabled = true; }
            select.classList.add('loaded');
        }).getScheduleStoreList();
        return;
    }
    if (elementId === 'eval-store' || elementId === 'eval-list-store') {
        var role = (typeof userRole !== "undefined") ? userRole : "";
        google.script.run.withSuccessHandler(function(list) {
            select.innerHTML = "";
            var isManager = (typeof userRole !== "undefined") ? userRole === "manager" : false;
            var managerStoreOnly = (typeof userStore !== "undefined") ? userStore : "";
            var restrictStores = isManager && managerStoreOnly;
            var listToUse = restrictStores ? [managerStoreOnly] : (list || []);
            var allStoresText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
            var selectPhText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_select_ph) ? I18N[currentLang].store_select_ph : "ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”";
            if (!restrictStores && elementId === 'eval-list-store') select.add(new Option(allStoresText, "All"));
            else if (!restrictStores) select.add(new Option(selectPhText, ""));
            listToUse.forEach(function(s) { select.add(new Option(s, s)); });
            if (restrictStores && listToUse.length > 0) { select.value = userStore; select.disabled = true; }
            select.classList.add('loaded');
        }).getPayrollStoreList(role);
        return;
    }

    var role = (typeof userRole !== "undefined") ? userRole : "";
    google.script.run.withSuccessHandler(function(list) {
        select.innerHTML = "";
        var isManager = (typeof userRole !== "undefined") && userRole === "manager";
        var managerStoreOnly = (typeof userStore !== "undefined") && userStore;
        var restrictStores = (isManager && managerStoreOnly && (elementId === "sch-store-select" || elementId === "complaint-store" || elementId === "complaint-list-store" || elementId === "att-store-filter" || elementId === "petty-cash-store" || elementId === "petty-add-store" || elementId === "petty-monthly-store"));
        var listToUse = restrictStores ? [userStore] : (list || []);
        var allStoresText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
        var selectPhText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_select_ph) ? I18N[currentLang].store_select_ph : "ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”";
        var addAll = elementId.includes('filter') || elementId.includes('hist') || elementId === 'eval-list-store' || elementId === 'complaint-list-store' || elementId === 'att-today-store' || elementId === 'sch-store-select' || elementId === 'sch-store' || elementId === 'chk-store' || elementId === 'hist-store' || elementId === 'complaint-store' || elementId === 'complaint-list-store' || elementId === 'visit-filter-store' || elementId === 'ord-store-selector' || elementId === 'stock-store-selector' || elementId === 'adj-store-selector' || elementId === 'filter-store-select' || elementId === 'hr-store-selector' || elementId === 'leave-store-select' || elementId === 'emp-store' || elementId === 'os-store' || elementId === 'a-store' || elementId === 'petty-cash-store' || elementId === 'petty-add-store' || elementId === 'petty-monthly-store';
        if (!restrictStores && addAll) {
            var allStoresLabel = (elementId === 'att-today-store' && typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].att_all_stores) ? I18N[currentLang].att_all_stores : allStoresText;
            select.add(new Option(allStoresLabel, "All"));
        } else if (!restrictStores) {
            select.add(new Option(selectPhText, ""));
        }
        listToUse.forEach(function(s) { select.add(new Option(s, s)); });
        if (restrictStores && listToUse.length > 0) { select.value = userStore; select.disabled = true; }
        select.classList.add('loaded');
    }).getStoreListForUI(role);
}

/** ì„¤ì • > ë©”ë‰´ë³„ ê¶Œí•œ: ë§¤ì¥ ë“œë¡­ë‹¤ìš´ì„ ì§ì›ì •ë³´ ì‹œíŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì±„ì›€ (ì§ì› ëª©ë¡ê³¼ ë§¤ì¥ëª… ì¼ì¹˜) */
function loadPermStoreOptions() {
    var select = document.getElementById('perm-store');
    if (!select) return;
    var role = (typeof userRole !== 'undefined') ? userRole : '';
    google.script.run.withSuccessHandler(function(list) {
        select.innerHTML = "";
        var ph = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].store_select_ph) ? I18N[currentLang].store_select_ph : "ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”";
        select.add(new Option(ph, ""));
        (list || []).forEach(function(s) { select.add(new Option(s, s)); });
        select.classList.add('loaded');
    }).withFailureHandler(function() {
        select.innerHTML = "";
        select.add(new Option("ë§¤ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", ""));
    }).getPayrollStoreList(role);
}

/** ì„¤ì • í˜ì´ì§€: ë³¸ì‚¬ ì •ë³´ í¼ì— í˜„ì¬ ê°’ ë¡œë“œ */
function loadHeadOfficeInfo() {
    google.script.run
        .withSuccessHandler(function(info) {
            if (!info) return;
            var el = function(id) { return document.getElementById(id); };
            if (el('settings-company-name')) el('settings-company-name').value = info.companyName || '';
            if (el('settings-tax-id')) el('settings-tax-id').value = info.taxId || '';
            if (el('settings-address')) el('settings-address').value = info.address || '';
            if (el('settings-phone')) el('settings-phone').value = info.phone || '';
            if (el('settings-bank-info')) el('settings-bank-info').value = info.bankInfo || '';
        })
        .withFailureHandler(function() {})
        .getInvoiceCompanyInfo();
}

/** ì„¤ì • í˜ì´ì§€: ë³¸ì‚¬ ì •ë³´ ì €ì¥ */
function saveHeadOfficeInfo() {
    var d = {
        companyName: document.getElementById('settings-company-name') ? document.getElementById('settings-company-name').value : '',
        taxId: document.getElementById('settings-tax-id') ? document.getElementById('settings-tax-id').value : '',
        address: document.getElementById('settings-address') ? document.getElementById('settings-address').value : '',
        phone: document.getElementById('settings-phone') ? document.getElementById('settings-phone').value : '',
        bankInfo: document.getElementById('settings-bank-info') ? document.getElementById('settings-bank-info').value : ''
    };
    google.script.run
        .withSuccessHandler(function(msg) { alert(msg); })
        .withFailureHandler(function(err) { alert('ì €ì¥ ì‹¤íŒ¨: ' + (err && err.message ? err.message : err)); })
        .saveHeadOfficeInfoToSheet(d);
}

/** ì„¤ì • íƒ­ ì „í™˜ (office | menu-permission | about) */
function showSettingsTab(tabId) {
    ['office', 'menu-permission', 'about'].forEach(function(id) {
        var panel = document.getElementById('settings-panel-' + id);
        var link = document.getElementById('settings-tab-' + id);
        if (panel) panel.style.display = (id === tabId ? 'block' : 'none');
        if (link) { link.classList.remove('active'); if (id === tabId) link.classList.add('active'); }
    });
    if (tabId === 'menu-permission') {
        var permStore = document.getElementById('perm-store');
        if (permStore && (permStore.options.length <= 1 || !permStore.classList.contains('loaded'))) {
            permStore.classList.remove('loaded');
            loadPermStoreOptions();
        }
        loadMenuPermissionCheckboxes();
        loadMenuPermissionEmployees();
    }
}

/** ë©”ë‰´ë³„ ê¶Œí•œ ì„¤ì •ìš© ë©”ë‰´ ëª©ë¡ (id = go() í˜ì´ì§€ id, labelKey = ë‹¤êµ­ì–´ í‚¤) */
var MENU_PERMISSION_ITEMS = [
    { id: 'dashboard', labelKey: 'menu_dashboard' },
    { id: 'notices', labelKey: 'menu_notices' },
    { id: 'work-log', labelKey: 'menu_work_log' },
    { id: 'item-manage', labelKey: 'menu_item_manage' },
    { id: 'vendor-manage', labelKey: 'menu_vendor' },
    { id: 'outbound', labelKey: 'menu_outbound' },
    { id: 'stock', labelKey: 'menu_stock' },
    { id: 'inbound', labelKey: 'menu_inbound' },
    { id: 'force', labelKey: 'menu_force' },
    { id: 'hr-employee', labelKey: 'menu_hr_employee' },
    { id: 'attendance-manage', labelKey: 'menu_attendance' },
    { id: 'payroll', labelKey: 'menu_payroll' },
    { id: 'hr-leave', labelKey: 'menu_hr_leave' },
    { id: 'petty-cash', labelKey: 'menu_petty_cash' },
    { id: 'store-manage', labelKey: 'menu_store_check' },
    { id: 'store-visit', labelKey: 'menu_store_visit' },
    { id: 'store-complaint', labelKey: 'menu_store_complaint' },
    { id: 'settings', labelKey: 'menu_header_settings' }
];

function loadMenuPermissionCheckboxes() {
    var container = document.getElementById('perm-checkboxes');
    if (!container) return;
    var lang = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== 'undefined' && I18N.ko) ? I18N.ko : {};
    var viewText = (lang.perm_view != null) ? lang.perm_view : 'ë³´ê¸°';
    var editText = (lang.perm_edit != null) ? lang.perm_edit : 'ìˆ˜ì •';
    container.innerHTML = '';
    MENU_PERMISSION_ITEMS.forEach(function(m) {
        var label = (lang[m.labelKey] != null) ? lang[m.labelKey] : m.labelKey;
        container.innerHTML += '<div class="col-12 col-md-6 border-bottom py-2"><div class="d-flex align-items-center flex-wrap gap-2"><span class="small fw-bold" style="min-width:100px;">' + label + '</span><label class="form-check mb-0"><input type="checkbox" class="form-check-input perm-menu" data-menu-id="' + m.id + '" data-perm-type="view"> <span class="small">' + viewText + '</span></label><label class="form-check mb-0"><input type="checkbox" class="form-check-input perm-menu" data-menu-id="' + m.id + '" data-perm-type="edit"> <span class="small">' + editText + '</span></label></div></div>';
    });
}

function loadMenuPermissionEmployees() {
    var storeSel = document.getElementById('perm-store');
    var empSel = document.getElementById('perm-employee');
    if (!storeSel || !empSel) return;
    var store = (storeSel.value || '').trim();
    empSel.innerHTML = '<option value="">ì§ì› ì„ íƒ</option>';
    if (!store) return;
    google.script.run
        .withSuccessHandler(function(list) {
            (list || []).forEach(function(o) {
                var opt = document.createElement('option');
                opt.value = o.name || o;
                opt.textContent = (o.name != null ? o.name : o);
                if (o.store) opt.setAttribute('data-store', o.store);
                empSel.appendChild(opt);
            });
            loadMenuPermissionForEmployee();
        })
        .withFailureHandler(function() {})
        .getEmployeeNamesByStore(store);
}

function loadMenuPermissionForEmployee() {
    var storeSel = document.getElementById('perm-store');
    var empSel = document.getElementById('perm-employee');
    var name = empSel && empSel.value ? empSel.value.trim() : '';
    var store = storeSel && storeSel.value ? storeSel.value.trim() : '';
    if (!name || !store) {
        document.querySelectorAll('.perm-menu').forEach(function(cb) { cb.checked = false; });
        return;
    }
    google.script.run
        .withSuccessHandler(function(perm) {
            document.querySelectorAll('.perm-menu').forEach(function(cb) {
                var id = cb.getAttribute('data-menu-id');
                var type = cb.getAttribute('data-perm-type') || 'view';
                var key = id + '_' + type;
                cb.checked = (perm && perm[key]) ? true : false;
            });
        })
        .withFailureHandler(function() {
            document.querySelectorAll('.perm-menu').forEach(function(cb) { cb.checked = false; });
        })
        .getMenuPermission(store, name);
}

function saveMenuPermission() {
    var storeSel = document.getElementById('perm-store');
    var empSel = document.getElementById('perm-employee');
    var store = storeSel && storeSel.value ? storeSel.value.trim() : '';
    var name = empSel && empSel.value ? empSel.value.trim() : '';
    if (!store || !name) { alert('ë§¤ì¥ê³¼ ì§ì›ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
    var perm = {};
    document.querySelectorAll('.perm-menu').forEach(function(cb) {
        var id = cb.getAttribute('data-menu-id');
        var type = cb.getAttribute('data-perm-type') || 'view';
        perm[id + '_' + type] = cb.checked ? 1 : 0;
    });
    google.script.run
        .withSuccessHandler(function(msg) { alert(msg || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); })
        .withFailureHandler(function(err) { alert('ì €ì¥ ì‹¤íŒ¨: ' + (err && err.message ? err.message : err)); })
        .setMenuPermission(store, name, perm);
}

/** íŒ¨í‹° ìºì‰¬ íƒ­ ì „í™˜ (list | monthly) */
function showPettyCashTab(tabId) {
    var listTab = document.getElementById('petty-tab-list');
    var monthlyTab = document.getElementById('petty-tab-monthly');
    var navList = document.getElementById('petty-nav-list');
    var navMonthly = document.getElementById('petty-nav-monthly');
    if (listTab) listTab.style.display = (tabId === 'list' ? 'block' : 'none');
    if (monthlyTab) monthlyTab.style.display = (tabId === 'monthly' ? 'block' : 'none');
    if (navList) { navList.classList.remove('active'); if (tabId === 'list') navList.classList.add('active'); }
    if (navMonthly) { navMonthly.classList.remove('active'); if (tabId === 'monthly') navMonthly.classList.add('active'); }
    if (tabId === 'monthly') {
        var ms = document.getElementById('petty-monthly-store');
        if (ms && (ms.options.length <= 1 || !ms.classList.contains('loaded'))) {
            ms.classList.remove('loaded');
            loadStoreOptions('petty-monthly-store');
        }
        var ymSel = document.getElementById('petty-monthly-ym');
        if (ymSel && ymSel.options.length === 0) {
            var now = new Date();
            var y = now.getFullYear();
            var m = now.getMonth() + 1;
            for (var i = 0; i < 24; i++) {
                var d = new Date(y, m - 1 - i, 1);
                var yy = d.getFullYear();
                var mm = d.getMonth() + 1;
                var ym = yy + '-' + String(mm).padStart(2, '0');
                var label = yy + 'ë…„ ' + mm + 'ì›”';
                ymSel.add(new Option(label, ym));
            }
            ymSel.value = y + '-' + String(m).padStart(2, '0');
        }
        loadPettyCashMonthDetail();
    }
}

/** íŒ¨í‹° ìºì‰¬ ì›”ë³„ í˜„í™© - í•´ë‹¹ ì›” ê±°ë˜ ì „ì²´ + ì‹¤ì‹œê°„ ì”ì•¡ */
function loadPettyCashMonthDetail() {
    var storeEl = document.getElementById('petty-monthly-store');
    var ymEl = document.getElementById('petty-monthly-ym');
    var store = storeEl ? storeEl.value || '' : '';
    var yearMonth = ymEl ? ymEl.value || '' : '';
    if (!yearMonth) {
        var n = new Date();
        yearMonth = n.getFullYear() + '-' + String(n.getMonth() + 1).padStart(2, '0');
    }
    var us = typeof userStore !== 'undefined' ? userStore : '';
    var ur = typeof userRole !== 'undefined' ? userRole : '';
    google.script.run
        .withSuccessHandler(function(list) {
            var tbody = document.getElementById('petty-monthly-list');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                var noData = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_no_data) ? I18N[currentLang].petty_no_data : 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
                tbody.innerHTML = '<tr><td colspan="8" class="text-muted">' + noData + '</td></tr>';
                return;
            }
            var memos = [], seen = {};
            list.forEach(function(r) { var m = (r.memo || '').trim(); if (m && !seen[m]) { seen[m] = true; memos.push(m); } });
            var targetLang = typeof getTranslationLang === 'function' ? getTranslationLang() : 'ko';
            function renderRows(memoMap) {
                var typeLabels = { receive: 'ìˆ˜ë ¹', expense: 'ì§€ì¶œ', replenish: 'ë³´ì¶©', settle: 'ì •ì‚°' };
                if (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) {
                    typeLabels = { receive: I18N[currentLang].petty_type_receive || 'ìˆ˜ë ¹', expense: I18N[currentLang].petty_type_expense || 'ì§€ì¶œ', replenish: I18N[currentLang].petty_type_replenish || 'ë³´ì¶©', settle: I18N[currentLang].petty_type_settle || 'ì •ì‚°' };
                }
                var fmt = function(n) { return (Number(n) || 0).toLocaleString(); };
                var receiptTitle = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_col_receipt) ? I18N[currentLang].petty_col_receipt : 'ì˜ìˆ˜ì¦';
                var getMemo = function(m) { return (m && memoMap[m]) ? memoMap[m] : (m || ''); };
                window.pettyMonthlyDataCache = list;
                list.forEach(function(r) {
                    var tr = document.createElement('tr');
                    tr.className = 'petty-monthly-data-row';
                    if (r.receipt_url && r.receipt_url.length > 0) tr.setAttribute('data-receipt', 'Y');
                    var memoDisp = getMemo((r.memo || '').trim());
                    var receiptCell = (r.receipt_url && r.receipt_url.length > 0)
                        ? '<td class="p-1"><button type="button" class="btn btn-sm btn-outline-secondary petty-receipt-btn" title="' + receiptTitle + '">ğŸ“·</button></td>'
                        : '<td>-</td>';
                    tr.innerHTML = '<td>' + (r.trans_date || '-') + '</td><td>' + (r.store || '-') + '</td><td>' + (typeLabels[r.trans_type] || r.trans_type) + '</td><td class="text-end">' + (r.amount >= 0 ? '' : '-') + fmt(Math.abs(r.amount)) + '</td><td class="text-end fw-bold">' + fmt(r.balance_after) + '</td><td>' + (memoDisp || '') + '</td>' + receiptCell + '<td>' + (r.user_name || '-') + '</td>';
                    var btn = tr.querySelector('.petty-receipt-btn');
                    if (btn && r.receipt_url) { (function(url) { btn.onclick = function() { showPettyReceiptModal(url); }; })(r.receipt_url); }
                    tbody.appendChild(tr);
                });
            }
            if (memos.length === 0) { renderRows({}); return; }
            google.script.run.withSuccessHandler(function(translated) {
                var map = {};
                memos.forEach(function(m, i) { map[m] = (translated && translated[i] !== undefined) ? translated[i] : m; });
                renderRows(map);
            }).withFailureHandler(function() { renderRows({}); }).translateBatch(memos, targetLang);
        })
        .withFailureHandler(function(err) {
            var lang = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) ? I18N[currentLang] : {};
            alert((lang.petty_query_fail || 'ì¡°íšŒ ì‹¤íŒ¨') + ': ' + (err && err.message ? err.message : err));
        })
        .getPettyCashMonthDetail(us, ur, store, yearMonth);
}

/** íŒ¨í‹° ìºì‰¬ ë‚´ì—­ ì¡°íšŒ */
function loadPettyCashList() {
    var storeEl = document.getElementById('petty-cash-store');
    var startEl = document.getElementById('petty-cash-start');
    var endEl = document.getElementById('petty-cash-end');
    var store = storeEl ? storeEl.value || '' : '';
    var startStr = startEl ? startEl.value || '' : '';
    var endStr = endEl ? endEl.value || '' : '';
    var us = typeof userStore !== 'undefined' ? userStore : '';
    var ur = typeof userRole !== 'undefined' ? userRole : '';
    google.script.run
        .withSuccessHandler(function(list) {
            var tbody = document.getElementById('petty-cash-list');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-muted">' + ((typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_no_data) ? I18N[currentLang].petty_no_data : 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤') + '</td></tr>';
                return;
            }
            var memos = [], seen = {};
            list.forEach(function(r) { var m = (r.memo || '').trim(); if (m && !seen[m]) { seen[m] = true; memos.push(m); } });
            var targetLang = typeof getTranslationLang === 'function' ? getTranslationLang() : 'ko';
            function renderRows(memoMap) {
                var typeLabels = { receive: 'ìˆ˜ë ¹', expense: 'ì§€ì¶œ', replenish: 'ë³´ì¶©', settle: 'ì •ì‚°' };
                if (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) {
                    typeLabels = { receive: I18N[currentLang].petty_type_receive || 'ìˆ˜ë ¹', expense: I18N[currentLang].petty_type_expense || 'ì§€ì¶œ', replenish: I18N[currentLang].petty_type_replenish || 'ë³´ì¶©', settle: I18N[currentLang].petty_type_settle || 'ì •ì‚°' };
                }
                var receiptTitle = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_col_receipt) ? I18N[currentLang].petty_col_receipt : 'ì˜ìˆ˜ì¦';
                var getMemo = function(m) { return (m && memoMap[m]) ? memoMap[m] : (m || ''); };
                list.forEach(function(r) {
                    var tr = document.createElement('tr');
                    var bal = r.balance_after != null ? r.balance_after.toLocaleString() : '-';
                    var memoDisp = getMemo((r.memo || '').trim());
                    var receiptCell;
                    if (r.receipt_url && r.receipt_url.length > 0) {
                        receiptCell = '<td class="p-1"><button type="button" class="btn btn-sm btn-outline-secondary petty-receipt-btn" title="' + receiptTitle + '">ğŸ“·</button></td>';
                        tr.innerHTML = '<td>' + (r.trans_date || '-') + '</td><td>' + (r.store || '-') + '</td><td>' + (typeLabels[r.trans_type] || r.trans_type) + '</td><td class="text-end">' + (r.amount >= 0 ? '' : '-') + Math.abs(r.amount).toLocaleString() + '</td><td class="text-end">' + bal + '</td><td>' + (memoDisp || '') + '</td>' + receiptCell + '<td>' + (r.user_name || '-') + '</td>';
                        var btn = tr.querySelector('.petty-receipt-btn');
                        if (btn) { (function(url) { btn.onclick = function() { showPettyReceiptModal(url); }; })(r.receipt_url); }
                    } else {
                        receiptCell = '<td>-</td>';
                        tr.innerHTML = '<td>' + (r.trans_date || '-') + '</td><td>' + (r.store || '-') + '</td><td>' + (typeLabels[r.trans_type] || r.trans_type) + '</td><td class="text-end">' + (r.amount >= 0 ? '' : '-') + Math.abs(r.amount).toLocaleString() + '</td><td class="text-end">' + bal + '</td><td>' + (memoDisp || '') + '</td>' + receiptCell + '<td>' + (r.user_name || '-') + '</td>';
                    }
                    tbody.appendChild(tr);
                });
            }
            if (memos.length === 0) { renderRows({}); return; }
            google.script.run.withSuccessHandler(function(translated) {
                var map = {};
                memos.forEach(function(m, i) { map[m] = (translated && translated[i] !== undefined) ? translated[i] : m; });
                renderRows(map);
            }).withFailureHandler(function() { renderRows({}); }).translateBatch(memos, targetLang);
        })
        .withFailureHandler(function(err) { var lang = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) ? I18N[currentLang] : {}; alert((lang.petty_query_fail || 'ì¡°íšŒ ì‹¤íŒ¨') + ': ' + (err && err.message ? err.message : err)); })
        .getPettyCashList(us, ur, startStr, endStr, store);
}

/** íŒ¨í‹° ìºì‰¬ ê±°ë˜ ë“±ë¡ */
function savePettyCash() {
    var storeEl = document.getElementById('petty-add-store');
    var dateEl = document.getElementById('petty-add-date');
    var typeEl = document.getElementById('petty-add-type');
    var amountEl = document.getElementById('petty-add-amount');
    var memoEl = document.getElementById('petty-add-memo');
    var store = storeEl ? storeEl.value || '' : '';
    var transDate = dateEl ? dateEl.value || '' : '';
    var transType = typeEl ? typeEl.value || 'expense' : 'expense';
    var amount = amountEl ? Number(amountEl.value) || 0 : 0;
    var memo = memoEl ? memoEl.value || '' : '';
    var userName = (typeof userName !== 'undefined' && userName) ? userName : (typeof sessionStorage !== 'undefined' ? sessionStorage.getItem('cm_name') || '' : '');
    var us = typeof userStore !== 'undefined' ? userStore : '';
    var ur = typeof userRole !== 'undefined' ? userRole : '';
    var lang = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) ? I18N[currentLang] : {};
    if (!store) { alert(lang.petty_alert_store || 'ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
    if (!transDate) { alert(lang.petty_alert_date || 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
    if (amount <= 0) { alert(lang.petty_alert_amount || 'ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    google.script.run
        .withSuccessHandler(function(msg) {
            alert(msg || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (amountEl) amountEl.value = '';
            if (memoEl) memoEl.value = '';
            loadPettyCashList();
        })
        .withFailureHandler(function(err) { var lang = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang]) ? I18N[currentLang] : {}; alert((lang.petty_save_fail || 'ë“±ë¡ ì‹¤íŒ¨') + ': ' + (err && err.message ? err.message : err)); })
        .addPettyCashTransaction(store, transDate, transType, amount, memo, userName, us, ur);
}

/** íŒ¨í‹°ìºì‹œ ì˜ìˆ˜ì¦ ëª¨ë‹¬ í‘œì‹œ (í´ë¦­ ì‹œ) */
function showPettyReceiptModal(url) {
    if (!url || url.length === 0) return;
    var modal = document.getElementById('pettyReceiptModal');
    var img = document.getElementById('pettyReceiptModalImg');
    if (!modal || !img) return;
    img.src = url;
    var altText = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_col_receipt) ? I18N[currentLang].petty_col_receipt : 'ì˜ìˆ˜ì¦';
    img.alt = altText;
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        var m = new bootstrap.Modal(modal);
        m.show();
    } else {
        modal.classList.add('show');
        modal.style.display = 'block';
    }
}

/** íŒ¨í‹°ìºì‹œ ì›”ë³„ í˜„í™© ì¸ì‡„ */
function printPettyMonthly() {
    var tbody = document.getElementById('petty-monthly-list');
    if (!tbody || tbody.querySelectorAll('tr.petty-monthly-data-row').length === 0) {
        var msg = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_no_data) ? I18N[currentLang].petty_no_data : 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
        alert((typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].ord_query_please) ? I18N[currentLang].ord_query_please : 'ì¡°íšŒ í›„ ì¸ì‡„í•´ ì£¼ì„¸ìš”.');
        return;
    }
    var table = tbody.closest('table');
    if (!table) return;
    var ymEl = document.getElementById('petty-monthly-ym');
    var ymLabel = ymEl && ymEl.options[ymEl.selectedIndex] ? ymEl.options[ymEl.selectedIndex].text : '';
    var printDiv = document.createElement('div');
    printDiv.className = 'p-3';
    var title = document.createElement('div');
    title.className = 'mb-2 fw-bold fs-5';
    title.textContent = (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].petty_cash_title) ? I18N[currentLang].petty_cash_title + ' - ' + ymLabel : 'íŒ¨í‹° ìºì‰¬ ì›”ë³„ í˜„í™© - ' + ymLabel;
    printDiv.appendChild(title);
    printDiv.appendChild(table.cloneNode(true));
    var w = window.open('', '_blank');
    if (!w) { alert('íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.'); return; }
    w.document.write('<html><head><meta charset="utf-8"><link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet"></head><body>' + printDiv.outerHTML + '</body></html>');
    w.document.close();
    w.onload = function() { w.print(); w.close(); };
}

/** íŒ¨í‹°ìºì‹œ ì›”ë³„ í˜„í™© ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ */
function downloadPettyMonthlyExcel() {
    var tbody = document.getElementById('petty-monthly-list');
    if (!tbody) return;
    var dataRows = tbody.querySelectorAll('tr.petty-monthly-data-row');
    if (dataRows.length === 0) {
        alert((typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang].ord_query_please) ? I18N[currentLang].ord_query_please : 'ì¡°íšŒ í›„ ë‹¤ìš´ë¡œë“œí•´ ì£¼ì„¸ìš”.');
        return;
    }
    var table = tbody.closest('table');
    var thead = table ? table.querySelector('thead tr') : null;
    var headers = [];
    if (thead) {
        thead.querySelectorAll('th').forEach(function(th) { headers.push((th.textContent || '').trim()); });
    } else {
        headers = ['ë‚ ì§œ', 'ë§¤ì¥', 'ìœ í˜•', 'ê¸ˆì•¡', 'ì”ì•¡', 'ë‚´ìš©', 'ì˜ìˆ˜ì¦', 'ë“±ë¡ì'];
    }
    function csvEscape(s) {
        if (s == null) return '';
        var t = String(s).trim().replace(/\r?\n/g, ' ');
        return t.indexOf(',') !== -1 || t.indexOf('"') !== -1 ? '"' + t.replace(/"/g, '""') + '"' : t;
    }
    var rows = [headers.map(csvEscape).join(',')];
    dataRows.forEach(function(tr) {
        var cells = [];
        tr.querySelectorAll('td').forEach(function(td, i) {
            var btn = td.querySelector('.petty-receipt-btn');
            if (btn) cells.push(tr.getAttribute('data-receipt') === 'Y' ? 'ìˆìŒ' : '-');
            else cells.push(td.textContent || '');
        });
        rows.push(cells.map(csvEscape).join(','));
    });
    var csv = '\uFEFF' + rows.join('\r\n');
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'petty_cash_monthly_' + (document.getElementById('petty-monthly-ym') ? document.getElementById('petty-monthly-ym').value : '') + '.csv';
    a.click();
    URL.revokeObjectURL(a.href);
}

/** íŒ¨í‹°ìºì‹œ ì˜ìˆ˜ì¦ ì €ì¥(ë‹¤ìš´ë¡œë“œ) */
function savePettyReceiptImage() {
    var img = document.getElementById('pettyReceiptModalImg');
    if (!img || !img.src || img.src.length < 20) return;
    var url = img.src;
    var a = document.createElement('a');
    a.href = url;
    a.download = 'petty_receipt_' + new Date().toISOString().slice(0, 10) + '_' + Date.now() + '.jpg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

</script>