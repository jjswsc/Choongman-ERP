<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#E65100">
  <title>ì¶©ë§Œ ERP (Vercel)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    #loading { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); align-items: center; justify-content: center; z-index: 9999; }
    #loading.show { display: flex; }
    #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #FFE0B2; padding: 20px; }
    .brand-logo-large { color: #E65100; font-size: 28px; font-weight: 900; margin-bottom: 20px; }
    .login-card { background: white; max-width: 350px; width: 100%; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
    .login-btn { width: 100%; padding: 14px; background: #E65100; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; }
    #app-screen { display: none; max-width: 800px; margin: 0 auto; padding: 20px; }
    #app-screen.show { display: block; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .notice-list { background: #fff; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #eee; }
    .notice-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    .notice-item:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div id="loading" class="show"><div class="spinner-border text-warning" style="width:3rem;height:3rem;"></div></div>

  <div id="login-screen">
    <div class="brand-logo-large">ì¶©ë§Œ ERP (Vercel)</div>
    <div class="login-card">
      <select id="storeSelect" class="login-input"><option value="">ë§¤ì¥ ì„ íƒ...</option></select>
      <select id="loginName" class="login-input"><option value="">ì´ë¦„ ì„ íƒ...</option></select>
      <input type="password" id="loginPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (PIN)">
      <button class="login-btn" id="btn-login" onclick="tryLogin()">ë¡œê·¸ì¸</button>
    </div>
  </div>

  <div id="app-screen">
    <div class="app-header">
      <strong style="color:#E65100;">ì¶©ë§Œì¹˜í‚¨</strong>
      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div style="background:#fff3e0; padding:16px; border-radius:12px; margin-bottom:16px;">
      <p style="margin:0; color:#555;" id="home-notice-content">ê³µì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <div class="notice-list">
      <div style="font-weight:bold; color:#E65100; margin-bottom:10px;">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
      <div id="notice-list-box">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
      <button type="button" class="btn btn-sm mt-2" style="background:#E65100; color:white;" onclick="loadNotices()">ê³µì§€ ì¡°íšŒ</button>
    </div>
    <p class="mt-3 text-muted small" id="data-status">ë¬¼ë¥˜ ë°ì´í„°: ë¡œë“œ ì „</p>
  </div>

  <script src="/api-adapter.js"></script>
  <script>
    var loginData = {}, loggedInStore = '', loggedInUser = '', loggedInRole = '', myNotices = [];

    function load(show) {
      var el = document.getElementById('loading');
      if (el) el.classList.toggle('show', !!show);
    }

    function fillStoreSelect() {
      var s = document.getElementById('storeSelect');
      if (!s || !loginData) return;
      s.innerHTML = '<option value="">ë§¤ì¥ ì„ íƒ...</option>';
      for (var k in loginData) {
        if (loginData.hasOwnProperty(k)) s.add(new Option(k, k));
      }
    }
    function onStoreChange() {
      var store = document.getElementById('storeSelect').value;
      var n = document.getElementById('loginName');
      if (!n) return;
      n.innerHTML = '<option value="">ì´ë¦„ ì„ íƒ...</option>';
      if (loginData[store]) {
        loginData[store].forEach(function(name) { n.add(new Option(name, name)); });
      }
    }
    document.getElementById('storeSelect').onchange = onStoreChange;

    // ì´ˆê¸° ë¡œë“œ: ê³µì§€ + ë¡œê·¸ì¸ ë°ì´í„°
    runApi('GET', 'getNotice', {}).then(function(r) {
      var txt = typeof r === 'string' ? r : (r && r.notice != null ? r.notice : '');
      var el = document.getElementById('home-notice-content');
      if (el && txt) el.innerText = txt;
    }).catch(function() {});

    load(true);
    runApi('GET', 'getLoginData', {}).then(function(d) {
      load(false);
      loginData = (d && d.users) ? d.users : (d || {});
      fillStoreSelect();
    }).catch(function(err) {
      load(false);
      alert('ì„œë²„ ì˜¤ë¥˜: ' + (err && err.message ? err.message : err));
    });

    function tryLogin() {
      var s = document.getElementById('storeSelect').value;
      var n = document.getElementById('loginName').value;
      var p = document.getElementById('loginPw').value;
      if (!s || !n) { alert('ë§¤ì¥ê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
      var btn = document.getElementById('btn-login');
      if (btn) btn.disabled = true;
      runApi('POST', 'loginCheck', { store: s, name: n, pw: p, isAdminPage: false })
        .then(function(res) {
          if (btn) btn.disabled = false;
          if (res && res.success) {
            loggedInStore = res.storeName;
            loggedInUser = res.userName;
            loggedInRole = res.role || '';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').classList.add('show');
            loadNotices();
            runApi('POST', 'getAppData', { storeName: loggedInStore }).then(function(appRes) {
              var items = (appRes && appRes.items) ? appRes.items : [];
              var status = document.getElementById('data-status');
              if (status) status.textContent = 'ë¬¼ë¥˜ ë°ì´í„°: í’ˆëª© ' + (items.length || 0) + 'ê±´ ë¡œë“œë¨';
            }).catch(function() {
              var status = document.getElementById('data-status');
              if (status) status.textContent = 'ë¬¼ë¥˜ ë°ì´í„°: ë¡œë“œ ì‹¤íŒ¨';
            });
          } else {
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: PINì„ í™•ì¸í•˜ì„¸ìš”.');
          }
        })
        .catch(function(err) {
          if (btn) btn.disabled = false;
          alert('ì„œë²„ ì˜¤ë¥˜: ' + (err && err.message ? err.message : err));
        });
    }

    function loadNotices() {
      if (!loggedInStore) return;
      var box = document.getElementById('notice-list-box');
      if (box) box.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      runApi('POST', 'getMyNotices', { store: loggedInStore, role: loggedInRole, name: loggedInUser })
        .then(function(list) {
          myNotices = list || [];
          if (!box) return;
          if (!myNotices.length) { box.innerHTML = '<div class="text-muted">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
          box.innerHTML = myNotices.map(function(n) {
            return '<div class="notice-item"><strong>' + (n.title || '(ì œëª© ì—†ìŒ)') + '</strong><br><small class="text-muted">' + (n.date || '') + ' Â· ' + (n.sender || '') + '</small></div>';
          }).join('');
        })
        .catch(function() {
          if (box) box.innerHTML = '<div class="text-muted">ì¡°íšŒ ì‹¤íŒ¨</div>';
        });
    }
  </script>
</body>
</html>
