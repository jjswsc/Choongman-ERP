<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ì¶©ë§Œ ERP">
    <title>Chungman Chicken ERP</title>
    <link rel="stylesheet" href="/public/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body class="login-page">
    <div id="loading" class="show">
        <div class="spinner-border" role="status"></div>
    </div>

    <div class="login-bg">
        <div class="background-glow"></div>
        <div class="data-streams"></div>
    </div>

    <div class="login-wrapper">
        <div class="glass-card">
            <div class="logo-section">
                <img src="/public/img/logo.png" alt="Chungman Chicken" class="logo">
                <h1 class="logo-title">CHUNGMAN CHICKEN</h1>
                <p class="erp-text">Integrated ERP</p>
            </div>

            <form class="login-form" id="loginForm">
                <div class="input-group">
                    <select id="langSelect" onchange="changeLanguage()">
                        <option value="ko">KR í•œêµ­ì–´</option>
                        <option value="en">EN English</option>
                        <option value="th">TH à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</option>
                        <option value="mm">MM á€™á€¼á€”á€ºá€™á€¬</option>
                        <option value="la">LA àºàº²àºªàº²àº¥àº²àº§</option>
                    </select>
                </div>
                <div class="input-group">
                    <select id="storeSelect" onchange="onStoreChange()">
                        <option value="" disabled selected>ë§¤ì¥ ì„ íƒ...</option>
                    </select>
                </div>
                <div class="input-group">
                    <select id="loginName">
                        <option value="" disabled selected>ì´ë¦„ ì„ íƒ...</option>
                    </select>
                </div>
                <div class="input-group">
                    <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (PIN)" autocomplete="off">
                </div>

                <button type="submit" class="login-btn" id="btn-login">LOGIN</button>

                <div class="form-footer">
                    <label><input type="checkbox" id="rememberMe"> Remember Me</label>
                    <a href="#" id="btn-pw-change" onclick="openPwModal(event)">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
                </div>
            </form>
        </div>
        <p class="copyright">Powered by Supabase & Vercel</p>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="pwModal" class="pw-modal" onclick="closePwModalOnBackdrop(event)">
        <div class="pw-modal-inner" onclick="event.stopPropagation()">
            <h3>ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <div class="input-group">
                <input type="password" id="pwOld" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="pwNew" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password">
            </div>
            <div class="input-group">
                <input type="password" id="pwNew2" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">
            </div>
            <button type="button" class="login-btn" id="btn-pw-submit" onclick="submitPwChange()">ë³€ê²½í•˜ê¸°</button>
            <span class="pw-modal-close" onclick="closePwModal()">ë‹«ê¸°</span>
        </div>
    </div>

    <script src="/public/api-adapter.js"></script>
    <script>
        var loginData = {};
        var currentLang = (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('cm_lang')) || 'ko';

        var I18N = {
            ko: { m_select_store: "ë§¤ì¥ ì„ íƒ", m_select_name: "ì´ë¦„ ì„ íƒ", m_pin_ph: "ë¹„ë°€ë²ˆí˜¸ (PIN)", err_select_store_name: "ë§¤ì¥ê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.", err_login_fail: "ë¡œê·¸ì¸ ì‹¤íŒ¨: PINì„ í™•ì¸í•˜ì„¸ìš”.", err_server: "ì„œë²„ ì˜¤ë¥˜", pw_change: "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½", pw_current: "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸", pw_new: "ìƒˆ ë¹„ë°€ë²ˆí˜¸", pw_new_confirm: "ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸", pw_btn_submit: "ë³€ê²½í•˜ê¸°", pw_alert_store_name: "ë§¤ì¥ê³¼ ì´ë¦„ì„ ì„ íƒí•œ ë’¤ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.", pw_alert_current: "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", pw_alert_new: "ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", pw_alert_mismatch: "ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", pw_success: "ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.", pw_error_fail: "ë³€ê²½ ì‹¤íŒ¨", modal_close: "ë‹«ê¸°", forgot_pw: "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½", remember_me: "Remember Me" },
            en: { m_select_store: "Select Store", m_select_name: "Select Name", m_pin_ph: "Password (PIN)", err_select_store_name: "Please select store and name.", err_login_fail: "Login failed: Check PIN.", err_server: "Server error", pw_change: "Change Password", pw_current: "Current Password", pw_new: "New Password", pw_new_confirm: "Confirm New Password", pw_btn_submit: "Change", pw_alert_store_name: "Please select store and name first.", pw_alert_current: "Enter current password.", pw_alert_new: "Enter new password.", pw_alert_mismatch: "New passwords do not match.", pw_success: "Password changed. Please log in again.", pw_error_fail: "Change failed", modal_close: "Close", forgot_pw: "Forgot Password?", remember_me: "Remember Me" }
        };

        function t(key) {
            var L = I18N[currentLang];
            return (L && L[key]) ? L[key] : (I18N.ko && I18N.ko[key]) ? I18N.ko[key] : key;
        }

        function changeLanguage() {
            var sel = document.getElementById('langSelect');
            if (sel) { currentLang = sel.value || 'ko'; try { sessionStorage.setItem('cm_lang', currentLang); } catch (e) {} applyTranslations(); }
        }

        function applyTranslations() {
            var s = document.getElementById('storeSelect');
            var n = document.getElementById('loginName');
            var pw = document.getElementById('loginPw');
            var pwLink = document.getElementById('btn-pw-change');
            if (s && s.options[0]) s.options[0].text = t('m_select_store') + '...';
            if (n && n.options[0]) n.options[0].text = t('m_select_name') + '...';
            if (pw) pw.placeholder = t('m_pin_ph');
            if (pwLink) pwLink.textContent = t('forgot_pw');
            document.getElementById('pwOld').placeholder = t('pw_current');
            document.getElementById('pwNew').placeholder = t('pw_new');
            document.getElementById('pwNew2').placeholder = t('pw_new_confirm');
            document.getElementById('btn-pw-submit').textContent = t('pw_btn_submit');
            document.querySelector('.pw-modal-close').textContent = t('modal_close');
            var lb = document.querySelector('.form-footer label'); if (lb) lb.innerHTML = '<input type="checkbox" id="rememberMe"> ' + t('remember_me');
        }

        function load(show) { var el = document.getElementById('loading'); if (el) el.classList.toggle('show', !!show); }

        function fillStoreSelect() {
            var s = document.getElementById('storeSelect');
            if (!s || !loginData) return;
            s.innerHTML = '<option value="" disabled selected>' + t('m_select_store') + '...</option>';
            for (var k in loginData) { if (loginData.hasOwnProperty(k)) s.add(new Option(k, k)); }
        }

        function onStoreChange() {
            var store = document.getElementById('storeSelect').value;
            var n = document.getElementById('loginName');
            if (!n) return;
            n.innerHTML = '<option value="" disabled selected>' + t('m_select_name') + '...</option>';
            if (loginData[store]) loginData[store].forEach(function(name) { n.add(new Option(name, name)); });
        }

        function tryLogin(e) {
            if (e) e.preventDefault();
            var s = document.getElementById('storeSelect').value;
            var n = document.getElementById('loginName').value;
            var p = document.getElementById('loginPw').value;
            if (!s || !n) { alert(t('err_select_store_name')); return; }
            var btn = document.getElementById('btn-login');
            if (btn) btn.disabled = true;
            window.runApi('POST', 'loginCheck', { store: s, name: n, pw: p, isAdminPage: false })
                .then(function(res) {
                    if (btn) btn.disabled = false;
                    if (res && res.success) {
                        try { sessionStorage.setItem('cm_store', res.storeName || s); sessionStorage.setItem('cm_user', res.userName || n); sessionStorage.setItem('cm_role', res.role || ''); } catch (e) {}
                        window.location.href = '/app';
                    } else { alert(t('err_login_fail')); }
                })
                .catch(function(err) { if (btn) btn.disabled = false; alert(t('err_server') + ': ' + (err && err.message ? err.message : err)); });
        }

        function openPwModal(e) {
            if (e) e.preventDefault();
            var s = document.getElementById('storeSelect').value;
            var n = document.getElementById('loginName').value;
            if (!s || !n) { alert(t('pw_alert_store_name')); return; }
            document.getElementById('pwOld').value = '';
            document.getElementById('pwNew').value = '';
            document.getElementById('pwNew2').value = '';
            document.getElementById('pwModal').classList.add('show');
        }

        function closePwModal() { document.getElementById('pwModal').classList.remove('show'); }
        function closePwModalOnBackdrop(e) { if (e.target.id === 'pwModal') closePwModal(); }

        function submitPwChange() {
            var s = document.getElementById('storeSelect').value;
            var n = document.getElementById('loginName').value;
            var o = (document.getElementById('pwOld').value || '').trim();
            var p1 = (document.getElementById('pwNew').value || '').trim();
            var p2 = (document.getElementById('pwNew2').value || '').trim();
            if (!o) { alert(t('pw_alert_current')); return; }
            if (!p1) { alert(t('pw_alert_new')); return; }
            if (p1 !== p2) { alert(t('pw_alert_mismatch')); return; }
            var btn = document.getElementById('btn-pw-submit');
            if (btn) btn.disabled = true;
            window.runApi('POST', 'changePassword', { store: s, name: n, oldPw: o, newPw: p1 })
                .then(function(r) {
                    if (btn) btn.disabled = false;
                    if (r && r.success) { alert(r.message || t('pw_success')); closePwModal(); }
                    else { alert(r && r.message ? r.message : t('pw_error_fail')); }
                })
                .catch(function(err) { if (btn) btn.disabled = false; alert(t('err_server') + ': ' + (err && err.message ? err.message : err)); });
        }

        document.getElementById('loginForm').onsubmit = tryLogin;

        load(true);
        var langSel = document.getElementById('langSelect');
        if (langSel && currentLang) langSel.value = currentLang;
        window.runApi('GET', 'getLoginData', {})
            .then(function(d) {
                load(false);
                loginData = (d && d.users) ? d.users : (d || {});
                fillStoreSelect();
                applyTranslations();
            })
            .catch(function(err) { load(false); alert(t('err_server') + ': ' + (err && err.message ? err.message : err)); });
    </script>
</body>
</html>
