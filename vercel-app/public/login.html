<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e40af">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ì¶©ë§Œ ERP">
  <title>ì¶©ë§Œ ERP - ë¡œê·¸ì¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="/public/css/style.css" rel="stylesheet">
  <link href="/public/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background: linear-gradient(160deg, #dbeafe 0%, #bfdbfe 40%, #93c5fd 100%); color: #0f172a; -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="loading" class="show">
    <div class="spinner-border text-warning" style="width:3rem;height:3rem;"></div>
  </div>

  <div id="login-screen">
    <div class="login-logo-wrap">
      <img src="/public/img/logo.png" alt="Choongman Chicken" class="login-logo">
    </div>
    <div class="login-card">
      <select id="langSelect" class="login-input" onchange="changeLanguage()">
        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="th">ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</option>
        <option value="mm">ğŸ‡²ğŸ‡² á€™á€¼á€”á€ºá€™á€¬</option>
        <option value="la">ğŸ‡±ğŸ‡¦ àºàº²àºªàº²àº¥àº²àº§</option>
      </select>
      <select id="storeSelect" class="login-input" onchange="onStoreChange()">
        <option value="">ë§¤ì¥ ì„ íƒ...</option>
      </select>
      <select id="loginName" class="login-input">
        <option value="">ì´ë¦„ ì„ íƒ...</option>
      </select>
      <input type="password" id="loginPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (PIN)" autocomplete="off">
      <button class="login-btn" id="btn-login" onclick="tryLogin()">ë¡œê·¸ì¸</button>
    </div>
  </div>

  <script src="/public/api-adapter.js"></script>
  <script>
    var loginData = {};
    var currentLang = (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('cm_lang')) || 'ko';

    var I18N = {
      ko: { m_select_store: "ë§¤ì¥ ì„ íƒ", m_select_name: "ì´ë¦„ ì„ íƒ", m_pin_ph: "ë¹„ë°€ë²ˆí˜¸ (PIN)", btn_login: "ë¡œê·¸ì¸", err_select_store_name: "ë§¤ì¥ê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.", err_login_fail: "ë¡œê·¸ì¸ ì‹¤íŒ¨: PINì„ í™•ì¸í•˜ì„¸ìš”.", err_server: "ì„œë²„ ì˜¤ë¥˜" },
      en: { m_select_store: "Select Store", m_select_name: "Select Name", m_pin_ph: "Password (PIN)", btn_login: "Login", err_select_store_name: "Please select store and name.", err_login_fail: "Login failed: Check PIN.", err_server: "Server error" },
      th: { m_select_store: "à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²", m_select_name: "à¹€à¸¥à¸·à¸­à¸à¸Šà¸·à¹ˆà¸­", m_pin_ph: "à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (PIN)", btn_login: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š", err_select_store_name: "à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¹à¸¥à¸°à¸Šà¸·à¹ˆà¸­", err_login_fail: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ", err_server: "à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ" },
      mm: { m_select_store: "á€†á€­á€¯á€„á€ºá€›á€½á€±á€¸á€•á€«", m_select_name: "á€¡á€™á€Šá€ºá€›á€½á€±á€¸á€•á€«", m_pin_ph: "á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º (PIN)", btn_login: "á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º", err_select_store_name: "á€†á€­á€¯á€„á€ºá€”á€¾á€„á€·á€ºá€¡á€™á€Šá€ºá€›á€½á€±á€¸á€•á€«", err_login_fail: "á€á€„á€ºá€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«", err_server: "á€†á€¬á€—á€¬ á€¡á€™á€¾á€¬á€¸" },
      la: { m_select_store: "à»€àº¥àº·àº­àºàºªàº²àº‚àº²", m_select_name: "à»€àº¥àº·àº­àºàºŠàº·à»ˆ", m_pin_ph: "àº¥àº°àº«àº±àº” (PIN)", btn_login: "à»€àº‚àº»à»‰àº²àºªàº¹à»ˆàº¥àº°àºšàº»àºš", err_select_store_name: "à»€àº¥àº·àº­àºàºªàº²àº‚àº²à»àº¥àº°àºŠàº·à»ˆ", err_login_fail: "à»€àº‚àº»à»‰àº²àºšà»à»ˆàºªàº³à»€àº¥àº±àº”", err_server: "àº‚à»à»‰àºœàº´àº”àºàº²àº”à»€àºŠàºµàºšà»€àº§àºµ" }
    };

    function t(key) {
      var L = I18N[currentLang];
      return (L && L[key]) ? L[key] : (I18N.ko && I18N.ko[key]) ? I18N.ko[key] : key;
    }

    function changeLanguage() {
      var sel = document.getElementById('langSelect');
      if (sel) {
        currentLang = sel.value || 'ko';
        try { sessionStorage.setItem('cm_lang', currentLang); } catch (e) {}
        applyTranslations();
      }
    }

    function applyTranslations() {
      var s = document.getElementById('storeSelect');
      var n = document.getElementById('loginName');
      var pw = document.getElementById('loginPw');
      var btn = document.getElementById('btn-login');
      if (s && s.options[0]) s.options[0].text = t('m_select_store') + '...';
      if (n && n.options[0]) n.options[0].text = t('m_select_name') + '...';
      if (pw) pw.placeholder = t('m_pin_ph');
      if (btn) btn.textContent = t('btn_login');
    }

    function load(show) {
      var el = document.getElementById('loading');
      if (el) el.classList.toggle('show', !!show);
    }

    function fillStoreSelect() {
      var s = document.getElementById('storeSelect');
      if (!s || !loginData) return;
      s.innerHTML = '<option value="">' + t('m_select_store') + '...</option>';
      for (var k in loginData) {
        if (loginData.hasOwnProperty(k)) s.add(new Option(k, k));
      }
    }

    function onStoreChange() {
      var store = document.getElementById('storeSelect').value;
      var n = document.getElementById('loginName');
      if (!n) return;
      n.innerHTML = '<option value="">' + t('m_select_name') + '...</option>';
      if (loginData[store]) {
        loginData[store].forEach(function(name) { n.add(new Option(name, name)); });
      }
    }

    function tryLogin() {
      var s = document.getElementById('storeSelect').value;
      var n = document.getElementById('loginName').value;
      var p = document.getElementById('loginPw').value;
      if (!s || !n) {
        alert(t('err_select_store_name'));
        return;
      }
      var btn = document.getElementById('btn-login');
      if (btn) btn.disabled = true;

      window.runApi('POST', 'loginCheck', { store: s, name: n, pw: p, isAdminPage: false })
        .then(function(res) {
          if (btn) btn.disabled = false;
          if (res && res.success) {
            try {
              sessionStorage.setItem('cm_store', res.storeName || s);
              sessionStorage.setItem('cm_user', res.userName || n);
              sessionStorage.setItem('cm_role', res.role || '');
            } catch (e) {}
            window.location.href = '/app';
          } else {
            alert(t('err_login_fail'));
          }
        })
        .catch(function(err) {
          if (btn) btn.disabled = false;
          alert(t('err_server') + ': ' + (err && err.message ? err.message : err));
        });
    }

    load(true);
    var langSel = document.getElementById('langSelect');
    if (langSel && currentLang) langSel.value = currentLang;
    window.runApi('GET', 'getLoginData', {})
      .then(function(d) {
        load(false);
        loginData = (d && d.users) ? d.users : (d || {});
        fillStoreSelect();
        applyTranslations();
      })
      .catch(function(err) {
        load(false);
        alert(t('err_server') + ': ' + (err && err.message ? err.message : err));
      });
  </script>
</body>
</html>
