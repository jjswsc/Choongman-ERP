<script>
  /* 1. ë°©ë¬¸ ì‹œì‘/ì¢…ë£Œ ê¸°ë¡ ì „ì†¡ */
  function handleVisit(type) {
    var store = document.getElementById("visit-store-select").value;
    var purpose = document.getElementById("visit-purpose").value;

    if (type === 'ë°©ë¬¸ì‹œì‘' && !store) return alert("ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!confirm(store + " " + type + " ê¸°ë¡ì„ ë‚¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    load(1); // ë¡œë”©ë°” ì‹œì‘
    
    navigator.geolocation.getCurrentPosition(p => {
      google.script.run.withSuccessHandler(res => {
        load(0); // ë¡œë”©ë°” ì¢…ë£Œ
        alert(res.msg); 
        
        if (res.success) { 
          updateVisitUI(type, store, purpose); // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
          loadTodayVisitLog(); // âœ… ë²„íŠ¼ ëˆ„ë¥´ëŠ” ì¦‰ì‹œ ì•„ë˜ ë¡œê·¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
      }).submitStoreVisit({
        userName: loggedInUser,
        storeName: store,
        type: type,
        purpose: purpose,
        lat: p.coords.latitude,
        lng: p.coords.longitude
      });
    }, err => {
      load(0);
      alert("GPS ì‹ í˜¸ë¥¼ ì¡ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    }, { enableHighAccuracy: true, timeout: 7000 });
  }

  /* 2. ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ì‹œì‘ <-> ì¢…ë£Œ) */
  function updateVisitUI(type, store, purpose) {
    var inBtn = document.getElementById("btn-visit-in");
    var outBtn = document.getElementById("btn-visit-out");
    var msgBox = document.getElementById("visit-status-msg");
    var storeSel = document.getElementById("visit-store-select");

    if (type === 'ë°©ë¬¸ì‹œì‘') {
      if(inBtn) inBtn.style.display = "none";
      if(outBtn) outBtn.style.display = "block";
      if(msgBox) {
        msgBox.style.display = "block";
        msgBox.innerHTML = `ğŸ“ <b>[${store}]</b> ì§€ì› ì¤‘...`;
      }
      if(storeSel) storeSel.disabled = true;
    } else {
      if(inBtn) inBtn.style.display = "block";
      if(outBtn) outBtn.style.display = "none";
      if(msgBox) msgBox.style.display = "none";
      if(storeSel) {
        storeSel.disabled = false;
        storeSel.value = "";
      }
    }
  }

 /**
 * [ëª¨ë°”ì¼] ì˜¤ëŠ˜ ë°©ë¬¸ ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ (ì²´ë¥˜ì‹œê°„ í‘œì‹œ ë¡œì§ ìˆ˜ì •)
 */
function loadTodayVisitLog() {
  if (!loggedInUser) return;

  var logBody = document.getElementById("visit-log-body");
  if (!logBody) return;

  google.script.run.withSuccessHandler(function(list) {
    logBody.innerHTML = "";
    var noVisit = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_no_visit : "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    if (!list || list.length === 0) {
      logBody.innerHTML = "<tr><td colspan='4' style='padding:20px; color:#999;'>" + noVisit + "</td></tr>";
      return;
    }
    var texts = list.map(function(r){ return r.type || ""; });
    var targetLang = typeof getTranslationLang === "function" ? getTranslationLang() : "ko";
    if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
      list.forEach(function(r){ appendVisitRow(logBody, r, r.type); });
      return;
    }
    google.script.run.withSuccessHandler(function(translated) {
      list.forEach(function(r, i){ appendVisitRow(logBody, r, (translated && translated[i] !== undefined) ? translated[i] : r.type); });
    }).translateBatch(texts, targetLang);
  }).getTodayMyVisits(loggedInUser);
}
function appendVisitRow(logBody, r, typeText) {
  var typeColor = (r.type === "ë°©ë¬¸ì‹œì‘") ? "#1976D2" : "#D32F2F";
  var durationHtml = (r.duration !== "" && r.duration !== null && !isNaN(r.duration))
      ? "<span style=\"background:#E1F5FE; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:bold; color:#01579B;\">" + r.duration + "ë¶„</span>"
      : "-";
  var row = document.createElement("tr");
  row.style.borderBottom = "1px solid #f2f2f2";
  row.innerHTML = "<td style=\"padding:12px 5px; font-size:11px; color:#555;\">" + r.time + "</td><td style=\"padding:12px 5px; font-weight:bold; font-size:12px; color:#333;\">" + (r.store || "-") + "</td><td style=\"padding:12px 5px; color:" + typeColor + "; font-weight:bold; font-size:12px;\">" + (typeText || "") + "</td><td style=\"padding:12px 5px;\">" + durationHtml + "</td>";
  logBody.appendChild(row);
}

  /* 4. ì•± ì‹¤í–‰ ì‹œ ìƒíƒœ í™•ì¸ */
  function checkActiveVisitStatus() {
    google.script.run.withSuccessHandler(res => {
      if (res && res.active) {
        updateVisitUI('ë°©ë¬¸ì‹œì‘', res.storeName, res.purpose);
      }
      loadTodayVisitLog(); // ì•± ì¼œì§ˆ ë•Œ ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ
    }).checkUserVisitStatus(loggedInUser);
  }
</script>