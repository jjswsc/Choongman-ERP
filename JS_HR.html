<script>
  var lastAttendanceSummaryList = [];

  /* =================================================================
      ì¸ì‚¬/ìŠ¤ì¼€ì¤„ ê´€ë¦¬
     ================================================================= */ 
  /* =================================================================
     ì§ì› / ê¸‰ì—¬
     ================================================================= */ 

// ì§ì› ë°ì´í„° ë¡œë“œ. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œë˜ë©°, ì™„ë£Œ í›„ optionalCallback ì‹¤í–‰(ì˜ˆ: filterEmpList)
function loadEmployeeList(optionalCallback) { 
    load(1); 
    google.script.run.withSuccessHandler(l => { 
        load(0); 
        employeeCache = l || [];
        google.script.run.withSuccessHandler(function(grades) {
            function normName(n) { return String(n || "").trim().replace(/\s+/g, " ").replace(/^(Mr\.?|Ms\.?|Mrs\.?)\s*/i, "").trim() || String(n || "").trim(); }
            (employeeCache || []).forEach(function(e) {
                var fromSheet = (e.grade != null && String(e.grade).trim() !== "") ? String(e.grade).trim() : null;
                if (fromSheet) { e.finalGrade = fromSheet; return; }
                var store = String(e.store || "").trim().replace(/\s+/g, " ");
                var name = String(e.name || "").trim().replace(/\s+/g, " ");
                var nick = String(e.nick || "").trim().replace(/\s+/g, " ");
                var key = store + "|" + name;
                var keyNorm = store + "|" + (normName(name) || name);
                var keyNick = (nick && nick !== name) ? store + "|" + nick : "";
                var g = (grades && grades[key]) ? grades[key].grade : (grades && grades[keyNorm]) ? grades[keyNorm].grade : (grades && keyNick && grades[keyNick]) ? grades[keyNick].grade : null;
                e.finalGrade = (g && String(g).trim()) ? g : "-";
            });
            var filterSelect = document.getElementById("filter-store-select");
            if (filterSelect) {
                var role = (typeof userRole !== "undefined") ? userRole : "";
                google.script.run.withSuccessHandler(function(stores) {
                    if (!filterSelect) return;
                    filterSelect.innerHTML = "";
                    var allStoresText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
                    filterSelect.add(new Option(allStoresText, "All"));
                    if (stores && stores.length) stores.forEach(function(s) { filterSelect.add(new Option(s, s)); });
                    filterSelect.disabled = false;
                    if (typeof optionalCallback === "function") optionalCallback();
                    else {
                        var b = document.getElementById("emp-list-body");
                        var hint = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].emp_search_hint) ? I18N[currentLang].emp_search_hint : "ë§¤ì¥Â·ë“±ê¸‰ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ë¦„ì„ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                        if(b) b.innerHTML = "<tr><td colspan='8' class='text-center p-5 text-muted'>ğŸ” " + hint + "</td></tr>";
                    }
                }).getPayrollStoreList(role);
            } else {
                if (typeof optionalCallback === "function") optionalCallback();
                else {
                    var b = document.getElementById("emp-list-body");
                    var hint = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].emp_search_hint) ? I18N[currentLang].emp_search_hint : "ë§¤ì¥Â·ë“±ê¸‰ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ë¦„ì„ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                    if(b) b.innerHTML = "<tr><td colspan='8' class='text-center p-5 text-muted'>ğŸ” " + hint + "</td></tr>";
                }
            }
        }).getEmployeeLatestGrades();
    }).getAdminEmployeeList(userStore, userRole); 
}
function filterEmpList(){ 
    var storeInput = document.getElementById("filter-store-select");
    var gradeInput = document.getElementById("filter-grade-select");
    var searchInput = document.getElementById("emp-search");

    if (!storeInput || !searchInput) return;

    if (!employeeCache || employeeCache.length === 0) {
        loadEmployeeList(function() { filterEmpList(); });
        return;
    }

    var s = storeInput.value;
    var g = (gradeInput && gradeInput.value) ? gradeInput.value : "All";
    var k = searchInput.value.toLowerCase().trim();

    var f = employeeCache.filter(e => {
        var eStore = String(e.store || "");
        var eName = String(e.name || "").toLowerCase();
        var eNick = String(e.nick || "").toLowerCase();
        var eGrade = String(e.finalGrade || "").trim();
        var matchStore = (s === "" || s === "All" || eStore === s);
        var matchGrade = (g === "" || g === "All" || eGrade === g);
        var matchKey = (k === "" || eName.includes(k) || eNick.includes(k));
        return matchStore && matchGrade && matchKey;
    });
    
    renderEmpTable(f); 
}
  function gradeBadgeStyle(g) {
      var v = String(g || "-").trim().toUpperCase();
      if (v === "A" || v === "S") return "background:linear-gradient(135deg,#1B5E20,#4CAF50); color:#fff; border:none; font-weight:600;";
      if (v === "B") return "background:linear-gradient(135deg,#0D47A1,#1976D2); color:#fff; border:none; font-weight:600;";
      if (v === "C") return "background:linear-gradient(135deg,#F57F17,#FFC107); color:#1a1a1a; border:none; font-weight:600;";
      if (v === "D") return "background:linear-gradient(135deg,#BF360C,#FF5722); color:#fff; border:none; font-weight:600;";
      if (v === "F" || v === "E") return "background:linear-gradient(135deg,#3E2723,#795548); color:#fff; border:none; font-weight:600;";
      return "background:linear-gradient(135deg,#9e9e9e,#bdbdbd); color:#fff; border:none;";
    }
  function renderEmpTable(l) { 
      var L = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : {};
      var txtEmpty = L.emp_result_empty || "ê²°ê³¼ ì—†ìŒ", txtEdit = L.btn_edit || "ìˆ˜ì •", txtDel = L.btn_delete || "ì‚­ì œ";
      var b=document.getElementById("emp-list-body"); b.innerHTML=""; 
      if(!l.length){ b.innerHTML="<tr><td colspan='9'>"+txtEmpty+"</td></tr>"; return; }
      l.forEach(e=>{ 
          var age = "-"; if(e.birth) { var d=new Date(e.birth); age = new Date().getFullYear()-d.getFullYear(); }
          var grade = e.finalGrade || "-";
          var idx = employeeCache.findIndex(z=>z.row===e.row);
          var gradeStyle = gradeBadgeStyle(grade);
          b.innerHTML+=`<tr><td>${e.store}</td><td><span class='badge' style='${gradeStyle}'>${grade}</span></td><td class='fw-bold'>${e.name}</td><td>${e.nick||'-'}</td><td>${e.nation||'-'}</td><td>${age}ì„¸</td><td><span class='badge bg-info text-dark'>${e.role}</span></td><td class='text-end'>${Number(e.salAmt).toLocaleString()}</td><td><button class='btn btn-sm btn-primary' onclick='editEmp(${idx})'>${txtEdit}</button> <button class='btn btn-sm btn-danger' onclick='delEmp(${e.row})'>${txtDel}</button></td></tr>`; 
      }); 
  }
  function updateEmpFormPhoto() {
      var inp = document.getElementById("emp-photo");
      var img = document.getElementById("emp-form-photo-img");
      if (!inp || !img) return;
      var v = (inp.value || "").trim();
      if (v) { img.src = v; img.style.display = "block"; img.onerror = function() { img.style.display = "none"; }; } else { img.src = ""; img.style.display = "none"; }
  }
  function saveEmployee() { 
      var d={ row:document.getElementById("emp-row").value, store:document.getElementById("emp-store").value, name:document.getElementById("emp-name").value, nick:document.getElementById("emp-nick").value, job:document.getElementById("emp-job").value, phone:document.getElementById("emp-phone").value, email:document.getElementById("emp-email").value, birth:document.getElementById("emp-birth").value, nation:document.getElementById("emp-nation").value, join:document.getElementById("emp-date").value, resign:document.getElementById("emp-resign").value, salType:document.getElementById("emp-sal-type").value, salAmt:document.getElementById("emp-sal-amt").value, pw:document.getElementById("emp-pw").value, role:document.getElementById("emp-role").value, annualLeaveDays:document.getElementById("emp-annual-leave")?document.getElementById("emp-annual-leave").value:15, bankName:document.getElementById("emp-bank-name")?document.getElementById("emp-bank-name").value:"", accountNumber:document.getElementById("emp-account-number")?document.getElementById("emp-account-number").value:"", positionAllowance:document.getElementById("emp-position-allowance")?document.getElementById("emp-position-allowance").value:0, grade:document.getElementById("emp-grade")?document.getElementById("emp-grade").value:"", photo:document.getElementById("emp-photo")?document.getElementById("emp-photo").value:"" }; 
      if(!d.name) return; load(1); google.script.run.withSuccessHandler(function(r){load(0);alert(r);loadEmployeeList(function(){filterEmpList();});}).saveAdminEmployee(d, typeof userStore !== "undefined" ? userStore : "", typeof userRole !== "undefined" ? userRole : ""); 
  }
  function editEmp(i) { var e=employeeCache[i]; document.getElementById("emp-row").value=e.row; document.getElementById("emp-store").value=e.store; document.getElementById("emp-name").value=e.name; document.getElementById("emp-nick").value=e.nick; document.getElementById("emp-phone").value=e.phone; document.getElementById("emp-job").value=e.job; document.getElementById("emp-birth").value=e.birth; document.getElementById("emp-nation").value=e.nation; document.getElementById("emp-email").value=e.email; document.getElementById("emp-date").value=e.join; document.getElementById("emp-resign").value=e.resign; document.getElementById("emp-sal-type").value=e.salType; document.getElementById("emp-sal-amt").value=e.salAmt; document.getElementById("emp-pw").value=e.pw; document.getElementById("emp-role").value=e.role; var a=document.getElementById("emp-annual-leave"); if(a) a.value=(e.annualLeaveDays!=null&&e.annualLeaveDays!=="")?e.annualLeaveDays:15; var bn=document.getElementById("emp-bank-name"); if(bn) bn.value=e.bankName||""; var ac=document.getElementById("emp-account-number"); if(ac) ac.value=e.accountNumber||""; var pa=document.getElementById("emp-position-allowance"); if(pa) pa.value=(e.positionAllowance!=null)?e.positionAllowance:0; var g=document.getElementById("emp-grade"); if(g) g.value=(e.grade!=null&&String(e.grade).trim())?String(e.grade).trim():""; var ph=document.getElementById("emp-photo"); if(ph) ph.value=e.photo||""; if(typeof updateEmpFormPhoto==="function") updateEmpFormPhoto(); }
  function delEmp(r) { var msg = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].confirm_delete) ? I18N[currentLang].confirm_delete : "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; if(confirm(msg)){load(1);google.script.run.withSuccessHandler(function(res){load(0);alert(res);loadEmployeeList(function(){filterEmpList();});}).deleteAdminEmployee(r, typeof userStore !== "undefined" ? userStore : "", typeof userRole !== "undefined" ? userRole : "");} }
  function createNewEmployee() { document.querySelectorAll('#hr-employee-section input').forEach(i=>i.value=""); document.getElementById("emp-row").value="0"; var ph=document.getElementById("emp-photo"); if(ph) ph.value=""; var a=document.getElementById("emp-annual-leave"); if(a) a.value="15"; var g=document.getElementById("emp-grade"); if(g) g.value=""; var pa=document.getElementById("emp-position-allowance"); if(pa) pa.value="0"; if(typeof updateEmpFormPhoto==="function") updateEmpFormPhoto(); }

/* ----- ì§ì› ê´€ë¦¬: 5ê°œ íƒ­ (ì§ì› ëª©ë¡ / ì§ì› í‰ê°€ / í‰ê°€ ëª©ë¡ / ì£¼ë°© í•­ëª© ì„¤ì • / ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •) ----- */
function showHrEmployeeTab(t) {
  var listPanel = document.getElementById("hr-emp-tab-list");
  var evalPanel = document.getElementById("eval-type-eval");
  var evalListPanel = document.getElementById("eval-type-list");
  var kitchenPanel = document.getElementById("eval-type-kitchen-setting");
  var servicePanel = document.getElementById("eval-type-service-setting");
  if (listPanel) listPanel.style.display = (t === "list") ? "block" : "none";
  if (evalPanel) evalPanel.style.display = (t === "eval") ? "block" : "none";
  if (evalListPanel) evalListPanel.style.display = (t === "eval-list") ? "block" : "none";
  if (kitchenPanel) kitchenPanel.style.display = (t === "kitchen-setting") ? "block" : "none";
  if (servicePanel) servicePanel.style.display = (t === "service-setting") ? "block" : "none";
  var navIds = ["hr-emp-nav-list", "hr-emp-nav-eval", "hr-emp-nav-eval-list", "hr-emp-nav-kitchen-setting", "hr-emp-nav-service-setting"];
  var tabValues = ["list", "eval", "eval-list", "kitchen-setting", "service-setting"];
  navIds.forEach(function(id, idx) {
    var el = document.getElementById(id);
    if (el) el.classList.toggle("active", tabValues[idx] === t);
  });
  if (t === "list") {
    var b = document.getElementById("emp-list-body");
    var hint = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].emp_search_hint) ? I18N[currentLang].emp_search_hint : "ë§¤ì¥Â·ë“±ê¸‰ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ë¦„ì„ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
    if (b) b.innerHTML = "<tr><td colspan='8' class='text-center p-5 text-muted'>ğŸ” " + hint + "</td></tr>";
  }
  if (t === "eval") {
    var evalInsp = document.getElementById("eval-evaluator");
    if (evalInsp) {
      var loginName = (typeof userName !== "undefined" && userName) ? userName : (typeof sessionStorage !== "undefined" && sessionStorage.getItem("cm_name")) || "";
      if (!loginName) {
        var uInfo = document.getElementById("u-info");
        if (uInfo && uInfo.innerText) loginName = uInfo.innerText.trim().split(/\s+/).pop() || uInfo.innerText.trim();
      }
      evalInsp.value = loginName || "";
    }
    var evalDate = document.getElementById("eval-date");
    if (evalDate && !evalDate.value) evalDate.valueAsDate = new Date();
    var evalStore = document.getElementById("eval-store");
    if (evalStore && typeof loadStoreOptions === "function" && (!evalStore.options || evalStore.options.length <= 1)) loadStoreOptions("eval-store");
    fillEvalEmployeeOptions();
  }
  if (t === "eval-list") {
    var startEl = document.getElementById("eval-list-start");
    var endEl = document.getElementById("eval-list-end");
    if (startEl && !startEl.value) {
      var d = new Date();
      var y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, "0");
      startEl.value = y + "-" + m + "-01";
      endEl.value = y + "-" + m + "-" + String(d.getDate()).padStart(2, "0");
    }
    var storeSel = document.getElementById("eval-list-store");
    if (storeSel && typeof loadStoreOptions === "function") {
      if (storeSel.options.length <= 1) storeSel.classList.remove("loaded");
      loadStoreOptions("eval-list-store");
    }
    loadEvaluationHistory();
  }
  if (t === "kitchen-setting") loadEvaluationSettings("kitchen");
  if (t === "service-setting") loadEvaluationSettings("service");
}
function getEvalType() {
  var sel = document.getElementById("eval-type-select");
  return (sel && sel.value) ? sel.value : "kitchen";
}
function showEvalTypeTab(type) {
  if (type === "eval") showHrEmployeeTab("eval");
  else if (type === "list") showHrEmployeeTab("eval-list");
  else if (type === "kitchen-setting") showHrEmployeeTab("kitchen-setting");
  else if (type === "service-setting") showHrEmployeeTab("service-setting");
}
function fillEvalEmployeeOptions() {
  var storeSel = document.getElementById("eval-store");
  var empSel = document.getElementById("eval-employee");
  if (!storeSel || !empSel) return;
  var store = storeSel.value;
  empSel.innerHTML = "<option value=\"\">ì§ì› ì„ íƒ</option>";
  if (!store || store === "All" || !employeeCache || !employeeCache.length) { updateEvalEmployeePhoto(); return; }
  var list = employeeCache.filter(function(e) { return String(e.store || "") === String(store); });
  list.forEach(function(e) { empSel.add(new Option(e.name || "", e.name || "")); });
  updateEvalEmployeePhoto();
}
function updateEvalEmployeePhoto() {
  var empSel = document.getElementById("eval-employee");
  var img = document.getElementById("eval-employee-photo");
  var wrap = document.getElementById("eval-employee-photo-wrap");
  if (!empSel || !img) return;
  var name = (empSel.value || "").trim();
  var storeSel = document.getElementById("eval-store");
  var store = storeSel ? (storeSel.value || "").trim() : "";
  if (!name || !store || !employeeCache || !employeeCache.length) { img.style.display = "none"; img.src = ""; if (wrap) wrap.title = ""; return; }
  var emp = employeeCache.find(function(e) { return String(e.store || "") === store && String(e.name || "") === name; });
  if (emp && emp.photo && String(emp.photo).trim()) { img.src = emp.photo; img.style.display = "block"; img.onerror = function() { img.style.display = "none"; }; if (wrap) wrap.title = emp.name || ""; } else { img.src = ""; img.style.display = "none"; if (wrap) wrap.title = ""; }
}
var EVAL_INCIDENT_TYPES = ["ë°˜ë³µ ê³¼ë‹¤ ì†ŒìŠ¤", "ìœ„ìƒ ê´€ë ¨ ì´ë ¥", "ê³ ê° ê´€ë ¨", "ê°œì„  ì—†ìŒ", "ì•ˆì „ ì‚¬ê³ (í™”ìƒ/ë¯¸ë„ëŸ¼/ë‚™ìƒ ë“±)"];
var EVAL_WEIGHTS = { "ë©”ë‰´ìˆ™ë ¨": 0.4, "ì›ê°€ì •í™•ë„": 0.2, "ìœ„ìƒ": 0.2, "íƒœë„": 0.2 };
var EVAL_GRADE_CUT = [4.8, 4.5, 4.0, 3.0];
var EVAL_GRADE_LABEL = ["S", "A", "B", "C", "F"];

function scoreToGrade(score) {
  var s = parseFloat(score);
  for (var i = 0; i < EVAL_GRADE_CUT.length; i++) { if (s >= EVAL_GRADE_CUT[i]) return EVAL_GRADE_LABEL[i]; }
  return EVAL_GRADE_LABEL[EVAL_GRADE_LABEL.length - 1];
}
function updateEvalTotals() {
  var rows = document.querySelectorAll(".eval-row");
  var sums = {}, counts = {};
  rows.forEach(function(row) {
    var section = row.getAttribute("data-main") || "";
    if (!section) return;
    var sel = row.querySelector(".eval-score-select");
    var v = sel ? parseInt(sel.value, 10) : 0;
    if (isNaN(v)) v = 0;
    sums[section] = (sums[section] || 0) + v;
    counts[section] = (counts[section] || 0) + 1;
  });
  var menuAvg = counts["ë©”ë‰´ìˆ™ë ¨"] ? sums["ë©”ë‰´ìˆ™ë ¨"] / counts["ë©”ë‰´ìˆ™ë ¨"] : 0;
  var costAvg = counts["ì›ê°€ì •í™•ë„"] ? sums["ì›ê°€ì •í™•ë„"] / counts["ì›ê°€ì •í™•ë„"] : 0;
  var hygieneAvg = counts["ìœ„ìƒ"] ? sums["ìœ„ìƒ"] / counts["ìœ„ìƒ"] : 0;
  var attitudeAvg = counts["íƒœë„"] ? sums["íƒœë„"] / counts["íƒœë„"] : 0;
  var serviceAvgForSection = counts["ì„œë¹„ìŠ¤"] ? sums["ì„œë¹„ìŠ¤"] / counts["ì„œë¹„ìŠ¤"] : 0;
  document.querySelectorAll(".eval-section-avg").forEach(function(span) {
    var sec = span.getAttribute("data-section");
    var avg = sec === "ë©”ë‰´ìˆ™ë ¨" ? menuAvg : sec === "ì›ê°€ì •í™•ë„" ? costAvg : sec === "ìœ„ìƒ" ? hygieneAvg : sec === "íƒœë„" ? attitudeAvg : sec === "ì„œë¹„ìŠ¤" ? serviceAvgForSection : 0;
    span.textContent = avg > 0 ? avg.toFixed(2) : "-";
  });
  var serviceAvg = counts["ì„œë¹„ìŠ¤"] ? sums["ì„œë¹„ìŠ¤"] / counts["ì„œë¹„ìŠ¤"] : 0;
  var total;
  if (counts["ì„œë¹„ìŠ¤"] !== undefined && counts["ì„œë¹„ìŠ¤"] > 0) {
    total = serviceAvg;
  } else {
    total = menuAvg * EVAL_WEIGHTS["ë©”ë‰´ìˆ™ë ¨"] + costAvg * EVAL_WEIGHTS["ì›ê°€ì •í™•ë„"] + hygieneAvg * EVAL_WEIGHTS["ìœ„ìƒ"] + attitudeAvg * EVAL_WEIGHTS["íƒœë„"];
  }
  var grade = (menuAvg || costAvg || hygieneAvg || attitudeAvg || serviceAvg) ? scoreToGrade(total) : "-";
  var totalEl = document.getElementById("eval-total-score");
  var gradeSel = document.getElementById("eval-final-grade");
  if (totalEl) totalEl.textContent = total > 0 ? total.toFixed(2) : "-";
  if (gradeSel && grade !== "-") { gradeSel.value = grade; }
}
function updateEvalGradeDisplay() {}

function fillEvalIncidents() {
  var tbody = document.getElementById("eval-incidents-body");
  if (!tbody) return;
  var html = "";
  EVAL_INCIDENT_TYPES.forEach(function(label) {
    html += buildEvalIncidentRow(label);
  });
  html += "<tr><td colspan=\"5\" class=\"text-end\"><button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"addEvalIncidentRow()\">+ í–‰ ì¶”ê°€</button></td></tr>";
  tbody.innerHTML = html;
}
function buildEvalIncidentRow(typeLabel) {
  var esc = function(s) { return String(s != null && s !== undefined ? s : "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\"/g, "&quot;"); };
  var opts = EVAL_INCIDENT_TYPES.map(function(l) {
    return "<option value=\"" + esc(l) + "\"" + (l === typeLabel ? " selected" : "") + ">" + (l || "") + "</option>";
  }).join("");
  opts += "<option value=\"__ê¸°íƒ€__\">ê¸°íƒ€(ì§ì ‘ì…ë ¥)</option>";
  return "<tr class=\"eval-incident-row\">" +
    "<td><select class=\"form-select form-select-sm eval-incident-type\" onchange=\"var o=this.nextElementSibling;if(o)o.style.display=this.value==='__ê¸°íƒ€__'?'block':'none';\">" + opts + "</select><input type=\"text\" class=\"form-control form-control-sm mt-1 eval-incident-type-other\" placeholder=\"ê¸°íƒ€ ìœ í˜•\" style=\"display:none;\"></td>" +
    "<td><select class=\"form-select form-select-sm eval-incident-occured\"><option value=\"No\">No</option><option value=\"Yes\">Yes</option></select></td>" +
    "<td><input type=\"date\" class=\"form-control form-control-sm eval-incident-date\"></td>" +
    "<td><input type=\"text\" class=\"form-control form-control-sm eval-incident-details\" placeholder=\"ìƒì„¸\"></td>" +
    "<td style=\"width:50px;\"><button type=\"button\" class=\"btn btn-sm btn-outline-danger\" onclick=\"removeEvalIncidentRow(this)\" title=\"ì‚­ì œ\">Ã—</button></td></tr>";
}
function addEvalIncidentRow() {
  var tbody = document.getElementById("eval-incidents-body");
  if (!tbody) return;
  var addRow = tbody.querySelector("tr:last-child");
  var html = buildEvalIncidentRow(EVAL_INCIDENT_TYPES[0]);
  var tmp = document.createElement("tbody");
  tmp.innerHTML = html;
  var newTr = tmp.querySelector("tr");
  if (!newTr) return;
  if (addRow) tbody.insertBefore(newTr, addRow);
  else tbody.appendChild(newTr);
  var sel = newTr.querySelector(".eval-incident-type");
  var other = newTr.querySelector(".eval-incident-type-other");
  if (sel && other) sel.addEventListener("change", function() { other.style.display = (sel.value === "__ê¸°íƒ€__") ? "block" : "none"; });
}
function removeEvalIncidentRow(btn) {
  var row = btn && btn.closest ? btn.closest("tr") : null;
  if (row && row.classList.contains("eval-incident-row")) row.remove();
}

/** ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°: í‰ê°€ ìœ í˜•(ì£¼ë°© ì§ì› â†’ ì£¼ë°© í•­ëª© ì„¤ì •, ì„œë¹„ìŠ¤ ì§ì› â†’ ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •)ì— ë”°ë¼ í•´ë‹¹ ì‹œíŠ¸ í•­ëª©ì„ ë¶ˆëŸ¬ì˜´ */
function loadEvaluationForm(type) {
  var container = document.getElementById("eval-sections-container");
  if (!container) return;
  type = type || getEvalType();
  if (!type) type = "kitchen";
  var extraKitchen = document.getElementById("eval-extra-kitchen");
  if (extraKitchen) extraKitchen.style.display = "block"; /* ì£¼ë°©Â·ì„œë¹„ìŠ¤ ëª¨ë‘ 6)7) í‘œì‹œ */
  var weightLine = document.querySelector(".eval-weight-line");
  if (weightLine) weightLine.style.display = (type === "kitchen") ? "block" : "none";
  container.innerHTML = "<p class=\"text-center py-3\">â³ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
  var loadTimeout = setTimeout(function() {
    if (container.innerHTML.indexOf("ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘") !== -1) {
      container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì‹œíŠ¸(í‰ê°€í•­ëª©_ì£¼ë°©/í‰ê°€í•­ëª©_ì„œë¹„ìŠ¤)ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>";
    }
  }, 25000);
  google.script.run
    .withSuccessHandler(function(items) {
      clearTimeout(loadTimeout);
      try {
        if (!container) return;
        container.innerHTML = "";
        if (!items || !Array.isArray(items)) items = [];
        if (items.length === 0) {
          var hint = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_no_items_hint) ? I18N[currentLang].eval_no_items_hint : "ë“±ë¡ëœ í‰ê°€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. [ì£¼ë°© í•­ëª© ì„¤ì •] ë˜ëŠ” [ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •] íƒ­ì—ì„œ í•­ëª© ë¶ˆëŸ¬ì˜¤ê¸° í›„ ì €ì¥í•˜ì„¸ìš”.";
          container.innerHTML = "<p class=\"text-center text-muted\">" + hint + "</p>";
          fillEvalIncidents();
          return;
        }
        var bySection = {};
        items.forEach(function(item) {
          var sec = (item && item.main != null) ? String(item.main).trim() : "";
          if (!bySection[sec]) bySection[sec] = [];
          bySection[sec].push(item);
        });
        var sectionOrder = type === "service" ? ["ì„œë¹„ìŠ¤"] : ["ë©”ë‰´ìˆ™ë ¨", "ì›ê°€ì •í™•ë„", "ìœ„ìƒ", "íƒœë„"];
        var sectionTitles = type === "service" ? { "ì„œë¹„ìŠ¤": "ì„œë¹„ìŠ¤ í‰ê°€ í•­ëª© (1-5)" } : { "ë©”ë‰´ìˆ™ë ¨": "2) ë©”ë‰´ ìˆ™ë ¨ (1-5)", "ì›ê°€ì •í™•ë„": "3) ì¡°ë¦¬ ì •í™•ë„Â·ì›ê°€ ê´€ë¦¬ (1-5)", "ìœ„ìƒ": "4) ìœ„ìƒÂ·ì‘ì—… ìŠµê´€ (1-5)", "íƒœë„": "5) íƒœë„Â·í”¼í¬íƒ€ì„ ìˆ˜í–‰ (1-5)" };
        var fullHtml = "";
        sectionOrder.forEach(function(sec) {
          var list = bySection[sec];
          if (!list || list.length === 0) return;
          var card = "<div class=\"card-box mb-3\"><h6 class=\"fw-bold border-bottom pb-2\">" + (sectionTitles[sec] || sec) + "</h6><div class=\"table-responsive\"><table class=\"table table-sm table-bordered align-middle mb-0\"><thead class=\"table-light\"><tr class=\"text-center\">";
          if (sec === "ë©”ë‰´ìˆ™ë ¨") card += "<th>NO</th><th>Category</th><th>Menu Item</th><th>Score(1-5)</th><th>Solo OK</th><th>Peak OK</th><th>Can Train</th><th>Notes</th></tr></thead><tbody>";
          else card += "<th>NO</th><th>í‰ê°€ í•­ëª©</th><th>Score(1-5)</th><th>Notes</th></tr></thead><tbody>";
          list.forEach(function(item) {
            var esc = function(s) { return String(s != null && s !== undefined ? s : "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\"/g, "&quot;"); };
            var id = item && (item.id != null) ? item.id : "";
            var main = item && (item.main != null) ? String(item.main) : "";
            var sub = item && (item.sub != null) ? String(item.sub) : "";
            var name = item && (item.name != null) ? String(item.name) : "";
            var scoreOpts = "<option value=\"1\">1</option><option value=\"2\">2</option><option value=\"3\">3</option><option value=\"4\">4</option><option value=\"5\" selected>5</option>";
            if (sec === "ë©”ë‰´ìˆ™ë ¨" && type === "kitchen") {
              card += "<tr class=\"eval-row\" data-id=\"" + esc(id) + "\" data-main=\"" + esc(main) + "\" data-sub=\"" + esc(sub) + "\" data-name=\"" + esc(name) + "\">" +
                "<td class=\"text-center fw-bold bg-light\">" + esc(id) + "</td><td>" + esc(sub) + "</td><td class=\"text-start\">" + esc(name) + "</td>" +
                "<td class=\"text-center\"><select class=\"form-select form-select-sm eval-score-select\" onchange=\"updateEvalTotals()\">" + scoreOpts + "</select></td>" +
                "<td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-solo-ok\"></td><td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-peak-ok\"></td><td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-can-train\"></td>" +
                "<td><input type=\"text\" class=\"form-control form-control-sm eval-remark\" placeholder=\"ë¹„ê³ \"></td></tr>";
            } else {
              card += "<tr class=\"eval-row\" data-id=\"" + esc(id) + "\" data-main=\"" + esc(main) + "\" data-sub=\"" + esc(sub) + "\" data-name=\"" + esc(name) + "\">" +
                "<td class=\"text-center fw-bold bg-light\">" + esc(id) + "</td><td class=\"text-start\">" + esc(name) + "</td>" +
                "<td class=\"text-center\"><select class=\"form-select form-select-sm eval-score-select\" onchange=\"updateEvalTotals()\">" + scoreOpts + "</select></td>" +
                "<td><input type=\"text\" class=\"form-control form-control-sm eval-remark\" placeholder=\"ë¹„ê³ \"></td></tr>";
            }
          });
          card += "</tbody></table></div><p class=\"small mb-0 mt-1\">" + sec + " í‰ê· : <span class=\"eval-section-avg\" data-section=\"" + sec + "\">-</span></p></div>";
          fullHtml += card;
        });
        container.innerHTML = fullHtml;
        fillEvalIncidents();
        updateEvalTotals();
      } catch (e) {
        if (container) container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || "") + "</p>";
        console.error("loadEvaluationForm success handler error:", e);
      }
    })
    .withFailureHandler(function(err) {
      clearTimeout(loadTimeout);
      if (container) container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‹œíŠ¸(í‰ê°€í•­ëª©_ì£¼ë°©/í‰ê°€í•­ëª©_ì„œë¹„ìŠ¤)ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>";
      console.error("getEvaluationItems error:", err);
    })
    .getEvaluationItems(type, true);
}
function saveEvaluationResult(type) {
  var store = document.getElementById("eval-store").value;
  var employee = document.getElementById("eval-employee").value;
  var date = document.getElementById("eval-date").value;
  var evaluator = document.getElementById("eval-evaluator").value;
  var finalGrade = document.getElementById("eval-final-grade").value;
  var memo = document.getElementById("eval-total-memo").value;
  var id = document.getElementById("eval-id").value;
  if (!store || !employee || !date) { alert("ë§¤ì¥, ì§ì›, í‰ê°€ì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  var isService = (type === "service");
  var sections = { menu: [], cost: [], hygiene: [], attitude: [] };
  var sectionKey = { "ë©”ë‰´ìˆ™ë ¨": "menu", "ì›ê°€ì •í™•ë„": "cost", "ìœ„ìƒ": "hygiene", "íƒœë„": "attitude", "ì„œë¹„ìŠ¤": "menu" };
  var rowContainer = document.getElementById("eval-sections-container");
  var rowSelector = rowContainer ? rowContainer.querySelectorAll(".eval-row") : document.querySelectorAll(".eval-row");
  [].forEach.call(rowSelector || [], function(row) {
    var rId = row.getAttribute("data-id");
    var main = row.getAttribute("data-main");
    var sub = row.getAttribute("data-sub");
    var name = row.getAttribute("data-name");
    var scoreSel = row.querySelector(".eval-score-select");
    var score = scoreSel ? scoreSel.value : "5";
    var remark = row.querySelector(".eval-remark");
    var note = remark ? remark.value : "";
    var rec = { id: rId, main: main, sub: sub, name: name, score: score, notes: note };
    if (main === "ë©”ë‰´ìˆ™ë ¨") {
      var solo = row.querySelector(".eval-solo-ok");
      var peak = row.querySelector(".eval-peak-ok");
      var train = row.querySelector(".eval-can-train");
      rec.soloOK = solo ? solo.checked : false;
      rec.peakOK = peak ? peak.checked : false;
      rec.canTrain = train ? train.checked : false;
    }
    var key = sectionKey[main];
    if (key && sections[key]) sections[key].push(rec);
  });
  var incidents = [];
  document.querySelectorAll(".eval-incident-row").forEach(function(row) {
    var typeSel = row.querySelector(".eval-incident-type");
    var typeOther = row.querySelector(".eval-incident-type-other");
    var typeLabel = typeSel ? (typeSel.value === "__ê¸°íƒ€__" && typeOther ? typeOther.value : typeSel.value) : "";
    if (!typeLabel) return;
    var occ = row.querySelector(".eval-incident-occured");
    var dt = row.querySelector(".eval-incident-date");
    var det = row.querySelector(".eval-incident-details");
    incidents.push({ type: typeLabel, occurred: occ ? occ.value : "No", date: dt ? dt.value : "", details: det ? det.value : "" });
  });
  var actionPlan = {
    trainingNeeded: document.getElementById("eval-training-needed") ? document.getElementById("eval-training-needed").value : "",
    coach: document.getElementById("eval-coach") ? document.getElementById("eval-coach").value : "",
    targetDate: document.getElementById("eval-target-date") ? document.getElementById("eval-target-date").value : "",
    reEvalDate: document.getElementById("eval-reeval-date") ? document.getElementById("eval-reeval-date").value : ""
  };
  var totalScoreEl = document.getElementById("eval-total-score");
  var totalScore = totalScoreEl && totalScoreEl.textContent !== "-" ? parseFloat(totalScoreEl.textContent) : 0;
  var payload = { sections: sections, incidents: incidents, actionPlan: actionPlan, totalScore: totalScore, grade: finalGrade };
  if (confirm("í‰ê°€ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    if (typeof load === "function") load(1);
    google.script.run.withSuccessHandler(function(res) {
      if (typeof load === "function") load(0);
      alert(res === "UPDATED" ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      document.getElementById("eval-id").value = "";
      document.getElementById("eval-total-memo").value = "";
      document.getElementById("eval-training-needed").value = "";
      document.getElementById("eval-coach").value = "";
      var td = document.getElementById("eval-target-date"); if (td) td.value = "";
      var rd = document.getElementById("eval-reeval-date"); if (rd) rd.value = "";
      if (typeof loadEmployeeList === "function") loadEmployeeList();
    }).saveEvaluationResult(type, id, date, store, employee, evaluator, finalGrade, memo, JSON.stringify(payload));
  }
}
function loadEvaluationHistory() {
  var typeEl = document.getElementById("eval-list-type");
  var startEl = document.getElementById("eval-list-start");
  var endEl = document.getElementById("eval-list-end");
  var storeEl = document.getElementById("eval-list-store");
  var empEl = document.getElementById("eval-list-employee");
  var evalEl = document.getElementById("eval-list-evaluator");
  var tbody = document.getElementById("eval-history-tbody");
  var countEl = document.getElementById("eval-history-count");
  if (!tbody) return;
  var type = typeEl ? typeEl.value : "kitchen";
  var start = startEl ? startEl.value : "";
  var end = endEl ? endEl.value : "";
  var store = storeEl ? storeEl.value : "All";
  var employee = empEl ? empEl.value : "All";
  var evaluator = evalEl ? evalEl.value : "All";
  var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
  var loadingTxt = lang.eval_list_loading || "ì¡°íšŒ ì¤‘...";
  var noDataTxt = lang.eval_list_no_data || "ì¡°íšŒëœ í‰ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
  var countSuffix = lang.eval_list_count || "ê±´";
  var failTxt = lang.eval_list_fail || "ì¡°íšŒ ì‹¤íŒ¨. ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
  var viewTxt = lang.eval_list_btn_view || "ë³´ê¸°";
  tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4\">â³ " + loadingTxt + "</td></tr>";
  google.script.run
    .withSuccessHandler(function(list) {
      tbody.innerHTML = "";
      if (!list || list.length === 0) {
        tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4 text-muted\">" + noDataTxt + "</td></tr>";
        if (countEl) countEl.textContent = "0" + countSuffix;
        return;
      }
      window.evalHistoryList = list;
      var employees = {}, evaluators = {};
      list.forEach(function(r) {
        if (r.employeeName) employees[r.employeeName] = true;
        if (r.evaluator) evaluators[r.evaluator] = true;
      });
      if (empEl && empEl.options.length <= 1) {
        Object.keys(employees).sort().forEach(function(name) { empEl.add(new Option(name, name)); });
      }
      if (evalEl && evalEl.options.length <= 1) {
        Object.keys(evaluators).sort().forEach(function(name) { evalEl.add(new Option(name, name)); });
      }
      list.forEach(function(r, idx) {
        var memoShort = (r.memo || "").substring(0, 30);
        if ((r.memo || "").length > 30) memoShort += "â€¦";
        var row = "<tr><td>" + (r.date || "") + "</td><td class=\"fw-bold\">" + (r.store || "") + "</td><td>" + (r.employeeName || "") + "</td><td>" + (r.evaluator || "") + "</td><td class=\"text-center\">" + (r.totalScore || "-") + "</td><td><span class=\"badge bg-primary\">" + (r.finalGrade || "-") + "</span></td><td class=\"small text-muted\">" + (memoShort || "-") + "</td><td><button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"openEvalDetailModal(" + idx + ")\">" + viewTxt + "</button></td></tr>";
        tbody.innerHTML += row;
      });
      if (countEl) countEl.textContent = list.length + countSuffix;
    })
    .withFailureHandler(function() {
      tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4 text-danger\">" + failTxt + "</td></tr>";
      if (countEl) countEl.textContent = "";
    })
    .getEvaluationHistory(type, start, end, store, employee, evaluator);
}
function openEvalDetailModal(idx) {
  var list = window.evalHistoryList;
  if (!list || !list[idx]) return;
  var r = list[idx];
  var modal = document.getElementById("evalDetailModal");
  if (!modal) return;
  document.getElementById("eval-detail-title").textContent = (r.store || "") + " / " + (r.employeeName || "") + " (" + (r.date || "") + ")";
  document.getElementById("eval-detail-meta").innerHTML = "í‰ê°€ì: <strong>" + (r.evaluator || "-") + "</strong> &nbsp;|&nbsp; ë“±ê¸‰: <span class=\"badge bg-primary\">" + (r.finalGrade || "-") + "</span> &nbsp;|&nbsp; ì´ì : " + (r.totalScore || "-");
  document.getElementById("eval-detail-memo").textContent = r.memo || "(ì—†ìŒ)";
  var body = document.getElementById("eval-detail-body");
  body.innerHTML = "";
  var jsonData = r.jsonData;
  if (jsonData) {
    try {
      var data = typeof jsonData === "string" ? JSON.parse(jsonData) : jsonData;
      if (data && data.sections) {
        var html = "<p class=\"fw-bold mb-2\">ì´ì : " + (data.totalScore != null ? data.totalScore : "-") + "</p><table class=\"table table-sm table-bordered\"><thead class=\"table-light\"><tr><th>ëŒ€ë¶„ë¥˜</th><th>í•­ëª©</th><th>ì ìˆ˜</th><th>ë¹„ê³ </th></tr></thead><tbody>";
        ["menu", "cost", "hygiene", "attitude"].forEach(function(key) {
          var arr = data.sections[key];
          if (!arr || !arr.length) return;
          arr.forEach(function(item) {
            html += "<tr><td>" + (item.main || "") + "</td><td>" + (item.name || item.sub || "") + "</td><td>" + (item.score || "") + "</td><td class=\"small\">" + (item.notes || "") + "</td></tr>";
          });
        });
        html += "</tbody></table>";
        body.innerHTML = html;
      } else {
        body.textContent = JSON.stringify(data).substring(0, 500) + (JSON.stringify(data).length > 500 ? "â€¦" : "");
      }
    } catch (e) {
      body.textContent = "ìƒì„¸ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    }
  } else {
    body.textContent = "ì €ì¥ëœ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
  if (modal.parentNode !== document.body) document.body.appendChild(modal);
  try {
    var inst = bootstrap.Modal.getOrCreateInstance(modal);
    inst.show();
  } catch (e) {
    modal.style.display = "block";
    modal.classList.add("show");
  }
}
function loadEvaluationSettings(type) {
  var tbodyId = type === "service" ? "eval-setting-list-body-service" : "eval-setting-list-body";
  google.script.run.withSuccessHandler(function(items) {
    var tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!items || items.length === 0) { tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ì €ì¥ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</td></tr>"; return; }
    items.forEach(function(item) {
      var checked = item.use ? "checked" : "";
      var mainVal = (item.main || "").replace(/"/g, "&quot;");
      var subVal = (item.sub || "").replace(/"/g, "&quot;");
      var nameVal = (item.name || "").replace(/"/g, "&quot;");
      tbody.innerHTML += "<tr><td>" + item.id + "</td><td><input class=\"form-control form-control-sm\" value=\"" + mainVal + "\" readonly></td><td><input class=\"form-control form-control-sm\" value=\"" + subVal + "\" readonly></td><td><input class=\"form-control form-control-sm eval-set-name\" value=\"" + nameVal + "\"></td><td><input type=\"checkbox\" class=\"form-check-input eval-set-use\" data-id=\"" + item.id + "\" " + checked + "></td><td><button type=\"button\" class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteEvalItem('" + type + "', '" + item.id + "')\">ì‚­ì œ</button></td></tr>";
    });
  }).getEvaluationItems(type, false);
}
function saveEvaluationSettings(type) {
  var tbodyId = type === "service" ? "eval-setting-list-body-service" : "eval-setting-list-body";
  var tbody = document.getElementById(tbodyId);
  if (!tbody) return;
  var updates = [];
  tbody.querySelectorAll("tr").forEach(function(tr) {
    var useEl = tr.querySelector(".eval-set-use");
    var nameEl = tr.querySelector(".eval-set-name");
    if (useEl && nameEl) updates.push({ id: useEl.getAttribute("data-id"), name: nameEl.value, use: useEl.checked });
  });
  if (!updates.length) { alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  google.script.run.withSuccessHandler(function(res) { alert("í•­ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadEvaluationSettings(type); }).updateEvaluationItems(type, updates);
}

function addEvalItemRow(type) {
  var mainCat = type === "service" ? "ì„œë¹„ìŠ¤" : "";
  var subCat = "";
  var itemName = "";
  if (type === "kitchen") {
    mainCat = prompt("ëŒ€ë¶„ë¥˜ (ë©”ë‰´ìˆ™ë ¨ / ì›ê°€ì •í™•ë„ / ìœ„ìƒ / íƒœë„)", "ë©”ë‰´ìˆ™ë ¨") || "ë©”ë‰´ìˆ™ë ¨";
    subCat = prompt("ì¤‘ë¶„ë¥˜ (ë©”ë‰´ ì¹´í…Œê³ ë¦¬ ë“±, ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°)", "");
    itemName = prompt("í‰ê°€ í•­ëª© ì´ë¦„", "(ìƒˆ í•­ëª©)") || "(ìƒˆ í•­ëª©)";
  } else {
    itemName = prompt("í‰ê°€ í•­ëª© ì´ë¦„", "(ìƒˆ í•­ëª©)") || "(ìƒˆ í•­ëª©)";
  }
  if (!itemName) return;
  if (typeof load === "function") load(1);
  var addOk = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_add_item_ok) ? I18N[currentLang].eval_add_item_ok : "í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.";
  var addErr = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_add_item_error) ? I18N[currentLang].eval_add_item_error : "í•­ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  google.script.run.withSuccessHandler(function(res) {
    if (typeof load === "function") load(0);
    if (res === "SUCCESS") { alert(addOk); loadEvaluationSettings(type); }
    else alert(res || "ì¶”ê°€ ì‹¤íŒ¨");
  }).withFailureHandler(function() { if (typeof load === "function") load(0); alert(addErr); }).addEvaluationItem(type, mainCat, subCat, itemName);
}

function deleteEvalItem(type, id) {
  var confirmMsg = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_delete_confirm) ? I18N[currentLang].eval_delete_confirm : "ì´ í‰ê°€ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
  if (!confirm(confirmMsg)) return;
  var delOk = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_delete_ok) ? I18N[currentLang].eval_delete_ok : "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
  var delErr = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].eval_delete_error) ? I18N[currentLang].eval_delete_error : "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  if (typeof load === "function") load(1);
  google.script.run.withSuccessHandler(function(res) {
    if (typeof load === "function") load(0);
    if (res === "SUCCESS") { alert(delOk); loadEvaluationSettings(type); }
    else alert(res || "ì‚­ì œ ì‹¤íŒ¨");
  }).withFailureHandler(function() { if (typeof load === "function") load(0); alert(delErr); }).deleteEvaluationItem(type, id);
}

var globalPayrollList = []; // ë°ì´í„°ë¥¼ ë‹´ì•„ë‘˜ ì „ì—­ ë³€ìˆ˜

/* ê¸‰ì—¬ ê³„ì‚° íƒ­: ë§¤ì¥ í•„í„° ì˜µì…˜ ë¡œë“œ (C.E.O/HRë§Œ Office ì˜µì…˜ ë…¸ì¶œ) */
function loadPayrollStoreOptions() {
    var sel = document.getElementById("payroll-store-filter");
    if (!sel) return;
    var role = (typeof userRole !== "undefined") ? userRole : "";
    google.script.run.withSuccessHandler(function(stores) {
        sel.innerHTML = "";
        var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : {};
        var allText = (lang.label_all || "ì „ì²´");
        sel.add(new Option(allText, "All"));
        if (stores && stores.length) stores.forEach(function(s) { sel.add(new Option(s, s)); });
    }).getPayrollStoreList(role);
}

/* 0. DB ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒìš©) */
function runDBSetup() {
    if(confirm("ê¸‰ì—¬ ë°ì´í„°ë¥¼ ì €ì¥í•  [ê¸‰ì—¬_DB] ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ìˆìœ¼ë©´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)")) {
        google.script.run.withSuccessHandler(alert).setupPayrollDB();
    }
}

/* 1. ê³„ì‚° ì‹¤í–‰ ë²„íŠ¼ (ë§¤ì¥ í•„í„° ì ìš©, C.E.O/HRë§Œ Office ì¡°íšŒ ê°€ëŠ¥) */
function calculateMonthlySalary() {
    var month = document.getElementById("payroll-month").value;
    if(!month) return alert("ë‚ ì§œ(ë…„-ì›”)ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    var storeEl = document.getElementById("payroll-store-filter");
    var storeFilter = (storeEl && storeEl.value) ? storeEl.value : "All";
    var role = (typeof userRole !== "undefined") ? userRole : "";
    
    load(1); // ë¡œë”© ì‹œì‘
    google.script.run.withSuccessHandler(res => {
        load(0); // ë¡œë”© ë
        if(!res.success) return alert(res.msg);
        
        globalPayrollList = res.list;
        renderPayrollTable();
        alert("âœ… ê³„ì‚° ì™„ë£Œ! ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì €ì¥í•˜ì„¸ìš”.");
    }).calculatePayrollPreview(month, storeFilter, role);
}

/* 2. í…Œì´ë¸” ê·¸ë¦¬ê¸° (ìˆ˜ì • ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜) */
function renderPayrollTable() {
    var tbody = document.getElementById("payroll-list-body");
    tbody.innerHTML = "";
    
    if(globalPayrollList.length === 0) {
        tbody.innerHTML = "<tr><td colspan='16' class='py-5 text-muted'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    globalPayrollList.forEach((p, idx) => {
        var holidayPay = Number(p.holidayPay) || 0;
        var income = p.salary + p.posAllow + p.hazAllow + p.birthBonus + holidayPay + p.splBonus + p.otAmt;
        var deduct = p.lateDed + p.sso + p.tax + p.otherDed;
        p.netPay = income - deduct;

        var rowClass = (idx % 2 === 0) ? "payroll-row-even" : "payroll-row-odd";
        var row = `<tr class="${rowClass}">
            <td class="payroll-td-num">${idx+1}</td>
            <td class="payroll-td-store fw-bold">${p.store}</td>
            <td class="payroll-td-name">${p.name}<br><small class="text-secondary">${p.role}</small></td>
            <td class="payroll-td-num text-end">${p.salary.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.posAllow.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.hazAllow.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.birthBonus.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${holidayPay.toLocaleString()}${p.holidayWorkDays ? ' <small class="text-secondary">(' + p.holidayWorkDays + 'ì¼)</small>' : ''}</td>
            <td class="payroll-td-num text-end small fw-bold">${p.splBonus.toLocaleString()}</td>
            <td class="payroll-td-num text-center small text-secondary">(1.5: ${p.ot15}h)</td>
            <td class="payroll-td-num text-end small fw-bold">${p.otAmt.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small">${p.lateDed.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small">${p.sso.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small fw-bold">${p.otherDed.toLocaleString()}</td>
            <td class="payroll-td-net text-end fw-bold">${p.netPay.toLocaleString()}</td>
            <td><button class="btn btn-sm btn-outline-primary" onclick="openEditPayroll(${idx})">âœï¸ ìˆ˜ì •</button></td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

/* 3. ìˆ˜ì • íŒì—… ì—´ê¸° */
function openEditPayroll(idx) {
    var p = globalPayrollList[idx]; // ì„ íƒí•œ ì§ì› ë°ì´í„°
    document.getElementById("py-index").value = idx;
    document.getElementById("py-name").innerText = p.name;
    document.getElementById("py-store").innerText = p.store;
    
    // ê¸°ì¡´ ê°’ ì±„ì›Œë„£ê¸°
    document.getElementById("py-bonus").value = p.splBonus; // ë³´ë„ˆìŠ¤
    document.getElementById("py-ot").value = p.otAmt;       // OT ê¸ˆì•¡
    document.getElementById("py-late").value = p.lateDed;   // ì§€ê° ê³µì œ
    document.getElementById("py-deduct").value = p.otherDed;// ê¸°íƒ€ ê³µì œ

    // ëª¨ë‹¬ ë„ìš°ê¸°
    new bootstrap.Modal(document.getElementById('modalPayrollEdit')).show();
}

/* 4. ìˆ˜ì • ì ìš© (íŒì—…ì—ì„œ ì €ì¥ ëˆ„ë¥¼ ë•Œ) */
function applyPayrollEdit() {
    var idx = document.getElementById("py-index").value;
    var p = globalPayrollList[idx];
    
    // ì…ë ¥ê°’ ì—…ë°ì´íŠ¸ (ìˆ«ìë¡œ ë³€í™˜)
    p.splBonus = Number(document.getElementById("py-bonus").value) || 0;
    p.otAmt = Number(document.getElementById("py-ot").value) || 0;
    p.lateDed = Number(document.getElementById("py-late").value) || 0;
    p.otherDed = Number(document.getElementById("py-deduct").value) || 0;
    
    // ëª¨ë‹¬ ë‹«ê¸°
    var modal = bootstrap.Modal.getInstance(document.getElementById('modalPayrollEdit'));
    modal.hide();
    
    // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë ¤ì„œ í•©ê³„ ê°±ì‹ 
    renderPayrollTable();
}

/* 5. ìµœì¢… DB ì €ì¥ - í™•ì • ì €ì¥ ì‹œ ìƒíƒœë¥¼ "í™•ì •"ìœ¼ë¡œ ì €ì¥ (ëª…ì„¸ì„œ ì¡°íšŒì—ì„œ í™•ì •ìœ¼ë¡œ í‘œì‹œ) */
function saveFinalPayroll() {
    var month = document.getElementById("payroll-month").value;
    if(!globalPayrollList.length) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    if(!confirm("âš ï¸ " + month + "ì›” ê¸‰ì—¬ë¥¼ í™•ì • ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ì— ì €ì¥ëœ ì´ ë‹¬ì˜ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)")) return;
    
    var listToSave = globalPayrollList.map(function(p) {
        var q = {};
        for (var k in p) q[k] = p[k];
        q.status = "í™•ì •";
        return q;
    });
    load(1);
    google.script.run.withSuccessHandler(res => {
        load(0);
        alert(res);
    }).savePayrollToDB(month, JSON.stringify(listToSave));
}

/* 6. ë‚´ì—­ ì¡°íšŒ - loadPayrollHistory / renderHistoryTable ì‚¬ìš© */
/* payroll-history-ui: ì²´í¬ë°•ìŠ¤ ì„ íƒ í›„ ì¼ê´„ ì´ë©”ì¼ ë°œì†¡ (v2) */

/* =========================================
   [ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ] ê¸°ëŠ¥ ì¶”ê°€
   ========================================= */

// 1. í˜ì´ì§€ ì—´ë¦´ ë•Œ ë§¤ì¥ ëª©ë¡ ì±„ìš°ê¸° (ê¸°ì¡´ í•¨ìˆ˜ í™œìš©)
// (ì´ ì½”ë“œëŠ” calculateMonthlySalary í•¨ìˆ˜ ê·¼ì²˜ë‚˜ go í•¨ìˆ˜ ì•ˆì— ë„£ì–´ë„ ë˜ì§€ë§Œ, í¸ì˜ìƒ ì¡°íšŒ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì—†ìœ¼ë©´ ì±„ìš°ë„ë¡ í•¨)

/* 2. ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ (ì„œë²„: getPayrollFromDB ì‚¬ìš©) */
function loadPayrollHistory() {
    if (typeof google === "undefined" || !google.script || !google.script.run) {
        alert("ëª…ì„¸ì„œ ì¡°íšŒëŠ” Google Apps Script í™˜ê²½ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.");
        return;
    }
    var monthEl = document.getElementById("py-history-month");
    var storeFilter = document.getElementById("py-history-store");
    var month = monthEl ? monthEl.value : "";

    if (storeFilter && storeFilter.options.length <= 1 && typeof loadStoreOptions === "function") {
       loadStoreOptions("py-history-store");
    }

    if (!month) { alert("ì¡°íšŒí•  ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

    load(1); // ë¡œë”© ì‹œì‘
    
    google.script.run
        .withSuccessHandler(function(res) {
            load(0); // ë¡œë”© ë
            var tbody = document.getElementById("py-history-list");
            if (!tbody) return;
            tbody.innerHTML = "";
            if (!res) {
                tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤. (clasp push í›„ ë°°í¬ ë²„ì „ì„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”)</td></tr>";
                return;
            }
            if (!res.success) {
                var msg = (res.msg && String(res.msg).trim()) ? res.msg : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">" + msg + "</td></tr>";
                return;
            }
            window.historyData = res.list || [];
            window.historyMonth = month || "";
            renderHistoryTable();
        })
        .withFailureHandler(function(err) {
            load(0);
            var tbody = document.getElementById("py-history-list");
            var errMsg = (err && (err.message || err)) ? String(err.message || err) : "ì„œë²„ ì—°ê²° í™•ì¸";
            if (tbody) tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: " + errMsg + "</td></tr>";
            console.error("getPayrollFromDB error:", err);
        })
        .getPayrollFromDB(month);
}

/* 3. í…Œì´ë¸” ê·¸ë¦¬ê¸° (ë§¤ì¥ í•„í„° ì ìš©, getPayrollFromDB ì‘ë‹µ í˜•ì‹) */
function renderHistoryTable() {
    var storeEl = document.getElementById("py-history-store");
    var filterStore = storeEl ? storeEl.value : "All";
    var tbody = document.getElementById("py-history-list");
    var totalCount = 0;
    var totalMoney = 0;
    
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!window.historyData || window.historyData.length === 0) {
        tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-muted\">ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        if (document.getElementById("total-count")) document.getElementById("total-count").innerText = "0";
        if (document.getElementById("total-amount")) document.getElementById("total-amount").innerText = "0";
        return;
    }

    window.historyData.forEach(function(p) {
        if (filterStore !== "All" && p.store !== filterStore) return;
        totalCount++;
        var totalAllow = (Number(p.posAllow) || 0) + (Number(p.hazAllow) || 0) + (Number(p.birthBonus) || 0) + (Number(p.holidayPay) || 0) + (Number(p.splBonus) || 0);
        var totalDed = (Number(p.lateDed) || 0) + (Number(p.sso) || 0) + (Number(p.tax) || 0) + (Number(p.otherDed) || 0);
        var netPay = Number(p.netPay) || 0;
        totalMoney += netPay;
        var storeEsc = (p.store || "").replace(/"/g, "&quot;");
        var nameEsc = (p.name || "").replace(/"/g, "&quot;");
        var row = "<tr><td class=\"align-middle\"><input type=\"checkbox\" class=\"form-check-input py-history-check\" data-store=\"" + storeEsc + "\" data-name=\"" + nameEsc + "\" title=\"ë°œì†¡ ëŒ€ìƒ ì„ íƒ\"></td>" +
            "<td class=\"fw-bold\">" + (p.store || "") + "</td><td>" + (p.name || "") + "</td>" +
            "<td class=\"text-end text-muted\">" + (Number(p.salary) || 0).toLocaleString() + "</td>" +
            "<td class=\"text-end text-primary\">+" + totalAllow.toLocaleString() + "</td>" +
            "<td class=\"text-end text-info\">+" + (Number(p.otAmt) || 0).toLocaleString() + "</td>" +
            "<td class=\"text-end text-danger\">-" + totalDed.toLocaleString() + "</td>" +
            "<td class=\"text-end fw-bold bg-light\" style=\"color:#E65100;\">" + netPay.toLocaleString() + "</td>" +
            "<td><span class=\"badge bg-secondary\">" + (p.status || "ì§€ê¸‰ëŒ€ê¸°") + "</span></td></tr>";
        tbody.innerHTML += row;
    });

    if (totalCount === 0) {
        tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-muted\">ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
    }

    if (document.getElementById("total-count")) document.getElementById("total-count").innerText = totalCount;
    if (document.getElementById("total-amount")) document.getElementById("total-amount").innerText = totalMoney.toLocaleString();
}

/* ì „ì²´ ì„ íƒ/í•´ì œ */
function togglePayrollHistoryCheckAll(headerCheck) {
    var list = document.querySelectorAll(".py-history-check");
    var checked = headerCheck ? headerCheck.checked : false;
    for (var i = 0; i < list.length; i++) list[i].checked = checked;
    var headerEl = document.getElementById("py-history-check-all");
    if (headerEl && !headerCheck) headerEl.checked = false;
}

/* ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ì¼ê´„ ë°œì†¡ */
function sendPayrollEmailSelected() {
    var month = window.historyMonth || (document.getElementById("py-history-month") && document.getElementById("py-history-month").value) || "";
    if (!month) { alert("ì¡°íšŒì›”ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒí•˜ê¸°ë¥¼ ì‹¤í–‰í•´ ì£¼ì„¸ìš”."); return; }
    var checks = document.querySelectorAll(".py-history-check:checked");
    if (!checks || checks.length === 0) { alert("ë°œì†¡í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤. í–‰ì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    var list = [];
    for (var i = 0; i < checks.length; i++) {
        list.push({ store: checks[i].getAttribute("data-store") || "", name: checks[i].getAttribute("data-name") || "" });
    }
    var btn = document.getElementById("py-send-selected-btn");
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    if (btn) { btn.disabled = true; btn.textContent = (lang.pay_sending_count || "ë°œì†¡ ì¤‘â€¦ (Nëª…)").replace("N", list.length); }
    google.script.run.withSuccessHandler(function(res) {
        if (btn) { btn.disabled = false; btn.textContent = (lang.pay_send_selected || "ğŸ“§ ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ë°œì†¡"); }
        if (res && res.sent !== undefined) {
            var msg = "ë°œì†¡ ì™„ë£Œ: " + (res.sent || 0) + "ëª…";
            if (res.failed && res.failed.length) msg += ", ì‹¤íŒ¨ " + res.failed.length + "ëª… (" + (res.errors ? res.errors.join("; ") : "") + ")";
            alert(msg);
            if (res.sent > 0) togglePayrollHistoryCheckAll(null);
        } else {
            alert("âŒ " + (res && res.msg ? res.msg : "ë°œì†¡ ì‹¤íŒ¨"));
        }
    }).withFailureHandler(function(err) {
        if (btn) { btn.disabled = false; btn.textContent = (lang.pay_send_selected || "ğŸ“§ ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ë°œì†¡"); }
        alert("âŒ ë°œì†¡ ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).sendPayrollStatementEmailBatch(month, JSON.stringify(list));
}

/* 5. ë§¤ì¥ ì„ íƒ ë°”ê¿€ ë•Œë§ˆë‹¤ ë°”ë¡œë°”ë¡œ í‘œ ê°±ì‹  */
(function(){
    var el = document.getElementById("py-history-store");
    if (el) el.addEventListener("change", renderHistoryTable);
})();

/* [ì‹ ê·œ] ê¸‰ì—¬ ê´€ë¦¬ íƒ­ ì „í™˜ í•¨ìˆ˜ */
function showPayrollTab(t) {
    var tabCalc = document.getElementById("payroll-tab-calc");
    var tabHist = document.getElementById("payroll-tab-hist");
    var tabHoliday = document.getElementById("payroll-tab-holiday");
    if (tabCalc) tabCalc.style.display = "none";
    if (tabHist) tabHist.style.display = "none";
    if (tabHoliday) tabHoliday.style.display = "none";
    var targetTab = document.getElementById("payroll-tab-" + t);
    if (targetTab) targetTab.style.display = "block";

    document.getElementById("payroll-nav-calc").classList.remove("active");
    document.getElementById("payroll-nav-hist").classList.remove("active");
    var navHoliday = document.getElementById("payroll-nav-holiday");
    if (navHoliday) navHoliday.classList.remove("active");
    document.getElementById("payroll-nav-" + t).classList.add("active");

    if (t === "hist") {
        var storeFilter = document.getElementById("py-history-store");
        if (storeFilter && storeFilter.options.length <= 1) loadStoreOptions("py-history-store");
    }
    if (t === "holiday") {
        var yearEl = document.getElementById("holiday-year");
        if (yearEl && yearEl.options.length <= 1) fillHolidayYearOptions();
        loadPublicHolidays();
    }
}

function fillHolidayYearOptions() {
    var el = document.getElementById("holiday-year");
    if (!el) return;
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var suffix = (lang.pay_holiday_year_suffix != null && lang.pay_holiday_year_suffix !== "") ? lang.pay_holiday_year_suffix : "ë…„";
    var y = new Date().getFullYear();
    el.innerHTML = "";
    for (var i = y - 1; i <= y + 3; i++) el.add(new Option(i + suffix, i));
    el.value = y;
}

function loadPublicHolidays() {
    var yearEl = document.getElementById("holiday-year");
    var tbody = document.getElementById("public-holiday-list");
    if (!yearEl || !tbody) return;
    var year = yearEl.value || new Date().getFullYear();
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var loadingTxt = lang.pay_holiday_loading || "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    var noDataTxt = lang.pay_holiday_no_data || "í•´ë‹¹ ì—°ë„ ê³µíœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤. [ì¶”ê°€]ë¡œ ë“±ë¡í•˜ê±°ë‚˜ ì‹œíŠ¸ ìƒì„± í›„ ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.";
    var editBtnTxt = lang.pay_holiday_edit_btn || "ìˆ˜ì •";
    var delBtnTxt = lang.pay_holiday_delete_btn || "ì‚­ì œ";
    tbody.innerHTML = "<tr><td colspan='4' class='py-3 text-muted'>" + loadingTxt + "</td></tr>";
    google.script.run.withSuccessHandler(function(res) {
        tbody.innerHTML = "";
        var list = (res && res.list) ? res.list : [];
        if (list.length === 0) {
            tbody.innerHTML = "<tr><td colspan='4' class='py-4 text-muted'>" + noDataTxt + "</td></tr>";
            return;
        }
        list.forEach(function(h, i) {
            var rowIndex = (h.rowIndex != null) ? h.rowIndex : "";
            var editBtn = rowIndex ? "<button type='button' class='btn btn-sm btn-outline-secondary me-1' onclick='openHolidayEditModal(" + rowIndex + ",\"" + (h.date || "") + "\",\"" + (String(h.name || "-").replace(/"/g, "&quot;")) + "\")'>" + editBtnTxt + "</button>" : "";
            var delBtn = rowIndex ? "<button type='button' class='btn btn-sm btn-outline-danger' onclick='deleteHolidayRow(" + rowIndex + ")'>" + delBtnTxt + "</button>" : "";
            tbody.innerHTML += "<tr><td>" + (i + 1) + "</td><td>" + (h.date || "") + "</td><td>" + (h.name || "-") + "</td><td>" + editBtn + delBtn + "</td></tr>";
        });
    }).withFailureHandler(function() {
        tbody.innerHTML = "<tr><td colspan='4' class='py-4 text-danger'>" + (lang.eval_list_fail || "ì¡°íšŒ ì‹¤íŒ¨") + "</td></tr>";
    }).getPublicHolidaysWithRows(parseInt(year, 10));
}

function openHolidayAddModal() {
    var yearEl = document.getElementById("holiday-year");
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    document.getElementById("holiday-form-modal-title").textContent = lang.pay_holiday_modal_add || "ê³µíœ´ì¼ ì¶”ê°€";
    document.getElementById("holiday-form-rowIndex").value = "";
    document.getElementById("holiday-form-year").value = yearEl ? yearEl.value : new Date().getFullYear();
    document.getElementById("holiday-form-date").value = "";
    document.getElementById("holiday-form-name").value = "";
    var modal = new bootstrap.Modal(document.getElementById("holiday-form-modal"));
    modal.show();
}

function openHolidayEditModal(rowIndex, dateStr, name) {
    var yearEl = document.getElementById("holiday-year");
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    document.getElementById("holiday-form-modal-title").textContent = lang.pay_holiday_modal_edit || "ê³µíœ´ì¼ ìˆ˜ì •";
    document.getElementById("holiday-form-rowIndex").value = rowIndex;
    document.getElementById("holiday-form-year").value = yearEl ? yearEl.value : new Date().getFullYear();
    document.getElementById("holiday-form-date").value = (dateStr || "").substring(0, 10);
    document.getElementById("holiday-form-name").value = name || "";
    var modal = new bootstrap.Modal(document.getElementById("holiday-form-modal"));
    modal.show();
}

function saveHolidayForm() {
    var rowIndex = document.getElementById("holiday-form-rowIndex").value.trim();
    var year = document.getElementById("holiday-form-year").value;
    var dateStr = document.getElementById("holiday-form-date").value;
    var name = document.getElementById("holiday-form-name").value.trim() || "-";
    if (!year || !dateStr) { alert("ì—°ë„ì™€ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    var done = function(msg) { alert(msg); bootstrap.Modal.getInstance(document.getElementById("holiday-form-modal")).hide(); loadPublicHolidays(); };
    var fail = function(err) { alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err)); };
    if (rowIndex) {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).updatePublicHoliday(parseInt(rowIndex, 10), parseInt(year, 10), dateStr, name);
    } else {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).addPublicHoliday(parseInt(year, 10), dateStr, name);
    }
}

function deleteHolidayRow(rowIndex) {
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    if (!confirm(lang.pay_holiday_delete_confirm || "ì´ ê³µíœ´ì¼ í–‰ì„ ì‚­ì œí• ê¹Œìš”?")) return;
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        loadPublicHolidays();
    }).withFailureHandler(function(err) {
        alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).deletePublicHoliday(parseInt(rowIndex, 10));
}

function setupPublicHolidaysSheet() {
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        loadPublicHolidays();
    }).withFailureHandler(function(err) {
        alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).setupPublicHolidaysSheet();
}

/* =========================================
   [NEW] ê¸‰ì—¬ ê´€ë¦¬ í†µí•© ìŠ¤í¬ë¦½íŠ¸ (DB ë²„ì „)
   ========================================= */


/* [ìµœì¢… í†µí•©] ê·¼íƒœ ê´€ë¦¬ íƒ­ ì „í™˜ í•¨ìˆ˜ */
function showAttendanceTab(tabName) {
    // 1. ëª¨ë“  íƒ­ ì»¨í…ì¸ ë¥¼ ìˆ¨ê¹€ (ì¡°íšŒ íƒ­ í¬í•¨)
    const tabs = ['status', 'schedule', 'view-edit', 'today-realtime'];
    tabs.forEach(t => {
        const el = document.getElementById('attendance-tab-' + t);
        if (el) el.style.display = 'none';
    });

    // 2. ì„ íƒí•œ íƒ­ë§Œ ë³´ì´ê¸°
    const targetTab = document.getElementById('attendance-tab-' + tabName);
    if (targetTab) targetTab.style.display = 'block';

    // 3. íƒ­ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬ (ID ê¸°ë°˜ìœ¼ë¡œ ì •í™•íˆ íƒ€ê²ŸíŒ…)
    const navLinks = document.querySelectorAll('#attendanceTab .nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
        // í´ë¦­ëœ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë‚˜ ì¸ìë¥¼ ë¹„êµí•˜ì—¬ active í´ë˜ìŠ¤ ë¶€ì—¬
        if (link.getAttribute('onclick').includes(tabName)) {
            link.classList.add('active');
        }
    });

    // 4. [íŠ¹ìˆ˜ ë¡œì§] ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸ íƒ­ ì§„ì… ì‹œ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ, ì§ì› ì„ íƒì°½ì€ ë§¤ì¥ì— ë§ê²Œ ì´ˆê¸°í™”
    if (tabName === 'status') {
        const attStore = document.getElementById('att-store-filter');
        if (attStore && attStore.options.length <= 1 && typeof loadStoreOptions === 'function') {
            attStore.classList.remove('loaded');
            loadStoreOptions('att-store-filter');
        }
        if (typeof loadAttEmployeeOptions === 'function') loadAttEmployeeOptions();
    }

    // 5. [íŠ¹ìˆ˜ ë¡œì§] ìŠ¤ì¼€ì¤„ ì‘ì„± íƒ­ ì§„ì… ì‹œ
    if (tabName === 'schedule') {
        if (typeof loadScheduleManager === 'function') loadScheduleManager();
    }

    // 6. [íŠ¹ìˆ˜ ë¡œì§] ìŠ¤ì¼€ì¤„ ì¡°íšŒ/ìˆ˜ì • íƒ­ ì§„ì… ì‹œ ë‚ ì§œ(í•´ë‹¹ ì£¼ ì›”ìš”ì¼) ì„¸íŒ… ë° ë§¤ì¥ ë¡œë“œ
    if (tabName === 'view-edit') {
        const dateInput = document.getElementById('view-week-monday');
        if (dateInput && !dateInput.value) {
            var today = new Date().toISOString().substring(0, 10);
            dateInput.value = (typeof getMondayOfWeek === 'function') ? getMondayOfWeek(today) : today;
        }
        // ë§¤ì¥ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ
        const viewSelect = document.getElementById('view-store-select');
        if (viewSelect && viewSelect.options.length <= 1) {
            loadStoreOptions('view-store-select');
        }
    }

    // 7. [íŠ¹ìˆ˜ ë¡œì§] ë‹¹ì¼ ì‹¤ì‹œê°„ ê·¼ë¬´ íƒ­ ì§„ì… ì‹œ ë‚ ì§œÂ·ë§¤ì¥ ë¡œë“œ
    if (tabName === 'today-realtime') {
        var dateEl = document.getElementById('att-today-date');
        if (dateEl && !dateEl.value) {
            var today = new Date();
            dateEl.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        }
        var storeEl = document.getElementById('att-today-store');
        if (storeEl && storeEl.options.length <= 1 && typeof loadStoreOptions === 'function') {
            storeEl.classList.remove('loaded');
            loadStoreOptions('att-today-store');
        }
    }
}

/** [ë‹¹ì¼ ì‹¤ì‹œê°„ ê·¼ë¬´ íƒ­] ë°ì´í„° ë¡œë“œ í›„ ë Œë” (ëª¨ë°”ì¼ê³¼ ë™ì¼í•œ í‘œ) */
function loadAdminTodayRealtime() {
    var dateEl = document.getElementById('att-today-date');
    var storeEl = document.getElementById('att-today-store');
    var areaEl = document.getElementById('att-today-area');
    var box = document.getElementById('att-today-realtime-box');
    if (!box) return;
    var dateStr = (dateEl && dateEl.value) ? dateEl.value.substring(0, 10) : (function() { var d = new Date(); return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); })();
    var storeFilter = (storeEl && storeEl.value) ? String(storeEl.value).trim() : 'All';
    var areaFilter = (areaEl && areaEl.value) ? areaEl.value : 'All';
    var mondayStr = (typeof getMondayOfWeek === 'function') ? getMondayOfWeek(dateStr) : dateStr;
    box.innerHTML = "<div class='text-center text-muted py-4 small'>ì¡°íšŒ ì¤‘...</div>";
    google.script.run.withSuccessHandler(function(weekList) {
        var daySchedule = (weekList || []).filter(function(r) { return (r.date || "").substring(0, 10) === dateStr; });
        if (areaFilter !== 'All') daySchedule = daySchedule.filter(function(r) { return (r.area || 'Service') === areaFilter; });
        google.script.run.withSuccessHandler(function(attList) {
            renderAdminTodayRealtime(daySchedule, attList || [], areaFilter, storeFilter);
        }).withFailureHandler(function() {
            renderAdminTodayRealtime(daySchedule, [], areaFilter, storeFilter);
        }).getMobileTodayAttendance(storeFilter, dateStr);
    }).withFailureHandler(function() {
        box.innerHTML = "<div class='text-center text-muted py-4 small'>ìŠ¤ì¼€ì¤„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>";
    }).getMobileWeeklySchedule(storeFilter, mondayStr, areaFilter);
}

/** [ë‹¹ì¼ ì‹¤ì‹œê°„ ê·¼ë¬´ íƒ­] ëª¨ë°”ì¼ê³¼ ë™ì¼í•œ ë‹¹ì¼ ê·¼ë¬´ í‘œ ë Œë”. storeFilter === 'All'ì´ë©´ ë§¤ì¥ë³„ êµ¬ë¶„ í–‰ ì¶”ê°€ */
function renderAdminTodayRealtime(todaySchedule, attendanceList, areaFilter, storeFilter) {
    var box = document.getElementById('att-today-realtime-box');
    if (!box) return;
    var areaFilter = areaFilter || 'All';
    var storeFilter = (storeFilter || '').toString().trim();
    var showStoreSection = (storeFilter === 'All' || storeFilter === '');
    var attByKey = {};
    (attendanceList || []).forEach(function(r) {
        var k = (r.store || '') + '|' + (r.name || '');
        attByKey[k] = r;
    });
    var invT = (typeof window.invT === 'function') ? window.invT : (typeof invT === 'function') ? invT : function(k) { return (typeof I18N !== 'undefined' && currentLang && I18N[currentLang] && I18N[currentLang][k]) ? I18N[currentLang][k] : k; };
    var areaLabelT = function(area) { return invT(area === 'Service' ? 'm_schedule_area_service' : area === 'Kitchen' ? 'm_schedule_area_kitchen' : 'm_schedule_area_office') || area; };
    var multiArea = (function() { var a = {}; (todaySchedule || []).forEach(function(x) { a[x.area || 'Service'] = 1; }); return Object.keys(a).length > 1; })();
    var showArea = (areaFilter === 'All' && multiArea);
    if (!todaySchedule || todaySchedule.length === 0) {
        box.innerHTML = "<div class='text-center text-muted py-5 small'>í•´ë‹¹ ë‚ ì§œÂ·ë§¤ì¥Â·êµ¬ì—­ì— ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        return;
    }
    function parseTimeToDecimal(s) {
        if (!s || typeof s !== 'string') return null;
        var m = s.match(/(\d{1,2}):(\d{2})/);
        return m ? parseInt(m[1], 10) + parseInt(m[2], 10) / 60 : null;
    }
    var byPerson = {};
    todaySchedule.forEach(function(r) {
        var key = (r.store || '') + '|' + (r.name || '');
        if (!byPerson[key]) byPerson[key] = { name: r.nick || r.name || '', store: r.store || '', area: r.area || 'Service', pIn: r.pIn, pOut: r.pOut, pBS: r.pBS, pBE: r.pBE };
    });
    var minDec = 24, maxDec = 0;
    Object.keys(byPerson).forEach(function(k) {
        var p = byPerson[k];
        var inD = parseTimeToDecimal(p.pIn), outD = parseTimeToDecimal(p.pOut), bsD = parseTimeToDecimal(p.pBS), beD = parseTimeToDecimal(p.pBE);
        if (inD != null && inD < minDec) minDec = inD;
        if (bsD != null && bsD < minDec) minDec = bsD;
        if (outD != null && outD > maxDec) maxDec = outD;
        if (beD != null && beD > maxDec) maxDec = beD;
    });
    var hourStart = minDec <= maxDec ? Math.max(0, Math.floor(minDec)) : 6;
    var hourEnd = minDec <= maxDec ? Math.min(24, Math.ceil(maxDec) + 1) : 24;
    if (hourEnd <= hourStart) { hourStart = 6; hourEnd = 24; }
    var hours = [];
    for (var h = hourStart; h < hourEnd; h++) hours.push(h);
    var areaOrder = { Service: 0, Kitchen: 1, Office: 2 };
    var personKeys = Object.keys(byPerson).sort(function(a, b) {
        var pA = byPerson[a], pB = byPerson[b];
        if (showStoreSection && pA.store !== pB.store) return (pA.store || '').localeCompare(pB.store || '');
        var oA = areaOrder[pA.area] !== undefined ? areaOrder[pA.area] : 3;
        var oB = areaOrder[pB.area] !== undefined ? areaOrder[pB.area] : 3;
        if (oA !== oB) return oA - oB;
        var inA = parseTimeToDecimal(pA.pIn), inB = parseTimeToDecimal(pB.pIn);
        return (inA || 0) - (inB || 0);
    });
    var tc = 'text-align:center;', nowrap = 'white-space:nowrap;';
    var areaLabel = invT('m_schedule_label_area') || 'êµ¬ì—­';
    var nameLabel = invT('label_name') || 'ì´ë¦„';
    var storeLabel = invT('label_store') || 'ë§¤ì¥';
    var areaColHeader = showArea ? "<th style='min-width:52px;padding:4px 6px;" + tc + ";" + nowrap + "'>" + areaLabel + "</th>" : "";
    var nameColSpan = (showArea ? 1 : 0) + 1;
    var storeToKeys = {};
    personKeys.forEach(function(key) {
        var st = byPerson[key].store || '';
        if (!storeToKeys[st]) storeToKeys[st] = [];
        storeToKeys[st].push(key);
    });
    function countWorkingAtHour(keys, h) {
        var h0 = h, h05 = h + 0.5, h1 = h + 1;
        var count = 0;
        keys.forEach(function(key) {
            var p = byPerson[key];
            var inDec = parseTimeToDecimal(p.pIn), outDec = parseTimeToDecimal(p.pOut), bsDec = parseTimeToDecimal(p.pBS), beDec = parseTimeToDecimal(p.pBE);
            var breakFirst = (bsDec != null && beDec != null && bsDec < h05 && beDec > h0);
            var breakSecond = (bsDec != null && beDec != null && bsDec < h1 && beDec > h05);
            var workFirst = (inDec != null && outDec != null && inDec < h05 && outDec > h0) && !breakFirst;
            var workSecond = (inDec != null && outDec != null && inDec < h1 && outDec > h05) && !breakSecond;
            if (workFirst || workSecond) count++;
        });
        return count;
    }
    var html = "<div style='overflow-x:auto;'><table class='table table-bordered table-sm mb-0' style='font-size:12px;border-collapse:collapse;'>";
    html += "<thead><tr style='background:#f5f5f5;'>" + areaColHeader + "<th style='min-width:80px;padding:4px 6px;" + tc + ";" + nowrap + "'>" + nameLabel + "</th>";
    hours.forEach(function(h) { html += "<th style='min-width:26px;padding:2px;font-size:11px;" + tc + "'>" + h + "</th>"; });
    html += "</tr></thead><tbody>";
    var lastStore = null;
    personKeys.forEach(function(key) {
        var p = byPerson[key];
        if (showStoreSection && (lastStore === null || lastStore !== p.store)) {
            var storeName = (p.store || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var storeKeys = storeToKeys[p.store] || [];
            html += "<tr style='background:#E8EAF6;'>";
            html += "<td colspan='" + nameColSpan + "' class='fw-bold py-2' style='text-align:left; padding-left:12px;'>" + storeLabel + ": " + storeName + "</td>";
            hours.forEach(function(h) {
                var cnt = countWorkingAtHour(storeKeys, h);
                html += "<td style='padding:2px;font-size:11px;" + tc + ";'>" + (cnt > 0 ? cnt : "") + "</td>";
            });
            html += "</tr>";
        }
        lastStore = p.store;
        var att = attByKey[key];
        var inDec = parseTimeToDecimal(p.pIn), outDec = parseTimeToDecimal(p.pOut), bsDec = parseTimeToDecimal(p.pBS), beDec = parseTimeToDecimal(p.pBE);
        var hasProblem = !att ? true : (att.lateMin && att.lateMin > 0) || att.onlyIn === true || (att.status && (att.status.indexOf('ì§€ê°') !== -1 || att.status.indexOf('ê²°ì„') !== -1 || att.status.indexOf('ë¯¸ê¸°ë¡') !== -1));
        var rowBg = hasProblem ? '#FFCDD2' : '#E3F2FD';
        var areaCell = showArea ? "<td style='padding:4px 6px;" + tc + ";" + nowrap + ";background:" + rowBg + ";'>" + (areaLabelT(p.area) || p.area) + "</td>" : "";
        html += "<tr>" + areaCell + "<td style='padding:4px 6px;font-weight:600;min-width:80px;" + tc + ";" + nowrap + ";background:" + rowBg + ";'>" + (p.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + "</td>";
        hours.forEach(function(h) {
            var h0 = h, h05 = h + 0.5, h1 = h + 1;
            var breakFirst = (bsDec != null && beDec != null && bsDec < h05 && beDec > h0);
            var breakSecond = (bsDec != null && beDec != null && bsDec < h1 && beDec > h05);
            var workFirst = (inDec != null && outDec != null && inDec < h05 && outDec > h0) && !breakFirst;
            var workSecond = (inDec != null && outDec != null && inDec < h1 && outDec > h05) && !breakSecond;
            var fullBreak = breakFirst && breakSecond;
            var fullWork = workFirst && workSecond;
            var mark = '';
            if (fullBreak) mark = "<span style='display:inline-block;width:12px;height:12px;border-radius:50%;border:1px solid #555;background:transparent;'></span>";
            else if (fullWork) mark = "<span style='color:#000;'>â—</span>";
            else if (breakFirst && workSecond) mark = "<span style='display:inline-block;width:12px;height:12px;position:relative;'><span style='position:absolute;left:0;top:0;width:6px;height:12px;border:1px solid #555;border-right:none;border-radius:50% 0 0 50%;background:transparent;box-sizing:border-box;'></span><span style='position:absolute;right:0;top:0;width:6px;height:12px;border-radius:0 50% 50% 0;background:#000;'></span></span>";
            else if (workFirst && breakSecond) mark = "<span style='display:inline-block;width:12px;height:12px;position:relative;'><span style='position:absolute;left:0;top:0;width:6px;height:12px;border-radius:50% 0 0 50%;background:#000;'></span><span style='position:absolute;right:0;top:0;width:6px;height:12px;border:1px solid #555;border-left:none;border-radius:0 50% 50% 0;background:transparent;box-sizing:border-box;'></span></span>";
            else if (workFirst && !workSecond) mark = "<span style='display:inline-block;width:12px;height:12px;position:relative;'><span style='position:absolute;left:0;top:0;width:6px;height:12px;border-radius:50% 0 0 50%;background:#000;'></span></span>";
            else if (workSecond && !workFirst) mark = "<span style='display:inline-block;width:12px;height:12px;position:relative;'><span style='position:absolute;right:0;top:0;width:6px;height:12px;border-radius:0 50% 50% 0;background:#000;'></span></span>";
            html += "<td style='padding:2px;min-width:26px;" + tc + ";background:" + (mark ? rowBg : 'transparent') + "'>" + mark + "</td>";
        });
        html += "</tr>";
    });
    html += "</tbody></table></div>";
    box.innerHTML = html;
}

/** [ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸] ë§¤ì¥ ì„ íƒ ì‹œ í•´ë‹¹ ë§¤ì¥ ì§ì› ëª©ë¡ì„ ì§ì› ê²€ìƒ‰ì°½ì— ë¡œë“œ. ì „ì²´ ë§¤ì¥ì´ë©´ 'ì „ì²´ ì§ì›'ë§Œ í‘œì‹œí•´ ì§ì› í•„í„° ê¼¬ì„ ë°©ì§€ */
function loadAttEmployeeOptions() {
    var storeEl = document.getElementById('att-store-filter');
    var empEl = document.getElementById('att-employee-filter');
    if (!storeEl || !empEl) return;
    var store = (storeEl.value || '').trim();
    var storeText = storeEl.options[storeEl.selectedIndex] ? (storeEl.options[storeEl.selectedIndex].text || '').trim() : '';
    var isAllStores = !store || store === 'All' || storeText === 'ì „ì²´ ë§¤ì¥' || storeText.indexOf('ì „ì²´') >= 0;
    var allEmpText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].att_all_employees) ? I18N[currentLang].att_all_employees : (I18N.ko && I18N.ko.att_all_employees) ? I18N.ko.att_all_employees : "ì „ì²´ ì§ì›";
    var selectFirstText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].att_select_store_first) ? I18N[currentLang].att_select_store_first : (I18N.ko && I18N.ko.att_select_store_first) ? I18N.ko.att_select_store_first : "ë§¤ì¥ì„ ë¨¼ì € ì„ íƒ";
    empEl.disabled = true;
    empEl.innerHTML = '<option value="">' + selectFirstText + '</option>';
    if (isAllStores) {
        empEl.innerHTML = '<option value="">' + allEmpText + '</option>';
        empEl.disabled = false;
        return;
    }
    google.script.run
        .withSuccessHandler(function(list) {
            var optHtml = '<option value="">' + allEmpText + '</option>';
            if (list && list.length > 0) {
                list.forEach(function(emp) {
                    var nm = (emp.name || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    var display = (emp.name || '') + (emp.nick ? ' (' + (emp.nick || '') + ')' : '');
                    display = display.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    optHtml += '<option value="' + nm + '">' + display + '</option>';
                });
            } else {
                optHtml += '<option value="" disabled>í•´ë‹¹ ë§¤ì¥ì— ë“±ë¡ëœ ì§ì› ì—†ìŒ</option>';
            }
            empEl.innerHTML = optHtml;
            empEl.disabled = false;
        })
        .withFailureHandler(function() {
            empEl.innerHTML = '<option value="">ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</option>';
            empEl.disabled = false;
        })
        .getStoreStaffOnly(store);
}

/** [ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸] ì¼ë³„ ìš”ì•½ ëª©ë¡ ë Œë” (ì „ì—­). list ì—†ìœ¼ë©´ lastAttendanceSummaryList ì‚¬ìš©. */
function renderDailySummaryList(list) {
    list = list || lastAttendanceSummaryList || [];
    var tbody = document.getElementById('att-list-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    var approvalTypeFilterEl = document.getElementById('att-approval-type-filter');
    var approvalTypeFilter = (approvalTypeFilterEl && approvalTypeFilterEl.value) ? approvalTypeFilterEl.value : 'all';
    if (list && list.length > 0 && approvalTypeFilter !== 'all') {
        list = list.filter(function(r) { return r.approvalType === approvalTypeFilter; });
    }
    if (!list || list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="py-5 text-muted">ì¡°íšŒëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var noRecord = lang.att_no_record || "ë¯¸ê¸°ë¡";
    var statusNoOut = lang.att_status_no_out || "í‡´ê·¼ë¯¸ê¸°ë¡";
    var statusNormal = lang.att_status_normal || "ì •ìƒ";
    var wait = lang.att_wait || "ëŒ€ê¸°";
    var btnApprove = lang.att_approve_btn || "ìŠ¹ì¸";
    var btnReject = lang.att_reject_btn || "ë°˜ë ¤";
    var approvalDone = lang.att_approval_done || "ìŠ¹ì¸ì™„ë£Œ";
    list.forEach(function(r) {
        var lateStr = (r.lateMin && r.lateMin !== 0) ? 'ì§€ê° ' + r.lateMin + 'ë¶„' : '';
        var earlyStr = (r.earlyMin && r.earlyMin !== 0) ? 'ì¡°í‡´ ' + r.earlyMin + 'ë¶„' : '';
        var otStr = (r.otMin && r.otMin !== 0) ? 'ì—°ì¥ ' + r.otMin + 'ë¶„' : '';
        var lateExtraText = [lateStr, earlyStr, otStr].filter(Boolean).join(' / ') || '-';
        var diffText = (r.diffMin != null && r.diffMin !== 0) ? (r.diffMin > 0 ? '+' : '') + r.diffMin + 'ë¶„' : '-';
        var approval = String(r.approval || '').trim();
        var status = String(r.status || '').trim();
        var onlyIn = r.onlyIn === true;
        var showApprovalButtons = !onlyIn && (approval !== 'ìŠ¹ì¸ì™„ë£Œ' && approval !== 'ë°˜ë ¤') && (r.lateMin > 0 || r.otMin > 0 || status.indexOf('ìœ„ì¹˜ë¯¸í™•ì¸') !== -1 || status.indexOf('ìŠ¹ì¸ëŒ€ê¸°') !== -1 || status.indexOf('ê°•ì œí‡´ê·¼') !== -1);
        var approvalRow = r.approvalRow != null ? r.approvalRow : 0;
        var outStr = (r.outTimeStr === 'ë¯¸ê¸°ë¡') ? noRecord : (r.outTimeStr || '-');
        var statusStr = (status === 'í‡´ê·¼ë¯¸ê¸°ë¡') ? statusNoOut : (status === 'ì •ìƒ') ? statusNormal : (status || '-');
        var approvalStr = (approval === 'ëŒ€ê¸°') ? wait : (approval === 'ìŠ¹ì¸ì™„ë£Œ') ? approvalDone : (approval === 'ë°˜ë ¤') ? btnReject : (approval || '-');
        var isForcedOut = (r.approvalType === 'forced_out');
        var otPlaceholder = (typeof lang.att_ot_min === 'string') ? lang.att_ot_min : 'ì—°ì¥(ë¶„)';
        var actionCell = '';
        if (onlyIn) {
            actionCell = '<td><small class="text-muted">' + statusStr + '</small></td>';
        } else if (showApprovalButtons && approvalRow) {
            if (isForcedOut) {
                actionCell = '<td><input type="number" id="att-ot-' + approvalRow + '" min="0" max="9999" placeholder="' + otPlaceholder + '" class="form-control form-control-sm d-inline-block me-1" style="width:4rem;"> <button type="button" class="btn btn-sm btn-success me-1" onclick="processAttApprovalWithOt(' + approvalRow + ')">' + btnApprove + '</button><button type="button" class="btn btn-sm btn-danger" onclick="processAttApproval(' + approvalRow + ',\'ë°˜ë ¤\')">' + btnReject + '</button></td>';
            } else {
                actionCell = '<td><button type="button" class="btn btn-sm btn-success me-1" onclick="processAttApproval(' + approvalRow + ',\'ìŠ¹ì¸ì™„ë£Œ\')">' + btnApprove + '</button><button type="button" class="btn btn-sm btn-danger" onclick="processAttApproval(' + approvalRow + ',\'ë°˜ë ¤\')">' + btnReject + '</button></td>';
            }
        } else {
            actionCell = '<td><small class="text-muted">' + approvalStr + '</small></td>';
        }
        var actualHrsText = (r.actualWorkHrs != null) ? r.actualWorkHrs : '-';
        tbody.innerHTML += '<tr><td>' + (r.date || '') + '</td><td><small>' + (r.store || '') + '</small></td><td><b>' + (r.name || '') + '</b></td><td>' + (r.inTimeStr || '-') + '</td><td>' + outStr + '</td><td>' + (r.breakMin != null ? r.breakMin : '-') + '</td><td>' + actualHrsText + '</td><td>' + (r.plannedWorkHrs != null ? r.plannedWorkHrs : '-') + '</td><td>' + diffText + '</td><td>' + lateExtraText + '</td><td>' + statusStr + '</td>' + actionCell + '</tr>';
    });
}

/** ìŠ¹ì¸ ìœ í˜• í•„í„° ë³€ê²½ ì‹œ ì €ì¥ëœ ëª©ë¡ìœ¼ë¡œë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° */
function rerenderAttendanceByApprovalType() {
    if (lastAttendanceSummaryList) renderDailySummaryList(lastAttendanceSummaryList);
}

/** [ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸] ì¡°íšŒ - íŒŒë¼ë¯¸í„°ë¥¼ ê°ì²´ë¡œ ì „ë‹¬, 'ì „ì²´ ë§¤ì¥'Â·ì˜¤í”¼ìŠ¤ í•„í„° ì„œë²„ ì¸ì‹ ë³´ê°• */
function loadAttendanceRecords() {
    var startEl = document.getElementById('att-start');
    var endEl = document.getElementById('att-end');
    var storeEl = document.getElementById('att-store-filter');
    var empEl = document.getElementById('att-employee-filter');
    var tbody = document.getElementById('att-list-body');
    if (!startEl || !endEl || !storeEl || !tbody) return;

    var startStr = (startEl.value || '').trim();
    var endStr = (endEl.value || '').trim();
    if (!startStr || !endStr) {
        var now = new Date();
        var today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        var firstDay = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-01';
        startStr = startStr || firstDay;
        endStr = endStr || today;
        if (startEl) startEl.value = startStr;
        if (endEl) endEl.value = endStr;
    }

    var storeVal = (storeEl.value || '').trim();
    var storeText = storeEl.options[storeEl.selectedIndex] ? (storeEl.options[storeEl.selectedIndex].text || '').trim() : '';
    if (!storeVal || storeText.indexOf('ì „ì²´') >= 0 || storeVal === 'All' || storeVal.toLowerCase() === 'all' || storeVal === 'ì „ì²´ ë§¤ì¥' || storeVal === 'ì „ì²´') {
        storeVal = 'All';
    }
    var employeeVal = (empEl && empEl.value) ? (empEl.value || '').trim() : '';
    var sendStore = (storeVal || 'All');
    if (sendStore === '' || String(sendStore).toLowerCase().replace(/\s/g, '') === 'all') sendStore = 'All';
    if (sendStore === 'All') employeeVal = '';  // ì „ì²´ ë§¤ì¥ì´ë©´ ì§ì› í•„í„° ë¬´ì‹œ(ì „ì²´ ì§ì›ìœ¼ë¡œ ì¡°íšŒ)

    var isAllStores = (sendStore === 'All');
    var s = String(sendStore).toLowerCase();
    var isOfficeStores = (s.indexOf('office') !== -1 || s.indexOf('ì˜¤í”¼ìŠ¤') !== -1 || s.indexOf('ë³¸ì‚¬') !== -1);

    var statusFilterEl = document.getElementById('att-status-filter');
    var approvalOnly = (statusFilterEl && statusFilterEl.value === 'pending');
    if (typeof load === 'function') load(1);
    var mode = (isAllStores ? 'all' : isOfficeStores ? 'office' : 'store');
    var payload = { start: startStr, end: endStr, store: sendStore, emp: employeeVal, mode: mode, approvalOnly: approvalOnly, dailySummary: true };

    function doLoadList() {
        google.script.run
            .withSuccessHandler(function(list) {
                if (typeof load === 'function') load(0);
                lastAttendanceSummaryList = list || [];
                renderDailySummaryList(list);
            })
            .withFailureHandler(function(err) {
                if (typeof load === 'function') load(0);
                tbody.innerHTML = '<tr><td colspan="12" class="py-5 text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            })
            .getAttendanceListFromPayload(JSON.stringify(payload));
    }

    doLoadList();
    var batchWrap = document.getElementById('att-batch-forced-wrap');
    if (batchWrap) batchWrap.style.display = (statusFilterEl && statusFilterEl.value === 'pending') ? '' : 'none';
}

/** ê¸°ê°„ ë‚´ í‡´ê·¼ ë¯¸ê¸°ë¡ ê±´ì„ ê°•ì œí‡´ê·¼(ìŠ¹ì¸ëŒ€ê¸°)ìœ¼ë¡œ ì¼ê´„ ìƒì„± í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ */
function runBatchForcedClockOutThenReload() {
    var startEl = document.getElementById('att-start');
    var endEl = document.getElementById('att-end');
    if (!startEl || !endEl) return;
    var startStr = (startEl.value || '').trim();
    var endStr = (endEl.value || '').trim();
    if (!startStr || !endStr) { alert('ì‹œì‘ì¼Â·ì¢…ë£Œì¼ì„ ì„ íƒí•œ ë’¤ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.'); return; }
    if (typeof load === 'function') load(1);
    google.script.run
        .withSuccessHandler(function() {
            if (typeof load === 'function') load(0);
            if (typeof loadAttendanceRecords === 'function') loadAttendanceRecords();
        })
        .withFailureHandler(function(err) {
            if (typeof load === 'function') load(0);
            alert(err && err.message ? err.message : 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .processDailyForcedClockOutForRange(startStr, endStr);
}

/** ê·¼íƒœ ìŠ¹ì¸/ë°˜ë ¤ ë²„íŠ¼ ì²˜ë¦¬. optOtMinutes: ê°•ì œí‡´ê·¼ ì‹œ ì—°ì¥(ë¶„) ì…ë ¥ ì‹œ ì „ë‹¬ */
function processAttApproval(row, decision, optOtMinutes) {
    var runner = google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        if (typeof loadAttendanceRecords === 'function') loadAttendanceRecords();
    });
    var uStore = (typeof userStore !== 'undefined') ? userStore : '';
    var uRole = (typeof userRole !== 'undefined') ? userRole : '';
    if (optOtMinutes != null && optOtMinutes !== '') {
        runner.processAttendanceApproval(row, decision, optOtMinutes, uStore, uRole);
    } else {
        runner.processAttendanceApproval(row, decision, null, uStore, uRole);
    }
}

/** ê°•ì œí‡´ê·¼ í–‰ì—ì„œ ì—°ì¥(ë¶„) ì…ë ¥ê°’ì„ ë„£ì–´ ìŠ¹ì¸ */
function processAttApprovalWithOt(approvalRow) {
    var el = document.getElementById('att-ot-' + approvalRow);
    var otVal = (el && el.value !== undefined) ? el.value.trim() : '';
    processAttApproval(approvalRow, 'ìŠ¹ì¸ì™„ë£Œ', otVal);
}

/** ê°•ì œ í‡´ê·¼ ê¸°ë¡ (ì¶œê·¼ë§Œ ìˆê³  í‡´ê·¼ ë¯¸ê¸°ë¡ì¸ ê²½ìš°, ì‹œê°„í‘œ ê³„íš í‡´ê·¼ìœ¼ë¡œ ê¸°ë¡ â†’ ìŠ¹ì¸ëŒ€ê¸°) */
function recordForcedClockOutFromUI(dateStr, storeName, employeeName) {
    if (!dateStr || !storeName || !employeeName) return;
    if (!confirm('í•´ë‹¹ ë‚ ì§œì˜ ê³„íš í‡´ê·¼ ì‹œê°ìœ¼ë¡œ ê°•ì œ í‡´ê·¼ì„ ê¸°ë¡í•©ë‹ˆë‹¤. ë§¤ë‹ˆì € ìŠ¹ì¸ í›„ ì¸ì •ë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;
    google.script.run
        .withSuccessHandler(function(msg) {
            alert(msg);
            if (typeof loadAttendanceRecords === 'function') loadAttendanceRecords();
        })
        .withFailureHandler(function(err) { alert(err.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); })
        .recordForcedClockOut(dateStr, storeName, employeeName);
}

/* ì‹œê°„í‘œ ê´€ë¦¬ ë°ì´í„° ë¡œë“œ (sch-date-filter/sch-store-filter UIê°€ ìˆì„ ë•Œë§Œ ë™ì‘) */
function loadScheduleManager() {
    const dateEl = document.getElementById('sch-date-filter');
    const storeEl = document.getElementById('sch-store-filter');
    const tbody = document.getElementById('sch-list-body');
    if (!dateEl || !storeEl || !tbody) return;
    const date = dateEl.value;
    const store = storeEl.value;
    if (!date) return;

    load(1);
    google.script.run
        .withSuccessHandler(function(list) {
            load(0);
            tbody.innerHTML = "";
            if (!list || !list.length) {
                tbody.innerHTML = "<tr><td colspan=\"6\" class=\"text-muted py-3\">í•´ë‹¹ ë‚ ì§œ/ë§¤ì¥ì— ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                return;
            }
            list.forEach(s => {
                tbody.innerHTML += `
                <tr>
                    <td><b>${s.name}</b><br><small>${s.store}</small></td>
                    <td><input type="time" id="pIn-${s.row}" class="form-control form-control-sm" value="${s.pIn || ""}"></td>
                    <td><input type="time" id="pOut-${s.row}" class="form-control form-control-sm" value="${s.pOut || ""}"></td>
                    <td><input type="time" id="pBS-${s.row}" class="form-control form-control-sm" value="${s.pBS || ""}"></td>
                    <td><input type="time" id="pBE-${s.row}" class="form-control form-control-sm" value="${s.pBE || ""}"></td>
                    <td><button class="btn btn-sm btn-success" onclick="saveScheduleRow(${s.row})">ğŸ’¾</button></td>
                </tr>`;
            });
        })
        .withFailureHandler(function(err) {
            load(0);
            tbody.innerHTML = "<tr><td colspan=\"6\" class=\"text-danger py-3\">ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì—°ê²° í™•ì¸)</td></tr>";
            console.error("getScheduleForAdmin error:", err);
        })
        .getScheduleForAdmin(date, store);
}

/* ì‹œê°„í‘œ ê°œë³„ ìˆ˜ì • ì €ì¥ */
function saveScheduleRow(row) {
    const data = {
        row: row,
        pIn: document.getElementById('pIn-'+row).value,
        pOut: document.getElementById('pOut-'+row).value,
        pBS: document.getElementById('pBS-'+row).value,
        pBE: document.getElementById('pBE-'+row).value
    };
    load(1);
    google.script.run.withSuccessHandler(res => {
        load(0);
        alert("ì‹œê°„í‘œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }).updateScheduleRow(data);
}

let currentStaff = "";
let isDrawing = false;

/** ë§¤ì¥ì´ ì˜¤í”¼ìŠ¤(ë³¸ì‚¬)ì¸ì§€ íŒë³„ - ìŠ¤ì¼€ì¤„ ê·¸ë¦¬ë“œì—ì„œ Office êµ¬ì—­ ì‚¬ìš© ì—¬ë¶€ */
function isOfficeStore(store) {
    var s = (store || '').toString().trim().toLowerCase();
    return s === 'office' || s === 'ì˜¤í”¼ìŠ¤' || s === 'ë³¸ì‚¬' || s.indexOf('office') !== -1;
}

/* [ìˆ˜ì •] 7ì¼ ê³ ì • ê·¸ë¦¬ë“œ ìƒì„± í•¨ìˆ˜ (ì˜¤í”¼ìŠ¤ ì„ íƒ ì‹œ Office êµ¬ì—­ë§Œ, ë§¤ì¥ ì„ íƒ ì‹œ Service/Kitchen) */
function initWeeklyGrid(type = 'sch') {
    const mondayEl = document.getElementById(type + '-week-monday');
    const monday = mondayEl ? (mondayEl.value || '').trim() : '';
    const startSel = document.getElementById('sch-start-hour');
    const endSel = document.getElementById('sch-end-hour');
    let startHour = startSel ? parseInt(startSel.value, 10) : NaN;
    let endHour = endSel ? parseInt(endSel.value, 10) : NaN;
    if (isNaN(startHour)) startHour = 6;
    if (isNaN(endHour)) endHour = 23;
    if (endHour < startHour) endHour = 23;

    if (!monday) return;

    var storeEl = (type === 'view') ? document.getElementById('view-store-select') : document.getElementById('sch-store-select');
    var store = storeEl ? (storeEl.value || '').trim() : '';
    var areas = isOfficeStore(store) ? ['Office'] : ['Service', 'Kitchen'];
    window.currentScheduleAreas = areas;

    // 1. ê¸°ì¡´ ë‚´ìš© ì‹¹ ë¹„ìš°ê¸° (10ì¼ì´ ë‚˜ì˜¤ëŠ” ì£¼ë²” ë°©ì§€)
    const headerRow = document.getElementById(type + '-header-row');
    const areaRow = document.getElementById(type + '-header-areas');
    const tbody = document.getElementById(type + '-body-slots');

    if (!headerRow || !areaRow || !tbody) return;

    headerRow.innerHTML = "<th>Time</th>";
    areaRow.innerHTML = "<th></th>";
    tbody.innerHTML = "";

    var areaStyles = { Service: 'background:#FFE0B2; color:#E65100;', Kitchen: 'background:#C8E6C9; color:#2E7D32;', Office: 'background:#BBDEFB; color:#1976D2;' };
    var areaLabels = { Service: 'ì„œë¹„ìŠ¤', Kitchen: 'ì£¼ë°©', Office: 'ì˜¤í”¼ìŠ¤' };

    // 2. í—¤ë” ìƒì„± (ë”± 7ë²ˆë§Œ ë°˜ë³µ!) - íƒœêµ­ ì‹œê°„ ê¸°ì¤€: yyyy-MM-dd ë¬¸ìì—´ ê¸°ì¤€ ì¼ìˆ˜ ê³„ì‚°(ë¸Œë¼ìš°ì € ì‹œê°„ëŒ€ ë¬´ê´€)
    var mondayNorm = (monday || "").substring(0, 10);
    for(let i=0; i<7; i++) {
        var dayStr = (typeof addDaysToYyyyMmDd === "function") ? addDaysToYyyyMmDd(mondayNorm, i) : mondayNorm;
        var parts = dayStr.split("-");
        var dateStr = (parts.length >= 3) ? (parseInt(parts[1],10) + "/" + parseInt(parts[2],10)) : dayStr;

        headerRow.innerHTML += `<th colspan="${areas.length}" class="bg-dark text-white sch-date-header text-center">${dateStr}</th>`;

        areas.forEach(function(area) {
            areaRow.innerHTML += `<th class="small py-1 text-center" style="min-width:60px;${areaStyles[area] || ''}">${areaLabels[area] || area}<br><span id="${type}-count-${i}-${area}" class="area-count fw-bold">0</span>ëª…</th>`;
        });
    }

    // 3. ë°”ë””(ì‹œê°„ ìŠ¬ë¡¯) ìƒì„±
    let currentH = startHour;
    let isFinished = false;
    var isViewOnly = (type === 'view');
    var slotClick = isViewOnly ? '' : ' onclick="toggleMultiSlot(this)"';

    while (!isFinished) {
        let row = `<tr><td class="time-label text-center fw-bold">${currentH.toString().padStart(2,'0')}:00</td>`;

        for(let day=0; day<7; day++) {
            areas.forEach(function(area) {
                row += `<td class="hour-cell p-0">
                            <div class="slot-container">
                                <div class="half-slot"${slotClick} data-day="${day}" data-area="${area}" data-time="${currentH.toString().padStart(2,'0')}:00"></div>
                                <div class="half-slot"${slotClick} data-day="${day}" data-area="${area}" data-time="${currentH.toString().padStart(2,'0')}:30"></div>
                            </div>
                        </td>`;
            });
        }
        tbody.innerHTML += row + "</tr>";

        if (currentH === endHour) isFinished = true;
        currentH = (currentH + 1) % 24;
    }

    if (typeof updateDailyCounts === 'function') updateDailyCounts(type);
}


/* êµ¬ì—­ë³„(Service/Kitchen/Office) ë‹¹ì¼ ì´ ê·¼ë¬´ ì¸ì›ìˆ˜ë¥¼ ê³„ì‚°í•´ í—¤ë”ì— í‘œì‹œ */
function updateDailyCounts(type = 'sch') {
    var areas = window.currentScheduleAreas || ['Service', 'Kitchen'];
    for(let day=0; day<7; day++) {
        areas.forEach(function(area) {
            const slots = document.querySelectorAll('#' + type + '-body-slots .half-slot[data-day="' + day + '"][data-area="' + area + '"].active-fill');
            let uniqueStaff = new Set();
            slots.forEach(function(slot) {
                let namesStr = slot.getAttribute('data-names');
                if(namesStr) {
                    namesStr.split(',').forEach(function(n) { uniqueStaff.add(n.replace("BRK_", "")); });
                }
            });
            const countEl = document.getElementById(type + '-count-' + day + '-' + area);
            if(countEl) countEl.innerText = uniqueStaff.size;
        });
    }
}


// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒì§€ ë¨¼ì € ì±„ìš°ê¸° ì‹¤í–‰
fillHourSelectors();

/* [ì¶”ê°€] ì´ˆê¸° ë¡œë“œ ì‹œ ì‹œê°„ ë²”ìœ„ ì„ íƒì§€ ì±„ìš°ê¸° (00ì‹œ ~ 24ì‹œ) */
function fillHourSelectors() {
    const s = document.getElementById('sch-start-hour');
    const e = document.getElementById('sch-end-hour');
    if(!s || s.options.length > 0) return;

    for(let i=0; i<24; i++) {
        let h = i.toString().padStart(2, '0') + ":00";
        s.add(new Option(h, i));
        e.add(new Option(h, i));
    }
    s.value = 9;  // ê¸°ë³¸ ì‹œì‘: 09:00 (ì²« í–‰ì— 09:00, 09:30 í‘œì‹œ)
    e.value = 18; // ê¸°ë³¸ ì¢…ë£Œ: 18:00
}

/* ì¹¸ í´ë¦­ ì‹œ ì‘ë™í•˜ëŠ” í† ê¸€ í•¨ìˆ˜ */
function toggleSlot(el) {
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

    // ì´ë¯¸ í•´ë‹¹ ì§ì›ì´ ì±„ì›Œì ¸ ìˆë‹¤ë©´ ë¹„ìš°ê¸° (ì‚­ì œ)
    if(el.getAttribute('data-name') === selectedName) {
        el.classList.remove('active-fill');
        el.innerHTML = "";
        el.removeAttribute('data-name');
        el.removeAttribute('data-nick');
    } 
    // ë¹„ì–´ìˆê±°ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ìˆë‹¤ë©´ í˜„ì¬ ì„ íƒëœ ì§ì›ìœ¼ë¡œ ì±„ìš°ê¸°
    else {
        el.classList.add('active-fill');
        el.innerHTML = selectedNick; // í™”ë©´ì—ëŠ” ë‹‰ë„¤ì„ í‘œì‹œ
        el.setAttribute('data-name', selectedName); // ì €ì¥ìš© ì‹¤ëª… ì†ì„±
        el.setAttribute('data-nick', selectedNick);
        
        // êµ¬ì—­(Hall/Kitchen)ì— ë”°ë¼ ìƒ‰ìƒì„ ì•½ê°„ ë‹¤ë¥´ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ ì œì–´ ê°€ëŠ¥
        if(el.getAttribute('data-area') === "Hall") {
            el.style.backgroundColor = "#E65100"; // í™€: ì£¼í™©ìƒ‰ê³„ì—´
        } else {
            el.style.backgroundColor = "#2E7D32"; // ì£¼ë°©: ì´ˆë¡ìƒ‰ê³„ì—´
        }
        el.style.color = "white";
    }
}

// 2. ë“œë˜ê·¸ ìƒ‰ì¹  ë¡œì§
function startDraw(el) { if(!currentStaff) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!"); isDrawing = true; fillSlot(el); }
function moveDraw(el) { if(isDrawing) fillSlot(el); }
function fillSlot(el) {
    if(el.classList.contains('active-fill') && el.getAttribute('data-staff') === currentStaff) {
        el.classList.remove('active-fill'); el.innerText = ""; el.removeAttribute('data-staff');
    } else {
        el.classList.add('active-fill'); el.innerText = currentStaff.split(' ')[0];
        el.setAttribute('data-staff', currentStaff);
    }
}

/* [ìµœì¢…] ë°ì´í„° ë¶„ì„ í›„ ì„œë²„(ì‹œíŠ¸) ì €ì¥ í•¨ìˆ˜ */
function prepareAndSave() {
    const store = document.getElementById('sch-store-select').value;
    const monday = document.getElementById('sch-week-monday').value;
    const slots = document.querySelectorAll('.half-slot.active-fill');
    
    if(!monday) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    if(!store || store === "All") return alert("ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

    // ë°ì´í„° êµ¬ì¡°: { "ë‚ ì§œ_ì´ë¦„_êµ¬ì—­": { work: [ì‹œê°„ë“¤], break: [ì‹œê°„ë“¤] } }
    let map = {}; 

    slots.forEach(s => {
        let namesStr = s.getAttribute('data-names');
        if(!namesStr) return;
        
        let names = namesStr.split(',');
        let day = parseInt(s.getAttribute('data-day'));
        let time = s.getAttribute('data-time');
        let area = s.getAttribute('data-area');
        
        let datePart = (typeof addDaysToYyyyMmDd === "function") ? addDaysToYyyyMmDd((monday || "").substring(0, 10), day) : (monday || "").substring(0, 10);

        names.forEach(n => {
            let name = n.trim();
            if(!name) return;

            // íœ´ê²Œ ì—¬ë¶€ í™•ì¸ ë° ì‹¤ì œ ì´ë¦„ ì¶”ì¶œ
            const isBrk = name.startsWith("BRK_");
            const realName = isBrk ? name.replace("BRK_", "") : name;
            
            let key = datePart + "_" + realName + "_" + area;
            if(!map[key]) map[key] = { work: [], break: [] };
            
            // íœ´ê²Œì™€ ê·¼ë¬´ ì‹œê°„ì„ ê°ê° ë¶„ë¥˜í•´ì„œ ìˆ˜ì§‘
            if(isBrk) map[key].break.push(time);
            else map[key].work.push(time);
        });
    });

    let finalData = [];
    for(let k in map) {
        let parts = k.split('_');
        let date = parts[0];
        let area = parts[parts.length - 1];
        let name = parts.length > 2 ? parts.slice(1, -1).join('_') : (parts[1] || '');
        
        // í•´ë‹¹ ì§ì›ì˜ ëª¨ë“  ì‹œê°„(ê·¼ë¬´+íœ´ê²Œ)ì„ í•©ì³ì„œ ì¶œí‡´ê·¼ ë²”ìœ„ ê³„ì‚°
        let allTimes = [...map[k].work, ...map[k].break].sort();
        if(allTimes.length === 0) continue;

        // 1. ì „ì²´ ì¶œê·¼/í‡´ê·¼ ì‹œê°„ ê³„ì‚°
        let pIn = allTimes[0];
        let last = allTimes[allTimes.length - 1];
        let [hh, mm] = last.split(':').map(Number);
        mm += 30; if(mm === 60) { hh++; mm = 0; }
        let pOut = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;

        // 2. íœ´ê²Œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ê³„ì‚° (ê²€ì •ìƒ‰ ì¹´ë“œ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
        let pBS = "", pBE = "";
        if(map[k].break.length > 0) {
            let brkTimes = map[k].break.sort();
            pBS = brkTimes[0];
            let bLast = brkTimes[brkTimes.length - 1];
            let [bhh, bmm] = bLast.split(':').map(Number);
            bmm += 30; if(bmm === 60) { bhh++; bmm = 0; }
            pBE = `${bhh.toString().padStart(2, '0')}:${bmm.toString().padStart(2, '0')}`;
        }

        finalData.push({
            date: date,
            name: name,
            pIn: pIn,
            pOut: pOut,
            pBS: pBS, // íœ´ê²Œ ì‹œì‘ ì‹œê°„
            pBE: pBE, // íœ´ê²Œ ì¢…ë£Œ ì‹œê°„
            remark: "[" + area + "]"
        });
    }

    if(finalData.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    load(1);
    google.script.run
        .withSuccessHandler(res => {
            load(0);
            alert(res);
        })
        .withFailureHandler(function(err) {
            load(0);
            alert("ì£¼ê°„ ìŠ¤ì¼€ì¤„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .saveWeeklySmartSchedule(store, monday, finalData);
}

let selectedName = ""; // ì‹œíŠ¸ ì €ì¥ìš© (ì‹¤ëª…)
let selectedNick = ""; // í™”ë©´ í‘œì‹œìš© (ë‹‰ë„¤ì„)

/* ì§ì› ëª©ë¡ ë¡œë“œ ë° ì„ íƒ í•¨ìˆ˜ */
function loadStaffAndGrid() {
    const store = document.getElementById('sch-store-select').value;
    if(!store || store === "All") return;
    
    google.script.run.withSuccessHandler(function(list) {
        const pool = document.getElementById('sch-staff-list');
        pool.innerHTML = "";
        
        list.forEach(function(emp) {
            const btn = document.createElement("button");
            btn.className = "list-group-item list-group-item-action staff-item";
            btn.innerHTML = '<div><b>' + emp.name + '</b> (' + emp.nick + ')</div><div class="staff-dept small text-muted">[' + emp.dept + ']</div>';
            btn.onclick = function() {
                document.querySelectorAll('.staff-item').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                selectedName = emp.name;
                selectedNick = emp.nick;
            };
            pool.appendChild(btn);
        });
        initWeeklyGrid();
        var isOffice = isOfficeStore(store);
        var btnService = document.getElementById('btn-quick-service');
        var btnKitchen = document.getElementById('btn-quick-kitchen');
        var btnOffice = document.getElementById('btn-quick-office');
        if (btnService) btnService.style.display = isOffice ? 'none' : 'inline-block';
        if (btnKitchen) btnKitchen.style.display = isOffice ? 'none' : 'inline-block';
        if (btnOffice) btnOffice.style.display = isOffice ? 'inline-block' : 'none'; 
    }).getStoreStaffOnly(store);
}

function toggleMultiSlot(el) {
    if (el.closest('.view-schedule-readonly')) return;
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

    // 1. ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let assignedNames = el.getAttribute('data-names') ? el.getAttribute('data-names').split(',') : [];
    let assignedNicks = el.getAttribute('data-nicks') ? el.getAttribute('data-nicks').split(',') : [];

    const nameIdx = assignedNames.indexOf(selectedName);

    // 2. ì¶”ê°€ ë˜ëŠ” ì œê±° ê²°ì •
    if(nameIdx > -1) {
        // ì´ë¯¸ ëª…ë‹¨ì— ìˆìœ¼ë©´ ì œê±° (í† ê¸€)
        assignedNames.splice(nameIdx, 1);
        assignedNicks.splice(nameIdx, 1);
    } else {
        // ê°™ì€ ìš”ì¼ ë‹¤ë¥¸ ì¹¸ì— ì´ë¯¸ ë°°ì •ë˜ì–´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
        var day = el.getAttribute('data-day');
        var otherSlots = document.querySelectorAll('#sch-body-slots .half-slot[data-day="' + day + '"]');
        for (var o = 0; o < otherSlots.length; o++) {
            if (otherSlots[o] === el) continue;
            var onames = (otherSlots[o].getAttribute('data-names') || '').split(',');
            for (var n = 0; n < onames.length; n++) {
                var nm = (onames[n] || '').trim();
                if (nm === selectedName || nm === 'BRK_' + selectedName) {
                    alert('í•´ë‹¹ ìš”ì¼ì—ëŠ” ì´ë¯¸ ë°°ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì¹¸ì„ í´ë¦­í•´ ì œê±°í•œ ë’¤ ë°°ì •í•˜ì„¸ìš”.');
                    return;
                }
            }
        }
        assignedNames.push(selectedName);
        assignedNicks.push(selectedNick);
    }

    // 3. ì—˜ë¦¬ë¨¼íŠ¸ì— ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
    el.setAttribute('data-names', assignedNames.join(','));
    el.setAttribute('data-nicks', assignedNicks.join(','));

    // 4. í™”ë©´ ê·¸ë¦¬ê¸° (ë‹‰ë„¤ì„ ì¹© ìƒì„±)
    el.innerHTML = "";
    const area = el.getAttribute('data-area'); // 'Service', 'Kitchen', 'Office'
    
    var chipColor = '#2E7D32';
    if (area === 'Service') chipColor = '#E65100';
    else if (area === 'Office') chipColor = '#1976D2';
    assignedNicks.forEach(function(nick) {
        el.innerHTML += '<span class="nick-chip" style="background:' + chipColor + '; color:white;">' + nick + '</span>';
    });

    // 5. ì¹¸ì˜ ë°°ê²½ìƒ‰ ê°•ì¡° ì²˜ë¦¬
    var bgColor = (area === 'Service') ? '#FFF3E0' : (area === 'Office') ? '#E3F2FD' : '#E8F5E9';
    if(assignedNames.length > 0) {
        el.classList.add('active-fill');
        el.style.backgroundColor = bgColor;
    } else {
        el.classList.remove('active-fill');
        el.style.backgroundColor = "";
    }
}

/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„ ì„ íƒì§€(08:00~23:30)ë¥¼ ì±„ì›Œì¤ë‹ˆë‹¤ */
function fillTimeOptions() {
    const startSelect = document.getElementById('quick-start');
    const breakSelect = document.getElementById('quick-break-start');
    for(let h=8; h<24; h++) {
        ["00", "30"].forEach(m => {
            let t = `${h.toString().padStart(2,'0')}:${m}`;
            startSelect.add(new Option(t, t));
            breakSelect.add(new Option(t, t));
        });
    }
    if (startSelect) startSelect.value = "09:30";
    if (breakSelect) breakSelect.value = "13:30";
}

function applyQuickSchedule(area) {
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
    
    const startTimeStr = document.getElementById('quick-start').value;
    const workHours = parseFloat(document.getElementById('quick-work-hours').value) || 0;
    const breakStartTimeStr = document.getElementById('quick-break-start').value;
    const breakHours = parseFloat(document.getElementById('quick-break-hours').value) || 0;
    const targetDay = document.getElementById('quick-day').value;
    const gridStartHour = parseInt(document.getElementById('sch-start-hour').value);

    if(isNaN(workHours)) return alert("ê·¼ë¬´ ì‹œê°„ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");

    // --- [1ë‹¨ê³„] í•´ë‹¹ ì§ì›ì˜ ê¸°ì¡´ ê¸°ë¡ ì´ˆê¸°í™” (ë®ì–´ì“°ê¸° ì¤€ë¹„) ---
    const allSlots = document.querySelectorAll(`.half-slot[data-day="${targetDay}"][data-area="${area}"]`);
    
    allSlots.forEach(slot => {
        let names = slot.getAttribute('data-names') ? slot.getAttribute('data-names').split(',') : [];
        let nicks = slot.getAttribute('data-nicks') ? slot.getAttribute('data-nicks').split(',') : [];
        
        // ì¼ë°˜ ê·¼ë¬´(selectedName)ì™€ íœ´ê²Œ(BRK_selectedName) ê¸°ë¡ì„ ëª¨ë‘ ì°¾ì•„ ì œê±°
        const brkName = "BRK_" + selectedName;
        
        for (let i = names.length - 1; i >= 0; i--) {
            if (names[i] === selectedName || names[i] === brkName) {
                names.splice(i, 1);
                nicks.splice(i, 1);
            }
        }
        
        slot.setAttribute('data-names', names.join(','));
        slot.setAttribute('data-nicks', nicks.join(','));
        refreshSlotUI(slot); // UIë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
    });

    // --- [2ë‹¨ê³„] ì‹œê°„ ê³„ì‚° ë¡œì§ ---
    let [sH, sM] = startTimeStr.split(':').map(Number);
    let startMin = sH * 60 + sM;
    if (sH < gridStartHour) startMin += 1440; // ìì • ì´ì›” ì²˜ë¦¬
    let endMin = startMin + (workHours + breakHours) * 60;

    let [bSH, bSM] = breakStartTimeStr.split(':').map(Number);
    let bStartMin = bSH * 60 + bSM;
    if (bSH < gridStartHour) bStartMin += 1440;
    let bEndMin = bStartMin + (breakHours * 60);

    // --- [3ë‹¨ê³„] ì‹ ê·œ ìŠ¤ì¼€ì¤„ ì ìš© ---
    allSlots.forEach(slot => {
        let [currH, currM] = slot.getAttribute('data-time').split(':').map(Number);
        let currMin = currH * 60 + currM;
        if (currH < gridStartHour) currMin += 1440;

        if (currMin >= startMin && currMin < endMin) {
            let names = slot.getAttribute('data-names') ? slot.getAttribute('data-names').split(',') : [];
            let nicks = slot.getAttribute('data-nicks') ? slot.getAttribute('data-nicks').split(',') : [];
            
            if (currMin >= bStartMin && currMin < bEndMin) {
                // íœ´ê²Œ ì‹œê°„: ê²€ì •ìƒ‰ ë‹‰ë„¤ì„ ì¹´ë“œ
                names.push("BRK_" + selectedName);
                nicks.push(selectedNick);
            } else {
                // ê·¼ë¬´ ì‹œê°„: ì¼ë°˜ ìƒ‰ìƒ ë‹‰ë„¤ì„ ì¹´ë“œ
                names.push(selectedName);
                nicks.push(selectedNick);
            }
            
            slot.setAttribute('data-names', names.join(','));
            slot.setAttribute('data-nicks', nicks.join(','));
            refreshSlotUI(slot);
        }
    });
    if (typeof updateDailyCounts === 'function') updateDailyCounts();
}

/* [ë³´ì¡°] ìŠ¬ë¡¯ì˜ UIë¥¼ ë°ì´í„°ì— ë§ê²Œ ë‹¤ì‹œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ */
function refreshSlotUI(el) {
    el.innerHTML = "";
    let names = el.getAttribute('data-names') ? el.getAttribute('data-names').split(',') : [];
    let nicks = el.getAttribute('data-nicks') ? el.getAttribute('data-nicks').split(',') : [];
    const area = el.getAttribute('data-area');
    var color = (area === 'Service') ? '#E65100' : (area === 'Office') ? '#1976D2' : '#2E7D32';

    nicks.forEach(function(nick, i) {
        if (names[i] && names[i].startsWith("BRK_")) {
            el.innerHTML += '<span class="nick-chip break-mode">' + nick + '</span>';
        } else {
            el.innerHTML += '<span class="nick-chip" style="background-color:' + color + ';">' + nick + '</span>';
        }
    });

    if (names.length > 0) el.classList.add('active-fill');
    else el.classList.remove('active-fill');
}

// ì´ˆê¸°í™” ì‹œ ì‹œê°„ ì„ íƒì§€ ìƒì„± ì‹¤í–‰
fillTimeOptions();

/* íƒœêµ­(Asia/Bangkok) ë“± ì‹œê°„ëŒ€ ë¬´ê´€: yyyy-MM-ddì— Nì¼ ë”í•œ ë‚ ì§œ ë°˜í™˜ (UTC ê¸°ì¤€ ì¼ìˆ˜ ê³„ì‚°) */
function addDaysToYyyyMmDd(dateStr, days) {
    var p = (dateStr || "").substring(0, 10).split("-");
    if (p.length !== 3) return dateStr;
    var y = parseInt(p[0], 10), m = parseInt(p[1], 10) - 1, d = parseInt(p[2], 10);
    var utc = Date.UTC(y, m, d) + (days || 0) * 24 * 60 * 60 * 1000;
    var t = new Date(utc);
    return t.getUTCFullYear() + "-" + String(t.getUTCMonth() + 1).padStart(2, "0") + "-" + String(t.getUTCDate()).padStart(2, "0");
}
/* í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼ ë‚ ì§œ(YYYY-MM-DD) ë°˜í™˜ - UTC ê¸°ì¤€ ìš”ì¼ ê³„ì‚°(íƒœêµ­ ì‹œê°„ê³¼ ì¼ì¹˜) */
function getMondayOfWeek(dateStr) {
    if (!dateStr) return '';
    var p = (dateStr || "").substring(0, 10).split("-");
    if (p.length !== 3) return dateStr;
    var y = parseInt(p[0], 10), m = parseInt(p[1], 10) - 1, d = parseInt(p[2], 10);
    var dayOfWeek = new Date(Date.UTC(y, m, d)).getUTCDay();
    var diff = dayOfWeek === 0 ? -6 : -(dayOfWeek - 1);
    return addDaysToYyyyMmDd(dateStr, diff);
}
/* ë‚ ì§œ ì…ë ¥ ì‹œ í•´ë‹¹ ì£¼ ì›”ìš”ì¼ë¡œ ìë™ ë³´ì • */
function snapToMonday(el) {
    if (!el || !el.value) return;
    var monday = getMondayOfWeek(el.value);
    if (monday && monday !== el.value) el.value = monday;
}

/* [ëª¨ë°”ì¼í˜•] ì£¼ê°„ ìŠ¤ì¼€ì¤„ ë°ì´í„°ë¥¼ í…Œì´ë¸” HTMLë¡œ ë³€í™˜ (ì¡°íšŒ íƒ­ìš©). areaFilter Allì´ë©´ êµ¬ì—­ í‘œì‹œ */
function buildAdminScheduleTableHtml(list, mondayStr, areaFilter) {
    if (!list || list.length === 0) return "<p class=\"text-muted py-4 text-center mb-0\">í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    areaFilter = areaFilter || "All";
    if (areaFilter !== "All") list = list.filter(function(r) { return (r.area || "Service") === areaFilter; });
    if (!list || list.length === 0) return "<p class=\"text-muted py-4 text-center mb-0\">í•´ë‹¹ êµ¬ì—­ì— ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    var dayLabels = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"];
    var areaLabelKo = { Service: "ì„œë¹„ìŠ¤", Kitchen: "ì£¼ë°©", Office: "ì˜¤í”¼ìŠ¤" };
    var mondayNorm = (mondayStr || "").substring(0, 10);
    var dayStrs = [];
    for (var i = 0; i < 7; i++) {
        dayStrs.push(typeof addDaysToYyyyMmDd === "function" ? addDaysToYyyyMmDd(mondayNorm, i) : mondayNorm);
    }
    var byPerson = {};
    list.forEach(function(r) {
        var key = (r.store || "") + "|" + (r.name || "");
        if (!byPerson[key]) byPerson[key] = { name: r.nick || r.name || "", store: r.store || "", area: r.area || "Service", byDate: {} };
        byPerson[key].byDate[r.date] = r;
    });
    var personKeys = Object.keys(byPerson).sort();
    var dailyCount = [0, 0, 0, 0, 0, 0, 0];
    var persons = [];
    var multiArea = (function() { var a = {}; list.forEach(function(x) { a[x.area || "Service"] = 1; }); return Object.keys(a).length > 1; })();
    var showArea = (areaFilter === "All" && multiArea);
    function scheduleTimeOnly(v) {
        if (v == null || v === "") return "";
        var s = String(v).trim();
        var match = s.match(/(\d{1,2}):(\d{2})/);
        if (match) return ("0" + match[1]).slice(-2) + ":" + match[2];
        if (s.indexOf("T") !== -1) { var tPart = s.split("T")[1]; if (tPart && (match = tPart.match(/(\d{1,2}):(\d{2})/))) return ("0" + match[1]).slice(-2) + ":" + match[2]; }
        return s.length >= 5 && s.charAt(2) === ":" ? s.substring(0, 5) : s;
    }
    personKeys.forEach(function(key) {
        var p = byPerson[key];
        var workDays = [], breakDays = [];
        var offCount = 0;
        for (var i = 0; i < 7; i++) {
            var row = p.byDate[dayStrs[i]];
            var pIn = row && row.pIn ? scheduleTimeOnly(row.pIn) : "";
            var pOut = row && row.pOut ? scheduleTimeOnly(row.pOut) : "";
            var workStr = row && (pIn || pOut) ? (pIn || "-") + "-" + (pOut || "-") : "OFF";
            var pBS = row && row.pBS ? scheduleTimeOnly(row.pBS) : "";
            var pBE = row && row.pBE ? scheduleTimeOnly(row.pBE) : "";
            var breakStr = row && pBS && pBE ? (pBS + "-" + pBE) : "-";
            workDays.push(workStr);
            breakDays.push(breakStr);
            if (workStr === "OFF") offCount++; else dailyCount[i]++;
        }
        persons.push({ name: p.name, store: p.store, area: p.area, workDays: workDays, breakDays: breakDays, offCount: offCount, workCount: 7 - offCount });
    });
    window._lastScheduleViewData = { persons: persons, dayLabels: dayLabels, dayStrs: dayStrs, dailyCount: dailyCount, mondayStr: mondayStr, showArea: showArea, areaLabelKo: areaLabelKo };
    var tc = "text-align:center;";
    var cellWork = "background:#E3F2FD;";
    var cellBreak = "background:#e8e8e8;";
    var areaColHeader = showArea ? "<th style=\"min-width:42px;padding:6px 4px;" + tc + "\">êµ¬ì—­</th>" : "";
    var html = "<div style=\"overflow-x:auto;\"><table class=\"table table-bordered table-sm mb-0\" style=\"font-size:15px; min-width:520px; border-collapse:collapse;\">";
    html += "<thead><tr style=\"background:#f5f5f5;\">" + areaColHeader + "<th style=\"min-width:52px;padding:6px 4px;" + tc + "\">ì´ë¦„</th>";
    for (var i = 0; i < 7; i++) html += "<th style=\"min-width:58px;padding:6px 4px;" + tc + "\">" + dayLabels[i] + "</th>";
    html += "<th style=\"min-width:36px;padding:6px 4px;" + tc + "\">íœ´ë¬´</th><th style=\"min-width:48px;padding:6px 4px;" + tc + "\">ê·¼ë¬´ì¼</th></tr></thead><tbody>";
    persons.forEach(function(p) {
        var displayName = p.name + (p.store ? " (" + p.store + ")" : "");
        var areaCell = showArea ? "<td style=\"padding:4px;" + tc + ";" + cellWork + "\">" + (areaLabelKo[p.area] || p.area) + "</td>" : "";
        html += "<tr>" + areaCell + "<td style=\"padding:4px;font-weight:600;" + tc + ";" + cellWork + "\">" + (displayName.replace(/</g, "&lt;").replace(/>/g, "&gt;")) + "</td>";
        for (var i = 0; i < 7; i++) html += "<td style=\"padding:4px;" + tc + ";" + cellWork + "\">" + (p.workDays[i].replace(/</g, "&lt;")) + "</td>";
        html += "<td style=\"padding:4px;" + tc + ";" + cellWork + "\">" + p.offCount + "</td><td style=\"padding:4px;" + tc + ";" + cellWork + "\">" + p.workCount + "</td></tr>";
        var breakAreaCell = showArea ? "<td style=\"padding:2px 4px;font-size:14px;color:#555;" + tc + ";" + cellBreak + "\"></td>" : "";
        html += "<tr>" + breakAreaCell + "<td style=\"padding:2px 4px;font-size:14px;color:#555;" + tc + ";" + cellBreak + "\">íœ´ì‹</td>";
        for (var i = 0; i < 7; i++) html += "<td style=\"padding:2px 4px;font-size:14px;" + tc + ";" + cellBreak + "\">" + (p.breakDays[i].replace(/</g, "&lt;")) + "</td>";
        html += "<td style=\"" + tc + ";" + cellBreak + "\"></td><td style=\"" + tc + ";" + cellBreak + "\"></td></tr>";
    });
    var footAreaCell = showArea ? "<td style=\"padding:4px;" + tc + "\"></td>" : "";
    html += "</tbody><tfoot><tr style=\"background:#E8EAF6;font-weight:600;\">" + footAreaCell + "<td style=\"padding:4px;" + tc + "\">ì¼ì¼ ê·¼ë¬´ ì¸ì›</td>";
    for (var i = 0; i < 7; i++) html += "<td style=\"padding:4px;" + tc + "\">" + dailyCount[i] + "</td>";
    html += "<td style=\"" + tc + "\"></td><td style=\"" + tc + "\"></td></tr></tfoot></table></div>";
    return html;
}

function exportScheduleToExcel() {
    var data = window._lastScheduleViewData;
    if (!data || !data.persons || data.persons.length === 0) {
        alert("ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ì¡°íšŒí•˜ì„¸ìš”.");
        return;
    }
    var dayLabels = data.dayLabels;
    var headerRow = (data.showArea ? ["êµ¬ì—­", "ì´ë¦„"] : ["ì´ë¦„"]).concat(dayLabels).concat(["íœ´ë¬´", "ê·¼ë¬´ì¼"]);
    var colCount = headerRow.length;
    var rows = [];
    var periodStr = (data.period || (data.mondayStr && data.dayStrs && data.dayStrs[6]) ? (data.mondayStr || "") + " ~ " + (data.dayStrs ? data.dayStrs[6] : "") : "");
    var storeStr = data.storeName || "";
    if (periodStr || storeStr) {
        var periodRow = []; for (var i = 0; i < colCount; i++) periodRow.push(i === 0 ? "ê¸°ê°„: " + periodStr : ""); rows.push(periodRow);
        var storeRow = []; for (var i = 0; i < colCount; i++) storeRow.push(i === 0 ? "ë§¤ì¥: " + storeStr : ""); rows.push(storeRow);
    }
    rows.push(headerRow);
    data.persons.forEach(function(p) {
        var nameCell = p.name + (p.store ? " (" + p.store + ")" : "");
        var workRow = data.showArea ? [(data.areaLabelKo[p.area] || p.area), nameCell] : [nameCell];
        rows.push(workRow.concat(p.workDays).concat([String(p.offCount), String(p.workCount)]));
        var breakRow = data.showArea ? ["", "íœ´ì‹"] : ["íœ´ì‹"];
        rows.push(breakRow.concat(p.breakDays).concat(["", ""]));
    });
    var footRow = data.showArea ? ["", "ì¼ì¼ ê·¼ë¬´ ì¸ì›"] : ["ì¼ì¼ ê·¼ë¬´ ì¸ì›"];
    rows.push(footRow.concat(data.dailyCount.map(String)).concat(["", ""]));
    var csv = rows.map(function(row) {
        return row.map(function(cell) {
            var s = String(cell == null ? "" : cell).replace(/"/g, '""');
            return s.indexOf(",") >= 0 || s.indexOf('"') >= 0 || s.indexOf("\n") >= 0 ? '"' + s + '"' : s;
        }).join(",");
    }).join("\n");
    var BOM = "\uFEFF";
    var blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "schedule_" + (data.mondayStr || "week") + ".csv";
    a.click();
    URL.revokeObjectURL(a.href);
}

/* [ìµœì¢…] ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì„ ë¶ˆëŸ¬ì™€ 'ì¡°íšŒ' íƒ­ì— ëª¨ë°”ì¼í˜• í…Œì´ë¸”ë¡œ í‘œì‹œ */
function loadSavedSchedule() {
    var storeEl = document.getElementById('view-store-select');
    var mondayEl = document.getElementById('view-week-monday');
    var areaEl = document.getElementById('view-area-select');
    if (!storeEl || !mondayEl) return;
    var store = (storeEl.value || '').trim();
    var monday = (mondayEl.value || '').trim();
    var areaFilter = (areaEl && areaEl.value) ? areaEl.value : 'All';
    if (!store || !monday) {
        alert("ë§¤ì¥ê³¼ ê¸°ì¤€ ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
    }
    monday = getMondayOfWeek(monday) || monday;
    mondayEl.value = monday;

    if (typeof load === 'function') load(1);
    var loadTimeout = setTimeout(function() {
        if (typeof load === 'function') load(0);
        alert("ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }, 25000);
    google.script.run
        .withSuccessHandler(function(data) {
            clearTimeout(loadTimeout);
            if (typeof load === 'function') load(0);
            try {
                var container = document.querySelector('.view-schedule-readonly .table-responsive');
                var exportBtn = document.getElementById('view-export-excel-btn');
                if (!container) {
                    return alert("ì¡°íšŒ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                if (!data || !Array.isArray(data)) {
                    container.innerHTML = "<p class=\"text-muted py-4 text-center mb-0\">í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    if (exportBtn) exportBtn.style.display = 'none';
                    return;
                }
                container.innerHTML = buildAdminScheduleTableHtml(data, monday, areaFilter);
                var viewData = window._lastScheduleViewData;
                if (viewData) {
                    viewData.storeName = (storeEl.options[storeEl.selectedIndex] && storeEl.options[storeEl.selectedIndex].text) ? storeEl.options[storeEl.selectedIndex].text : store;
                    viewData.period = (viewData.mondayStr || "") + " ~ " + (viewData.dayStrs && viewData.dayStrs[6] ? viewData.dayStrs[6] : "");
                }
                if (exportBtn) exportBtn.style.display = 'inline-block';
            } catch (e) {
                alert("ì €ì¥ëœ ì‹œê°„í‘œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || ""));
                console.error("loadSavedSchedule:", e);
            }
        })
        .withFailureHandler(function(err) {
            clearTimeout(loadTimeout);
            if (typeof load === 'function') load(0);
            alert("ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§¤ì¥Â·ë‚ ì§œë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .getSavedWeeklyData(store, monday);
}

/* [ìŠ¤ì¼€ì¤„ ì‘ì„± íƒ­] ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì™€ í¸ì§‘ ê·¸ë¦¬ë“œ(sch-body-slots)ì— ì±„ìš°ê¸° (íƒ€ì„ì•„ì›ƒ + try/catchë¡œ ì•ˆì •í™”) */
function loadSavedScheduleIntoEditor() {
    var storeEl = document.getElementById('sch-store-select');
    var mondayEl = document.getElementById('sch-week-monday');
    if (!storeEl || !mondayEl) return;
    var store = (storeEl.value || '').trim();
    var monday = (mondayEl.value || '').trim();
    if (!store || !monday) {
        alert("ë§¤ì¥ê³¼ ê¸°ì¤€ ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•œ ë’¤ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
        return;
    }
    monday = getMondayOfWeek(monday) || monday;
    mondayEl.value = monday;

    if (typeof load === 'function') load(1);
    var loadTimeout = setTimeout(function() {
        if (typeof load === 'function') load(0);
        alert("ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }, 25000);
    google.script.run
        .withSuccessHandler(function(data) {
            clearTimeout(loadTimeout);
            try {
                mondayEl.value = monday;
                var startEl = document.getElementById('sch-start-hour');
                var endEl = document.getElementById('sch-end-hour');
                if (startEl && endEl) { startEl.value = "6"; endEl.value = "23"; }
                var schBody = document.getElementById('sch-body-slots');
                var schHeader = document.getElementById('sch-header-row');
                if (!schBody || !schHeader) {
                    if (typeof initWeeklyGrid === 'function') initWeeklyGrid('sch');
                    schBody = document.getElementById('sch-body-slots');
                    schHeader = document.getElementById('sch-header-row');
                }
                if (!schBody || !schHeader) {
                    if (typeof load === 'function') load(0);
                    return alert("ìŠ¤ì¼€ì¤„ ê·¸ë¦¬ë“œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                if (!data || !Array.isArray(data)) {
                    if (typeof load === 'function') load(0);
                    alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,...' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                    return;
                }
            initWeeklyGrid('sch');
            if (data.length === 0) {
                if (typeof load === 'function') load(0);
                alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,...' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                return;
            }
            var mondayPartsSch = monday.split('-');
            var d1UtcSch = mondayPartsSch.length >= 3 ? Date.UTC(parseInt(mondayPartsSch[0],10), parseInt(mondayPartsSch[1],10)-1, parseInt(mondayPartsSch[2],10)) : 0;
            var idx = 0;
            function findSchSlot(dayIdx, area, timeStr) {
                var sel = '#sch-body-slots .half-slot[data-day="' + dayIdx + '"][data-area="' + (area || 'Service') + '"][data-time="' + timeStr + '"]';
                var slot = document.querySelector(sel);
                if (slot) return slot;
                var any = document.querySelectorAll('#sch-body-slots .half-slot[data-day="' + dayIdx + '"][data-time="' + timeStr + '"]');
                for (var a = 0; a < any.length; a++) { if (any[a].getAttribute('data-area') === (area || 'Service')) return any[a]; }
                return any.length ? any[0] : null;
            }
            function applyNextBatch() {
                var batch = 15;
                var end = Math.min(idx + batch, data.length);
                for (var i = idx; i < end; i++) {
                    var row = data[i];
                    var dateStr = String(row.date || '').trim().substring(0, 10);
                    var rowParts = dateStr.split('-');
                    var d2Utc = rowParts.length >= 3 ? Date.UTC(parseInt(rowParts[0],10), parseInt(rowParts[1],10)-1, parseInt(rowParts[2],10)) : 0;
                    var dayIdx = Math.round((d2Utc - d1UtcSch) / (1000 * 60 * 60 * 24));
                    if (dayIdx < 0 || dayIdx > 6) continue;
                    var times = get30MinIntervals(row.pIn || '09:00', row.pOut || '18:00');
                    var breakTimes = (row.pBS && row.pBE) ? get30MinIntervals(row.pBS, row.pBE) : [];
                    for (var ti = 0; ti < times.length; ti++) {
                        var t = times[ti];
                        var slot = findSchSlot(dayIdx, row.area || 'Service', t);
                        if (slot) {
                            var names = (slot.getAttribute('data-names') || '').split(',').filter(Boolean);
                            var nicks = (slot.getAttribute('data-nicks') || '').split(',').filter(Boolean);
                            var saveName = breakTimes.indexOf(t) !== -1 ? 'BRK_' + row.name : row.name;
                            if (names.indexOf(saveName) === -1) {
                                names.push(saveName);
                                nicks.push(row.nick || row.name);
                                slot.setAttribute('data-names', names.join(','));
                                slot.setAttribute('data-nicks', nicks.join(','));
                                refreshSlotUI(slot);
                            }
                        }
                    }
                }
                idx = end;
                if (idx < data.length) {
                    setTimeout(applyNextBatch, 0);
                } else {
                    if (typeof updateDailyCounts === 'function') updateDailyCounts('sch');
                    if (typeof load === 'function') load(0);
                }
            }
            requestAnimationFrame(function() {
                setTimeout(applyNextBatch, 120);
            });
            } catch (e) {
                if (typeof load === 'function') load(0);
                alert("ì €ì¥ëœ ì‹œê°„í‘œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || ""));
                console.error("loadSavedScheduleIntoEditor success handler:", e);
            }
        })
        .withFailureHandler(function(err) {
            clearTimeout(loadTimeout);
            if (typeof load === 'function') load(0);
            alert("ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§¤ì¥Â·ë‚ ì§œë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .getSavedWeeklyData(store, monday);
}

/* [ë³´ì¡°] ë‘ ì‹œê°„ ì‚¬ì´ì˜ 30ë¶„ ë‹¨ìœ„ ë°°ì—´ ìƒì„± (ì˜ˆ: "09:00", "09:30", "10:00"...) */
function get30MinIntervals(start, end) {
    let result = [];
    let [sh, sm] = start.split(':').map(Number);
    let [eh, em] = end.split(':').map(Number);
    let cur = sh * 60 + sm;
    const finish = eh * 60 + em;

    while(cur < finish) {
        let h = Math.floor(cur / 60).toString().padStart(2, '0');
        let m = (cur % 60).toString().padStart(2, '0');
        result.push(`${h}:${m}`);
        cur += 30;
    }
    return result;
}

/* [ì¶”ê°€] í˜„ì¬ ìŠ¤ì¼€ì¤„ì„ ë‹¤ìŒ ì£¼ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì—¬ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ìŠ¤ì¼€ì¤„ ì‘ì„± ê·¸ë¦¬ë“œë§Œ ëŒ€ìƒ) */
function copyToNextWeek() {
    const store = document.getElementById('sch-store-select').value;
    const currentMonday = document.getElementById('sch-week-monday').value;
    const slots = document.querySelectorAll('#sch-body-slots .half-slot.active-fill');

    if(!currentMonday) return alert("ê¸°ì¤€ ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    if(!store || store === "All") return alert("ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");
    if(slots.length === 0) return alert("ë³µì‚¬í•  ë°ì´í„°ê°€ í™”ë©´ì— ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ì‘ì„±í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");

    // 1. ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ ë‚ ì§œ ê³„ì‚° (íƒœêµ­ ê¸°ì¤€: UTC ì¼ìˆ˜ë¡œ +7ì¼)
    const nextMondayStr = (typeof addDaysToYyyyMmDd === "function") ? addDaysToYyyyMmDd((currentMonday || "").substring(0, 10), 7) : currentMonday;

    if(!confirm(`í˜„ì¬ í™”ë©´ì˜ ìŠ¤ì¼€ì¤„ì„ ë‹¤ìŒ ì£¼(${nextMondayStr})ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    // 2. í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„° ìˆ˜ì§‘ (prepareAndSaveì˜ ë¡œì§ ì¬í™œìš©)
    let map = {}; 
    slots.forEach(s => {
        let namesStr = s.getAttribute('data-names');
        if(!namesStr) return;
        
        let names = namesStr.split(',');
        let dayOffset = parseInt(s.getAttribute('data-day'));
        let time = s.getAttribute('data-time');
        let area = s.getAttribute('data-area');
        
        // â˜… ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ + ìš”ì¼ ì˜¤í”„ì…‹ (íƒœêµ­ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´)
        let datePart = (typeof addDaysToYyyyMmDd === "function") ? addDaysToYyyyMmDd((nextMondayStr || "").substring(0, 10), dayOffset) : nextMondayStr;

        names.forEach(n => {
            let name = n.trim();
            if(!name) return;
            const isBrk = name.startsWith("BRK_");
            const realName = isBrk ? name.replace("BRK_", "") : name;
            
            let key = datePart + "_" + realName + "_" + area;
            if(!map[key]) map[key] = { work: [], break: [] };
            if(isBrk) map[key].break.push(time);
            else map[key].work.push(time);
        });
    });

    // 3. ìµœì¢… ë°ì´í„° ë³€í™˜ (í‚¤ í˜•ì‹: date_name_area, ì´ë¦„ì— _ í¬í•¨ ê°€ëŠ¥)
    let finalData = [];
    for(let k in map) {
        let parts = k.split('_');
        let date = parts[0];
        let area = parts[parts.length - 1];
        let name = parts.length > 2 ? parts.slice(1, -1).join('_') : (parts[1] || '');
        let allTimes = [...map[k].work, ...map[k].break].sort();
        if(allTimes.length === 0) continue;

        let pIn = allTimes[0];
        let last = allTimes[allTimes.length - 1];
        let [hh, mm] = last.split(':').map(Number);
        mm += 30; if(mm === 60) { hh++; mm = 0; }
        let pOut = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;

        let pBS = "", pBE = "";
        if(map[k].break.length > 0) {
            let brkTimes = map[k].break.sort();
            pBS = brkTimes[0];
            let bLast = brkTimes[brkTimes.length - 1];
            let [bhh, bmm] = bLast.split(':').map(Number);
            bmm += 30; if(bmm === 60) { bhh++; bmm = 0; }
            pBE = `${bhh.toString().padStart(2, '0')}:${bmm.toString().padStart(2, '0')}`;
        }

        finalData.push({ date: date, name: name, pIn: pIn, pOut: pOut, pBS: pBS, pBE: pBE, remark: "[" + area + "]" });
    }

    // 4. ì„œë²„ ì €ì¥ ì‹¤í–‰
    load(1);
    google.script.run
        .withSuccessHandler(res => {
            load(0);
            alert(`âœ… ë³µì‚¬ ì™„ë£Œ!\në‹¤ìŒ ì£¼(${nextMondayStr}) ìŠ¤ì¼€ì¤„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            document.getElementById('sch-week-monday').value = nextMondayStr;
            loadSavedScheduleIntoEditor(); // ì‘ì„± íƒ­ì— ë‹¤ìŒ ì£¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        })
        .withFailureHandler(function(err) {
            load(0);
            alert("ë‹¤ìŒ ì£¼ë¡œ ë³µì‚¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .saveWeeklySmartSchedule(store, nextMondayStr, finalData);
}



/* =================================================================
     íœ´ê°€ ì—°ì°¨
 ================================================================= */ 
function showLeaveTab(tab) {
    var panelApproval = document.getElementById("leave-panel-approval");
    var panelStats = document.getElementById("leave-panel-stats");
    var tabApproval = document.getElementById("leave-tab-approval");
    var tabStats = document.getElementById("leave-tab-stats");
    if (!panelApproval || !panelStats || !tabApproval || !tabStats) return;
    panelApproval.style.display = (tab === "approval") ? "block" : "none";
    panelStats.style.display = (tab === "stats") ? "block" : "none";
    tabApproval.classList.toggle("active", tab === "approval");
    tabStats.classList.toggle("active", tab === "stats");
    if (tab === "stats") {
      var statsList = document.getElementById("stats-list");
      if (statsList) statsList.innerHTML = "<tr><td colspan='7' class='text-muted py-4'>ê¸°ê°„Â·ë§¤ì¥ ì„ íƒ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
    }
}
function procLv(r,d){ if(confirm(d+"?")) google.script.run.withSuccessHandler(r=>{alert(r);loadLeaveData(filterLeaves);}).processLeaveDecision(r,d); }
  /* [ìˆ˜ì •] íœ´ê°€ í†µê³„ ê²€ìƒ‰ í•¨ìˆ˜ (ë§¤ì¥ í•„í„° ê¸°ëŠ¥ ì¶”ê°€) */
  function filterStats() {
    var start = document.getElementById("stats-start").value;
    var end = document.getElementById("stats-end").value;
    var store = document.getElementById("hr-store-selector").value; // â˜… ë§¤ì¥ ê°’ ì½ì–´ì˜¤ê¸°

    // ë¡œë”© í‘œì‹œ
    document.getElementById("stats-list").innerHTML = "<tr><td colspan='7'>â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";

    // ì„œë²„ë¡œ ë‚ ì§œì™€ í•¨ê»˜ 'ë§¤ì¥(store)' ì •ë³´ë„ ê°™ì´ ë³´ëƒ„!
    google.script.run.withSuccessHandler(function(data) {
        var tbody = document.getElementById("stats-list");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='7'>ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
        }

        // ê²°ê³¼ í…Œì´ë¸” ê·¸ë¦¬ê¸°
        data.forEach(function(r) {
            var row = "<tr>" +
                "<td>" + r.store + "</td>" +
                "<td>" + r.name + "</td>" +
                "<td>" + r.used_annual + "</td>" + // ê¸°ê°„ ë‚´ ì—°ì°¨
                "<td>" + r.used_sick + "</td>" +   // ê¸°ê°„ ë‚´ ë³‘ê°€
                "<td>" + r.total_annual + "</td>" + // ì „ì²´ ëˆ„ì  ì—°ì°¨
                "<td>" + r.total_sick + "</td>" +   // ì „ì²´ ëˆ„ì  ë³‘ê°€
                "<td class='fw-bold text-primary'>" + r.remain + "</td>" + // ì”ì—¬
                "</tr>";
            tbody.innerHTML += row;
        });
    }).getLeaveStats(start, end, store); // â˜… ì„œë²„ í•¨ìˆ˜ì— store ì „ë‹¬
}

/* [ìˆ˜ì •] íœ´ê°€ ê²€ìƒ‰ (ê¸°ê°„, ë§¤ì¥, ìƒíƒœ í•„í„°ë§ ì ìš©) */
function filterLeaves() { 
    var startInput = document.getElementById("leave-start");
    var endInput = document.getElementById("leave-end");
    var statusInput = document.getElementById("leave-status");
    var storeInput = document.getElementById("leave-store-select");
    var b = document.getElementById("leave-list");

    // ì•ˆì „ì¥ì¹˜: ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!allLeaveData || !allLeaveData.leaves) {
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
        return;
    }

    b.innerHTML = "";

    // 1. ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    var s = startInput.value; // ì‹œì‘ì¼
    var e = endInput.value;   // ì¢…ë£Œì¼
    var st = statusInput.value; // ìƒíƒœ (All, ëŒ€ê¸°, ìŠ¹ì¸, ë°˜ë ¤)
    var str = storeInput.value; // ë§¤ì¥

    // 2. í•„í„°ë§ ë¡œì§ (ì—¬ê¸°ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤!)
    var f = allLeaveData.leaves.filter(function(i) {
        // (1) ë‚ ì§œ ë¹„êµ: ì‹œì‘ì¼ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ê³ , ì¢…ë£Œì¼ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•¨
        // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´(ì„ íƒ ì•ˆ í–ˆìœ¼ë©´) ë‚ ì§œ ì¡°ê±´ì€ ë¬´ì‹œí•˜ê³  í†µê³¼
        var dateMatch = true;
        if (s && i.date < s) dateMatch = false; // ì‹œì‘ì¼ë³´ë‹¤ ì „ì´ë©´ íƒˆë½
        if (e && i.date > e) dateMatch = false; // ì¢…ë£Œì¼ë³´ë‹¤ í›„ë©´ íƒˆë½

        // (2) ìƒíƒœ ë¹„êµ: 'All'ì´ë©´ í†µê³¼, ì•„ë‹ˆë©´ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
        var statusMatch = (st === "All" || i.status === st);

        // (3) ë§¤ì¥ ë¹„êµ: 'All'ì´ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ í†µê³¼, ì•„ë‹ˆë©´ ì¼ì¹˜í•´ì•¼ í•¨
        var storeMatch = (str === "All" || str === "" || i.store === str);

        return dateMatch && statusMatch && storeMatch;
    });

    // 3. ê²°ê³¼ ê·¸ë¦¬ê¸°
    var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var noMatchTxt = lang.mgr_no_match || "ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
    if (f.length === 0) {
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>" + noMatchTxt + "</td></tr>";
        return;
    }

    f.forEach(i => { 
        // ì¢…ë¥˜ ë²ˆì—­: ì—°ì°¨/ë³‘ê°€/ë°˜ì°¨
        var typeLabel = i.type;
        if (i.type === "ì—°ì°¨") typeLabel = lang.leave_annual || i.type;
        else if (i.type === "ë³‘ê°€") typeLabel = lang.leave_sick || i.type;
        else if (i.type === "ë°˜ì°¨") typeLabel = lang.leave_half || i.type;

        // ìƒíƒœ ë²ˆì—­: ëŒ€ê¸°/Pending/ìŠ¹ì¸/ë°˜ë ¤
        var statusLabel = i.status;
        if (i.status === "ëŒ€ê¸°" || i.status === "Pending") statusLabel = lang.leave_wait || i.status;
        else if (i.status === "ìŠ¹ì¸") statusLabel = lang.leave_approved || i.status;
        else if (i.status === "ë°˜ë ¤") statusLabel = lang.leave_rejected || i.status;

        // ë²„íŠ¼: ìŠ¹ì¸/ë°˜ë ¤ ë²„íŠ¼ì€ 'ëŒ€ê¸°(Pending)' ìƒíƒœì¼ ë•Œë§Œ ë³´ì—¬ì¤Œ
        var btns = "";
        if (i.status === 'Pending' || i.status === 'ëŒ€ê¸°') {
            btns = `<button class="btn btn-success btn-sm me-1" onclick="procLv('${i.row}','ìŠ¹ì¸')">O</button>
                    <button class="btn btn-danger btn-sm" onclick="procLv('${i.row}','ë°˜ë ¤')">X</button>`;
        } else {
            btns = `<span class="text-muted small">-</span>`;
        }

        // ìƒíƒœ ë±ƒì§€ ê¾¸ë¯¸ê¸°
        var badgeClass = "bg-secondary";
        if(i.status === 'ìŠ¹ì¸') badgeClass = "bg-success";
        if(i.status === 'ë°˜ë ¤') badgeClass = "bg-danger";
        if(i.status === 'ëŒ€ê¸°' || i.status === 'Pending') badgeClass = "bg-warning text-dark";

        b.innerHTML += `
            <tr>
                <td>${i.date}</td>
                <td><span class="fw-bold">${i.store}</span></td>
                <td>${i.name}</td>
                <td>${typeLabel}</td>
                <td><span class="badge ${badgeClass}">${statusLabel}</span></td>
                <td>${btns}</td>
            </tr>`; 
    }); 
}

  function loadLeaveData(cb) { load(1); google.script.run.withSuccessHandler(l => { load(0); allLeaveData = l; if(cb) cb(); }).getLeaveAllData(); }


</script>