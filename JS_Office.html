<script>

  /* =================================================================
     ìš´ì˜ ê´€ë¦¬
     ================================================================= */ 

/* ì—…ë¬´ì¼ì§€ ì¤‘ìš”ë„ í‘œì‹œ í…ìŠ¤íŠ¸ (ë‹¤êµ­ì–´) */
function wlPriorityLabel(lang, val) {
  if (val === 'ê¸´ê¸‰') return 'âš¡' + (lang && lang.wl_priority_urgent ? lang.wl_priority_urgent : 'ê¸´ê¸‰');
  if (val === 'ìƒ') return (lang && lang.wl_priority_high) ? lang.wl_priority_high : 'ìƒ';
  if (val === 'ì¤‘') return (lang && lang.wl_priority_medium) ? lang.wl_priority_medium : 'ì¤‘';
  if (val === 'í•˜') return (lang && lang.wl_priority_low) ? lang.wl_priority_low : 'í•˜';
  return val || '-';
}

/* [ìµœì¢… ìˆ˜ì •] ê´€ë¦¬ì ì¡°íšŒ (ì¤„ë°”ê¿ˆ í‘œì‹œ + ë‹¤êµ­ì–´ I18N ì ìš©) */
function renderManagerTable() {
    var container = document.getElementById("mgr-review-list");
    var filterDept = document.getElementById("filter-dept").value;
    var filterName = document.getElementById("filter-name").value;
    var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};

    // 1. ì²´í¬ë°•ìŠ¤ ê°’ ì½ê¸°
    var checkedStatuses = [];
    document.querySelectorAll('.chk-filter-status:checked').forEach(function(chk) {
        checkedStatuses.push(chk.value);
    });

    // ë²„íŠ¼ ê¸€ì ì—…ë°ì´íŠ¸ (ë‹¤êµ­ì–´)
    var btn = document.getElementById("statusDropdownBtn");
    if(btn) {
        if(checkedStatuses.length === 4) btn.innerText = lang.wl_filter_all || "ì „ì²´ ë³´ê¸°";
        else if(checkedStatuses.length === 0) btn.innerText = lang.filter_none || "ì„ íƒ ì•ˆí•¨";
        else btn.innerText = checkedStatuses.length + (lang.filter_n_selected || "ê°œ ì„ íƒë¨");
    }

    container.innerHTML = "";

    if (!globalManagerData || globalManagerData.length === 0) {
        container.innerHTML = "<div class='text-center py-5 text-muted'>âŒ " + (lang.mgr_no_data || "ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.") + "</div>";
        return;
    }

    // 2. í•„í„°ë§
    var filteredData = globalManagerData.filter(item => {
        var matchDept = (filterDept === "All") || (item.dept === filterDept);
        var matchName = (filterName === "All") || (item.name === filterName);
        var status = item.status === 'Start Today' ? 'Carry Over' : item.status;
        var matchStatus = checkedStatuses.includes(status);
        return matchDept && matchName && matchStatus;
    });

    if(filteredData.length === 0) {
        container.innerHTML = "<div class='text-center py-5 text-muted'>" + (lang.mgr_no_match || "ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.") + "</div>";
        return;
    }

    var L = {
        date: lang.label_date || "ë‚ ì§œ",
        importance: lang.wl_importance || "ì¤‘ìš”ë„",
        task: lang.wl_task_content || "ì—…ë¬´ ë‚´ìš©",
        progress: lang.wl_progress || "ì§„í–‰ë¥ ",
        status: lang.wl_status || "ìƒíƒœ",
        approveFeedback: lang.wl_approve_feedback || "ìŠ¹ì¸/í”¼ë“œë°±",
        statusFinish: lang.status_finish || "ì™„ë£Œ",
        statusCarry: lang.status_carry_over || "ì´ì›”",
        statusToday: lang.status_today || "ì§„í–‰ì¤‘",
        statusContinue: lang.status_continue || "ëŒ€ê¸°",
        approved: lang.mgr_approved || "ìŠ¹ì¸ë¨",
        reject: lang.mgr_reject || "ë°˜ë ¤",
        approveBtn: lang.mgr_approve_btn || "ìŠ¹ì¸"
    };

    // 3. ê·¸ë£¹í™”
    var grouped = {};
    filteredData.forEach(item => {
        var deptKey = item.dept || "ê¸°íƒ€";
        if(!grouped[deptKey]) grouped[deptKey] = {};
        if(!grouped[deptKey][item.name]) grouped[deptKey][item.name] = [];
        grouped[deptKey][item.name].push(item);
    });

    // 4. HTML ìƒì„±
    for (var dept in grouped) {
        var html = `<div class="mb-4 border rounded shadow-sm bg-white">
            <div class="p-2 bg-light border-bottom text-primary fw-bold">ğŸ¢ ${dept}</div>
            <div class="p-2">`;

        for (var name in grouped[dept]) {
            html += `<div class="mb-3">
                <h6 class="fw-bold ms-2">ğŸ‘¤ ${name}</h6>
                <table class="table table-bordered table-sm align-middle text-center table-hover" style="font-size:0.9rem;">
                    <thead class="table-secondary">
                        <tr>
                            <th width="12%">ğŸ“… ${L.date}</th>
                            <th width="10%">${L.importance}</th>
                            <th width="38%">${L.task}</th>
                            <th width="10%">${L.progress}</th>
                            <th width="10%">${L.status}</th>
                            <th width="20%">${L.approveFeedback}</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            var logs = grouped[dept][name].sort((a,b) => String(b.date).localeCompare(String(a.date)));

            logs.forEach(log => {
                var statusBadge = "";
                var displayStatus = log.status === 'Start Today' ? 'Carry Over' : log.status;

                if(displayStatus === 'Finish') statusBadge = "<span class=\"badge bg-success\">" + L.statusFinish + "</span>";
                else if(displayStatus === 'Carry Over') statusBadge = "<span class=\"badge bg-warning text-dark\">" + L.statusCarry + "</span>";
                else if(displayStatus === 'Today') statusBadge = "<span class=\"badge bg-primary\">" + L.statusToday + "</span>";
                else statusBadge = "<span class=\"badge bg-secondary\">" + L.statusContinue + "</span>";

                var priBadge = "bg-secondary"; 
                if(log.priority === 'ê¸´ê¸‰') priBadge = "bg-warning text-dark";
                else if(log.priority === 'ìƒ') priBadge = "bg-danger";
                else if(log.priority === 'ì¤‘') priBadge = "bg-primary";

                var priText = wlPriorityLabel(lang, log.priority);

                var checkBtn = "";
                if(log.managerCheck === 'ìŠ¹ì¸') {
                    checkBtn = "<span class=\"text-success fw-bold\"><i class=\"bi bi-check-circle-fill\"></i> " + L.approved + "</span>";
                } else if(log.managerCheck === 'ë°˜ë ¤') {
                    checkBtn = "<span class=\"text-danger fw-bold\">ğŸš« " + L.reject + "</span>";
                } else {
                    checkBtn = "<button class=\"btn btn-xs btn-outline-success me-1\" onclick=\"mgrAction('" + log.id + "', 'approve')\">" + L.approveBtn + "</button><button class=\"btn btn-xs btn-outline-danger\" onclick=\"mgrAction('" + log.id + "', 'reject')\">" + L.reject + "</button>";
                }
                
                var commentHtml = log.managerComment ? "<div class=\"text-danger small text-start mt-1\">ğŸ’¬ " + log.managerComment + "</div>" : "";

                html += "<tr><td>" + log.date + "</td><td><span class=\"badge " + priBadge + "\">" + (priText || '-') + "</span></td><td class=\"text-start\" style=\"white-space: pre-wrap;\">" + log.content + " " + commentHtml + "</td><td><div class=\"progress\" style=\"height: 15px;\"><div class=\"progress-bar " + (log.progress==100?'bg-success':(displayStatus==='Carry Over'?'bg-warning':'bg-primary')) + "\" role=\"progressbar\" style=\"width: " + log.progress + "%\">" + log.progress + "%</div></div></td><td>" + statusBadge + "</td><td>" + checkBtn + "</td></tr>";
            });

            html += `</tbody></table></div>`;
        }
        html += `</div></div>`;
        container.innerHTML += html;
    }
}

/* ìŠ¹ì¸/ë°˜ë ¤ ì•¡ì…˜ */
function mgrAction(id, action) {
    var comment = "";
    if(action === 'reject') {
        comment = prompt("ë°˜ë ¤ ì‚¬ìœ (í”¼ë“œë°±)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(comment === null) return;
    }
    
    var status = (action === 'approve') ? "ìŠ¹ì¸" : "ë°˜ë ¤";

    google.script.run.withSuccessHandler(function(){
        // ë°ì´í„° ê°±ì‹  (í™”ë©´ë§Œ)
        var target = globalManagerData.find(x => x.id === id);
        if(target) {
            target.managerCheck = status;
            if(comment) target.managerComment = comment;
        }
        renderManagerTable();
    }).updateManagerCheck(id, status, comment);
}
/* 4. í•„í„° ì´ˆê¸°í™” */
function resetFilters() {
    document.getElementById("filter-dept").value = "All";
    document.getElementById("filter-name").value = "All";
    document.getElementById("filter-status").value = "All";
    renderManagerTable();
}

/* 5. ìŠ¹ì¸/ë°˜ë ¤ ì•¡ì…˜ (ì„œë²„ í†µì‹  í›„ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  í•´ë‹¹ ì¤„ë§Œ ì—…ë°ì´íŠ¸ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ê°„ë‹¨íˆ ì¬ì¡°íšŒ) */
function mgrAction(id, action) {
    var comment = "";
    if(action === 'reject') {
        comment = prompt("ë°˜ë ¤ ì‚¬ìœ (í”¼ë“œë°±)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(comment === null) return; // ì·¨ì†Œ
    }
    
    var status = (action === 'approve') ? "ìŠ¹ì¸" : "ë°˜ë ¤";

    google.script.run.withSuccessHandler(function(){
        // ë°ì´í„° ê°±ì‹ ì„ ìœ„í•´ ì¬ì¡°íšŒ (ë˜ëŠ” globalManagerDataë§Œ ìˆ˜ì •í•´ì„œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°)
        // ì—¬ê¸°ì„œëŠ” UXë¥¼ ìœ„í•´ globalArrayë¥¼ ìˆ˜ì •í•˜ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
        var target = globalManagerData.find(x => x.id === id);
        if(target) {
            target.managerCheck = status;
            if(comment) target.managerComment = comment;
        }
        renderManagerTable(); // í™”ë©´ë§Œ ê°±ì‹  (ë¹ ë¦„)
        
    }).updateManagerCheck(id, status, comment);
}

/* [ìˆ˜ì •] ì¤‘ìš”ë„ ìƒ‰ìƒ ë³€ê²½ (ë²ˆê°œ/ë¹¨ê°•/íŒŒë‘/íšŒìƒ‰) */
function updatePriorityColor(el) {
    var val = el.value;
    
    // ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ ì´ˆê¸°í™”
    el.classList.remove('bg-danger', 'bg-warning', 'bg-primary', 'bg-secondary', 'text-white', 'text-dark');
    
    if(val === 'ê¸´ê¸‰') {
        // ë²ˆê°œ (ë…¸ë‘)
        el.classList.add('bg-warning', 'text-dark'); 
    } else if(val === 'ìƒ') {
        // ë¹¨ê°•
        el.classList.add('bg-danger', 'text-white');
    } else if(val === 'ì¤‘') {
        // íŒŒë‘
        el.classList.add('bg-primary', 'text-white');
    } else {
        // íšŒìƒ‰
        el.classList.add('bg-secondary', 'text-white');
    }
}

/* =========================================
   [ê´€ë¦¬ììš©] ìŠ¤ë§ˆíŠ¸ ì¡°íšŒ ë° í•„í„°ë§
   ========================================= */

var globalManagerData = []; // ì¡°íšŒëœ ë°ì´í„°ë¥¼ ì €ì¥í•´ë‘˜ ë³€ìˆ˜

function loadManagerReview() {
    var start = document.getElementById("mgr-date-start").value;
    var end = document.getElementById("mgr-date-end").value;

    var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    if(!start || !end) return alert(lang.mgr_prompt_date || "ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if(start > end) return alert(lang.mgr_prompt_order || "ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    var container = document.getElementById("mgr-review-list");
    container.innerHTML = "<div class='text-center py-5'>â³ " + (lang.mgr_loading || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...") + "</div>";

    google.script.run.withSuccessHandler(function(data){
        var targetLang = (typeof getTranslationLang === "function" ? getTranslationLang() : "ko");
        var texts = [];
        if (data && data.length) data.forEach(function(item){ texts.push(item.content || ""); texts.push(item.managerComment || ""); });
        if (targetLang === "ko" || texts.length === 0) {
            globalManagerData = data || [];
            renderManagerTable();
            return;
        }
        google.script.run.withSuccessHandler(function(translated){
            var ti = 0;
            globalManagerData = (data || []).map(function(item){
                return { id: item.id, date: item.date, dept: item.dept, name: item.name, content: translated[ti++] || item.content, managerComment: translated[ti++] || item.managerComment, progress: item.progress, priority: item.priority, status: item.status, managerCheck: item.managerCheck };
            });
            renderManagerTable();
        }).translateBatch(texts, targetLang);
    }).getManagerRangeReport(start, end);
}

/* 2. í•„í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (ë°ì´í„°ì— ìˆëŠ” ì‚¬ëŒë§Œ) */
function populateFilters(data) {
    var deptSet = new Set();
    var nameSet = new Set();

    data.forEach(item => {
        if(item.dept) deptSet.add(item.dept);
        if(item.name) nameSet.add(item.name);
    });

    var deptSel = document.getElementById("filter-dept");
    var nameSel = document.getElementById("filter-name");
    
    // ê¸°ì¡´ ì˜µì…˜(ì „ì²´) ë‚¨ê¸°ê³  ì´ˆê¸°í™”
    deptSel.length = 1; 
    nameSel.length = 1;

    deptSet.forEach(d => deptSel.add(new Option(d, d)));
    nameSet.forEach(n => nameSel.add(new Option(n, n)));
}


/* =========================================
   [ì—…ë¬´ì¼ì§€] í†µí•© ìŠ¤í¬ë¦½íŠ¸
   ========================================= */

/* [ìˆ˜ì •] íƒ­ ì „í™˜ ì‹œ í•„í„° ë¯¸ë¦¬ ë¡œë”© */
function showWorkLogTab(tabName) {
    document.getElementById("wl-view-personal").style.display = "none";
    document.getElementById("wl-view-manager").style.display = "none";
    document.getElementById("wl-view-report").style.display = "none";
    
    document.getElementById("wl-view-" + tabName).style.display = "block";
    
    document.querySelectorAll(".nav-link").forEach(el => el.classList.remove("active"));
    document.getElementById("tab-wl-" + tabName).classList.add("active");

    if(tabName === 'personal') initWorkLog();
    
    // â˜… ê´€ë¦¬ì íƒ­ì„ ëˆ„ë¥´ë©´ -> ì¡°íšŒê¸°ê°„ ì˜¤ëŠ˜ë¡œ ì„¸íŒ… + í•„í„° ë¡œë”©
    if(tabName === 'manager') {
        var today = new Date().toISOString().substring(0, 10);
        var startEl = document.getElementById("mgr-date-start");
        var endEl = document.getElementById("mgr-date-end");
        if (startEl) startEl.value = today;
        if (endEl) endEl.value = today;
        initManagerFilters(); // í•„í„° ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ
    }
}

function initManagerFilters() {
    // ì´ë¯¸ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ë‹¤ì‹œ ë¡œë”© ì•ˆ í•¨ (ê¹œë¹¡ì„ ë°©ì§€)
    if(document.getElementById("filter-name").options.length > 1) return;

    google.script.run.withSuccessHandler(function(res){
        var deptSel = document.getElementById("filter-dept");
        var nameSel = document.getElementById("filter-name");

        // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì „ì²´ëŠ” ë‚¨ê¹€)
        deptSel.length = 1; 
        nameSel.length = 1;

        // ë¶€ì„œ ì±„ìš°ê¸°
        res.depts.forEach(d => {
            deptSel.add(new Option(d, d));
        });

        // ì§ì› ì±„ìš°ê¸°
        res.staff.forEach(n => {
            nameSel.add(new Option(n, n));
        });

    }).getAllFilterOptions();
}

/* [ìˆ˜ì •] ì´ˆê¸°í™” í•¨ìˆ˜ (ë‹‰ë„¤ì„/ë¶€ì„œ í‘œì‹œ ìµœì í™”) - ë¡œê·¸ì¸ ê³„ì • ì´ë¦„ ì‚¬ìš© (u-infoëŠ” ë²ˆì—­ ì‹œ 'ì‚¬ìš©ì'ë¡œ ë®ì–´ì”Œì›Œì§) */
function initWorkLog() {
    var dateEl = document.getElementById("wl-date");
    if(!dateEl.value) dateEl.valueAsDate = new Date();
    
    var myName = (typeof userName !== "undefined" && userName) ? userName : "";
    if (!myName && typeof sessionStorage !== "undefined") myName = sessionStorage.getItem("cm_name") || "";

    google.script.run.withSuccessHandler(function(res){
        var select = document.getElementById("wl-staff");
        select.innerHTML = ""; 
        
        var foundMe = false;

        // 1. ëª©ë¡ ì±„ìš°ê¸°
        if(res.list && res.list.length > 0) {
            res.list.forEach(function(p){
                var opt = document.createElement("option");
                opt.value = p.name; // ì €ì¥ë  ê°’ (ë‹‰ë„¤ì„)
                
                // í™”ë©´ì— ë³´ì—¬ì§ˆ í…ìŠ¤íŠ¸: [Marketing] Mill
                opt.text = `[${p.dept}] ${p.name}`; 
                
                select.appendChild(opt);

                // ë‚´ ì´ë¦„(ë‹‰ë„¤ì„) ìë™ ì„ íƒ ë¡œì§
                // (ê³µë°± ì œê±° í›„ ë¹„êµ)
                var n1 = p.name.toLowerCase().replace(/\s/g, "");
                var n2 = myName.toLowerCase().replace(/\s/g, "");
                
                // ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì„ íƒ
                if(n1.includes(n2) || n2.includes(n1)) {
                    select.value = p.name;
                    foundMe = true;
                }
            });
        } else {
            select.add(new Option("âŒ ë°ì´í„° ì—†ìŒ", ""));
        }

        // 2. ë‚´ ì´ë¦„ì´ ëª©ë¡ì— ì—†ìœ¼ë©´ ê°•ì œ ì¶”ê°€
        if (!foundMe) {
            var opt = document.createElement("option");
            opt.value = myName;
            opt.text = `ğŸ‘¤ ${myName}`;
            select.add(opt, 0);
            select.value = myName;
        }

        // 3. ê¶Œí•œ ì ê¸ˆ ì²˜ë¦¬
        if (res.isAdmin) {
            select.disabled = false;
            select.classList.remove("bg-light");
        } else {
            select.disabled = true;
            select.classList.add("bg-light");
        }
        
        loadWorkLog();

    }).getOfficeStaffList(myName); 
}


/* [ìˆ˜ì •] ë‚´ ì—…ë¬´ì¼ì§€ (Finish ëª©ë¡ ìƒ‰ìƒ ì ìš© + ì‚¬ìš©ì ì…ë ¥ ê¸€ ìë™ ë²ˆì—­) */
function loadWorkLog() {
    var date = document.getElementById("wl-date").value;
    var name = document.getElementById("wl-staff").value;
    if(!name) return;

    document.getElementById("wl-body-finish").innerHTML = "";
    document.getElementById("wl-body-continue").innerHTML = "";
    document.getElementById("wl-body-today").innerHTML = "";

    google.script.run.withSuccessHandler(function(data){
        var targetLang = (typeof getTranslationLang === "function" ? getTranslationLang() : "ko");
        var texts = [];
        data.finish.forEach(function(item){ texts.push(item.content || ""); texts.push(item.managerComment || ""); });
        data.continueItems.forEach(function(item){ texts.push(item.content || ""); texts.push(item.managerComment || ""); });
        data.todayItems.forEach(function(item){ texts.push(item.content || ""); texts.push(item.managerComment || ""); });

        if (targetLang === "ko" || texts.length === 0) {
            renderWorkLogData(data, null);
            return;
        }
        google.script.run.withSuccessHandler(function(translated){
            renderWorkLogData(data, translated);
        }).translateBatch(texts, targetLang);
    }).getWorkLogData(date, name);
}

function renderWorkLogData(data, translated) {
    var ti = 0;
    var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    function next(){ return translated ? (translated[ti++] || "") : null; }
    function content(item){ var t = next(); return t !== null ? t : (item.content || ""); }
    function comment(item){ var t = next(); return t !== null ? t : (item.managerComment || ""); }

    document.getElementById("wl-body-finish").innerHTML = "";
    document.getElementById("wl-body-continue").innerHTML = "";
    document.getElementById("wl-body-today").innerHTML = "";

    if(data.finish.length === 0) {
        document.getElementById("wl-body-finish").innerHTML = "<tr><td colspan='5' class='text-muted'>ì™„ë£Œëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
    } else {
        data.finish.forEach(function(item, idx) {
            var c = content(item), cmt = comment(item);
            var statusBadge = `<span class="badge bg-secondary">ëŒ€ê¸°</span>`;
            if(item.managerCheck === 'ìŠ¹ì¸') statusBadge = `<span class="badge bg-success">ìŠ¹ì¸</span>`;
            if(item.managerCheck === 'ë°˜ë ¤') statusBadge = `<span class="badge bg-danger">ë°˜ë ¤</span>`;
            var commentHtml = cmt ? `<div class="small text-danger">â”” ğŸ’¬ ${cmt}</div>` : "";
            var priBadge = "bg-secondary";
            if(item.priority === 'ê¸´ê¸‰') priBadge = "bg-warning text-dark";
            else if(item.priority === 'ìƒ') priBadge = "bg-danger";
            else if(item.priority === 'ì¤‘') priBadge = "bg-primary";
            var priText = wlPriorityLabel(lang, item.priority);
            var row = `<tr><td>${idx+1}</td><td class="text-start">${c} ${commentHtml}</td><td><span class="badge ${priBadge}">${priText || '-'}</span></td><td><span class="badge bg-success">100%</span></td><td>${statusBadge}</td></tr>`;
            document.getElementById("wl-body-finish").innerHTML += row;
        });
    }

    if(data.continueItems.length === 0) {
        document.getElementById("wl-body-continue").innerHTML = "<div class='text-muted small text-center py-3'>ëŒ€ê¸° ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    } else {
        data.continueItems.forEach(function(item){
            var c = content(item), cmt = comment(item);
            addWorkRow('continue', { id: item.id, content: c, progress: item.progress, priority: item.priority, managerComment: cmt || undefined });
        });
    }

    if(data.todayItems.length === 0) {
        document.getElementById("wl-body-today").innerHTML = "<div class='text-muted small text-center py-5'>ìœ„ 'Continue Work'ì—ì„œ ì—…ë¬´ë¥¼ ì„ íƒí•˜ì—¬ ë‚´ë ¤ë°›ìœ¼ì„¸ìš”.</div>";
    } else {
        data.todayItems.forEach(function(item){
            var c = content(item), cmt = comment(item);
            addWorkRow('today', { id: item.id, content: c, progress: item.progress, priority: item.priority, managerComment: cmt || undefined });
        });
    }
}

/* [ìˆ˜ì •] ì—…ë¬´ ì…ë ¥ ì¤„ ìƒì„± (ë²ˆê°œ/ë¹¨ê°•/íŒŒë‘/íšŒìƒ‰ ì ìš©) */
function addWorkRow(type, item) {
    var container = document.getElementById("wl-body-" + type);
    var contentVal = item ? item.content : "";
    var progressVal = item ? item.progress : 0;
    var priorityVal = item ? item.priority : "ì¤‘";
    var idVal = item ? item.id : "";
    var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    var Lurgent = 'âš¡' + (lang.wl_priority_urgent || 'ê¸´ê¸‰');
    var Lhigh = lang.wl_priority_high || 'ìƒ';
    var Lmedium = lang.wl_priority_medium || 'ì¤‘';
    var Llow = lang.wl_priority_low || 'í•˜';

    // ì´ˆê¸° ìƒ‰ìƒ ì„¤ì • (ê¸°ë³¸: íŒŒë‘)
    var colorClass = "bg-primary text-white"; 
    var selectTextClass = "bg-white text-primary"; // ì˜µì…˜ ë‚´ë¶€ ìƒ‰ìƒ

    if(priorityVal === 'ê¸´ê¸‰') {
        colorClass = "bg-warning text-dark"; // ë²ˆê°œ(ë…¸ë‘)
    } else if(priorityVal === 'ìƒ') {
        colorClass = "bg-danger text-white"; // ë¹¨ê°•
    } else if(priorityVal === 'í•˜') {
        colorClass = "bg-secondary text-white"; // íšŒìƒ‰
    }

    var checkboxHtml = "";
    if (type === 'continue') {
        checkboxHtml = `
            <div class="input-group-text bg-white border-0 ps-1 pe-2" style="align-self: flex-start; margin-top: 5px;">
                <input class="form-check-input mt-0 chk-move" type="checkbox" value="" style="transform: scale(1.2);">
            </div>`;
    }

    var div = document.createElement("div");
    div.className = "card p-2 mb-2 work-row border-light shadow-sm";
    div.setAttribute("data-type", type);
    div.setAttribute("data-id", idVal);

    div.innerHTML = `
        <div class="d-flex align-items-start">
            ${checkboxHtml}
            <div class="input-group input-group-sm flex-grow-1">
                <select class="form-select work-priority fw-bold ${colorClass}" 
                        style="max-width: 80px; height: 38px; border:none;" 
                        onchange="updatePriorityColor(this)">
                    <option value="ê¸´ê¸‰" class="bg-white text-dark" ${priorityVal==='ê¸´ê¸‰'?'selected':''}>${Lurgent}</option>
                    <option value="ìƒ" class="bg-white text-danger" ${priorityVal==='ìƒ'?'selected':''}>${Lhigh}</option>
                    <option value="ì¤‘" class="bg-white text-primary" ${priorityVal==='ì¤‘'?'selected':''}>${Lmedium}</option>
                    <option value="í•˜" class="bg-white text-secondary" ${priorityVal==='í•˜'?'selected':''}>${Llow}</option>
                </select>
                
                <textarea class="form-control work-content" 
                          placeholder="ì—…ë¬´ ë‚´ìš© (Enterë¡œ ì¤„ë°”ê¿ˆ)" 
                          rows="1" 
                          style="resize:none; overflow:hidden; min-height: 38px; height:auto;" 
                          oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'">${contentVal}</textarea>
                
                <input type="number" class="form-control text-center work-progress" style="max-width: 70px; height: 38px;" value="${progressVal}" placeholder="%">
                <span class="input-group-text" style="height: 38px;">%</span>

                <button class="btn btn-outline-danger" style="height: 38px;" onclick="deleteWorkRow(this)">ğŸ—‘</button>
            </div>
        </div>
        ${item && item.managerComment ? `<div class="alert alert-warning py-1 px-2 mt-1 mb-0 small">ğŸ“¢ ${item.managerComment}</div>` : ""}
    `;
    container.appendChild(div);

    var textarea = div.querySelector('textarea');
    if(contentVal) {
        textarea.style.height = 'auto';
        textarea.style.height = (textarea.scrollHeight) + 'px';
    }
}

function deleteWorkRow(btn) {
    if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) btn.closest('.work-row').remove();
}

/* [2] ì²´í¬í•œ ì—…ë¬´ë¥¼ Todayë¡œ ì´ë™ */
function moveCheckedToToday() {
    var checkedBoxes = document.querySelectorAll('#wl-body-continue .chk-move:checked');
    if (checkedBoxes.length === 0) return alert("ì—…ë¬´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

    var todayContainer = document.getElementById("wl-body-today");
    
    checkedBoxes.forEach(function(box) {
        var row = box.closest('.work-row');
        row.setAttribute("data-type", "today"); // íƒ€ì… ë³€ê²½
        
        // ì²´í¬ë°•ìŠ¤ ì œê±°
        var chkDiv = box.closest('.input-group-text');
        if(chkDiv) chkDiv.remove();

        // í…Œë‘ë¦¬ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ (Start Today íš¨ê³¼)
        row.classList.remove("border-warning", "border-light");
        row.classList.add("border-primary");
        
        todayContainer.appendChild(row);
    });
}

/* [ì‹ ê·œ] ì—…ë¬´ ëë‚´ê¸° (í‡´ê·¼) ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ */
function finishDailyWork() {
    // 1. ì˜¤ëŠ˜ ì—…ë¬´(Today Work) ëª©ë¡ì— ìˆëŠ” ê²ƒë“¤ë§Œ ê°€ì ¸ì˜´
    var todayRows = document.querySelectorAll('#wl-body-today .work-row');
    
    if (todayRows.length === 0) {
        return alert("ì˜¤ëŠ˜ ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.\n(Continueì—ì„œ ë¨¼ì € ì—…ë¬´ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”)");
    }

    // 2. ì‚¬ìš©ì í™•ì¸ (ì¤‘ìš”)
    if (!confirm("ì˜¤ëŠ˜ ì—…ë¬´ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâœ… 100% ë‹¬ì„± â†’ Finishë¡œ ì´ë™\nğŸš§ 100% ë¯¸ë§Œ â†’ ê¸°ë¡ í›„ 'ë‚´ì¼'ë¡œ ì´ì›”")) {
        return;
    }

    // 3. ë°ì´í„° ìˆ˜ì§‘
    var date = document.getElementById("wl-date").value;
    var name = document.getElementById("wl-staff").value;
    var logs = [];

    todayRows.forEach(row => {
        var content = row.querySelector(".work-content").value;
        var progress = row.querySelector(".work-progress").value;
        var priority = row.querySelector(".work-priority").value;
        var id = row.getAttribute("data-id");

        if (content.trim() !== "") {
            logs.push({
                id: id,
                content: content,
                progress: progress,
                priority: priority
            });
        }
    });

    // 4. ë¡œë”©ë°” ì¼œê¸°
    var loadingEl = document.getElementById('loading');
    if(loadingEl) loadingEl.style.display = 'flex';

    // 5. ì„œë²„ë¡œ ì „ì†¡ (submitDailyClose í•¨ìˆ˜ í˜¸ì¶œ)
    google.script.run.withSuccessHandler(function(res) {
        // ë¡œë”©ë°” ë„ê¸°
        if(loadingEl) loadingEl.style.display = 'none';
        
        // ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥
        alert(res);
        
        // â˜… í™”ë©´ ìƒˆë¡œê³ ì¹¨ (ì¤‘ìš”: ê·¸ë˜ì•¼ Finishë¡œ ê°„ ê²Œ ë³´ì„)
        loadWorkLog(); 
        
    }).withFailureHandler(function(err) {
        if(loadingEl) loadingEl.style.display = 'none';
        alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    }).submitDailyClose(date, name, JSON.stringify(logs));
}

/* [ì§ì›ìš©] ì €ì¥í•˜ê¸° */
function saveWorkLog() {
    var date = document.getElementById("wl-date").value;
    var name = document.getElementById("wl-staff").value;
    var logs = [];

    document.querySelectorAll(".work-row").forEach(row => {
        var content = row.querySelector(".work-content").value;
        var progress = row.querySelector(".work-progress").value;
        var priority = row.querySelector(".work-priority").value;
        var type = row.getAttribute("data-type");
        var id = row.getAttribute("data-id");

        if(content.trim() !== "") {
            logs.push({
                id: id,
                type: type,
                content: content,
                progress: progress,
                priority: priority
            });
        }
    });

    if(logs.length === 0) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

    google.script.run.withSuccessHandler(function(res){
        alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadWorkLog();
    }).saveWorkLogData(date, name, JSON.stringify(logs));
}

/* ================= [ì¶”ê°€] ê³µì§€ì‚¬í•­ ê¸°ëŠ¥ ================= */
    
    // 1. ê³µì§€ ë°œì†¡
    // [ì‹ ê·œ] ì „ì²´ ì„ íƒ/í•´ì œ í—¬í¼ í•¨ìˆ˜
    function toggleAll(type, checked) {
       var className = type === 'store' ? 'store-chk' : 'role-chk';
       document.querySelectorAll('.' + className).forEach(el => el.checked = checked);
    }

    // [ìˆ˜ì •] ê³µì§€ ë°œì†¡ (ë‹¤ì¤‘ ì„ íƒ ì²˜ë¦¬ + ì²¨ë¶€íŒŒì¼)
    function sendNotice() {
      var t = document.getElementById("noticeTitle").value;
      var c = document.getElementById("noticeContent").value;

      var stores = [];
      if(document.getElementById("chk-store-all").checked) stores.push("ì „ì²´");
      else document.querySelectorAll('.store-chk:checked').forEach(el => stores.push(el.value));

      var roles = [];
      if(document.getElementById("chk-role-all").checked) roles.push("ì „ì²´");
      else document.querySelectorAll('.role-chk:checked').forEach(el => roles.push(el.value));

      if(!t || !c) return alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if(stores.length === 0) return alert("ë§¤ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      if(roles.length === 0) return alert("ì§ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      var storeStr = stores.join(",");
      var roleStr = roles.join(",");
      if(!confirm(`[ë§¤ì¥: ${storeStr}]\n[ì§ê¸‰: ${roleStr}]\n\në°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      var myRole = (typeof userRole !== 'undefined' && userRole) ? userRole : (typeof currentRole !== 'undefined' ? currentRole : 'officer');
      var myName = (typeof userName !== 'undefined' && userName) ? userName : (typeof currentUser !== 'undefined' ? currentUser : 'ê´€ë¦¬ì');
      var data = { title:t, content:c, targetStore:storeStr, targetRole:roleStr, sender:myName };

      var container = document.getElementById("notice-attachments-container");
      var inputs = container ? container.querySelectorAll("input.notice-file-input") : [];
      var files = [];
      for (var i = 0; i < inputs.length; i++) {
        var fl = inputs[i].files;
        if (fl && fl.length) for (var j = 0; j < fl.length; j++) files.push(fl[j]);
      }
      if (files.length === 0) {
        doSendNotice(data, myRole);
        return;
      }
      var maxSize = 5 * 1024 * 1024; // 5MB per file
      var readers = [];
      for (var i = 0; i < Math.min(files.length, 10); i++) {
        if (files[i].size > maxSize) { var msg = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_attach_over_5mb) ? I18N[currentLang].notice_attach_over_5mb : "5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤"; alert(files[i].name + " " + msg); return; }
        readers.push(readFileAsBase64(files[i]));
      }
      Promise.all(readers).then(function(arr) {
        data.attachments = arr.filter(function(x){ return x; });
        doSendNotice(data, myRole);
      }).catch(function() { var msg = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_attach_read_fail) ? I18N[currentLang].notice_attach_read_fail : "ì²¨ë¶€íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"; alert(msg); });
    }

    function addNoticeAttachmentInput() {
      var container = document.getElementById("notice-attachments-container");
      if (!container) return;
      var count = container.querySelectorAll("input.notice-file-input").length;
      var maxMsg = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_attach_max_10) ? I18N[currentLang].notice_attach_max_10 : "ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      if (count >= 10) { alert(maxMsg); return; }
      var removeText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_attach_remove) ? I18N[currentLang].notice_attach_remove : "âœ• ì œê±°";
      var wrap = document.createElement("div");
      wrap.className = "d-flex align-items-center gap-2 mb-2";
      wrap.innerHTML = "<input type=\"file\" class=\"form-control form-control-sm notice-file-input\" accept=\"image/*,.pdf,.doc,.docx,.xls,.xlsx\" style=\"max-width:280px;\"><button type=\"button\" class=\"btn btn-outline-danger btn-sm\" onclick=\"this.parentElement.remove()\">" + removeText + "</button>";
      container.appendChild(wrap);
    }

    function readFileAsBase64(file) {
      return new Promise(function(resolve) {
        var r = new FileReader();
        r.onload = function() {
          var b64 = (r.result || "").split(",")[1] || "";
          resolve({ base64: b64, fileName: file.name, mimeType: file.type || "application/octet-stream" });
        };
        r.onerror = function() { resolve(null); };
        r.readAsDataURL(file);
      });
    }

    function doSendNotice(data, myRole) {
      google.script.run.withSuccessHandler(function(res) {
        alert(res);
        if(res.indexOf("âœ…") !== -1) {
          document.getElementById("noticeTitle").value = "";
          document.getElementById("noticeContent").value = "";
          var container = document.getElementById("notice-attachments-container");
          if (container) {
            container.querySelectorAll("input.notice-file-input").forEach(function(inp){ inp.value = ""; });
            while (container.children.length > 1) container.lastElementChild.remove();
          }
          document.querySelectorAll('input[type=checkbox]').forEach(function(el){ el.checked = false; });
          loadNoticeHistory();
        }
      }).adminSaveNotice(data, myRole);
    }
    // 2. ë‚´ì—­ ì¡°íšŒ
    // [ìˆ˜ì •] ë‚´ì—­ ì¡°íšŒ (ìŠ¬ë¦¼ ë””ìì¸ + ì‚­ì œ ë²„íŠ¼ + ì„ íƒ ì–¸ì–´ ìë™ ë²ˆì—­)
    function appendNoticeHistoryItem(box, n, titleText, contentText) {
      var div = document.createElement("div");
      div.className = "notice-item border-bottom";
      div.style.cssText = "padding: 10px; background:white; transition: 0.2s;";
      div.onmouseover = function() { this.style.backgroundColor = "#f8f9fa"; };
      div.onmouseout = function() { this.style.backgroundColor = "white"; };
      var esc = function(s){ if(!s) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); };
      div.innerHTML = "<div class=\"d-flex justify-content-between align-items-center\"><div style=\"flex: 1; min-width: 0; margin-right: 10px;\"><div class=\"d-flex align-items-center mb-1\"><span class=\"fw-bold text-dark text-truncate me-2\" style=\"font-size:13px;\">" + esc(titleText) + "</span><span class=\"text-secondary small\" style=\"font-size:11px;\">" + esc(n.date) + "</span></div><div class=\"text-truncate\" style=\"font-size:12px; color:#555;\"><span class=\"badge bg-light text-dark border me-1\" style=\"font-size:10px;\">To: " + esc(n.targetStore) + "</span> " + esc(contentText) + "</div></div><div class=\"d-flex gap-1 flex-shrink-0\"><button class=\"btn btn-outline-danger\" style=\"padding: 2px 8px; font-size: 11px;\" onclick=\"deleteNotice('" + String(n.id).replace(/'/g, "\\'") + "')\">ì‚­ì œ</button><button class=\"btn btn-outline-dark\" style=\"padding: 2px 8px; font-size: 11px;\" onclick=\"showReadStats('" + String(n.id).replace(/'/g, "\\'") + "')\">ìˆ˜ì‹ í™•ì¸</button></div></div>";
      box.appendChild(div);
    }
    function loadNoticeHistory() {
      var s = document.getElementById("notice-start").value;
      var e = document.getElementById("notice-end").value;
      
      if(!s) { 
         var today = new Date().toISOString().substring(0,10);
         s = today; e = today;
         document.getElementById("notice-start").value = today;
         document.getElementById("notice-end").value = today;
      }

      var box = document.getElementById("noticeHistoryBox");
      box.innerHTML = "<div class='text-center mt-5 text-muted small'>ë¡œë”© ì¤‘...</div>";
      
      google.script.run.withSuccessHandler(function(list) {
        box.innerHTML = "";
        if (list.length === 0) { box.innerHTML = "<div class='text-center mt-5 text-muted small'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
        var texts = [];
        list.forEach(function(n){ texts.push(n.title || ""); texts.push(n.content || ""); });
        var targetLang = (typeof getTranslationLang === "function" ? getTranslationLang() : "ko");
        if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
          list.forEach(function(n){ appendNoticeHistoryItem(box, n, n.title || "", n.content || ""); });
          return;
        }
        google.script.run.withSuccessHandler(function(translated) {
          var ti = 0;
          list.forEach(function(n) {
            var titleText = (translated && translated[ti] !== undefined) ? translated[ti] : (n.title || "");
            ti++;
            var contentText = (translated && translated[ti] !== undefined) ? translated[ti] : (n.content || "");
            ti++;
            appendNoticeHistoryItem(box, n, titleText, contentText);
          });
        }).translateBatch(texts, targetLang);
      }).getNoticeHistoryAdmin(s, e);
    }
    
    // [ì¶”ê°€] ë‚´ê°€ ë°›ì€ ê³µì§€ ë¡œë“œ (ì§€ë‚˜ê°„ ê³µì§€ í¬í•¨, ë‚ ì§œ í•„í„°)
    var myReceivedNotices = [];
    function loadNoticeReceived() {
      var box = document.getElementById("noticeReceivedBox");
      if (!box) return;
      var store = typeof userStore !== "undefined" ? userStore : "";
      var role = typeof userRole !== "undefined" ? userRole : "";
      var name = typeof userName !== "undefined" ? userName : "";
      if (!store || !name) { box.innerHTML = "<div class='p-4 text-center text-muted small'>ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }

      var s = document.getElementById("notice-received-start") && document.getElementById("notice-received-start").value;
      var e = document.getElementById("notice-received-end") && document.getElementById("notice-received-end").value;
      box.innerHTML = "<div class='p-4 text-center text-muted small'>ë¡œë”© ì¤‘...</div>";

      google.script.run.withSuccessHandler(function(list) {
        myReceivedNotices = list || [];
        var unread = myReceivedNotices.filter(function(n){ return n.status === "New" || n.status === "new"; });
        var read = myReceivedNotices.filter(function(n){ return n.status !== "New" && n.status !== "new"; });
        var readInRange = read.filter(function(n){ return (!s || n.date >= s) && (!e || n.date <= e); });
        var filtered = unread.concat(readInRange);
        filtered.sort(function(a, b){ if ((a.status === "New" || a.status === "new") && (b.status !== "New" && b.status !== "new")) return -1; if ((a.status !== "New" && a.status !== "new") && (b.status === "New" || b.status === "new")) return 1; return (b.date || "").localeCompare(a.date || ""); });
        box.innerHTML = "";
        if (filtered.length === 0) { box.innerHTML = "<div class='p-4 text-center text-muted small'>ì¡°íšŒëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }
        var texts = filtered.map(function(n){ return n.title || ""; });
        var targetLang = (typeof getTranslationLang === "function" ? getTranslationLang() : "ko");
        if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
          filtered.forEach(function(n){ appendNoticeReceivedItem(box, n, n.title || ""); });
          return;
        }
        google.script.run.withSuccessHandler(function(translated) {
          filtered.forEach(function(n, i){ appendNoticeReceivedItem(box, n, (translated && translated[i] !== undefined) ? translated[i] : (n.title || "")); });
        }).translateBatch(texts, targetLang);
      }).getMyNotices(store, role, name);
    }

    function appendNoticeReceivedItem(box, n, titleText) {
      var div = document.createElement("div");
      div.className = "border-bottom p-3";
      div.style.cssText = "cursor:pointer; background:white; transition:0.2s;";
      div.onmouseover = function() { this.style.backgroundColor = "#f8f9fa"; };
      div.onmouseout = function() { this.style.backgroundColor = "white"; };
      var badge = n.status === "New" ? "<span class='badge bg-danger me-1'>NEW</span>" : "";
      div.innerHTML = "<div class='d-flex justify-content-between'><span class='fw-bold'>" + badge + (titleText || "") + "</span><span class='text-muted small'>" + n.date + "</span></div><div class='small text-secondary mt-1'>From: " + (n.sender || "") + "</div>";
      div.onclick = function() { openNoticeReceivedModal(n); };
      box.appendChild(div);
    }

    function openNoticeReceivedModal(n) {
      var modal = document.getElementById("noticeReceivedModal");
      if (!modal) return;
      // ì´ì „ ëª¨ë‹¬ ë°±ë“œë¡­ì´ ë‚¨ì•„ ìˆìœ¼ë©´ ì œê±° (í™”ë©´ ë©ˆì¶¤ ë°©ì§€)
      document.querySelectorAll(".modal-backdrop").forEach(function(el) { el.remove(); });
      document.body.classList.remove("modal-open");
      document.body.style.overflow = "";
      document.body.style.paddingRight = "";

      document.getElementById("noticeReceivedModalMeta").innerText = n.date + " Â· From: " + (n.sender || "");
      var attachEl = document.getElementById("noticeReceivedModalAttachments");
      if (attachEl) {
        attachEl.innerHTML = "";
        if (n.attachments && n.attachments.length > 0) {
          var wrap = document.createElement("div");
          wrap.className = "border-top pt-2 mt-2";
          var attachLabel = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_attach) ? I18N[currentLang].notice_attach : "ğŸ“ ì²¨ë¶€íŒŒì¼";
          wrap.innerHTML = "<strong class=\"d-block mb-2\">" + attachLabel + "</strong>";
          var list = document.createElement("div");
          list.className = "d-flex flex-wrap gap-2";
          n.attachments.forEach(function(a) {
            if (a.error) return;
            var isImg = (a.mime || "").indexOf("image/") === 0;
            if (isImg) {
              var img = document.createElement("img");
              img.src = a.url || ("https://drive.google.com/uc?export=view&id=" + (a.id || ""));
              img.alt = a.name || "";
              img.style.maxWidth = "100%"; img.style.maxHeight = "200px"; img.style.objectFit = "contain";
              img.className = "rounded border";
              list.appendChild(img);
            } else {
              var link = document.createElement("a");
              link.href = a.url || ("https://drive.google.com/uc?export=download&id=" + (a.id || ""));
              link.target = "_blank";
              link.rel = "noopener";
              link.className = "btn btn-outline-secondary btn-sm";
              link.textContent = a.name || (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].notice_file ? I18N[currentLang].notice_file : "íŒŒì¼");
              list.appendChild(link);
            }
          });
          wrap.appendChild(list);
          attachEl.appendChild(wrap);
        }
      }
      // ì„ íƒ ì–¸ì–´ë¡œ ì œëª©/ë‚´ìš© ìë™ ë²ˆì—­ (ëª¨ë°”ì¼ê³¼ ë™ì¼)
      var targetLang = (typeof getTranslationLang === "function" ? getTranslationLang() : "ko");
      if (targetLang === "ko" || (!(n.title || "").trim() && !(n.content || "").trim())) {
        document.getElementById("noticeReceivedModalTitle").innerText = n.title || "";
        document.getElementById("noticeReceivedModalContent").innerText = n.content || "";
        var bsModal = bootstrap.Modal.getOrCreateInstance(modal);
        setTimeout(function() { bsModal.show(); }, 0);
        return;
      }
      var texts = [n.title || "", n.content || ""];
      google.script.run.withSuccessHandler(function(translated) {
        document.getElementById("noticeReceivedModalTitle").innerText = (translated && translated[0] !== undefined) ? translated[0] : (n.title || "");
        document.getElementById("noticeReceivedModalContent").innerText = (translated && translated[1] !== undefined) ? translated[1] : (n.content || "");
        var bsModal = bootstrap.Modal.getOrCreateInstance(modal);
        setTimeout(function() { bsModal.show(); }, 0);
      }).translateBatch(texts, targetLang);
    }

    // ë°›ì€ ê³µì§€ ëª¨ë‹¬ ë‹«í ë•Œ ë°±ë“œë¡­/ìŠ¤í¬ë¡¤ ì ê¸ˆ ì •ë¦¬ (í•œ ë²ˆë§Œ ë“±ë¡)
    (function initNoticeReceivedModalCleanup() {
      var modal = document.getElementById("noticeReceivedModal");
      if (modal && !modal._noticeCleanupDone) {
        modal._noticeCleanupDone = true;
        modal.addEventListener("hidden.bs.modal", function() {
          document.querySelectorAll(".modal-backdrop").forEach(function(el) { el.remove(); });
          document.body.classList.remove("modal-open");
          document.body.style.overflow = "";
          document.body.style.paddingRight = "";
        });
      }
    })();

    // [ì¶”ê°€] ê³µì§€ì‚¬í•­ ì‚­ì œ ìš”ì²­
    function deleteNotice(id) {
      if (!confirm("ì •ë§ ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì§ì›ë“¤ ì•±ì—ì„œë„ ì¦‰ì‹œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.)")) return;
      
      google.script.run.withSuccessHandler(res => {
        if (res === "Success") {
          // ì„±ê³µí•˜ë©´ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ ê°±ì‹ 
          loadNoticeHistory(); 
        } else {
          alert("ì‚­ì œ ì‹¤íŒ¨: " + res);
        }
      }).deleteNoticeAdmin(id);
    }


   // [ìˆ˜ì •] ìˆ˜ì‹ í™•ì¸ ëª¨ë‹¬: I18N ì ìš© + ë§¤ì¥/ìƒíƒœ í•„í„° + ìƒíƒœëŠ” í´ë¼ì´ì–¸íŠ¸ í•„í„°
    function _readStatsLang() {
      return (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
    }
    function renderReadStatsTable(list) {
      var lang = _readStatsLang();
      var titleEl = document.getElementById("readStatsModalTitle") || document.querySelector('#readStatsModal .modal-title');
      var tbody = document.getElementById("readStatsBody");
      var statusFilter = document.getElementById("readStatsStatusFilter");
      var statusVal = (statusFilter && statusFilter.value) ? statusFilter.value : "";
      var filtered = !statusVal ? list : list.filter(function(r) { return r.status === statusVal; });
      var total = list.length;
      var unread = list.filter(function(r) { return r.status === "ë¯¸í™•ì¸"; }).length;
      var lblRead = (lang.read_stats_read != null) ? lang.read_stats_read : "ì½ìŒ";
      var lblUnread = (lang.read_stats_unread != null) ? lang.read_stats_unread : "ì•ˆì½ìŒ";
      var summary = (lang.read_stats_summary != null) ? lang.read_stats_summary : "ğŸ‘€ ìˆ˜ì‹  í˜„í™© (ì•ˆì½ìŒ: {unread} / ì „ì²´: {total})";
      summary = summary.replace("{unread}", "<span class=\"text-danger fw-bold\">" + unread + "</span>").replace("{total}", total);
      if (titleEl) titleEl.innerHTML = summary;
      if (!filtered.length) {
        tbody.innerHTML = "<tr><td colspan='4' class='text-center py-4'>" + (lang.read_stats_no_data || "í•´ë‹¹ë˜ëŠ” ëŒ€ìƒ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.") + "</td></tr>";
        return;
      }
      var html = "";
      filtered.forEach(function(r) {
        var badge = r.status === "í™•ì¸" ? "<span class=\"badge bg-success\">" + lblRead + "</span>" : "<span class=\"badge bg-danger\">" + lblUnread + "</span>";
        var bgStyle = r.status === "ë¯¸í™•ì¸" ? "background-color: #fff5f5;" : "";
        html += "<tr style=\"" + bgStyle + "\"><td><span class=\"fw-bold\">" + (r.store || "").replace(/</g, "&lt;") + "</span></td><td>" + (r.name || "").replace(/</g, "&lt;") + " <small class=\"text-muted\">(" + (r.role || "").replace(/</g, "&lt;") + ")</small></td><td>" + badge + "</td><td class=\"small text-secondary\">" + (r.date || "-") + "</td></tr>";
      });
      tbody.innerHTML = html;
    }
    function showReadStats(id) {
      window._readStatsNoticeId = id;
      var modalEl = document.getElementById('readStatsModal');
      if (!modalEl) { alert("ìˆ˜ì‹  í™•ì¸ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      if (modalEl.parentNode !== document.body) {
        document.body.appendChild(modalEl);
      }
      if (!window._readStatsModalInstance) {
        window._readStatsModalInstance = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true });
        modalEl.addEventListener('hidden.bs.modal', function() {
          document.querySelectorAll('.modal-backdrop').forEach(function(el) { el.remove(); });
          document.body.classList.remove('modal-open');
          document.body.style.removeProperty('overflow');
          document.body.style.removeProperty('padding-right');
        });
      }
      var lang = _readStatsLang();
      var titleEl = document.getElementById("readStatsModalTitle") || document.querySelector('#readStatsModal .modal-title');
      var tbody = document.getElementById("readStatsBody");
      var storeSel = document.getElementById("readStatsStoreFilter");
      var statusSel = document.getElementById("readStatsStatusFilter");
      var thead = document.getElementById("readStatsThead");
      var labelStore = document.getElementById("readStatsLabelStore");
      var labelStatus = document.getElementById("readStatsLabelStatus");

      if (titleEl) titleEl.textContent = (lang.read_stats_title != null) ? lang.read_stats_title : "ğŸ‘€ ìˆ˜ì‹  í™•ì¸ í˜„í™©";
      if (labelStore) labelStore.textContent = (lang.read_stats_store != null) ? lang.read_stats_store : "ë§¤ì¥";
      if (labelStatus) labelStatus.textContent = (lang.read_stats_status != null) ? lang.read_stats_status : "ìƒíƒœ";
      if (thead) {
        var h = (lang.read_stats_store != null ? lang.read_stats_store : "ë§¤ì¥") + "</th><th>" + (lang.read_stats_name != null ? lang.read_stats_name : "ì´ë¦„") + "</th><th>" + (lang.read_stats_status != null ? lang.read_stats_status : "ìƒíƒœ") + "</th><th>" + (lang.read_stats_read_at != null ? lang.read_stats_read_at : "í™•ì¸ì¼ì‹œ");
        thead.innerHTML = "<th>" + h + "</th>";
      }
      if (statusSel && statusSel.options.length >= 3) {
        statusSel.options[0].text = (lang.read_stats_all != null) ? lang.read_stats_all : "ì „ì²´";
        statusSel.options[1].text = (lang.read_stats_read != null) ? lang.read_stats_read : "ì½ìŒ";
        statusSel.options[2].text = (lang.read_stats_unread != null) ? lang.read_stats_unread : "ì•ˆì½ìŒ";
      }
      var storeFilter = (storeSel && storeSel.value) ? storeSel.value : "";
      tbody.innerHTML = "<tr><td colspan='4' class='text-center py-4'>" + (lang.read_stats_loading != null ? lang.read_stats_loading : "ë°ì´í„° ì¡°íšŒ ì¤‘...") + "</td></tr>";
      window._readStatsModalInstance.show();

      google.script.run.withSuccessHandler(function(list) {
        window._readStatsLastList = list || [];
        if (!list || !list.length) {
          tbody.innerHTML = "<tr><td colspan='4' class='text-center py-4'>" + (lang.read_stats_no_data || "í•´ë‹¹ë˜ëŠ” ëŒ€ìƒ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.") + "</td></tr>";
          if (titleEl) titleEl.textContent = (lang.read_stats_title != null) ? lang.read_stats_title : "ğŸ‘€ ìˆ˜ì‹  í™•ì¸ í˜„í™©";
          return;
        }
        if (storeSel) {
          while (storeSel.options.length > 1) storeSel.remove(1);
          var stores = [];
          list.forEach(function(r) { if (r.store && stores.indexOf(r.store) === -1) stores.push(r.store); });
          stores.sort();
          stores.forEach(function(s) {
            var opt = document.createElement("option");
            opt.value = s;
            opt.textContent = s;
            storeSel.appendChild(opt);
          });
        }
        renderReadStatsTable(list);
      }).adminGetNoticeStats(id, storeFilter);
    }
  function saveNotice() { google.script.run.withSuccessHandler(alert).saveNotice(document.getElementById("notice-text").value); }


</script>

