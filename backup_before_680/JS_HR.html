<script>

  /* =================================================================
      ì¸ì‚¬/ìŠ¤ì¼€ì¤„ ê´€ë¦¬
     ================================================================= */ 
  /* =================================================================
     ì§ì› / ê¸‰ì—¬
     ================================================================= */ 

// [ìˆ˜ì •] ì§ì› ë°ì´í„° ë¡œë“œ (í™”ë©´ í‘œì‹œ X, ê²€ìƒ‰ ëŒ€ê¸° ìƒíƒœ) + ë§¤ë‹ˆì €ì¼ ë•Œ í•„í„°ëŠ” í•´ë‹¹ ë§¤ì¥ë§Œ
function loadEmployeeList() { 
    load(1); 
    google.script.run.withSuccessHandler(l => { 
        load(0); 
        employeeCache = l || [];
        google.script.run.withSuccessHandler(function(grades) {
            (employeeCache || []).forEach(function(e) {
                var store = String(e.store || "").trim().replace(/\s+/g, " ");
                var name = String(e.name || "").trim().replace(/\s+/g, " ");
                var nick = String(e.nick || "").trim().replace(/\s+/g, " ");
                var key = store + "|" + name;
                var keyNick = (nick && nick !== name) ? store + "|" + nick : "";
                var g = (grades && grades[key]) ? grades[key].grade : (grades && keyNick && grades[keyNick]) ? grades[keyNick].grade : null;
                e.finalGrade = (g && String(g).trim()) ? g : "-";
            });
            var filterSelect = document.getElementById("filter-store-select");
            if (filterSelect) {
                filterSelect.innerHTML = "";
                var allStoresText = (typeof I18N !== "undefined" && currentLang && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
                filterSelect.add(new Option(allStoresText, "All"));
                var stores = [];
                (employeeCache || []).forEach(function(e) { if (e.store && stores.indexOf(e.store) === -1) stores.push(e.store); });
                stores.forEach(function(s) { filterSelect.add(new Option(s, s)); });
            }
            var b = document.getElementById("emp-list-body");
            if(b) b.innerHTML = "<tr><td colspan='9' class='text-center p-5 text-muted'>ğŸ” ë§¤ì¥Â·ë“±ê¸‰ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ë¦„ì„ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
        }).getEmployeeLatestGrades();
    }).getAdminEmployeeList(userStore, userRole); 
}
function filterEmpList(){ 
    var storeInput = document.getElementById("filter-store-select");
    var gradeInput = document.getElementById("filter-grade-select");
    var searchInput = document.getElementById("emp-search");

    if (!storeInput || !searchInput) return;

    var s = storeInput.value;
    var g = (gradeInput && gradeInput.value) ? gradeInput.value : "All";
    var k = searchInput.value.toLowerCase().trim();

    if (!employeeCache) employeeCache = [];

    var f = employeeCache.filter(e => {
        var eStore = String(e.store || "");
        var eName = String(e.name || "").toLowerCase();
        var eNick = String(e.nick || "").toLowerCase();
        var eGrade = String(e.finalGrade || "").trim();
        var matchStore = (s === "" || s === "All" || eStore === s);
        var matchGrade = (g === "" || g === "All" || eGrade === g);
        var matchKey = (k === "" || eName.includes(k) || eNick.includes(k));
        return matchStore && matchGrade && matchKey;
    });
    
    renderEmpTable(f); 
}
  function renderEmpTable(l) { 
      var b=document.getElementById("emp-list-body"); b.innerHTML=""; 
      if(!l.length){ b.innerHTML="<tr><td colspan='9'>ê²°ê³¼ ì—†ìŒ</td></tr>"; return; }
      l.forEach(e=>{ 
          var age = "-"; if(e.birth) { var d=new Date(e.birth); age = new Date().getFullYear()-d.getFullYear(); }
          var grade = e.finalGrade || "-";
          var idx = employeeCache.findIndex(z=>z.row===e.row);
          var gradeCell = "<span class=\"badge bg-primary\">" + grade + "</span>";
          var storeCell = (e.store || "-");
          b.innerHTML+=`<tr><td class="align-middle">${gradeCell}</td><td class="align-middle small fw-bold">${storeCell}</td><td class='fw-bold'>${e.name}</td><td>${e.nick||'-'}</td><td>${e.nation||'-'}</td><td>${age}ì„¸</td><td><span class='badge bg-info text-dark'>${e.role}</span></td><td class='text-end'>${Number(e.salAmt).toLocaleString()}</td><td><button class='btn btn-sm btn-primary' onclick='editEmp(${idx})'>ìˆ˜ì •</button> <button class='btn btn-sm btn-danger' onclick='delEmp(${e.row})'>ì‚­ì œ</button></td></tr>`; 
      }); 
  }
  function saveEmployee() { 
      var d={ row:document.getElementById("emp-row").value, store:document.getElementById("emp-store").value, name:document.getElementById("emp-name").value, nick:document.getElementById("emp-nick").value, job:document.getElementById("emp-job").value, phone:document.getElementById("emp-phone").value, email:document.getElementById("emp-email").value, birth:document.getElementById("emp-birth").value, nation:document.getElementById("emp-nation").value, join:document.getElementById("emp-date").value, resign:document.getElementById("emp-resign").value, salType:document.getElementById("emp-sal-type").value, salAmt:document.getElementById("emp-sal-amt").value, pw:document.getElementById("emp-pw").value, role:document.getElementById("emp-role").value, photo:document.getElementById("emp-photo")?document.getElementById("emp-photo").value:"" }; 
      if(!d.name) return; load(1); google.script.run.withSuccessHandler(r=>{load(0);alert(r);loadEmployeeList();}).saveAdminEmployee(d, typeof userStore !== "undefined" ? userStore : "", typeof userRole !== "undefined" ? userRole : ""); 
  }
  function editEmp(i) { var e=employeeCache[i]; document.getElementById("emp-row").value=e.row; document.getElementById("emp-store").value=e.store; document.getElementById("emp-name").value=e.name; document.getElementById("emp-nick").value=e.nick; document.getElementById("emp-phone").value=e.phone; document.getElementById("emp-job").value=e.job; document.getElementById("emp-birth").value=e.birth; document.getElementById("emp-nation").value=e.nation; document.getElementById("emp-email").value=e.email; document.getElementById("emp-date").value=e.join; document.getElementById("emp-resign").value=e.resign; document.getElementById("emp-sal-type").value=e.salType; document.getElementById("emp-sal-amt").value=e.salAmt; document.getElementById("emp-pw").value=e.pw; document.getElementById("emp-role").value=e.role; var ph=document.getElementById("emp-photo"); if(ph) ph.value=e.photo||""; var gEl=document.getElementById("emp-grade"); if(gEl) gEl.value=(e.finalGrade&&String(e.finalGrade).trim())?e.finalGrade:""; if(typeof updateEmpFormPhoto==="function") updateEmpFormPhoto(); }
  function delEmp(r) { if(confirm("ì‚­ì œ?")){load(1);google.script.run.withSuccessHandler(r=>{load(0);alert(r);loadEmployeeList();}).deleteAdminEmployee(r, typeof userStore !== "undefined" ? userStore : "", typeof userRole !== "undefined" ? userRole : "");} }
  function createNewEmployee() { document.querySelectorAll('#hr-employee-section input').forEach(i=>i.value=""); var gEl=document.getElementById("emp-grade"); if(gEl) gEl.value=""; document.getElementById("emp-row").value="0"; var ph=document.getElementById("emp-photo"); if(ph) ph.value=""; if(typeof updateEmpFormPhoto==="function") updateEmpFormPhoto(); }
  function updateEmpFormPhoto() { var inp=document.getElementById("emp-photo"); var img=document.getElementById("emp-form-photo-img"); if(!inp||!img) return; var v=(inp.value||"").trim(); if(v){ img.src=v; img.style.display="block"; img.onerror=function(){ img.style.display="none"; }; } else { img.src=""; img.style.display="none"; } }

/* ----- ì§ì› ê´€ë¦¬: 5ê°œ íƒ­ (ì§ì› ëª©ë¡ / ì§ì› í‰ê°€ / í‰ê°€ ëª©ë¡ / ì£¼ë°© í•­ëª© ì„¤ì • / ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •) ----- */
function showHrEmployeeTab(t) {
  var listPanel = document.getElementById("hr-emp-tab-list");
  var evalPanel = document.getElementById("eval-type-eval");
  var evalListPanel = document.getElementById("eval-type-list");
  var kitchenPanel = document.getElementById("eval-type-kitchen-setting");
  var servicePanel = document.getElementById("eval-type-service-setting");
  if (listPanel) listPanel.style.display = (t === "list") ? "block" : "none";
  if (evalPanel) evalPanel.style.display = (t === "eval") ? "block" : "none";
  if (evalListPanel) evalListPanel.style.display = (t === "eval-list") ? "block" : "none";
  if (kitchenPanel) kitchenPanel.style.display = (t === "kitchen-setting") ? "block" : "none";
  if (servicePanel) servicePanel.style.display = (t === "service-setting") ? "block" : "none";
  var navIds = ["hr-emp-nav-list", "hr-emp-nav-eval", "hr-emp-nav-eval-list", "hr-emp-nav-kitchen-setting", "hr-emp-nav-service-setting"];
  var tabValues = ["list", "eval", "eval-list", "kitchen-setting", "service-setting"];
  navIds.forEach(function(id, idx) {
    var el = document.getElementById(id);
    if (el) el.classList.toggle("active", tabValues[idx] === t);
  });
  if (t === "eval") {
    var evalInsp = document.getElementById("eval-evaluator");
    if (evalInsp) {
      var loginName = (typeof userName !== "undefined" && userName) ? userName : (typeof sessionStorage !== "undefined" && sessionStorage.getItem("cm_name")) || "";
      if (!loginName) {
        var uInfo = document.getElementById("u-info");
        if (uInfo && uInfo.innerText) loginName = uInfo.innerText.trim().split(/\s+/).pop() || uInfo.innerText.trim();
      }
      evalInsp.value = loginName || "";
    }
    var evalDate = document.getElementById("eval-date");
    if (evalDate && !evalDate.value) evalDate.valueAsDate = new Date();
    var evalStore = document.getElementById("eval-store");
    if (evalStore && typeof loadStoreOptions === "function" && (!evalStore.options || evalStore.options.length <= 1)) loadStoreOptions("eval-store");
    fillEvalEmployeeOptions();
  }
  if (t === "eval-list") {
    var startEl = document.getElementById("eval-list-start");
    var endEl = document.getElementById("eval-list-end");
    if (startEl && !startEl.value) {
      var d = new Date();
      var y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, "0");
      startEl.value = y + "-" + m + "-01";
      endEl.value = y + "-" + m + "-" + String(d.getDate()).padStart(2, "0");
    }
    var storeSel = document.getElementById("eval-list-store");
    if (storeSel && typeof loadStoreOptions === "function") {
      if (storeSel.options.length <= 1) storeSel.classList.remove("loaded");
      loadStoreOptions("eval-list-store");
    }
    loadEvaluationHistory();
  }
  if (t === "kitchen-setting") loadEvaluationSettings("kitchen");
  if (t === "service-setting") loadEvaluationSettings("service");
}
function getEvalType() {
  var sel = document.getElementById("eval-type-select");
  return (sel && sel.value) ? sel.value : "kitchen";
}
function showEvalTypeTab(type) {
  if (type === "eval") showHrEmployeeTab("eval");
  else if (type === "list") showHrEmployeeTab("eval-list");
  else if (type === "kitchen-setting") showHrEmployeeTab("kitchen-setting");
  else if (type === "service-setting") showHrEmployeeTab("service-setting");
}
function fillEvalEmployeeOptions() {
  var storeSel = document.getElementById("eval-store");
  var empSel = document.getElementById("eval-employee");
  if (!storeSel || !empSel) return;
  var store = storeSel.value;
  empSel.innerHTML = "<option value=\"\">ì§ì› ì„ íƒ</option>";
  if (!store || store === "All" || !employeeCache || !employeeCache.length) { updateEvalEmployeePhoto(); return; }
  var list = employeeCache.filter(function(e) { return String(e.store || "") === String(store); });
  list.forEach(function(e) { empSel.add(new Option(e.name || "", e.name || "")); });
  updateEvalEmployeePhoto();
}
function updateEvalEmployeePhoto() {
  var empSel = document.getElementById("eval-employee");
  var img = document.getElementById("eval-employee-photo");
  var wrap = document.getElementById("eval-employee-photo-wrap");
  if (!empSel || !img) return;
  var name = (empSel.value || "").trim();
  var storeSel = document.getElementById("eval-store");
  var store = storeSel ? (storeSel.value || "").trim() : "";
  if (!name || !store || !employeeCache || !employeeCache.length) { img.style.display = "none"; img.src = ""; if (wrap) wrap.title = ""; return; }
  var emp = employeeCache.find(function(e) { return String(e.store || "") === store && String(e.name || "") === name; });
  if (emp && emp.photo && String(emp.photo).trim()) { img.src = emp.photo; img.style.display = "block"; img.onerror = function() { img.style.display = "none"; }; if (wrap) wrap.title = emp.name || ""; } else { img.src = ""; img.style.display = "none"; if (wrap) wrap.title = ""; }
}
var EVAL_INCIDENT_TYPES = ["ë°˜ë³µ ê³¼ë‹¤ ì†ŒìŠ¤", "ìœ„ìƒ ê´€ë ¨ ì´ë ¥", "ê³ ê° ê´€ë ¨", "ê°œì„  ì—†ìŒ", "ì•ˆì „ ì‚¬ê³ (í™”ìƒ/ë¯¸ë„ëŸ¼/ë‚™ìƒ ë“±)"];
var EVAL_WEIGHTS = { "ë©”ë‰´ìˆ™ë ¨": 0.4, "ì›ê°€ì •í™•ë„": 0.2, "ìœ„ìƒ": 0.2, "íƒœë„": 0.2 };
var EVAL_GRADE_CUT = [4.8, 4.5, 4.0, 3.5, 3.0, 2.0];
var EVAL_GRADE_LABEL = ["S", "A", "B", "C", "D", "E", "F"];

function scoreToGrade(score) {
  var s = parseFloat(score);
  for (var i = 0; i < EVAL_GRADE_CUT.length; i++) { if (s >= EVAL_GRADE_CUT[i]) return EVAL_GRADE_LABEL[i]; }
  return EVAL_GRADE_LABEL[EVAL_GRADE_LABEL.length - 1];
}
function updateEvalTotals() {
  var rows = document.querySelectorAll(".eval-row");
  var sums = {}, counts = {};
  rows.forEach(function(row) {
    var section = row.getAttribute("data-main") || "";
    if (!section) return;
    var sel = row.querySelector(".eval-score-select");
    var v = sel ? parseInt(sel.value, 10) : 0;
    if (isNaN(v)) v = 0;
    sums[section] = (sums[section] || 0) + v;
    counts[section] = (counts[section] || 0) + 1;
  });
  var menuAvg = counts["ë©”ë‰´ìˆ™ë ¨"] ? sums["ë©”ë‰´ìˆ™ë ¨"] / counts["ë©”ë‰´ìˆ™ë ¨"] : 0;
  var costAvg = counts["ì›ê°€ì •í™•ë„"] ? sums["ì›ê°€ì •í™•ë„"] / counts["ì›ê°€ì •í™•ë„"] : 0;
  var hygieneAvg = counts["ìœ„ìƒ"] ? sums["ìœ„ìƒ"] / counts["ìœ„ìƒ"] : 0;
  var attitudeAvg = counts["íƒœë„"] ? sums["íƒœë„"] / counts["íƒœë„"] : 0;
  var serviceAvgForSection = counts["ì„œë¹„ìŠ¤"] ? sums["ì„œë¹„ìŠ¤"] / counts["ì„œë¹„ìŠ¤"] : 0;
  document.querySelectorAll(".eval-section-avg").forEach(function(span) {
    var sec = span.getAttribute("data-section");
    var avg = sec === "ë©”ë‰´ìˆ™ë ¨" ? menuAvg : sec === "ì›ê°€ì •í™•ë„" ? costAvg : sec === "ìœ„ìƒ" ? hygieneAvg : sec === "íƒœë„" ? attitudeAvg : sec === "ì„œë¹„ìŠ¤" ? serviceAvgForSection : 0;
    span.textContent = avg > 0 ? avg.toFixed(2) : "-";
  });
  var serviceAvg = counts["ì„œë¹„ìŠ¤"] ? sums["ì„œë¹„ìŠ¤"] / counts["ì„œë¹„ìŠ¤"] : 0;
  var total;
  if (counts["ì„œë¹„ìŠ¤"] !== undefined && counts["ì„œë¹„ìŠ¤"] > 0) {
    total = serviceAvg;
  } else {
    total = menuAvg * EVAL_WEIGHTS["ë©”ë‰´ìˆ™ë ¨"] + costAvg * EVAL_WEIGHTS["ì›ê°€ì •í™•ë„"] + hygieneAvg * EVAL_WEIGHTS["ìœ„ìƒ"] + attitudeAvg * EVAL_WEIGHTS["íƒœë„"];
  }
  var grade = (menuAvg || costAvg || hygieneAvg || attitudeAvg || serviceAvg) ? scoreToGrade(total) : "-";
  var totalEl = document.getElementById("eval-total-score");
  var gradeSel = document.getElementById("eval-final-grade");
  if (totalEl) totalEl.textContent = total > 0 ? total.toFixed(2) : "-";
  if (gradeSel && grade !== "-") { gradeSel.value = grade; }
}
function updateEvalGradeDisplay() {}

function fillEvalIncidents() {
  var tbody = document.getElementById("eval-incidents-body");
  if (!tbody) return;
  var html = "";
  EVAL_INCIDENT_TYPES.forEach(function(label) {
    html += buildEvalIncidentRow(label);
  });
  html += "<tr><td colspan=\"5\" class=\"text-end\"><button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"addEvalIncidentRow()\">+ í–‰ ì¶”ê°€</button></td></tr>";
  tbody.innerHTML = html;
}
function buildEvalIncidentRow(typeLabel) {
  var esc = function(s) { return String(s != null && s !== undefined ? s : "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\"/g, "&quot;"); };
  var opts = EVAL_INCIDENT_TYPES.map(function(l) {
    return "<option value=\"" + esc(l) + "\"" + (l === typeLabel ? " selected" : "") + ">" + (l || "") + "</option>";
  }).join("");
  opts += "<option value=\"__ê¸°íƒ€__\">ê¸°íƒ€(ì§ì ‘ì…ë ¥)</option>";
  return "<tr class=\"eval-incident-row\">" +
    "<td><select class=\"form-select form-select-sm eval-incident-type\" onchange=\"var o=this.nextElementSibling;if(o)o.style.display=this.value==='__ê¸°íƒ€__'?'block':'none';\">" + opts + "</select><input type=\"text\" class=\"form-control form-control-sm mt-1 eval-incident-type-other\" placeholder=\"ê¸°íƒ€ ìœ í˜•\" style=\"display:none;\"></td>" +
    "<td><select class=\"form-select form-select-sm eval-incident-occured\"><option value=\"No\">No</option><option value=\"Yes\">Yes</option></select></td>" +
    "<td><input type=\"date\" class=\"form-control form-control-sm eval-incident-date\"></td>" +
    "<td><input type=\"text\" class=\"form-control form-control-sm eval-incident-details\" placeholder=\"ìƒì„¸\"></td>" +
    "<td style=\"width:50px;\"><button type=\"button\" class=\"btn btn-sm btn-outline-danger\" onclick=\"removeEvalIncidentRow(this)\" title=\"ì‚­ì œ\">Ã—</button></td></tr>";
}
function addEvalIncidentRow() {
  var tbody = document.getElementById("eval-incidents-body");
  if (!tbody) return;
  var addRow = tbody.querySelector("tr:last-child");
  var html = buildEvalIncidentRow(EVAL_INCIDENT_TYPES[0]);
  var tmp = document.createElement("tbody");
  tmp.innerHTML = html;
  var newTr = tmp.querySelector("tr");
  if (!newTr) return;
  if (addRow) tbody.insertBefore(newTr, addRow);
  else tbody.appendChild(newTr);
  var sel = newTr.querySelector(".eval-incident-type");
  var other = newTr.querySelector(".eval-incident-type-other");
  if (sel && other) sel.addEventListener("change", function() { other.style.display = (sel.value === "__ê¸°íƒ€__") ? "block" : "none"; });
}
function removeEvalIncidentRow(btn) {
  var row = btn && btn.closest ? btn.closest("tr") : null;
  if (row && row.classList.contains("eval-incident-row")) row.remove();
}

/** ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°: í‰ê°€ ìœ í˜•(ì£¼ë°© ì§ì› â†’ ì£¼ë°© í•­ëª© ì„¤ì •, ì„œë¹„ìŠ¤ ì§ì› â†’ ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •)ì— ë”°ë¼ í•´ë‹¹ ì‹œíŠ¸ í•­ëª©ì„ ë¶ˆëŸ¬ì˜´ */
function loadEvaluationForm(type) {
  var container = document.getElementById("eval-sections-container");
  if (!container) return;
  type = type || getEvalType();
  if (!type) type = "kitchen";
  var extraKitchen = document.getElementById("eval-extra-kitchen");
  if (extraKitchen) extraKitchen.style.display = (type === "kitchen") ? "block" : "none";
  var weightLine = document.querySelector(".eval-weight-line");
  if (weightLine) weightLine.style.display = (type === "kitchen") ? "block" : "none";
  container.innerHTML = "<p class=\"text-center py-3\">â³ ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
  var loadTimeout = setTimeout(function() {
    if (container.innerHTML.indexOf("ì–‘ì‹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘") !== -1) {
      container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì‹œíŠ¸(í‰ê°€í•­ëª©_ì£¼ë°©/í‰ê°€í•­ëª©_ì„œë¹„ìŠ¤)ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</p>";
    }
  }, 25000);
  google.script.run
    .withSuccessHandler(function(items) {
      clearTimeout(loadTimeout);
      try {
        if (!container) return;
        container.innerHTML = "";
        if (!items || !Array.isArray(items)) items = [];
        if (items.length === 0) {
          container.innerHTML = "<p class=\"text-center text-muted\">ë“±ë¡ëœ í‰ê°€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. [ì£¼ë°© í•­ëª© ì„¤ì •] ë˜ëŠ” [ì„œë¹„ìŠ¤ í•­ëª© ì„¤ì •] íƒ­ì—ì„œ í•­ëª© ë¶ˆëŸ¬ì˜¤ê¸° í›„ ì €ì¥í•˜ì„¸ìš”.</p>";
          if (type === "kitchen") fillEvalIncidents();
          return;
        }
        var bySection = {};
        items.forEach(function(item) {
          var sec = (item && item.main != null) ? String(item.main).trim() : "";
          if (!bySection[sec]) bySection[sec] = [];
          bySection[sec].push(item);
        });
        var sectionOrder = type === "service" ? ["ì„œë¹„ìŠ¤"] : ["ë©”ë‰´ìˆ™ë ¨", "ì›ê°€ì •í™•ë„", "ìœ„ìƒ", "íƒœë„"];
        var sectionTitles = type === "service" ? { "ì„œë¹„ìŠ¤": "ì„œë¹„ìŠ¤ í‰ê°€ í•­ëª© (1-5)" } : { "ë©”ë‰´ìˆ™ë ¨": "2) ë©”ë‰´ ìˆ™ë ¨ (1-5)", "ì›ê°€ì •í™•ë„": "3) ì¡°ë¦¬ ì •í™•ë„Â·ì›ê°€ ê´€ë¦¬ (1-5)", "ìœ„ìƒ": "4) ìœ„ìƒÂ·ì‘ì—… ìŠµê´€ (1-5)", "íƒœë„": "5) íƒœë„Â·í”¼í¬íƒ€ì„ ìˆ˜í–‰ (1-5)" };
        var fullHtml = "";
        sectionOrder.forEach(function(sec) {
          var list = bySection[sec];
          if (!list || list.length === 0) return;
          var card = "<div class=\"card-box mb-3\"><h6 class=\"fw-bold border-bottom pb-2\">" + (sectionTitles[sec] || sec) + "</h6><div class=\"table-responsive\"><table class=\"table table-sm table-bordered align-middle mb-0\"><thead class=\"table-light\"><tr class=\"text-center\">";
          if (sec === "ë©”ë‰´ìˆ™ë ¨") card += "<th>NO</th><th>Category</th><th>Menu Item</th><th>Score(1-5)</th><th>Solo OK</th><th>Peak OK</th><th>Can Train</th><th>Notes</th></tr></thead><tbody>";
          else card += "<th>NO</th><th>í‰ê°€ í•­ëª©</th><th>Score(1-5)</th><th>Notes</th></tr></thead><tbody>";
          list.forEach(function(item) {
            var esc = function(s) { return String(s != null && s !== undefined ? s : "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\"/g, "&quot;"); };
            var id = item && (item.id != null) ? item.id : "";
            var main = item && (item.main != null) ? String(item.main) : "";
            var sub = item && (item.sub != null) ? String(item.sub) : "";
            var name = item && (item.name != null) ? String(item.name) : "";
            var scoreOpts = "<option value=\"1\">1</option><option value=\"2\">2</option><option value=\"3\">3</option><option value=\"4\">4</option><option value=\"5\" selected>5</option>";
            if (sec === "ë©”ë‰´ìˆ™ë ¨" && type === "kitchen") {
              card += "<tr class=\"eval-row\" data-id=\"" + esc(id) + "\" data-main=\"" + esc(main) + "\" data-sub=\"" + esc(sub) + "\" data-name=\"" + esc(name) + "\">" +
                "<td class=\"text-center fw-bold bg-light\">" + esc(id) + "</td><td>" + esc(sub) + "</td><td class=\"text-start\">" + esc(name) + "</td>" +
                "<td class=\"text-center\"><select class=\"form-select form-select-sm eval-score-select\" onchange=\"updateEvalTotals()\">" + scoreOpts + "</select></td>" +
                "<td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-solo-ok\"></td><td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-peak-ok\"></td><td class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input eval-can-train\"></td>" +
                "<td><input type=\"text\" class=\"form-control form-control-sm eval-remark\" placeholder=\"ë¹„ê³ \"></td></tr>";
            } else {
              card += "<tr class=\"eval-row\" data-id=\"" + esc(id) + "\" data-main=\"" + esc(main) + "\" data-sub=\"" + esc(sub) + "\" data-name=\"" + esc(name) + "\">" +
                "<td class=\"text-center fw-bold bg-light\">" + esc(id) + "</td><td class=\"text-start\">" + esc(name) + "</td>" +
                "<td class=\"text-center\"><select class=\"form-select form-select-sm eval-score-select\" onchange=\"updateEvalTotals()\">" + scoreOpts + "</select></td>" +
                "<td><input type=\"text\" class=\"form-control form-control-sm eval-remark\" placeholder=\"ë¹„ê³ \"></td></tr>";
            }
          });
          card += "</tbody></table></div><p class=\"small mb-0 mt-1\">" + sec + " í‰ê· : <span class=\"eval-section-avg\" data-section=\"" + sec + "\">-</span></p></div>";
          fullHtml += card;
        });
        container.innerHTML = fullHtml;
        if (type === "kitchen") fillEvalIncidents();
        updateEvalTotals();
      } catch (e) {
        if (container) container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || "") + "</p>";
        console.error("loadEvaluationForm success handler error:", e);
      }
    })
    .withFailureHandler(function(err) {
      clearTimeout(loadTimeout);
      if (container) container.innerHTML = "<p class=\"text-center text-danger py-3\">ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‹œíŠ¸(í‰ê°€í•­ëª©_ì£¼ë°©/í‰ê°€í•­ëª©_ì„œë¹„ìŠ¤)ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>";
      console.error("getEvaluationItems error:", err);
    })
    .getEvaluationItems(type, true);
}
function saveEvaluationResult(type) {
  var store = document.getElementById("eval-store").value;
  var employee = document.getElementById("eval-employee").value;
  var date = document.getElementById("eval-date").value;
  var evaluator = document.getElementById("eval-evaluator").value;
  var finalGrade = document.getElementById("eval-final-grade").value;
  var memo = document.getElementById("eval-total-memo").value;
  var id = document.getElementById("eval-id").value;
  if (!store || !employee || !date) { alert("ë§¤ì¥, ì§ì›, í‰ê°€ì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  var isService = (type === "service");
  var sections = { menu: [], cost: [], hygiene: [], attitude: [] };
  var sectionKey = { "ë©”ë‰´ìˆ™ë ¨": "menu", "ì›ê°€ì •í™•ë„": "cost", "ìœ„ìƒ": "hygiene", "íƒœë„": "attitude", "ì„œë¹„ìŠ¤": "menu" };
  var rowContainer = document.getElementById("eval-sections-container");
  var rowSelector = rowContainer ? rowContainer.querySelectorAll(".eval-row") : document.querySelectorAll(".eval-row");
  [].forEach.call(rowSelector || [], function(row) {
    var rId = row.getAttribute("data-id");
    var main = row.getAttribute("data-main");
    var sub = row.getAttribute("data-sub");
    var name = row.getAttribute("data-name");
    var scoreSel = row.querySelector(".eval-score-select");
    var score = scoreSel ? scoreSel.value : "5";
    var remark = row.querySelector(".eval-remark");
    var note = remark ? remark.value : "";
    var rec = { id: rId, main: main, sub: sub, name: name, score: score, notes: note };
    if (main === "ë©”ë‰´ìˆ™ë ¨") {
      var solo = row.querySelector(".eval-solo-ok");
      var peak = row.querySelector(".eval-peak-ok");
      var train = row.querySelector(".eval-can-train");
      rec.soloOK = solo ? solo.checked : false;
      rec.peakOK = peak ? peak.checked : false;
      rec.canTrain = train ? train.checked : false;
    }
    var key = sectionKey[main];
    if (key && sections[key]) sections[key].push(rec);
  });
  var incidents = [];
  if (!isService) document.querySelectorAll(".eval-incident-row").forEach(function(row) {
    var typeSel = row.querySelector(".eval-incident-type");
    var typeOther = row.querySelector(".eval-incident-type-other");
    var typeLabel = typeSel ? (typeSel.value === "__ê¸°íƒ€__" && typeOther ? typeOther.value : typeSel.value) : "";
    if (!typeLabel) return;
    var occ = row.querySelector(".eval-incident-occured");
    var dt = row.querySelector(".eval-incident-date");
    var det = row.querySelector(".eval-incident-details");
    incidents.push({ type: typeLabel, occurred: occ ? occ.value : "No", date: dt ? dt.value : "", details: det ? det.value : "" });
  });
  if (isService) { /* ì„œë¹„ìŠ¤ í‰ê°€ì—ëŠ” incident/actionPlan ì—†ìŒ */ }
  var actionPlan = isService ? {} : {
    trainingNeeded: document.getElementById("eval-training-needed") ? document.getElementById("eval-training-needed").value : "",
    coach: document.getElementById("eval-coach") ? document.getElementById("eval-coach").value : "",
    targetDate: document.getElementById("eval-target-date") ? document.getElementById("eval-target-date").value : "",
    reEvalDate: document.getElementById("eval-reeval-date") ? document.getElementById("eval-reeval-date").value : ""
  };
  var totalScoreEl = document.getElementById("eval-total-score");
  var totalScore = totalScoreEl && totalScoreEl.textContent !== "-" ? parseFloat(totalScoreEl.textContent) : 0;
  var payload = { sections: sections, incidents: incidents, actionPlan: actionPlan, totalScore: totalScore, grade: finalGrade };
  if (confirm("í‰ê°€ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    if (typeof load === "function") load(1);
    google.script.run.withSuccessHandler(function(res) {
      if (typeof load === "function") load(0);
      alert(res === "UPDATED" ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      document.getElementById("eval-id").value = "";
      document.getElementById("eval-total-memo").value = "";
      if (!isService) {
        document.getElementById("eval-training-needed").value = "";
        document.getElementById("eval-coach").value = "";
        var td = document.getElementById("eval-target-date"); if (td) td.value = "";
        var rd = document.getElementById("eval-reeval-date"); if (rd) rd.value = "";
      }
    }).saveEvaluationResult(type, id, date, store, employee, evaluator, finalGrade, memo, JSON.stringify(payload));
  }
}
function loadEvaluationHistory() {
  var typeEl = document.getElementById("eval-list-type");
  var startEl = document.getElementById("eval-list-start");
  var endEl = document.getElementById("eval-list-end");
  var storeEl = document.getElementById("eval-list-store");
  var empEl = document.getElementById("eval-list-employee");
  var evalEl = document.getElementById("eval-list-evaluator");
  var tbody = document.getElementById("eval-history-tbody");
  var countEl = document.getElementById("eval-history-count");
  if (!tbody) return;
  var type = typeEl ? typeEl.value : "kitchen";
  var start = startEl ? startEl.value : "";
  var end = endEl ? endEl.value : "";
  var store = storeEl ? storeEl.value : "All";
  var employee = empEl ? empEl.value : "All";
  var evaluator = evalEl ? evalEl.value : "All";
  var lang = (typeof I18N !== "undefined" && currentLang && I18N[currentLang]) ? I18N[currentLang] : (typeof I18N !== "undefined" && I18N.ko) ? I18N.ko : {};
  var loadingTxt = lang.eval_list_loading || "ì¡°íšŒ ì¤‘...";
  var noDataTxt = lang.eval_list_no_data || "ì¡°íšŒëœ í‰ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
  var countSuffix = lang.eval_list_count || "ê±´";
  var failTxt = lang.eval_list_fail || "ì¡°íšŒ ì‹¤íŒ¨. ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
  var viewTxt = lang.eval_list_btn_view || "ë³´ê¸°";
  tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4\">â³ " + loadingTxt + "</td></tr>";
  google.script.run
    .withSuccessHandler(function(list) {
      tbody.innerHTML = "";
      if (!list || list.length === 0) {
        tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4 text-muted\">" + noDataTxt + "</td></tr>";
        if (countEl) countEl.textContent = "0" + countSuffix;
        return;
      }
      window.evalHistoryList = list;
      var employees = {}, evaluators = {};
      list.forEach(function(r) {
        if (r.employeeName) employees[r.employeeName] = true;
        if (r.evaluator) evaluators[r.evaluator] = true;
      });
      if (empEl && empEl.options.length <= 1) {
        Object.keys(employees).sort().forEach(function(name) { empEl.add(new Option(name, name)); });
      }
      if (evalEl && evalEl.options.length <= 1) {
        Object.keys(evaluators).sort().forEach(function(name) { evalEl.add(new Option(name, name)); });
      }
      list.forEach(function(r, idx) {
        var memoShort = (r.memo || "").substring(0, 30);
        if ((r.memo || "").length > 30) memoShort += "â€¦";
        var row = "<tr><td>" + (r.date || "") + "</td><td class=\"fw-bold\">" + (r.store || "") + "</td><td>" + (r.employeeName || "") + "</td><td>" + (r.evaluator || "") + "</td><td class=\"text-center\">" + (r.totalScore || "-") + "</td><td><span class=\"badge bg-primary\">" + (r.finalGrade || "-") + "</span></td><td class=\"small text-muted\">" + (memoShort || "-") + "</td><td><button type=\"button\" class=\"btn btn-sm btn-outline-primary\" onclick=\"openEvalDetailModal(" + idx + ")\">" + viewTxt + "</button></td></tr>";
        tbody.innerHTML += row;
      });
      if (countEl) countEl.textContent = list.length + countSuffix;
    })
    .withFailureHandler(function() {
      tbody.innerHTML = "<tr><td colspan=\"8\" class=\"text-center py-4 text-danger\">" + failTxt + "</td></tr>";
      if (countEl) countEl.textContent = "";
    })
    .getEvaluationHistory(type, start, end, store, employee, evaluator);
}
function openEvalDetailModal(idx) {
  var list = window.evalHistoryList;
  if (!list || !list[idx]) return;
  var r = list[idx];
  var modal = document.getElementById("evalDetailModal");
  if (!modal) return;
  document.getElementById("eval-detail-title").textContent = (r.store || "") + " / " + (r.employeeName || "") + " (" + (r.date || "") + ")";
  document.getElementById("eval-detail-meta").innerHTML = "í‰ê°€ì: <strong>" + (r.evaluator || "-") + "</strong> &nbsp;|&nbsp; ë“±ê¸‰: <span class=\"badge bg-primary\">" + (r.finalGrade || "-") + "</span> &nbsp;|&nbsp; ì´ì : " + (r.totalScore || "-");
  document.getElementById("eval-detail-memo").textContent = r.memo || "(ì—†ìŒ)";
  var body = document.getElementById("eval-detail-body");
  body.innerHTML = "";
  var jsonData = r.jsonData;
  if (jsonData) {
    try {
      var data = typeof jsonData === "string" ? JSON.parse(jsonData) : jsonData;
      if (data && data.sections) {
        var html = "<p class=\"fw-bold mb-2\">ì´ì : " + (data.totalScore != null ? data.totalScore : "-") + "</p><table class=\"table table-sm table-bordered\"><thead class=\"table-light\"><tr><th>ëŒ€ë¶„ë¥˜</th><th>í•­ëª©</th><th>ì ìˆ˜</th><th>ë¹„ê³ </th></tr></thead><tbody>";
        ["menu", "cost", "hygiene", "attitude"].forEach(function(key) {
          var arr = data.sections[key];
          if (!arr || !arr.length) return;
          arr.forEach(function(item) {
            html += "<tr><td>" + (item.main || "") + "</td><td>" + (item.name || item.sub || "") + "</td><td>" + (item.score || "") + "</td><td class=\"small\">" + (item.notes || "") + "</td></tr>";
          });
        });
        html += "</tbody></table>";
        body.innerHTML = html;
      } else {
        body.textContent = JSON.stringify(data).substring(0, 500) + (JSON.stringify(data).length > 500 ? "â€¦" : "");
      }
    } catch (e) {
      body.textContent = "ìƒì„¸ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    }
  } else {
    body.textContent = "ì €ì¥ëœ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
  }
  if (modal.parentNode !== document.body) document.body.appendChild(modal);
  try {
    var inst = bootstrap.Modal.getOrCreateInstance(modal);
    inst.show();
  } catch (e) {
    modal.style.display = "block";
    modal.classList.add("show");
  }
}
function loadEvaluationSettings(type) {
  var tbodyId = type === "service" ? "eval-setting-list-body-service" : "eval-setting-list-body";
  google.script.run.withSuccessHandler(function(items) {
    var tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!items || items.length === 0) { tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ì €ì¥ ì‹œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</td></tr>"; return; }
    items.forEach(function(item) {
      var checked = item.use ? "checked" : "";
      var mainVal = (item.main || "").replace(/"/g, "&quot;");
      var subVal = (item.sub || "").replace(/"/g, "&quot;");
      var nameVal = (item.name || "").replace(/"/g, "&quot;");
      tbody.innerHTML += "<tr><td>" + item.id + "</td><td><input class=\"form-control form-control-sm\" value=\"" + mainVal + "\" readonly></td><td><input class=\"form-control form-control-sm\" value=\"" + subVal + "\" readonly></td><td><input class=\"form-control form-control-sm eval-set-name\" value=\"" + nameVal + "\"></td><td><input type=\"checkbox\" class=\"form-check-input eval-set-use\" data-id=\"" + item.id + "\" " + checked + "></td><td><button type=\"button\" class=\"btn btn-sm btn-outline-danger\" onclick=\"deleteEvalItem('" + type + "', '" + item.id + "')\">ì‚­ì œ</button></td></tr>";
    });
  }).getEvaluationItems(type, false);
}
function saveEvaluationSettings(type) {
  var tbodyId = type === "service" ? "eval-setting-list-body-service" : "eval-setting-list-body";
  var tbody = document.getElementById(tbodyId);
  if (!tbody) return;
  var updates = [];
  tbody.querySelectorAll("tr").forEach(function(tr) {
    var useEl = tr.querySelector(".eval-set-use");
    var nameEl = tr.querySelector(".eval-set-name");
    if (useEl && nameEl) updates.push({ id: useEl.getAttribute("data-id"), name: nameEl.value, use: useEl.checked });
  });
  if (!updates.length) { alert("ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  google.script.run.withSuccessHandler(function(res) { alert("í•­ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadEvaluationSettings(type); }).updateEvaluationItems(type, updates);
}

function addEvalItemRow(type) {
  var mainCat = type === "service" ? "ì„œë¹„ìŠ¤" : "";
  var subCat = "";
  var itemName = "";
  if (type === "kitchen") {
    mainCat = prompt("ëŒ€ë¶„ë¥˜ (ë©”ë‰´ìˆ™ë ¨ / ì›ê°€ì •í™•ë„ / ìœ„ìƒ / íƒœë„)", "ë©”ë‰´ìˆ™ë ¨") || "ë©”ë‰´ìˆ™ë ¨";
    subCat = prompt("ì¤‘ë¶„ë¥˜ (ë©”ë‰´ ì¹´í…Œê³ ë¦¬ ë“±, ì—†ìœ¼ë©´ ë¹„ì›Œë‘ê¸°)", "");
    itemName = prompt("í‰ê°€ í•­ëª© ì´ë¦„", "(ìƒˆ í•­ëª©)") || "(ìƒˆ í•­ëª©)";
  } else {
    itemName = prompt("í‰ê°€ í•­ëª© ì´ë¦„", "(ìƒˆ í•­ëª©)") || "(ìƒˆ í•­ëª©)";
  }
  if (!itemName) return;
  if (typeof load === "function") load(1);
  google.script.run.withSuccessHandler(function(res) {
    if (typeof load === "function") load(0);
    if (res === "SUCCESS") { alert("í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); loadEvaluationSettings(type); }
    else alert(res || "ì¶”ê°€ ì‹¤íŒ¨");
  }).withFailureHandler(function() { if (typeof load === "function") load(0); alert("í•­ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }).addEvaluationItem(type, mainCat, subCat, itemName);
}

function deleteEvalItem(type, id) {
  if (!confirm("ì´ í‰ê°€ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  if (typeof load === "function") load(1);
  google.script.run.withSuccessHandler(function(res) {
    if (typeof load === "function") load(0);
    if (res === "SUCCESS") { alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadEvaluationSettings(type); }
    else alert(res || "ì‚­ì œ ì‹¤íŒ¨");
  }).withFailureHandler(function() { if (typeof load === "function") load(0); alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }).deleteEvaluationItem(type, id);
}

var globalPayrollList = []; // ë°ì´í„°ë¥¼ ë‹´ì•„ë‘˜ ì „ì—­ ë³€ìˆ˜

/* ê¸‰ì—¬ ê³„ì‚° íƒ­: ë§¤ì¥ í•„í„° ì˜µì…˜ ë¡œë“œ (C.E.O/HRë§Œ Office ì˜µì…˜ ë…¸ì¶œ) */
function loadPayrollStoreOptions() {
    var sel = document.getElementById("payroll-store-filter");
    if (!sel) return;
    var role = (typeof userRole !== "undefined") ? userRole : "";
    google.script.run.withSuccessHandler(function(stores) {
        sel.innerHTML = "";
        var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : {};
        var allText = (lang.label_all || "ì „ì²´");
        sel.add(new Option(allText, "All"));
        if (stores && stores.length) stores.forEach(function(s) { sel.add(new Option(s, s)); });
    }).getPayrollStoreList(role);
}

/* 0. DB ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒìš©) */
function runDBSetup() {
    if(confirm("ê¸‰ì—¬ ë°ì´í„°ë¥¼ ì €ì¥í•  [ê¸‰ì—¬_DB] ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ìˆìœ¼ë©´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)")) {
        google.script.run.withSuccessHandler(alert).setupPayrollDB();
    }
}

/* 1. ê³„ì‚° ì‹¤í–‰ ë²„íŠ¼ (ë§¤ì¥ í•„í„° ì ìš©, C.E.O/HRë§Œ Office ì¡°íšŒ ê°€ëŠ¥) */
function calculateMonthlySalary() {
    var month = document.getElementById("payroll-month").value;
    if(!month) return alert("ë‚ ì§œ(ë…„-ì›”)ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    var storeEl = document.getElementById("payroll-store-filter");
    var storeFilter = (storeEl && storeEl.value) ? storeEl.value : "All";
    var role = (typeof userRole !== "undefined") ? userRole : "";
    
    load(1); // ë¡œë”© ì‹œì‘
    google.script.run.withSuccessHandler(res => {
        load(0); // ë¡œë”© ë
        if(!res.success) return alert(res.msg);
        
        globalPayrollList = res.list;
        renderPayrollTable();
        alert("âœ… ê³„ì‚° ì™„ë£Œ! ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì €ì¥í•˜ì„¸ìš”.");
    }).calculatePayrollPreview(month, storeFilter, role);
}

/* 2. í…Œì´ë¸” ê·¸ë¦¬ê¸° (ìˆ˜ì • ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜) */
function renderPayrollTable() {
    var tbody = document.getElementById("payroll-list-body");
    tbody.innerHTML = "";
    
    if(globalPayrollList.length === 0) {
        tbody.innerHTML = "<tr><td colspan='16' class='py-5 text-muted'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    globalPayrollList.forEach((p, idx) => {
        var holidayPay = Number(p.holidayPay) || 0;
        var income = p.salary + p.posAllow + p.hazAllow + p.birthBonus + holidayPay + p.splBonus + p.otAmt;
        var deduct = p.lateDed + p.sso + p.tax + p.otherDed;
        p.netPay = income - deduct;

        var rowClass = (idx % 2 === 0) ? "payroll-row-even" : "payroll-row-odd";
        var row = `<tr class="${rowClass}">
            <td class="payroll-td-num">${idx+1}</td>
            <td class="payroll-td-store fw-bold">${p.store}</td>
            <td class="payroll-td-name">${p.name}<br><small class="text-secondary">${p.role}</small></td>
            <td class="payroll-td-num text-end">${p.salary.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.posAllow.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.hazAllow.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${p.birthBonus.toLocaleString()}</td>
            <td class="payroll-td-num text-end small">${holidayPay.toLocaleString()}${p.holidayWorkDays ? ' <small class="text-secondary">(' + p.holidayWorkDays + 'ì¼)</small>' : ''}</td>
            <td class="payroll-td-num text-end small fw-bold">${p.splBonus.toLocaleString()}</td>
            <td class="payroll-td-num text-center small text-secondary">(1.5: ${p.ot15}h)</td>
            <td class="payroll-td-num text-end small fw-bold">${p.otAmt.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small">${p.lateDed.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small">${p.sso.toLocaleString()}</td>
            <td class="payroll-td-deduct text-end small fw-bold">${p.otherDed.toLocaleString()}</td>
            <td class="payroll-td-net text-end fw-bold">${p.netPay.toLocaleString()}</td>
            <td><button class="btn btn-sm btn-outline-primary" onclick="openEditPayroll(${idx})">âœï¸ ìˆ˜ì •</button></td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

/* 3. ìˆ˜ì • íŒì—… ì—´ê¸° */
function openEditPayroll(idx) {
    var p = globalPayrollList[idx]; // ì„ íƒí•œ ì§ì› ë°ì´í„°
    document.getElementById("py-index").value = idx;
    document.getElementById("py-name").innerText = p.name;
    document.getElementById("py-store").innerText = p.store;
    
    // ê¸°ì¡´ ê°’ ì±„ì›Œë„£ê¸°
    document.getElementById("py-bonus").value = p.splBonus; // ë³´ë„ˆìŠ¤
    document.getElementById("py-ot").value = p.otAmt;       // OT ê¸ˆì•¡
    document.getElementById("py-late").value = p.lateDed;   // ì§€ê° ê³µì œ
    document.getElementById("py-deduct").value = p.otherDed;// ê¸°íƒ€ ê³µì œ

    // ëª¨ë‹¬ ë„ìš°ê¸°
    new bootstrap.Modal(document.getElementById('modalPayrollEdit')).show();
}

/* 4. ìˆ˜ì • ì ìš© (íŒì—…ì—ì„œ ì €ì¥ ëˆ„ë¥¼ ë•Œ) */
function applyPayrollEdit() {
    var idx = document.getElementById("py-index").value;
    var p = globalPayrollList[idx];
    
    // ì…ë ¥ê°’ ì—…ë°ì´íŠ¸ (ìˆ«ìë¡œ ë³€í™˜)
    p.splBonus = Number(document.getElementById("py-bonus").value) || 0;
    p.otAmt = Number(document.getElementById("py-ot").value) || 0;
    p.lateDed = Number(document.getElementById("py-late").value) || 0;
    p.otherDed = Number(document.getElementById("py-deduct").value) || 0;
    
    // ëª¨ë‹¬ ë‹«ê¸°
    var modal = bootstrap.Modal.getInstance(document.getElementById('modalPayrollEdit'));
    modal.hide();
    
    // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë ¤ì„œ í•©ê³„ ê°±ì‹ 
    renderPayrollTable();
}

/* 5. ìµœì¢… DB ì €ì¥ */
function saveFinalPayroll() {
    var month = document.getElementById("payroll-month").value;
    if(!globalPayrollList.length) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    if(!confirm("âš ï¸ " + month + "ì›” ê¸‰ì—¬ë¥¼ í™•ì • ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ì— ì €ì¥ëœ ì´ ë‹¬ì˜ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)")) return;
    
    load(1);
    google.script.run.withSuccessHandler(res => {
        load(0);
        alert(res);
    }).savePayrollToDB(month, JSON.stringify(globalPayrollList));
}

/* 6. ë‚´ì—­ ì¡°íšŒ - loadPayrollHistory / renderHistoryTable ì‚¬ìš© */
/* payroll-history-ui: ì²´í¬ë°•ìŠ¤ ì„ íƒ í›„ ì¼ê´„ ì´ë©”ì¼ ë°œì†¡ (v2) */

/* =========================================
   [ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ] ê¸°ëŠ¥ ì¶”ê°€
   ========================================= */

// 1. í˜ì´ì§€ ì—´ë¦´ ë•Œ ë§¤ì¥ ëª©ë¡ ì±„ìš°ê¸° (ê¸°ì¡´ í•¨ìˆ˜ í™œìš©)
// (ì´ ì½”ë“œëŠ” calculateMonthlySalary í•¨ìˆ˜ ê·¼ì²˜ë‚˜ go í•¨ìˆ˜ ì•ˆì— ë„£ì–´ë„ ë˜ì§€ë§Œ, í¸ì˜ìƒ ì¡°íšŒ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì—†ìœ¼ë©´ ì±„ìš°ë„ë¡ í•¨)

/* 2. ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ (ì„œë²„: getPayrollFromDB ì‚¬ìš©) */
function loadPayrollHistory() {
    if (typeof google === "undefined" || !google.script || !google.script.run) {
        alert("ëª…ì„¸ì„œ ì¡°íšŒëŠ” Google Apps Script í™˜ê²½ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤.");
        return;
    }
    var monthEl = document.getElementById("py-history-month");
    var storeFilter = document.getElementById("py-history-store");
    var month = monthEl ? monthEl.value : "";

    if (storeFilter && storeFilter.options.length <= 1 && typeof loadStoreOptions === "function") {
       loadStoreOptions("py-history-store");
    }

    if (!month) { alert("ì¡°íšŒí•  ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

    load(1); // ë¡œë”© ì‹œì‘
    
    google.script.run
        .withSuccessHandler(function(res) {
            load(0); // ë¡œë”© ë
            var tbody = document.getElementById("py-history-list");
            if (!tbody) return;
            tbody.innerHTML = "";
            if (!res) {
                tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤. (clasp push í›„ ë°°í¬ ë²„ì „ì„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”)</td></tr>";
                return;
            }
            if (!res.success) {
                var msg = (res.msg && String(res.msg).trim()) ? res.msg : "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">" + msg + "</td></tr>";
                return;
            }
            window.historyData = res.list || [];
            window.historyMonth = month || "";
            renderHistoryTable();
        })
        .withFailureHandler(function(err) {
            load(0);
            var tbody = document.getElementById("py-history-list");
            var errMsg = (err && (err.message || err)) ? String(err.message || err) : "ì„œë²„ ì—°ê²° í™•ì¸";
            if (tbody) tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-danger\">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: " + errMsg + "</td></tr>";
            console.error("getPayrollFromDB error:", err);
        })
        .getPayrollFromDB(month);
}

/* 3. í…Œì´ë¸” ê·¸ë¦¬ê¸° (ë§¤ì¥ í•„í„° ì ìš©, getPayrollFromDB ì‘ë‹µ í˜•ì‹) */
function renderHistoryTable() {
    var storeEl = document.getElementById("py-history-store");
    var filterStore = storeEl ? storeEl.value : "All";
    var tbody = document.getElementById("py-history-list");
    var totalCount = 0;
    var totalMoney = 0;
    
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!window.historyData || window.historyData.length === 0) {
        tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-muted\">ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        if (document.getElementById("total-count")) document.getElementById("total-count").innerText = "0";
        if (document.getElementById("total-amount")) document.getElementById("total-amount").innerText = "0";
        return;
    }

    window.historyData.forEach(function(p) {
        if (filterStore !== "All" && p.store !== filterStore) return;
        totalCount++;
        var totalAllow = (Number(p.posAllow) || 0) + (Number(p.hazAllow) || 0) + (Number(p.birthBonus) || 0) + (Number(p.holidayPay) || 0) + (Number(p.splBonus) || 0);
        var totalDed = (Number(p.lateDed) || 0) + (Number(p.sso) || 0) + (Number(p.tax) || 0) + (Number(p.otherDed) || 0);
        var netPay = Number(p.netPay) || 0;
        totalMoney += netPay;
        var storeEsc = (p.store || "").replace(/"/g, "&quot;");
        var nameEsc = (p.name || "").replace(/"/g, "&quot;");
        var row = "<tr><td class=\"align-middle\"><input type=\"checkbox\" class=\"form-check-input py-history-check\" data-store=\"" + storeEsc + "\" data-name=\"" + nameEsc + "\" title=\"ë°œì†¡ ëŒ€ìƒ ì„ íƒ\"></td>" +
            "<td class=\"fw-bold\">" + (p.store || "") + "</td><td>" + (p.name || "") + "</td>" +
            "<td class=\"text-end text-muted\">" + (Number(p.salary) || 0).toLocaleString() + "</td>" +
            "<td class=\"text-end text-primary\">+" + totalAllow.toLocaleString() + "</td>" +
            "<td class=\"text-end text-info\">+" + (Number(p.otAmt) || 0).toLocaleString() + "</td>" +
            "<td class=\"text-end text-danger\">-" + totalDed.toLocaleString() + "</td>" +
            "<td class=\"text-end fw-bold bg-light\" style=\"color:#E65100;\">" + netPay.toLocaleString() + "</td>" +
            "<td><span class=\"badge bg-secondary\">" + (p.status || "ì§€ê¸‰ëŒ€ê¸°") + "</span></td></tr>";
        tbody.innerHTML += row;
    });

    if (totalCount === 0) {
        tbody.innerHTML = "<tr><td colspan=\"9\" class=\"py-4 text-muted\">ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
    }

    if (document.getElementById("total-count")) document.getElementById("total-count").innerText = totalCount;
    if (document.getElementById("total-amount")) document.getElementById("total-amount").innerText = totalMoney.toLocaleString();
}

/* ì „ì²´ ì„ íƒ/í•´ì œ */
function togglePayrollHistoryCheckAll(headerCheck) {
    var list = document.querySelectorAll(".py-history-check");
    var checked = headerCheck ? headerCheck.checked : false;
    for (var i = 0; i < list.length; i++) list[i].checked = checked;
    var headerEl = document.getElementById("py-history-check-all");
    if (headerEl && !headerCheck) headerEl.checked = false;
}

/* ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ì¼ê´„ ë°œì†¡ */
function sendPayrollEmailSelected() {
    var month = window.historyMonth || (document.getElementById("py-history-month") && document.getElementById("py-history-month").value) || "";
    if (!month) { alert("ì¡°íšŒì›”ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¡°íšŒí•˜ê¸°ë¥¼ ì‹¤í–‰í•´ ì£¼ì„¸ìš”."); return; }
    var checks = document.querySelectorAll(".py-history-check:checked");
    if (!checks || checks.length === 0) { alert("ë°œì†¡í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤. í–‰ì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    var list = [];
    for (var i = 0; i < checks.length; i++) {
        list.push({ store: checks[i].getAttribute("data-store") || "", name: checks[i].getAttribute("data-name") || "" });
    }
    var btn = document.getElementById("py-send-selected-btn");
    if (btn) { btn.disabled = true; btn.textContent = "ë°œì†¡ ì¤‘â€¦ (" + list.length + "ëª…)"; }
    google.script.run.withSuccessHandler(function(res) {
        if (btn) { btn.disabled = false; btn.textContent = "ğŸ“§ ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ë°œì†¡"; }
        if (res && res.sent !== undefined) {
            var msg = "ë°œì†¡ ì™„ë£Œ: " + (res.sent || 0) + "ëª…";
            if (res.failed && res.failed.length) msg += ", ì‹¤íŒ¨ " + res.failed.length + "ëª… (" + (res.errors ? res.errors.join("; ") : "") + ")";
            alert(msg);
            if (res.sent > 0) togglePayrollHistoryCheckAll(null);
        } else {
            alert("âŒ " + (res && res.msg ? res.msg : "ë°œì†¡ ì‹¤íŒ¨"));
        }
    }).withFailureHandler(function(err) {
        if (btn) { btn.disabled = false; btn.textContent = "ğŸ“§ ì„ íƒí•œ ëª…ì„¸ì„œ ì´ë©”ì¼ ë°œì†¡"; }
        alert("âŒ ë°œì†¡ ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).sendPayrollStatementEmailBatch(month, JSON.stringify(list));
}

/* 5. ë§¤ì¥ ì„ íƒ ë°”ê¿€ ë•Œë§ˆë‹¤ ë°”ë¡œë°”ë¡œ í‘œ ê°±ì‹  */
(function(){
    var el = document.getElementById("py-history-store");
    if (el) el.addEventListener("change", renderHistoryTable);
})();

/* [ì‹ ê·œ] ê¸‰ì—¬ ê´€ë¦¬ íƒ­ ì „í™˜ í•¨ìˆ˜ */
function showPayrollTab(t) {
    var tabCalc = document.getElementById("payroll-tab-calc");
    var tabHist = document.getElementById("payroll-tab-hist");
    var tabHoliday = document.getElementById("payroll-tab-holiday");
    if (tabCalc) tabCalc.style.display = "none";
    if (tabHist) tabHist.style.display = "none";
    if (tabHoliday) tabHoliday.style.display = "none";
    var targetTab = document.getElementById("payroll-tab-" + t);
    if (targetTab) targetTab.style.display = "block";

    document.getElementById("payroll-nav-calc").classList.remove("active");
    document.getElementById("payroll-nav-hist").classList.remove("active");
    var navHoliday = document.getElementById("payroll-nav-holiday");
    if (navHoliday) navHoliday.classList.remove("active");
    document.getElementById("payroll-nav-" + t).classList.add("active");

    if (t === "hist") {
        var storeFilter = document.getElementById("py-history-store");
        if (storeFilter && storeFilter.options.length <= 1) loadStoreOptions("py-history-store");
    }
    if (t === "holiday") {
        var yearEl = document.getElementById("holiday-year");
        if (yearEl && yearEl.options.length <= 1) fillHolidayYearOptions();
        loadPublicHolidays();
    }
}

function fillHolidayYearOptions() {
    var el = document.getElementById("holiday-year");
    if (!el) return;
    var y = new Date().getFullYear();
    el.innerHTML = "";
    for (var i = y - 1; i <= y + 3; i++) el.add(new Option(i + "ë…„", i));
    el.value = y;
}

function loadPublicHolidays() {
    var yearEl = document.getElementById("holiday-year");
    var tbody = document.getElementById("public-holiday-list");
    if (!yearEl || !tbody) return;
    var year = yearEl.value || new Date().getFullYear();
    tbody.innerHTML = "<tr><td colspan='4' class='py-3 text-muted'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";
    google.script.run.withSuccessHandler(function(res) {
        tbody.innerHTML = "";
        var list = (res && res.list) ? res.list : [];
        if (list.length === 0) {
            tbody.innerHTML = "<tr><td colspan='4' class='py-4 text-muted'>í•´ë‹¹ ì—°ë„ ê³µíœ´ì¼ì´ ì—†ìŠµë‹ˆë‹¤. [ì¶”ê°€]ë¡œ ë“±ë¡í•˜ê±°ë‚˜ ì‹œíŠ¸ ìƒì„± í›„ ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</td></tr>";
            return;
        }
        list.forEach(function(h, i) {
            var rowIndex = (h.rowIndex != null) ? h.rowIndex : "";
            var editBtn = rowIndex ? "<button type='button' class='btn btn-sm btn-outline-secondary me-1' onclick='openHolidayEditModal(" + rowIndex + ",\"" + (h.date || "") + "\",\"" + (String(h.name || "-").replace(/"/g, "&quot;")) + "\")'>ìˆ˜ì •</button>" : "";
            var delBtn = rowIndex ? "<button type='button' class='btn btn-sm btn-outline-danger' onclick='deleteHolidayRow(" + rowIndex + ")'>ì‚­ì œ</button>" : "";
            tbody.innerHTML += "<tr><td>" + (i + 1) + "</td><td>" + (h.date || "") + "</td><td>" + (h.name || "-") + "</td><td>" + editBtn + delBtn + "</td></tr>";
        });
    }).withFailureHandler(function() {
        tbody.innerHTML = "<tr><td colspan='4' class='py-4 text-danger'>ì¡°íšŒ ì‹¤íŒ¨</td></tr>";
    }).getPublicHolidaysWithRows(parseInt(year, 10));
}

function openHolidayAddModal() {
    var yearEl = document.getElementById("holiday-year");
    document.getElementById("holiday-form-modal-title").textContent = "ê³µíœ´ì¼ ì¶”ê°€";
    document.getElementById("holiday-form-rowIndex").value = "";
    document.getElementById("holiday-form-year").value = yearEl ? yearEl.value : new Date().getFullYear();
    document.getElementById("holiday-form-date").value = "";
    document.getElementById("holiday-form-name").value = "";
    var modal = new bootstrap.Modal(document.getElementById("holiday-form-modal"));
    modal.show();
}

function openHolidayEditModal(rowIndex, dateStr, name) {
    var yearEl = document.getElementById("holiday-year");
    document.getElementById("holiday-form-modal-title").textContent = "ê³µíœ´ì¼ ìˆ˜ì •";
    document.getElementById("holiday-form-rowIndex").value = rowIndex;
    document.getElementById("holiday-form-year").value = yearEl ? yearEl.value : new Date().getFullYear();
    document.getElementById("holiday-form-date").value = (dateStr || "").substring(0, 10);
    document.getElementById("holiday-form-name").value = name || "";
    var modal = new bootstrap.Modal(document.getElementById("holiday-form-modal"));
    modal.show();
}

function saveHolidayForm() {
    var rowIndex = document.getElementById("holiday-form-rowIndex").value.trim();
    var year = document.getElementById("holiday-form-year").value;
    var dateStr = document.getElementById("holiday-form-date").value;
    var name = document.getElementById("holiday-form-name").value.trim() || "-";
    if (!year || !dateStr) { alert("ì—°ë„ì™€ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    var done = function(msg) { alert(msg); bootstrap.Modal.getInstance(document.getElementById("holiday-form-modal")).hide(); loadPublicHolidays(); };
    var fail = function(err) { alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err)); };
    if (rowIndex) {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).updatePublicHoliday(parseInt(rowIndex, 10), parseInt(year, 10), dateStr, name);
    } else {
        google.script.run.withSuccessHandler(done).withFailureHandler(fail).addPublicHoliday(parseInt(year, 10), dateStr, name);
    }
}

function deleteHolidayRow(rowIndex) {
    if (!confirm("ì´ ê³µíœ´ì¼ í–‰ì„ ì‚­ì œí• ê¹Œìš”?")) return;
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        loadPublicHolidays();
    }).withFailureHandler(function(err) {
        alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).deletePublicHoliday(parseInt(rowIndex, 10));
}

function setupPublicHolidaysSheet() {
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        loadPublicHolidays();
    }).withFailureHandler(function(err) {
        alert("ì‹¤íŒ¨: " + (err && err.message ? err.message : err));
    }).setupPublicHolidaysSheet();
}

/* =========================================
   [NEW] ê¸‰ì—¬ ê´€ë¦¬ í†µí•© ìŠ¤í¬ë¦½íŠ¸ (DB ë²„ì „)
   ========================================= */


/* [ìµœì¢… í†µí•©] ê·¼íƒœ ê´€ë¦¬ íƒ­ ì „í™˜ í•¨ìˆ˜ */
function showAttendanceTab(tabName) {
    // 1. ëª¨ë“  íƒ­ ì»¨í…ì¸ ë¥¼ ìˆ¨ê¹€ (ì¡°íšŒ íƒ­ í¬í•¨)
    const tabs = ['status', 'schedule', 'view-edit'];
    tabs.forEach(t => {
        const el = document.getElementById('attendance-tab-' + t);
        if (el) el.style.display = 'none';
    });

    // 2. ì„ íƒí•œ íƒ­ë§Œ ë³´ì´ê¸°
    const targetTab = document.getElementById('attendance-tab-' + tabName);
    if (targetTab) targetTab.style.display = 'block';

    // 3. íƒ­ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬ (ID ê¸°ë°˜ìœ¼ë¡œ ì •í™•íˆ íƒ€ê²ŸíŒ…)
    const navLinks = document.querySelectorAll('#attendanceTab .nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
        // í´ë¦­ëœ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ë‚˜ ì¸ìë¥¼ ë¹„êµí•˜ì—¬ active í´ë˜ìŠ¤ ë¶€ì—¬
        if (link.getAttribute('onclick').includes(tabName)) {
            link.classList.add('active');
        }
    });

    // 4. [íŠ¹ìˆ˜ ë¡œì§] ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸ íƒ­ ì§„ì… ì‹œ ë§¤ì¥ ë¦¬ìŠ¤íŠ¸ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ, ì§ì› ì„ íƒì°½ ì´ˆê¸°í™”
    if (tabName === 'status') {
        const attStore = document.getElementById('att-store-filter');
        if (attStore && attStore.options.length <= 1 && typeof loadStoreOptions === 'function') {
            attStore.classList.remove('loaded');
            loadStoreOptions('att-store-filter');
        }
        var attEmp = document.getElementById('att-employee-filter');
        if (attEmp) {
            attEmp.innerHTML = '<option value="">ë§¤ì¥ì„ ë¨¼ì € ì„ íƒ</option>';
            attEmp.disabled = true;
        }
    }

    // 5. [íŠ¹ìˆ˜ ë¡œì§] ìŠ¤ì¼€ì¤„ ì‘ì„± íƒ­ ì§„ì… ì‹œ
    if (tabName === 'schedule') {
        if (typeof loadScheduleManager === 'function') loadScheduleManager();
    }

    // 6. [íŠ¹ìˆ˜ ë¡œì§] ìŠ¤ì¼€ì¤„ ì¡°íšŒ/ìˆ˜ì • íƒ­ ì§„ì… ì‹œ ë‚ ì§œ(í•´ë‹¹ ì£¼ ì›”ìš”ì¼) ì„¸íŒ… ë° ë§¤ì¥ ë¡œë“œ
    if (tabName === 'view-edit') {
        const dateInput = document.getElementById('view-week-monday');
        if (dateInput && !dateInput.value) {
            var today = new Date().toISOString().substring(0, 10);
            dateInput.value = (typeof getMondayOfWeek === 'function') ? getMondayOfWeek(today) : today;
        }
        // ë§¤ì¥ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¡œë“œ
        const viewSelect = document.getElementById('view-store-select');
        if (viewSelect && viewSelect.options.length <= 1) {
            loadStoreOptions('view-store-select');
        }
    }
}

/** [ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸] ë§¤ì¥ ì„ íƒ ì‹œ í•´ë‹¹ ë§¤ì¥ ì§ì› ëª©ë¡ì„ ì§ì› ê²€ìƒ‰ì°½ì— ë¡œë“œ */
function loadAttEmployeeOptions() {
    var storeEl = document.getElementById('att-store-filter');
    var empEl = document.getElementById('att-employee-filter');
    if (!storeEl || !empEl) return;
    var store = (storeEl.value || '').trim();
    var storeText = storeEl.options[storeEl.selectedIndex] ? (storeEl.options[storeEl.selectedIndex].text || '').trim() : '';
    empEl.disabled = true;
    empEl.innerHTML = '<option value="">ë§¤ì¥ì„ ë¨¼ì € ì„ íƒ</option>';
    if (!store || store === 'All' || storeText === 'ì „ì²´ ë§¤ì¥') return;
    google.script.run
        .withSuccessHandler(function(list) {
            var optHtml = '<option value="">ì „ì²´ ì§ì›</option>';
            if (list && list.length > 0) {
                list.forEach(function(emp) {
                    var nm = (emp.name || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    var display = (emp.name || '') + (emp.nick ? ' (' + (emp.nick || '') + ')' : '');
                    display = display.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    optHtml += '<option value="' + nm + '">' + display + '</option>';
                });
            } else {
                optHtml += '<option value="" disabled>í•´ë‹¹ ë§¤ì¥ì— ë“±ë¡ëœ ì§ì› ì—†ìŒ</option>';
            }
            empEl.innerHTML = optHtml;
            empEl.disabled = false;
        })
        .withFailureHandler(function() {
            empEl.innerHTML = '<option value="">ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</option>';
            empEl.disabled = false;
        })
        .getStoreStaffOnly(store);
}

/** [ê·¼íƒœ ê¸°ë¡/ìŠ¹ì¸] ì¡°íšŒ - íŒŒë¼ë¯¸í„°ë¥¼ ê°ì²´ë¡œ ì „ë‹¬, 'ì „ì²´ ë§¤ì¥'Â·ì˜¤í”¼ìŠ¤ í•„í„° ì„œë²„ ì¸ì‹ ë³´ê°• */
function loadAttendanceRecords() {
    var startEl = document.getElementById('att-start');
    var endEl = document.getElementById('att-end');
    var storeEl = document.getElementById('att-store-filter');
    var empEl = document.getElementById('att-employee-filter');
    var tbody = document.getElementById('att-list-body');
    if (!startEl || !endEl || !storeEl || !tbody) return;

    var startStr = (startEl.value || '').trim();
    var endStr = (endEl.value || '').trim();
    if (!startStr || !endStr) {
        alert('ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
    }

    var storeVal = (storeEl.value || '').trim();
    var storeText = storeEl.options[storeEl.selectedIndex] ? (storeEl.options[storeEl.selectedIndex].text || '').trim() : '';
    if (storeText.indexOf('ì „ì²´') >= 0 || storeVal === 'All' || storeVal === '' || storeVal.toLowerCase() === 'all' || storeVal === 'ì „ì²´ ë§¤ì¥' || storeVal === 'ì „ì²´') {
        storeVal = 'All';
    }
    var employeeVal = (empEl && empEl.value) ? (empEl.value || '').trim() : '';
    var params = { startDate: startStr, endDate: endStr, storeFilter: storeVal, employeeFilter: employeeVal || '' };

    if (typeof load === 'function') load(1);
    google.script.run
        .withSuccessHandler(function(list) {
            if (typeof load === 'function') load(0);
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="py-5 text-muted">ì¡°íšŒëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            list.forEach(function(r) {
                var lateText = (r.late && r.late !== 0) ? r.late + 'ë¶„' : '-';
                var otText = (r.ot && r.ot !== 0) ? r.ot + 'ë¶„' : '-';
                tbody.innerHTML += '<tr><td>' + (r.timestamp || '') + '</td><td><b>' + (r.name || '') + '</b><br><small>' + (r.store || '') + '</small></td><td>' + (r.type || '') + '</td><td>' + lateText + ' / ' + otText + '</td><td>' + (r.reason || '-') + '</td><td>' + (r.status || '-') + '</td></tr>';
            });
        })
        .withFailureHandler(function(err) {
            if (typeof load === 'function') load(0);
            tbody.innerHTML = '<tr><td colspan="6" class="py-5 text-danger">ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        })
        .getAttendanceList(params);
}

/** ê·¼íƒœ ìŠ¹ì¸/ë°˜ë ¤ ë²„íŠ¼ ì²˜ë¦¬ */
function processAttApproval(row, decision) {
    google.script.run.withSuccessHandler(function(msg) {
        alert(msg);
        if (typeof loadAttendanceRecords === 'function') loadAttendanceRecords();
    }).processAttendanceApproval(row, decision);
}

/* ì‹œê°„í‘œ ê´€ë¦¬ ë°ì´í„° ë¡œë“œ (sch-date-filter/sch-store-filter UIê°€ ìˆì„ ë•Œë§Œ ë™ì‘) */
function loadScheduleManager() {
    const dateEl = document.getElementById('sch-date-filter');
    const storeEl = document.getElementById('sch-store-filter');
    const tbody = document.getElementById('sch-list-body');
    if (!dateEl || !storeEl || !tbody) return;
    const date = dateEl.value;
    const store = storeEl.value;
    if (!date) return;

    load(1);
    google.script.run
        .withSuccessHandler(function(list) {
            load(0);
            tbody.innerHTML = "";
            if (!list || !list.length) {
                tbody.innerHTML = "<tr><td colspan=\"6\" class=\"text-muted py-3\">í•´ë‹¹ ë‚ ì§œ/ë§¤ì¥ì— ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                return;
            }
            list.forEach(s => {
                tbody.innerHTML += `
                <tr>
                    <td><b>${s.name}</b><br><small>${s.store}</small></td>
                    <td><input type="time" id="pIn-${s.row}" class="form-control form-control-sm" value="${s.pIn || ""}"></td>
                    <td><input type="time" id="pOut-${s.row}" class="form-control form-control-sm" value="${s.pOut || ""}"></td>
                    <td><input type="time" id="pBS-${s.row}" class="form-control form-control-sm" value="${s.pBS || ""}"></td>
                    <td><input type="time" id="pBE-${s.row}" class="form-control form-control-sm" value="${s.pBE || ""}"></td>
                    <td><button class="btn btn-sm btn-success" onclick="saveScheduleRow(${s.row})">ğŸ’¾</button></td>
                </tr>`;
            });
        })
        .withFailureHandler(function(err) {
            load(0);
            tbody.innerHTML = "<tr><td colspan=\"6\" class=\"text-danger py-3\">ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì—°ê²° í™•ì¸)</td></tr>";
            console.error("getScheduleForAdmin error:", err);
        })
        .getScheduleForAdmin(date, store);
}

/* ì‹œê°„í‘œ ê°œë³„ ìˆ˜ì • ì €ì¥ */
function saveScheduleRow(row) {
    const data = {
        row: row,
        pIn: document.getElementById('pIn-'+row).value,
        pOut: document.getElementById('pOut-'+row).value,
        pBS: document.getElementById('pBS-'+row).value,
        pBE: document.getElementById('pBE-'+row).value
    };
    load(1);
    google.script.run.withSuccessHandler(res => {
        load(0);
        alert("ì‹œê°„í‘œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }).updateScheduleRow(data);
}

let currentStaff = "";
let isDrawing = false;

/* [ìˆ˜ì •] 7ì¼ ê³ ì • ê·¸ë¦¬ë“œ ìƒì„± í•¨ìˆ˜ (10ì¼ ì”ìƒ ë°©ì§€: ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸° + ë£¨í”„ 7íšŒ ê³ ì •) */
function initWeeklyGrid(type = 'sch') {
    const monday = document.getElementById(type + '-week-monday').value;
    const startHour = parseInt(document.getElementById('sch-start-hour').value) || 9;
    const endHour = parseInt(document.getElementById('sch-end-hour').value) || 3;

    if(!monday) return;

    // 1. ê¸°ì¡´ ë‚´ìš© ì‹¹ ë¹„ìš°ê¸° (10ì¼ì´ ë‚˜ì˜¤ëŠ” ì£¼ë²” ë°©ì§€)
    const headerRow = document.getElementById(type + '-header-row');
    const areaRow = document.getElementById(type + '-header-areas');
    const tbody = document.getElementById(type + '-body-slots');

    if (!headerRow || !areaRow || !tbody) return;

    headerRow.innerHTML = "<th>Time</th>";
    areaRow.innerHTML = "<th></th>";
    tbody.innerHTML = "";

    // 2. í—¤ë” ìƒì„± (ë”± 7ë²ˆë§Œ ë°˜ë³µ!)
    for(let i=0; i<7; i++) {
        let d = new Date(monday);
        d.setDate(d.getDate() + i);
        let dateStr = (d.getMonth() + 1) + "/" + d.getDate();

        headerRow.innerHTML += `<th colspan="2" class="bg-dark text-white sch-date-header text-center">${dateStr}</th>`;

        areaRow.innerHTML += `
            <th class="small py-1 text-center" style="background:#FFE0B2; color:#E65100; min-width:60px;">S <span id="${type}-count-${i}-Service" class="area-count">0</span></th>
            <th class="small py-1 text-center" style="background:#C8E6C9; color:#2E7D32; min-width:60px;">K <span id="${type}-count-${i}-Kitchen" class="area-count">0</span></th>`;
    }

    // 3. ë°”ë””(ì‹œê°„ ìŠ¬ë¡¯) ìƒì„±
    let currentH = startHour;
    let isFinished = false;
    var isViewOnly = (type === 'view');
    var slotClick = isViewOnly ? '' : ' onclick="toggleMultiSlot(this)"';

    while (!isFinished) {
        let row = `<tr><td class="time-label text-center fw-bold">${currentH.toString().padStart(2,'0')}:00</td>`;

        for(let day=0; day<7; day++) {
            ['Service', 'Kitchen'].forEach(area => {
                row += `<td class="hour-cell p-0">
                            <div class="slot-container">
                                <div class="half-slot"${slotClick} data-day="${day}" data-area="${area}" data-time="${currentH.toString().padStart(2,'0')}:00"></div>
                                <div class="half-slot"${slotClick} data-day="${day}" data-area="${area}" data-time="${currentH.toString().padStart(2,'0')}:30"></div>
                            </div>
                        </td>`;
            });
        }
        tbody.innerHTML += row + "</tr>";

        if (currentH === endHour) isFinished = true;
        currentH = (currentH + 1) % 24;
    }

    if (typeof updateDailyCounts === 'function') updateDailyCounts(type);
}


/* êµ¬ì—­ë³„(Service/Kitchen) ë‹¹ì¼ ì´ ê·¼ë¬´ ì¸ì›ìˆ˜ë¥¼ ê³„ì‚°í•´ í—¤ë”ì— í‘œì‹œ */
function updateDailyCounts(type = 'sch') {
    for(let day=0; day<7; day++) {
        ['Service', 'Kitchen'].forEach(area => {
            // í•´ë‹¹ íƒ­(type)ì˜ ìŠ¬ë¡¯ë§Œ ì„ íƒ
            const slots = document.querySelectorAll(`#${type}-body-slots .half-slot[data-day="${day}"][data-area="${area}"].active-fill`);
            
            let uniqueStaff = new Set();
            slots.forEach(slot => {
                let namesStr = slot.getAttribute('data-names');
                if(namesStr) {
                    namesStr.split(',').forEach(n => uniqueStaff.add(n.replace("BRK_", "")));
                }
            });

            // ê²°ê³¼ê°’ ë°˜ì˜ (ID: sch-count-0-Service ë˜ëŠ” view-count-0-Service)
            const countEl = document.getElementById(`${type}-count-${day}-${area}`);
            if(countEl) countEl.innerText = uniqueStaff.size;
        });
    }
}


// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒì§€ ë¨¼ì € ì±„ìš°ê¸° ì‹¤í–‰
fillHourSelectors();

/* [ì¶”ê°€] ì´ˆê¸° ë¡œë“œ ì‹œ ì‹œê°„ ë²”ìœ„ ì„ íƒì§€ ì±„ìš°ê¸° (00ì‹œ ~ 24ì‹œ) */
function fillHourSelectors() {
    const s = document.getElementById('sch-start-hour');
    const e = document.getElementById('sch-end-hour');
    if(!s || s.options.length > 0) return;

    for(let i=0; i<24; i++) {
        let h = i.toString().padStart(2, '0') + ":00";
        s.add(new Option(h, i));
        e.add(new Option(h, i));
    }
    s.value = 9;  // ê¸°ë³¸ ì‹œì‘: 09:00 (ì²« í–‰ì— 09:00, 09:30 í‘œì‹œ)
    e.value = 18; // ê¸°ë³¸ ì¢…ë£Œ: 18:00
}

/* ì¹¸ í´ë¦­ ì‹œ ì‘ë™í•˜ëŠ” í† ê¸€ í•¨ìˆ˜ */
function toggleSlot(el) {
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

    // ì´ë¯¸ í•´ë‹¹ ì§ì›ì´ ì±„ì›Œì ¸ ìˆë‹¤ë©´ ë¹„ìš°ê¸° (ì‚­ì œ)
    if(el.getAttribute('data-name') === selectedName) {
        el.classList.remove('active-fill');
        el.innerHTML = "";
        el.removeAttribute('data-name');
        el.removeAttribute('data-nick');
    } 
    // ë¹„ì–´ìˆê±°ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ìˆë‹¤ë©´ í˜„ì¬ ì„ íƒëœ ì§ì›ìœ¼ë¡œ ì±„ìš°ê¸°
    else {
        el.classList.add('active-fill');
        el.innerHTML = selectedNick; // í™”ë©´ì—ëŠ” ë‹‰ë„¤ì„ í‘œì‹œ
        el.setAttribute('data-name', selectedName); // ì €ì¥ìš© ì‹¤ëª… ì†ì„±
        el.setAttribute('data-nick', selectedNick);
        
        // êµ¬ì—­(Hall/Kitchen)ì— ë”°ë¼ ìƒ‰ìƒì„ ì•½ê°„ ë‹¤ë¥´ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ ì œì–´ ê°€ëŠ¥
        if(el.getAttribute('data-area') === "Hall") {
            el.style.backgroundColor = "#E65100"; // í™€: ì£¼í™©ìƒ‰ê³„ì—´
        } else {
            el.style.backgroundColor = "#2E7D32"; // ì£¼ë°©: ì´ˆë¡ìƒ‰ê³„ì—´
        }
        el.style.color = "white";
    }
}

// 2. ë“œë˜ê·¸ ìƒ‰ì¹  ë¡œì§
function startDraw(el) { if(!currentStaff) return alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!"); isDrawing = true; fillSlot(el); }
function moveDraw(el) { if(isDrawing) fillSlot(el); }
function fillSlot(el) {
    if(el.classList.contains('active-fill') && el.getAttribute('data-staff') === currentStaff) {
        el.classList.remove('active-fill'); el.innerText = ""; el.removeAttribute('data-staff');
    } else {
        el.classList.add('active-fill'); el.innerText = currentStaff.split(' ')[0];
        el.setAttribute('data-staff', currentStaff);
    }
}

/* [ìµœì¢…] ë°ì´í„° ë¶„ì„ í›„ ì„œë²„(ì‹œíŠ¸) ì €ì¥ í•¨ìˆ˜ */
function prepareAndSave() {
    const store = document.getElementById('sch-store-select').value;
    const monday = document.getElementById('sch-week-monday').value;
    const slots = document.querySelectorAll('.half-slot.active-fill');
    
    if(!monday) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    if(!store || store === "All") return alert("ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");

    // ë°ì´í„° êµ¬ì¡°: { "ë‚ ì§œ_ì´ë¦„_êµ¬ì—­": { work: [ì‹œê°„ë“¤], break: [ì‹œê°„ë“¤] } }
    let map = {}; 

    slots.forEach(s => {
        let namesStr = s.getAttribute('data-names');
        if(!namesStr) return;
        
        let names = namesStr.split(',');
        let day = parseInt(s.getAttribute('data-day'));
        let time = s.getAttribute('data-time');
        let area = s.getAttribute('data-area');
        
        let d = new Date(monday);
        d.setDate(d.getDate() + day);
        let datePart = d.toISOString().split('T')[0];

        names.forEach(n => {
            let name = n.trim();
            if(!name) return;

            // íœ´ê²Œ ì—¬ë¶€ í™•ì¸ ë° ì‹¤ì œ ì´ë¦„ ì¶”ì¶œ
            const isBrk = name.startsWith("BRK_");
            const realName = isBrk ? name.replace("BRK_", "") : name;
            
            let key = datePart + "_" + realName + "_" + area;
            if(!map[key]) map[key] = { work: [], break: [] };
            
            // íœ´ê²Œì™€ ê·¼ë¬´ ì‹œê°„ì„ ê°ê° ë¶„ë¥˜í•´ì„œ ìˆ˜ì§‘
            if(isBrk) map[key].break.push(time);
            else map[key].work.push(time);
        });
    });

    let finalData = [];
    for(let k in map) {
        let parts = k.split('_');
        let date = parts[0];
        let area = parts[parts.length - 1];
        let name = parts.length > 2 ? parts.slice(1, -1).join('_') : (parts[1] || '');
        
        // í•´ë‹¹ ì§ì›ì˜ ëª¨ë“  ì‹œê°„(ê·¼ë¬´+íœ´ê²Œ)ì„ í•©ì³ì„œ ì¶œí‡´ê·¼ ë²”ìœ„ ê³„ì‚°
        let allTimes = [...map[k].work, ...map[k].break].sort();
        if(allTimes.length === 0) continue;

        // 1. ì „ì²´ ì¶œê·¼/í‡´ê·¼ ì‹œê°„ ê³„ì‚°
        let pIn = allTimes[0];
        let last = allTimes[allTimes.length - 1];
        let [hh, mm] = last.split(':').map(Number);
        mm += 30; if(mm === 60) { hh++; mm = 0; }
        let pOut = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;

        // 2. íœ´ê²Œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ê³„ì‚° (ê²€ì •ìƒ‰ ì¹´ë“œ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
        let pBS = "", pBE = "";
        if(map[k].break.length > 0) {
            let brkTimes = map[k].break.sort();
            pBS = brkTimes[0];
            let bLast = brkTimes[brkTimes.length - 1];
            let [bhh, bmm] = bLast.split(':').map(Number);
            bmm += 30; if(bmm === 60) { bhh++; bmm = 0; }
            pBE = `${bhh.toString().padStart(2, '0')}:${bmm.toString().padStart(2, '0')}`;
        }

        finalData.push({
            date: date,
            name: name,
            pIn: pIn,
            pOut: pOut,
            pBS: pBS, // íœ´ê²Œ ì‹œì‘ ì‹œê°„
            pBE: pBE, // íœ´ê²Œ ì¢…ë£Œ ì‹œê°„
            remark: "[" + area + "]"
        });
    }

    if(finalData.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    load(1);
    google.script.run
        .withSuccessHandler(res => {
            load(0);
            alert(res);
        })
        .withFailureHandler(function(err) {
            load(0);
            alert("ì£¼ê°„ ìŠ¤ì¼€ì¤„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .saveWeeklySmartSchedule(store, monday, finalData);
}

let selectedName = ""; // ì‹œíŠ¸ ì €ì¥ìš© (ì‹¤ëª…)
let selectedNick = ""; // í™”ë©´ í‘œì‹œìš© (ë‹‰ë„¤ì„)

/* ì§ì› ëª©ë¡ ë¡œë“œ ë° ì„ íƒ í•¨ìˆ˜ */
function loadStaffAndGrid() {
    const store = document.getElementById('sch-store-select').value;
    if(!store || store === "All") return;
    
    google.script.run.withSuccessHandler(function(list) {
        const pool = document.getElementById('sch-staff-list');
        pool.innerHTML = "";
        
        list.forEach(emp => {
            const btn = document.createElement("button");
            btn.className = "list-group-item list-group-item-action staff-item";
            btn.innerHTML = `
                <div><b>${emp.name}</b> (${emp.nick})</div>
                <div class="staff-dept small text-muted">[${emp.dept}]</div>
            `;
            btn.onclick = function() {
                // ì„ íƒ í•˜ì´ë¼ì´íŠ¸
                document.querySelectorAll('.staff-item').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // ì„ íƒëœ ì§ì›ì˜ ì´ë¦„ê³¼ ë‹‰ë„¤ì„ ì €ì¥
                selectedName = emp.name;
                selectedNick = emp.nick;
            };
            pool.appendChild(btn);
        });
        initWeeklyGrid(); 
    }).getStoreStaffOnly(store);
}

function toggleMultiSlot(el) {
    if (el.closest('.view-schedule-readonly')) return;
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

    // 1. ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let assignedNames = el.getAttribute('data-names') ? el.getAttribute('data-names').split(',') : [];
    let assignedNicks = el.getAttribute('data-nicks') ? el.getAttribute('data-nicks').split(',') : [];

    const nameIdx = assignedNames.indexOf(selectedName);

    // 2. ì¶”ê°€ ë˜ëŠ” ì œê±° ê²°ì •
    if(nameIdx > -1) {
        // ì´ë¯¸ ëª…ë‹¨ì— ìˆìœ¼ë©´ ì œê±° (í† ê¸€)
        assignedNames.splice(nameIdx, 1);
        assignedNicks.splice(nameIdx, 1);
    } else {
        // ëª…ë‹¨ì— ì—†ìœ¼ë©´ ì¶”ê°€
        assignedNames.push(selectedName);
        assignedNicks.push(selectedNick);
    }

    // 3. ì—˜ë¦¬ë¨¼íŠ¸ì— ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
    el.setAttribute('data-names', assignedNames.join(','));
    el.setAttribute('data-nicks', assignedNicks.join(','));

    // 4. í™”ë©´ ê·¸ë¦¬ê¸° (ë‹‰ë„¤ì„ ì¹© ìƒì„±)
    el.innerHTML = "";
    const area = el.getAttribute('data-area'); // 'Service' ë˜ëŠ” 'Kitchen'
    
    assignedNicks.forEach(nick => {
        // êµ¬ì—­ë³„ ì¹© ìƒ‰ìƒ ì„¤ì • (Service: ì£¼í™©, Kitchen: ì´ˆë¡)
        const chipColor = (area === 'Service') ? '#E65100' : '#2E7D32';
        el.innerHTML += `<span class="nick-chip" style="background:${chipColor}; color:white; padding:1px 4px; margin:1px; border-radius:3px; font-size:9px; display:inline-block;">${nick}</span>`;
    });

    // 5. ì¹¸ì˜ ë°°ê²½ìƒ‰ ê°•ì¡° ì²˜ë¦¬
    if(assignedNames.length > 0) {
        el.classList.add('active-fill');
        // ì¹¸ ë°°ê²½ìƒ‰ë„ ì‚´ì§ ì…í˜€ì„œ êµ¬ë¶„ì„ ë„ì™€ì¤ë‹ˆë‹¤.
        el.style.backgroundColor = (area === 'Service') ? '#FFF3E0' : '#E8F5E9';
    } else {
        el.classList.remove('active-fill');
        el.style.backgroundColor = "";
    }
}

/* í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„ ì„ íƒì§€(08:00~23:30)ë¥¼ ì±„ì›Œì¤ë‹ˆë‹¤ */
function fillTimeOptions() {
    const startSelect = document.getElementById('quick-start');
    const breakSelect = document.getElementById('quick-break-start');
    for(let h=8; h<24; h++) {
        ["00", "30"].forEach(m => {
            let t = `${h.toString().padStart(2,'0')}:${m}`;
            startSelect.add(new Option(t, t));
            breakSelect.add(new Option(t, t));
        });
    }
    if (startSelect) startSelect.value = "09:30";
    if (breakSelect) breakSelect.value = "13:30";
}

function applyQuickSchedule(area) {
    if(!selectedName) return alert("ì™¼ìª½ì—ì„œ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
    
    const startTimeStr = document.getElementById('quick-start').value;
    const workHours = parseFloat(document.getElementById('quick-work-hours').value) || 0;
    const breakStartTimeStr = document.getElementById('quick-break-start').value;
    const breakHours = parseFloat(document.getElementById('quick-break-hours').value) || 0;
    const targetDay = document.getElementById('quick-day').value;
    const gridStartHour = parseInt(document.getElementById('sch-start-hour').value);

    if(isNaN(workHours)) return alert("ê·¼ë¬´ ì‹œê°„ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");

    // --- [1ë‹¨ê³„] í•´ë‹¹ ì§ì›ì˜ ê¸°ì¡´ ê¸°ë¡ ì´ˆê¸°í™” (ë®ì–´ì“°ê¸° ì¤€ë¹„) ---
    const allSlots = document.querySelectorAll(`.half-slot[data-day="${targetDay}"][data-area="${area}"]`);
    
    allSlots.forEach(slot => {
        let names = slot.getAttribute('data-names') ? slot.getAttribute('data-names').split(',') : [];
        let nicks = slot.getAttribute('data-nicks') ? slot.getAttribute('data-nicks').split(',') : [];
        
        // ì¼ë°˜ ê·¼ë¬´(selectedName)ì™€ íœ´ê²Œ(BRK_selectedName) ê¸°ë¡ì„ ëª¨ë‘ ì°¾ì•„ ì œê±°
        const brkName = "BRK_" + selectedName;
        
        for (let i = names.length - 1; i >= 0; i--) {
            if (names[i] === selectedName || names[i] === brkName) {
                names.splice(i, 1);
                nicks.splice(i, 1);
            }
        }
        
        slot.setAttribute('data-names', names.join(','));
        slot.setAttribute('data-nicks', nicks.join(','));
        refreshSlotUI(slot); // UIë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
    });

    // --- [2ë‹¨ê³„] ì‹œê°„ ê³„ì‚° ë¡œì§ ---
    let [sH, sM] = startTimeStr.split(':').map(Number);
    let startMin = sH * 60 + sM;
    if (sH < gridStartHour) startMin += 1440; // ìì • ì´ì›” ì²˜ë¦¬
    let endMin = startMin + (workHours + breakHours) * 60;

    let [bSH, bSM] = breakStartTimeStr.split(':').map(Number);
    let bStartMin = bSH * 60 + bSM;
    if (bSH < gridStartHour) bStartMin += 1440;
    let bEndMin = bStartMin + (breakHours * 60);

    // --- [3ë‹¨ê³„] ì‹ ê·œ ìŠ¤ì¼€ì¤„ ì ìš© ---
    allSlots.forEach(slot => {
        let [currH, currM] = slot.getAttribute('data-time').split(':').map(Number);
        let currMin = currH * 60 + currM;
        if (currH < gridStartHour) currMin += 1440;

        if (currMin >= startMin && currMin < endMin) {
            let names = slot.getAttribute('data-names') ? slot.getAttribute('data-names').split(',') : [];
            let nicks = slot.getAttribute('data-nicks') ? slot.getAttribute('data-nicks').split(',') : [];
            
            if (currMin >= bStartMin && currMin < bEndMin) {
                // íœ´ê²Œ ì‹œê°„: ê²€ì •ìƒ‰ ë‹‰ë„¤ì„ ì¹´ë“œ
                names.push("BRK_" + selectedName);
                nicks.push(selectedNick);
            } else {
                // ê·¼ë¬´ ì‹œê°„: ì¼ë°˜ ìƒ‰ìƒ ë‹‰ë„¤ì„ ì¹´ë“œ
                names.push(selectedName);
                nicks.push(selectedNick);
            }
            
            slot.setAttribute('data-names', names.join(','));
            slot.setAttribute('data-nicks', nicks.join(','));
            refreshSlotUI(slot);
        }
    });
    if (typeof updateDailyCounts === 'function') updateDailyCounts();
}

/* [ë³´ì¡°] ìŠ¬ë¡¯ì˜ UIë¥¼ ë°ì´í„°ì— ë§ê²Œ ë‹¤ì‹œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜ */
function refreshSlotUI(el) {
    el.innerHTML = "";
    let names = el.getAttribute('data-names') ? el.getAttribute('data-names').split(',') : [];
    let nicks = el.getAttribute('data-nicks') ? el.getAttribute('data-nicks').split(',') : [];
    const area = el.getAttribute('data-area');

    nicks.forEach((nick, i) => {
        if (names[i].startsWith("BRK_")) {
            // íœ´ê²Œ ì¹´ë“œ: ê²€ì •ìƒ‰
            el.innerHTML += `<span class="nick-chip break-mode">${nick}</span>`;
        } else {
            // ê·¼ë¬´ ì¹´ë“œ: êµ¬ì—­ë³„ ìƒ‰ìƒ (Service ì£¼í™© / Kitchen ì´ˆë¡)
            const color = (area === 'Service') ? '#E65100' : '#2E7D32';
            el.innerHTML += `<span class="nick-chip" style="background-color:${color};">${nick}</span>`;
        }
    });

    if (names.length > 0) el.classList.add('active-fill');
    else el.classList.remove('active-fill');
}

// ì´ˆê¸°í™” ì‹œ ì‹œê°„ ì„ íƒì§€ ìƒì„± ì‹¤í–‰
fillTimeOptions();

/* í•´ë‹¹ ì£¼ì˜ ì›”ìš”ì¼ ë‚ ì§œ(YYYY-MM-DD) ë°˜í™˜ */
function getMondayOfWeek(dateStr) {
    if (!dateStr) return '';
    var d = new Date(dateStr + 'T12:00:00');
    if (isNaN(d.getTime())) return dateStr;
    var day = d.getDay();
    var diff = day === 0 ? -6 : -(day - 1);
    d.setDate(d.getDate() + diff);
    return d.toISOString().slice(0, 10);
}
/* ë‚ ì§œ ì…ë ¥ ì‹œ í•´ë‹¹ ì£¼ ì›”ìš”ì¼ë¡œ ìë™ ë³´ì • */
function snapToMonday(el) {
    if (!el || !el.value) return;
    var monday = getMondayOfWeek(el.value);
    if (monday && monday !== el.value) el.value = monday;
}

/* [ìµœì¢…] ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì„ ë¶ˆëŸ¬ì™€ 'ì¡°íšŒ/ìˆ˜ì •' ê·¸ë¦¬ë“œì— ë³µì› (íƒ€ì„ì•„ì›ƒ + try/catchë¡œ ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°ì™€ ë™ì¼í•˜ê²Œ ì•ˆì •í™”) */
function loadSavedSchedule() {
    var storeEl = document.getElementById('view-store-select');
    var mondayEl = document.getElementById('view-week-monday');
    if (!storeEl || !mondayEl) return;
    var store = (storeEl.value || '').trim();
    var monday = (mondayEl.value || '').trim();
    if (!store || !monday) {
        alert("ë§¤ì¥ê³¼ ê¸°ì¤€ ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
    }
    monday = getMondayOfWeek(monday) || monday;
    mondayEl.value = monday;

    if (typeof load === 'function') load(1);
    var loadTimeout = setTimeout(function() {
        if (typeof load === 'function') load(0);
        alert("ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }, 25000);
    google.script.run
        .withSuccessHandler(function(data) {
            clearTimeout(loadTimeout);
            try {
                var viewBody = document.getElementById('view-body-slots');
                var viewHeader = document.getElementById('view-header-row');
                if (!viewBody || !viewHeader) {
                    if (typeof load === 'function') load(0);
                    return alert("ì¡°íšŒ ê·¸ë¦¬ë“œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                if (!data || !Array.isArray(data)) {
                    if (typeof load === 'function') load(0);
                    alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,ê³„íšì¶œê·¼,ê³„íší‡´ê·¼,ê³„íšíœ´ê²Œì‹œì‘,ê³„íšíœ´ê²Œì¢…ë£Œ,ë¹„ê³ ' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥ëª…Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                    return;
                }
            var startEl = document.getElementById('sch-start-hour');
            var endEl = document.getElementById('sch-end-hour');
            if (startEl && endEl) { startEl.value = 6; endEl.value = 23; }
            mondayEl.value = monday;
            initWeeklyGrid('view');
            if (data.length === 0) {
                if (typeof load === 'function') load(0);
                alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,ê³„íšì¶œê·¼,ê³„íší‡´ê·¼,ê³„íšíœ´ê²Œì‹œì‘,ê³„íšíœ´ê²Œì¢…ë£Œ,ë¹„ê³ ' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥ëª…Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                return;
            }
            var mondayParts = monday.split('-');
            var d1Utc = mondayParts.length >= 3 ? Date.UTC(parseInt(mondayParts[0],10), parseInt(mondayParts[1],10)-1, parseInt(mondayParts[2],10)) : 0;
            var idx = 0;
            function applyNextBatch() {
                var batch = 15;
                var end = Math.min(idx + batch, data.length);
                for (var i = idx; i < end; i++) {
                    var row = data[i];
                    var dateStr = String(row.date || '').trim().substring(0, 10);
                    var rowParts = dateStr.split('-');
                    var d2Utc = rowParts.length >= 3 ? Date.UTC(parseInt(rowParts[0],10), parseInt(rowParts[1],10)-1, parseInt(rowParts[2],10)) : 0;
                    var dayIdx = Math.round((d2Utc - d1Utc) / (1000 * 60 * 60 * 24));
                    if (dayIdx < 0 || dayIdx > 6) continue;
                    var times = get30MinIntervals(row.pIn || '09:00', row.pOut || '18:00');
                    var breakTimes = (row.pBS && row.pBE) ? get30MinIntervals(row.pBS, row.pBE) : [];
                    for (var ti = 0; ti < times.length; ti++) {
                        var t = times[ti];
                        var slot = document.querySelector('#view-body-slots .half-slot[data-day="' + dayIdx + '"][data-area="' + (row.area || 'Service') + '"][data-time="' + t + '"]');
                        if (slot) {
                            var names = (slot.getAttribute('data-names') || '').split(',').filter(Boolean);
                            var nicks = (slot.getAttribute('data-nicks') || '').split(',').filter(Boolean);
                            var saveName = breakTimes.indexOf(t) !== -1 ? 'BRK_' + row.name : row.name;
                            if (names.indexOf(saveName) === -1) {
                                names.push(saveName);
                                nicks.push(row.nick || row.name);
                                slot.setAttribute('data-names', names.join(','));
                                slot.setAttribute('data-nicks', nicks.join(','));
                                refreshSlotUI(slot);
                            }
                        }
                    }
                }
                idx = end;
                if (idx < data.length) {
                    setTimeout(applyNextBatch, 0);
                } else {
                    if (typeof updateDailyCounts === 'function') updateDailyCounts('view');
                    if (typeof load === 'function') load(0);
                }
            }
            requestAnimationFrame(function() {
                setTimeout(applyNextBatch, 80);
            });
            } catch (e) {
                if (typeof load === 'function') load(0);
                alert("ì €ì¥ëœ ì‹œê°„í‘œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || ""));
                console.error("loadSavedSchedule success handler:", e);
            }
        })
        .withFailureHandler(function(err) {
            clearTimeout(loadTimeout);
            if (typeof load === 'function') load(0);
            alert("ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§¤ì¥Â·ë‚ ì§œë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .getSavedWeeklyData(store, monday);
}

/* [ìŠ¤ì¼€ì¤„ ì‘ì„± íƒ­] ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì™€ í¸ì§‘ ê·¸ë¦¬ë“œ(sch-body-slots)ì— ì±„ìš°ê¸° (íƒ€ì„ì•„ì›ƒ + try/catchë¡œ ì•ˆì •í™”) */
function loadSavedScheduleIntoEditor() {
    var storeEl = document.getElementById('sch-store-select');
    var mondayEl = document.getElementById('sch-week-monday');
    if (!storeEl || !mondayEl) return;
    var store = (storeEl.value || '').trim();
    var monday = (mondayEl.value || '').trim();
    if (!store || !monday) {
        alert("ë§¤ì¥ê³¼ ê¸°ì¤€ ì›”ìš”ì¼ ë‚ ì§œë¥¼ ì„ íƒí•œ ë’¤ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
        return;
    }
    monday = getMondayOfWeek(monday) || monday;
    mondayEl.value = monday;

    if (typeof load === 'function') load(1);
    var loadTimeout = setTimeout(function() {
        if (typeof load === 'function') load(0);
        alert("ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì™€ ì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ë¥¼ í™•ì¸í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
    }, 25000);
    google.script.run
        .withSuccessHandler(function(data) {
            clearTimeout(loadTimeout);
            try {
                var schBody = document.getElementById('sch-body-slots');
                var schHeader = document.getElementById('sch-header-row');
                if (!schBody || !schHeader) {
                    if (typeof load === 'function') load(0);
                    return alert("ìŠ¤ì¼€ì¤„ ê·¸ë¦¬ë“œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                if (!data || !Array.isArray(data)) {
                    if (typeof load === 'function') load(0);
                    alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,...' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                    return;
                }
            var startEl = document.getElementById('sch-start-hour');
            var endEl = document.getElementById('sch-end-hour');
            if (startEl && endEl) { startEl.value = 6; endEl.value = 23; }
            mondayEl.value = monday;
            initWeeklyGrid('sch');
            if (data.length === 0) {
                if (typeof load === 'function') load(0);
                alert("í•´ë‹¹ ì£¼ì— ì €ì¥ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì‹œê°„í‘œ ì‹œíŠ¸ì˜ 1í–‰ í—¤ë”ê°€ 'ë‚ ì§œ,ë§¤ì¥ëª…,ì´ë¦„,...' ìˆœì„œì¸ì§€, ì„ íƒí•œ ë§¤ì¥Â·ê¸°ì¤€ ì›”ìš”ì¼ì´ ë§ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                return;
            }
            var mondayPartsSch = monday.split('-');
            var d1UtcSch = mondayPartsSch.length >= 3 ? Date.UTC(parseInt(mondayPartsSch[0],10), parseInt(mondayPartsSch[1],10)-1, parseInt(mondayPartsSch[2],10)) : 0;
            var idx = 0;
            function applyNextBatch() {
                var batch = 15;
                var end = Math.min(idx + batch, data.length);
                for (var i = idx; i < end; i++) {
                    var row = data[i];
                    var dateStr = String(row.date || '').trim().substring(0, 10);
                    var rowParts = dateStr.split('-');
                    var d2Utc = rowParts.length >= 3 ? Date.UTC(parseInt(rowParts[0],10), parseInt(rowParts[1],10)-1, parseInt(rowParts[2],10)) : 0;
                    var dayIdx = Math.round((d2Utc - d1UtcSch) / (1000 * 60 * 60 * 24));
                    if (dayIdx < 0 || dayIdx > 6) continue;
                    var times = get30MinIntervals(row.pIn || '09:00', row.pOut || '18:00');
                    var breakTimes = (row.pBS && row.pBE) ? get30MinIntervals(row.pBS, row.pBE) : [];
                    for (var ti = 0; ti < times.length; ti++) {
                        var t = times[ti];
                        var slot = document.querySelector('#sch-body-slots .half-slot[data-day="' + dayIdx + '"][data-area="' + (row.area || 'Service') + '"][data-time="' + t + '"]');
                        if (slot) {
                            var names = (slot.getAttribute('data-names') || '').split(',').filter(Boolean);
                            var nicks = (slot.getAttribute('data-nicks') || '').split(',').filter(Boolean);
                            var saveName = breakTimes.indexOf(t) !== -1 ? 'BRK_' + row.name : row.name;
                            if (names.indexOf(saveName) === -1) {
                                names.push(saveName);
                                nicks.push(row.nick || row.name);
                                slot.setAttribute('data-names', names.join(','));
                                slot.setAttribute('data-nicks', nicks.join(','));
                                refreshSlotUI(slot);
                            }
                        }
                    }
                }
                idx = end;
                if (idx < data.length) {
                    setTimeout(applyNextBatch, 0);
                } else {
                    if (typeof updateDailyCounts === 'function') updateDailyCounts('sch');
                    if (typeof load === 'function') load(0);
                }
            }
            requestAnimationFrame(function() {
                setTimeout(applyNextBatch, 80);
            });
            } catch (e) {
                if (typeof load === 'function') load(0);
                alert("ì €ì¥ëœ ì‹œê°„í‘œ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. " + (e.message || ""));
                console.error("loadSavedScheduleIntoEditor success handler:", e);
            }
        })
        .withFailureHandler(function(err) {
            clearTimeout(loadTimeout);
            if (typeof load === 'function') load(0);
            alert("ì €ì¥ëœ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë§¤ì¥Â·ë‚ ì§œë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .getSavedWeeklyData(store, monday);
}

/* [ë³´ì¡°] ë‘ ì‹œê°„ ì‚¬ì´ì˜ 30ë¶„ ë‹¨ìœ„ ë°°ì—´ ìƒì„± (ì˜ˆ: "09:00", "09:30", "10:00"...) */
function get30MinIntervals(start, end) {
    let result = [];
    let [sh, sm] = start.split(':').map(Number);
    let [eh, em] = end.split(':').map(Number);
    let cur = sh * 60 + sm;
    const finish = eh * 60 + em;

    while(cur < finish) {
        let h = Math.floor(cur / 60).toString().padStart(2, '0');
        let m = (cur % 60).toString().padStart(2, '0');
        result.push(`${h}:${m}`);
        cur += 30;
    }
    return result;
}

/* [ì¶”ê°€] í˜„ì¬ ìŠ¤ì¼€ì¤„ì„ ë‹¤ìŒ ì£¼ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì—¬ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ìŠ¤ì¼€ì¤„ ì‘ì„± ê·¸ë¦¬ë“œë§Œ ëŒ€ìƒ) */
function copyToNextWeek() {
    const store = document.getElementById('sch-store-select').value;
    const currentMonday = document.getElementById('sch-week-monday').value;
    const slots = document.querySelectorAll('#sch-body-slots .half-slot.active-fill');

    if(!currentMonday) return alert("ê¸°ì¤€ ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
    if(!store || store === "All") return alert("ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");
    if(slots.length === 0) return alert("ë³µì‚¬í•  ë°ì´í„°ê°€ í™”ë©´ì— ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ì‘ì„±í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");

    // 1. ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ ë‚ ì§œ ê³„ì‚°
    let nextMonDate = new Date(currentMonday);
    nextMonDate.setDate(nextMonDate.getDate() + 7);
    const nextMondayStr = nextMonDate.toISOString().split('T')[0];

    if(!confirm(`í˜„ì¬ í™”ë©´ì˜ ìŠ¤ì¼€ì¤„ì„ ë‹¤ìŒ ì£¼(${nextMondayStr})ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    // 2. í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„° ìˆ˜ì§‘ (prepareAndSaveì˜ ë¡œì§ ì¬í™œìš©)
    let map = {}; 
    slots.forEach(s => {
        let namesStr = s.getAttribute('data-names');
        if(!namesStr) return;
        
        let names = namesStr.split(',');
        let dayOffset = parseInt(s.getAttribute('data-day'));
        let time = s.getAttribute('data-time');
        let area = s.getAttribute('data-area');
        
        // â˜… í•µì‹¬: ë‚ ì§œë¥¼ í˜„ì¬ ê¸°ì¤€ì´ ì•„ë‹Œ 'ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ + ìš”ì¼ì°¨ì´'ë¡œ ì„¤ì •
        let d = new Date(nextMondayStr);
        d.setDate(d.getDate() + dayOffset);
        let datePart = d.toISOString().split('T')[0];

        names.forEach(n => {
            let name = n.trim();
            if(!name) return;
            const isBrk = name.startsWith("BRK_");
            const realName = isBrk ? name.replace("BRK_", "") : name;
            
            let key = datePart + "_" + realName + "_" + area;
            if(!map[key]) map[key] = { work: [], break: [] };
            if(isBrk) map[key].break.push(time);
            else map[key].work.push(time);
        });
    });

    // 3. ìµœì¢… ë°ì´í„° ë³€í™˜ (í‚¤ í˜•ì‹: date_name_area, ì´ë¦„ì— _ í¬í•¨ ê°€ëŠ¥)
    let finalData = [];
    for(let k in map) {
        let parts = k.split('_');
        let date = parts[0];
        let area = parts[parts.length - 1];
        let name = parts.length > 2 ? parts.slice(1, -1).join('_') : (parts[1] || '');
        let allTimes = [...map[k].work, ...map[k].break].sort();
        if(allTimes.length === 0) continue;

        let pIn = allTimes[0];
        let last = allTimes[allTimes.length - 1];
        let [hh, mm] = last.split(':').map(Number);
        mm += 30; if(mm === 60) { hh++; mm = 0; }
        let pOut = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}`;

        let pBS = "", pBE = "";
        if(map[k].break.length > 0) {
            let brkTimes = map[k].break.sort();
            pBS = brkTimes[0];
            let bLast = brkTimes[brkTimes.length - 1];
            let [bhh, bmm] = bLast.split(':').map(Number);
            bmm += 30; if(bmm === 60) { bhh++; bmm = 0; }
            pBE = `${bhh.toString().padStart(2, '0')}:${bmm.toString().padStart(2, '0')}`;
        }

        finalData.push({ date: date, name: name, pIn: pIn, pOut: pOut, pBS: pBS, pBE: pBE, remark: "[" + area + "]" });
    }

    // 4. ì„œë²„ ì €ì¥ ì‹¤í–‰
    load(1);
    google.script.run
        .withSuccessHandler(res => {
            load(0);
            alert(`âœ… ë³µì‚¬ ì™„ë£Œ!\në‹¤ìŒ ì£¼(${nextMondayStr}) ìŠ¤ì¼€ì¤„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            document.getElementById('sch-week-monday').value = nextMondayStr;
            loadSavedScheduleIntoEditor(); // ì‘ì„± íƒ­ì— ë‹¤ìŒ ì£¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        })
        .withFailureHandler(function(err) {
            load(0);
            alert("ë‹¤ìŒ ì£¼ë¡œ ë³µì‚¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
            console.error(err);
        })
        .saveWeeklySmartSchedule(store, nextMondayStr, finalData);
}



/* =================================================================
     íœ´ê°€ ì—°ì°¨
 ================================================================= */ 
function showLeaveTab(tab) {
    var panelApproval = document.getElementById("leave-panel-approval");
    var panelStats = document.getElementById("leave-panel-stats");
    var tabApproval = document.getElementById("leave-tab-approval");
    var tabStats = document.getElementById("leave-tab-stats");
    if (!panelApproval || !panelStats || !tabApproval || !tabStats) return;
    panelApproval.style.display = (tab === "approval") ? "block" : "none";
    panelStats.style.display = (tab === "stats") ? "block" : "none";
    tabApproval.classList.toggle("active", tab === "approval");
    tabStats.classList.toggle("active", tab === "stats");
    if (tab === "stats") {
      var statsList = document.getElementById("stats-list");
      if (statsList) statsList.innerHTML = "<tr><td colspan='7' class='text-muted py-4'>ê¸°ê°„Â·ë§¤ì¥ ì„ íƒ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
    }
}
function procLv(r,d){ if(confirm(d+"?")) google.script.run.withSuccessHandler(r=>{alert(r);loadLeaveData(filterLeaves);}).processLeaveDecision(r,d); }
  /* [ìˆ˜ì •] íœ´ê°€ í†µê³„ ê²€ìƒ‰ í•¨ìˆ˜ (ë§¤ì¥ í•„í„° ê¸°ëŠ¥ ì¶”ê°€) */
  function filterStats() {
    var start = document.getElementById("stats-start").value;
    var end = document.getElementById("stats-end").value;
    var store = document.getElementById("hr-store-selector").value; // â˜… ë§¤ì¥ ê°’ ì½ì–´ì˜¤ê¸°

    // ë¡œë”© í‘œì‹œ
    document.getElementById("stats-list").innerHTML = "<tr><td colspan='7'>â³ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";

    // ì„œë²„ë¡œ ë‚ ì§œì™€ í•¨ê»˜ 'ë§¤ì¥(store)' ì •ë³´ë„ ê°™ì´ ë³´ëƒ„!
    google.script.run.withSuccessHandler(function(data) {
        var tbody = document.getElementById("stats-list");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            tbody.innerHTML = "<tr><td colspan='7'>ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
        }

        // ê²°ê³¼ í…Œì´ë¸” ê·¸ë¦¬ê¸°
        data.forEach(function(r) {
            var row = "<tr>" +
                "<td>" + r.store + "</td>" +
                "<td>" + r.name + "</td>" +
                "<td>" + r.used_annual + "</td>" + // ê¸°ê°„ ë‚´ ì—°ì°¨
                "<td>" + r.used_sick + "</td>" +   // ê¸°ê°„ ë‚´ ë³‘ê°€
                "<td>" + r.total_annual + "</td>" + // ì „ì²´ ëˆ„ì  ì—°ì°¨
                "<td>" + r.total_sick + "</td>" +   // ì „ì²´ ëˆ„ì  ë³‘ê°€
                "<td class='fw-bold text-primary'>" + r.remain + "</td>" + // ì”ì—¬
                "</tr>";
            tbody.innerHTML += row;
        });
    }).getLeaveStats(start, end, store); // â˜… ì„œë²„ í•¨ìˆ˜ì— store ì „ë‹¬
}

/* [ìˆ˜ì •] íœ´ê°€ ê²€ìƒ‰ (ê¸°ê°„, ë§¤ì¥, ìƒíƒœ í•„í„°ë§ ì ìš©) */
function filterLeaves() { 
    var startInput = document.getElementById("leave-start");
    var endInput = document.getElementById("leave-end");
    var statusInput = document.getElementById("leave-status");
    var storeInput = document.getElementById("leave-store-select");
    var b = document.getElementById("leave-list");

    // ì•ˆì „ì¥ì¹˜: ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    if (!allLeaveData || !allLeaveData.leaves) {
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>";
        return;
    }

    b.innerHTML = "";

    // 1. ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    var s = startInput.value; // ì‹œì‘ì¼
    var e = endInput.value;   // ì¢…ë£Œì¼
    var st = statusInput.value; // ìƒíƒœ (All, ëŒ€ê¸°, ìŠ¹ì¸, ë°˜ë ¤)
    var str = storeInput.value; // ë§¤ì¥

    // 2. í•„í„°ë§ ë¡œì§ (ì—¬ê¸°ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤!)
    var f = allLeaveData.leaves.filter(function(i) {
        // (1) ë‚ ì§œ ë¹„êµ: ì‹œì‘ì¼ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ê³ , ì¢…ë£Œì¼ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•¨
        // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´(ì„ íƒ ì•ˆ í–ˆìœ¼ë©´) ë‚ ì§œ ì¡°ê±´ì€ ë¬´ì‹œí•˜ê³  í†µê³¼
        var dateMatch = true;
        if (s && i.date < s) dateMatch = false; // ì‹œì‘ì¼ë³´ë‹¤ ì „ì´ë©´ íƒˆë½
        if (e && i.date > e) dateMatch = false; // ì¢…ë£Œì¼ë³´ë‹¤ í›„ë©´ íƒˆë½

        // (2) ìƒíƒœ ë¹„êµ: 'All'ì´ë©´ í†µê³¼, ì•„ë‹ˆë©´ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
        var statusMatch = (st === "All" || i.status === st);

        // (3) ë§¤ì¥ ë¹„êµ: 'All'ì´ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ í†µê³¼, ì•„ë‹ˆë©´ ì¼ì¹˜í•´ì•¼ í•¨
        var storeMatch = (str === "All" || str === "" || i.store === str);

        return dateMatch && statusMatch && storeMatch;
    });

    // 3. ê²°ê³¼ ê·¸ë¦¬ê¸°
    if (f.length === 0) {
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>ì¡°ê±´ì— ë§ëŠ” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
    }

    f.forEach(i => { 
        // ë²„íŠ¼: ìŠ¹ì¸/ë°˜ë ¤ ë²„íŠ¼ì€ 'ëŒ€ê¸°(Pending)' ìƒíƒœì¼ ë•Œë§Œ ë³´ì—¬ì¤Œ
        var btns = "";
        if (i.status === 'Pending' || i.status === 'ëŒ€ê¸°') {
            btns = `<button class="btn btn-success btn-sm me-1" onclick="procLv('${i.row}','ìŠ¹ì¸')">O</button>
                    <button class="btn btn-danger btn-sm" onclick="procLv('${i.row}','ë°˜ë ¤')">X</button>`;
        } else {
            btns = `<span class="text-muted small">-</span>`;
        }

        // ìƒíƒœ ë±ƒì§€ ê¾¸ë¯¸ê¸°
        var badgeClass = "bg-secondary";
        if(i.status === 'ìŠ¹ì¸') badgeClass = "bg-success";
        if(i.status === 'ë°˜ë ¤') badgeClass = "bg-danger";
        if(i.status === 'ëŒ€ê¸°' || i.status === 'Pending') badgeClass = "bg-warning text-dark";

        b.innerHTML += `
            <tr>
                <td>${i.date}</td>
                <td><span class="fw-bold">${i.store}</span></td>
                <td>${i.name}</td>
                <td>${i.type}</td>
                <td><span class="badge ${badgeClass}">${i.status}</span></td>
                <td>${btns}</td>
            </tr>`; 
    }); 
}

  function loadLeaveData(cb) { load(1); google.script.run.withSuccessHandler(l => { load(0); allLeaveData = l; if(cb) cb(); }).getLeaveAllData(); }


</script>