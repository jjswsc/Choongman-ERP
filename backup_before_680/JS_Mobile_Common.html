<script>
  /**
   * 1. ì „ì—­ ë³€ìˆ˜ ì„¤ì • (ì‹œìŠ¤í…œ ì „ì²´ ê³µìœ )
   */
  var loginData = {}, allItems = [], cart = [], usageCart = [], currentStock = {}, 
      loggedInStore = "", loggedInUser = "", loggedInRole = "", 
      selectedItem = null, selectedUsageItem = null, myNotices = [];

  /** ëª¨ë°”ì¼ ë‹¤êµ­ì–´: ë¡œê·¸ì¸ ì‹œ ì„ íƒí•œ ì–¸ì–´ ìœ ì§€ (sessionStorage) */
  var currentLang = (typeof sessionStorage !== "undefined" && sessionStorage.getItem("cm_lang")) || "ko";

  /** ëª¨ë°”ì¼ ì „ìš© ë‹¤êµ­ì–´ ë§µ (ko, en, th, mm, la) */
  var I18N = {
    ko: {
      login_title: "CM ERP SYSTEM", btn_login: "ë¡œê·¸ì¸", m_processing: "ì²˜ë¦¬ ì¤‘...",
      m_select_store: "ë§¤ì¥ ì„ íƒ", m_select_name: "ì´ë¦„ ì„ íƒ", m_pin_ph: "ë¹„ë°€ë²ˆí˜¸ (PIN)",
      m_logout: "ë¡œê·¸ì•„ì›ƒ", m_tab_home: "í™ˆ", m_tab_order: "ì£¼ë¬¸", m_tab_stock: "ì‚¬ìš©", m_tab_hr: "ì¸ì‚¬", m_tab_visit: "ë°©ë¬¸", m_tab_admin: "ê´€ë¦¬",
      m_welcome: "í™˜ì˜í•©ë‹ˆë‹¤!", m_welcome_sub: "ì˜¤ëŠ˜ë„ ì•ˆì „í•˜ê³  ì¦ê²ê²Œ ê·¼ë¬´í•˜ì„¸ìš”!", m_notice_board: "ê³µì§€ì‚¬í•­", m_loading_notices: "ê³µì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", m_no_notices: "ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.",
      m_ord_new: "ì‹ ê·œ ì£¼ë¬¸", m_ord_hist: "ì£¼ë¬¸ ë‚´ì—­", m_loading_items: "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", m_add_cart: "ë‹´ê¸°",
      m_item: "í’ˆëª©", m_price: "ë‹¨ê°€", m_qty: "ìˆ˜ëŸ‰", m_sub: "ì†Œê³„", m_subtotal: "ì†Œê³„:", m_vat: "VAT (7%):", m_total: "í•©ê³„:", m_place_order: "ì£¼ë¬¸í•˜ê¸°", m_search_hist: "ë‚´ì—­ ì¡°íšŒ",
      m_use_new: "ì‚¬ìš© ì…ë ¥", m_use_hist: "ë‚´ì—­", m_add_usage: "ì‚¬ìš© ì¶”ê°€", m_items_used: "ì‚¬ìš© í’ˆëª©", m_confirm_usage: "ì‚¬ìš© í™•ì •", m_search_period: "ê¸°ê°„ ì¡°íšŒ",
      m_user: "ì‚¬ìš©ì", m_att_in: "â˜€ï¸ ì¶œê·¼", m_att_out: "ğŸŒ™ í‡´ê·¼", m_break: "â˜• íœ´ì‹", m_resume: "â–¶ ì¬ê°œ",
      m_today_record: "ì˜¤ëŠ˜ ê¸°ë¡", m_att_help: "ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶œí‡´ê·¼ì„ ê¸°ë¡í•˜ì„¸ìš”.", m_leave_stats: "íœ´ê°€ í˜„í™© (ì˜¬í•´)",
      m_used_ann: "ì—°ì°¨ ì‚¬ìš©", m_used_sick: "ë³‘ê°€ ì‚¬ìš©", m_remain: "ì”ì—¬", m_leave_req: "íœ´ê°€ ì‹ ì²­",
      m_annual: "ì—°ì°¨", m_half: "ë°˜ì°¨", m_sick: "ë³‘ê°€", m_reason_ph: "ì‚¬ìœ ", m_submit_req: "ì‹ ì²­í•˜ê¸°", m_req_hist: "ì‹ ì²­ ë‚´ì—­",
      m_visit_title: "ë§¤ì¥ ë°©ë¬¸", m_visit_sub: "í˜„ì¥ ì§€ì› ë° êµìœ¡ í™œë™ì„ ê¸°ë¡í•˜ì„¸ìš”.", m_visit_store: "ë°©ë¬¸ ë§¤ì¥ ì„ íƒ", m_visit_purpose: "ë°©ë¬¸ ëª©ì ",
      m_purpose_inspect: "ğŸ” ì •ê¸° ì ê²€ (Inspection)", m_purpose_training: "ğŸ‘¨â€ğŸ« ì§ì› êµìœ¡ (Training)", m_purpose_urgent: "ğŸš¨ ê¸´ê¸‰ ì§€ì› (Urgent Support)", m_purpose_meeting: "ğŸ¤ ë§¤ì¥ ë¯¸íŒ… (Meeting)", m_purpose_etc: "ETC",
      m_visit_start: "ë°©ë¬¸ ì‹œì‘ (Check-in)", m_visit_end: "ë°©ë¬¸ ì¢…ë£Œ (Check-out)", m_today_visit_log: "Today's Visit Log", m_loading_visit: "ê¸°ë¡ì„ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...",
      m_time: "ì‹œê°„", m_store: "ë§¤ì¥", m_type: "êµ¬ë¶„", m_duration: "ì²´ë¥˜", m_modal_later: "ë‹¤ìŒì—", m_modal_confirm: "í™•ì¸í•¨ (Confirm)",
      m_no_visit: "ì˜¤ëŠ˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", m_select_store_name: "ë§¤ì¥ê³¼ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”.", m_login_fail: "ë¡œê·¸ì¸ ì‹¤íŒ¨: PIN ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
      m_no_history: "No history", m_no_records: "No records found.", m_receive: "ğŸ“¥ Receive", m_receive_confirm: "Receive items?", m_select_item: "Select an Item first!",
      m_app_title: "ì¶©ë§Œì¹˜í‚¨", m_admin_sub: "ê³µì§€ ë°œì†¡, ì—°ì°¨Â·ê·¼íƒœ ìŠ¹ì¸", m_admin_notice: "ğŸ“¢ ê³µì§€ì‚¬í•­ ë°œì†¡", m_admin_att: "ğŸ“… ê·¼íƒœ ìŠ¹ì¸ (ì§€ê°/OT)",
      label_subject: "ì œëª©", label_content: "ë‚´ìš©", label_all: "ì „ì²´", leave_wait: "ëŒ€ê¸°", btn_query: "ì¡°íšŒ"
    },
    en: {
      login_title: "CM ERP SYSTEM", btn_login: "Login", m_processing: "Processing...",
      m_select_store: "Select Store...", m_select_name: "Select Name...", m_pin_ph: "Password (PIN)",
      m_logout: "Logout", m_tab_home: "Home", m_tab_order: "Order", m_tab_stock: "Usage", m_tab_hr: "HR", m_tab_visit: "Visit", m_tab_admin: "Admin",
      m_welcome: "Welcome!", m_welcome_sub: "Work safe and enjoy your day!", m_notice_board: "Notice Board", m_loading_notices: "Loading...", m_no_notices: "No notices.",
      m_ord_new: "New Order", m_ord_hist: "Order History", m_loading_items: "Loading...", m_add_cart: "Add to Cart",
      m_item: "Item", m_price: "Price", m_qty: "Qty", m_sub: "Sub", m_subtotal: "Subtotal:", m_vat: "VAT (7%):", m_total: "Total:", m_place_order: "Place Order", m_search_hist: "Search History",
      m_use_new: "New Usage", m_use_hist: "History", m_add_usage: "Add Usage", m_items_used: "Items Used", m_confirm_usage: "Confirm Usage", m_search_period: "Search Period",
      m_user: "User", m_att_in: "â˜€ï¸ IN", m_att_out: "ğŸŒ™ OUT", m_break: "â˜• Break", m_resume: "â–¶ Resume",
      m_today_record: "Today's Record", m_att_help: "Tap buttons to record attendance.", m_leave_stats: "My Vacation Stats (This Year)",
      m_used_ann: "Used Annual", m_used_sick: "Used Sick", m_remain: "Remaining", m_leave_req: "Leave Request",
      m_annual: "Annual Leave", m_half: "Half-Day", m_sick: "Sick Leave", m_reason_ph: "Reason", m_submit_req: "Submit Request", m_req_hist: "Request History",
      m_visit_title: "Store Visit", m_visit_sub: "Record support and training.", m_visit_store: "Select Store", m_visit_purpose: "Purpose",
      m_purpose_inspect: "ğŸ” Inspection", m_purpose_training: "ğŸ‘¨â€ğŸ« Training", m_purpose_urgent: "ğŸš¨ Urgent", m_purpose_meeting: "ğŸ¤ Meeting", m_purpose_etc: "ETC",
      m_visit_start: "Check-in", m_visit_end: "Check-out", m_today_visit_log: "Today's Visit Log", m_loading_visit: "Loading...",
      m_time: "Time", m_store: "Store", m_type: "Type", m_duration: "Duration", m_modal_later: "Later", m_modal_confirm: "Confirm",
      m_no_visit: "No visits today.", m_select_store_name: "Select Store and Name", m_login_fail: "Login Failed: Check PIN.",
      m_no_history: "No history", m_no_records: "No records found.", m_receive: "ğŸ“¥ Receive", m_receive_confirm: "Receive items?", m_select_item: "Select an Item first!",
      m_app_title: "Choongman Chicken", m_admin_sub: "Notice, Leave & Attendance approval", m_admin_notice: "ğŸ“¢ Send Notice", m_admin_att: "ğŸ“… Attendance (Late/OT) approval",
      label_subject: "Subject", label_content: "Content", label_all: "All", leave_wait: "Pending", btn_query: "Query"
    },
    th: {
      login_title: "CM ERP SYSTEM", btn_login: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š", m_processing: "à¸à¸³à¸¥à¸±à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£...",
      m_select_store: "à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²", m_select_name: "à¹€à¸¥à¸·à¸­à¸à¸Šà¸·à¹ˆà¸­", m_pin_ph: "à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ (PIN)",
      m_logout: "à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š", m_tab_home: "à¸«à¸™à¹‰à¸²à¹à¸£à¸", m_tab_order: "à¸­à¸­à¹€à¸”à¸­à¸£à¹Œ", m_tab_stock: "à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™", m_tab_hr: "à¸šà¸¸à¸„à¸¥à¸²à¸à¸£", m_tab_visit: "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸ªà¸²à¸‚à¸²", m_tab_admin: "à¹à¸­à¸”à¸¡à¸´à¸™",
      m_welcome: "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š!", m_welcome_sub: "à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¹à¸¥à¸°à¸ªà¸™à¸¸à¸!", m_notice_board: "à¸›à¸£à¸°à¸à¸²à¸¨", m_loading_notices: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...", m_no_notices: "à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸à¸²à¸¨",
      m_ord_new: "à¸­à¸­à¹€à¸”à¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ", m_ord_hist: "à¸›à¸£à¸°à¸§à¸±à¸•à¸´", m_loading_items: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...", m_add_cart: "à¹€à¸à¸´à¹ˆà¸¡à¸¥à¸‡à¸•à¸°à¸à¸£à¹‰à¸²",
      m_item: "à¸£à¸²à¸¢à¸à¸²à¸£", m_price: "à¸£à¸²à¸„à¸²", m_qty: "à¸ˆà¸³à¸™à¸§à¸™", m_sub: "à¸¢à¸­à¸”", m_subtotal: "à¸¢à¸­à¸”à¸£à¸§à¸¡:", m_vat: "VAT (7%):", m_total: "à¸£à¸§à¸¡:", m_place_order: "à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­", m_search_hist: "à¸„à¹‰à¸™à¸«à¸²à¸›à¸£à¸°à¸§à¸±à¸•à¸´",
      m_use_new: "à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆ", m_use_hist: "à¸›à¸£à¸°à¸§à¸±à¸•à¸´", m_add_usage: "à¹€à¸à¸´à¹ˆà¸¡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™", m_items_used: "à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§", m_confirm_usage: "à¸¢à¸·à¸™à¸¢à¸±à¸™", m_search_period: "à¸„à¹‰à¸™à¸«à¸²à¸Šà¹ˆà¸§à¸‡",
      m_user: "à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰", m_att_in: "â˜€ï¸ à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™", m_att_out: "ğŸŒ™ à¸­à¸­à¸à¸‡à¸²à¸™", m_break: "â˜• à¸à¸±à¸", m_resume: "â–¶ à¸à¸¥à¸±à¸šà¸—à¸³à¸‡à¸²à¸™",
      m_today_record: "à¸šà¸±à¸™à¸—à¸¶à¸à¸§à¸±à¸™à¸™à¸µà¹‰", m_att_help: "à¸à¸”à¸›à¸¸à¹ˆà¸¡à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™", m_leave_stats: "à¸ªà¸–à¸´à¸•à¸´à¸¥à¸²à¸‡à¸²à¸™ (à¸›à¸µà¸™à¸µà¹‰)",
      m_used_ann: "à¹ƒà¸Šà¹‰à¸¥à¸²à¸›à¸£à¸°à¸ˆà¸³à¸›à¸µ", m_used_sick: "à¹ƒà¸Šà¹‰à¸¥à¸²à¸›à¹ˆà¸§à¸¢", m_remain: "à¹€à¸«à¸¥à¸·à¸­", m_leave_req: "à¸‚à¸­à¸¥à¸²à¸‡à¸²à¸™",
      m_annual: "à¸¥à¸²à¸›à¸£à¸°à¸ˆà¸³à¸›à¸µ", m_half: "à¸¥ half-day", m_sick: "à¸¥à¸²à¸›à¹ˆà¸§à¸¢", m_reason_ph: "à¹€à¸«à¸•à¸¸à¸œà¸¥", m_submit_req: "à¸ªà¹ˆà¸‡à¸„à¸³à¸‚à¸­", m_req_hist: "à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸„à¸³à¸‚à¸­",
      m_visit_title: "à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸ªà¸²à¸‚à¸²", m_visit_sub: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™à¹à¸¥à¸°à¸à¸¶à¸à¸­à¸šà¸£à¸¡", m_visit_store: "à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²", m_visit_purpose: "à¸§à¸±à¸•à¸–à¸¸à¸›à¸£à¸°à¸ªà¸‡à¸„à¹Œ",
      m_purpose_inspect: "ğŸ” à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š", m_purpose_training: "ğŸ‘¨â€ğŸ« à¸à¸¶à¸à¸­à¸šà¸£à¸¡", m_purpose_urgent: "ğŸš¨ à¸”à¹ˆà¸§à¸™", m_purpose_meeting: "ğŸ¤ à¸›à¸£à¸°à¸Šà¸¸à¸¡", m_purpose_etc: "à¸­à¸·à¹ˆà¸™à¹†",
      m_visit_start: "à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™", m_visit_end: "à¹€à¸Šà¹‡à¸„à¹€à¸­à¸²à¸—à¹Œ", m_today_visit_log: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹€à¸¢à¸µà¹ˆà¸¢à¸¡à¸§à¸±à¸™à¸™à¸µà¹‰", m_loading_visit: "à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...",
      m_time: "à¹€à¸§à¸¥à¸²", m_store: "à¸ªà¸²à¸‚à¸²", m_type: "à¸›à¸£à¸°à¹€à¸ à¸—", m_duration: "à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²", m_modal_later: "à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡", m_modal_confirm: "à¸¢à¸·à¸™à¸¢à¸±à¸™",
      m_no_visit: "à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸™à¸—à¸¶à¸à¸§à¸±à¸™à¸™à¸µà¹‰", m_select_store_name: "à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¹à¸¥à¸°à¸Šà¸·à¹ˆà¸­", m_login_fail: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š PIN",
      m_no_history: "à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´", m_no_records: "à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥", m_receive: "ğŸ“¥ à¸£à¸±à¸šà¸‚à¸­à¸‡", m_receive_confirm: "à¸£à¸±à¸šà¸‚à¸­à¸‡?", m_select_item: "à¹€à¸¥à¸·à¸­à¸à¸£à¸²à¸¢à¸à¸²à¸£à¸à¹ˆà¸­à¸™!",
      m_app_title: "Choongman Chicken", m_admin_sub: "à¸›à¸£à¸°à¸à¸²à¸¨, à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸¥à¸²à¸‡à¸²à¸™à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™", m_admin_notice: "ğŸ“¢ à¸ªà¹ˆà¸‡à¸›à¸£à¸°à¸à¸²à¸¨", m_admin_att: "ğŸ“… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹€à¸‚à¹‰à¸²à¸‡à¸²à¸™ (à¸ªà¸²à¸¢/OT)",
      label_subject: "à¸«à¸±à¸§à¸‚à¹‰à¸­", label_content: "à¹€à¸™à¸·à¹‰à¸­à¸«à¸²", label_all: "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", leave_wait: "à¸£à¸­", btn_query: "à¸„à¹‰à¸™à¸«à¸²"
    },
    mm: {
      login_title: "CM ERP SYSTEM", btn_login: "á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º", m_processing: "á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€”á€±á€á€Šá€º...",
      m_select_store: "á€†á€­á€¯á€„á€ºá€›á€½á€±á€¸á€•á€«", m_select_name: "á€¡á€™á€Šá€ºá€›á€½á€±á€¸á€•á€«", m_pin_ph: "á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º (PIN)",
      m_logout: "á€‘á€½á€€á€ºá€™á€Šá€º", m_tab_home: "á€•á€„á€ºá€™", m_tab_order: "á€¡á€±á€¬á€ºá€’á€«", m_tab_stock: "á€¡á€á€¯á€¶á€¸", m_tab_hr: "á€¡á€›á€•á€º", m_tab_visit: "á€á€½á€¬á€¸á€›á€±á€¬á€€á€º", m_tab_admin: "á€¡á€€á€ºá€’á€ºá€™á€„á€º",
      m_welcome: "á€€á€¼á€­á€¯á€†á€­á€¯á€•á€«á€á€Šá€º!", m_welcome_sub: "á€˜á€±á€¸á€€á€„á€ºá€¸á€…á€½á€¬á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€•á€«!", m_notice_board: "á€€á€¼á€±á€Šá€¬á€á€»á€€á€º", m_loading_notices: "á€á€»á€­á€á€ºá€†á€±á€¬á€„á€ºá€”á€±á€á€Šá€º...", m_no_notices: "á€€á€¼á€±á€Šá€¬á€á€»á€€á€ºá€™á€›á€¾á€­",
      m_ord_new: "á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€º", m_ord_hist: "á€™á€¾á€á€ºá€á€™á€ºá€¸", m_loading_items: "á€á€»á€­á€á€ºá€†á€±á€¬á€„á€ºá€”á€±á€á€Šá€º...", m_add_cart: "á€á€¼á€„á€ºá€¸á€á€±á€¬á€„á€ºá€¸á€‘á€Šá€·á€ºá€™á€Šá€º",
      m_item: "á€•á€…á€¹á€…á€Šá€ºá€¸", m_price: "á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸", m_qty: "á€¡á€›á€±á€¡á€á€½á€€á€º", m_sub: "á€•á€±á€«á€„á€ºá€¸", m_subtotal: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:", m_vat: "VAT (7%):", m_total: "á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:", m_place_order: "á€¡á€±á€¬á€ºá€’á€«á€™á€¾á€¬á€™á€Šá€º", m_search_hist: "á€™á€¾á€á€ºá€á€™á€ºá€¸á€›á€¾á€¬á€™á€Šá€º",
      m_use_new: "á€¡á€á€¯á€¶á€¸á€¡á€á€…á€º", m_use_hist: "á€™á€¾á€á€ºá€á€™á€ºá€¸", m_add_usage: "á€¡á€á€¯á€¶á€¸á€‘á€Šá€·á€ºá€™á€Šá€º", m_items_used: "á€á€¯á€¶á€¸á€•á€¼á€®á€¸", m_confirm_usage: "á€¡á€á€Šá€ºá€•á€¼á€¯á€™á€Šá€º", m_search_period: "á€€á€¬á€œá€›á€¾á€¬á€™á€Šá€º",
      m_user: "á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°", m_att_in: "â˜€ï¸ á€á€„á€ºá€›á€±á€¬á€€á€º", m_att_out: "ğŸŒ™ á€‘á€½á€€á€º", m_break: "â˜• á€”á€¬á€¸á€™á€Šá€º", m_resume: "â–¶ á€•á€¼á€”á€ºá€…á€™á€Šá€º",
      m_today_record: "á€šá€”á€±á€·á€™á€¾á€á€ºá€á€™á€ºá€¸", m_att_help: "á€á€œá€¯á€á€ºá€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸á€™á€¾á€á€ºá€á€™á€ºá€¸á€á€„á€ºá€•á€«", m_leave_stats: "á€á€½á€„á€·á€ºá€…á€¬á€›á€„á€ºá€¸ (á€¤á€”á€¾á€…á€º)",
      m_used_ann: "á€á€½á€„á€·á€ºá€”á€¾á€…á€ºá€á€¯á€¶á€¸", m_used_sick: "á€¡á€•á€»á€±á€¬á€·á€á€½á€„á€·á€ºá€á€¯á€¶á€¸", m_remain: "á€€á€»á€”á€º", m_leave_req: "á€á€½á€„á€·á€ºá€á€±á€¬á€„á€ºá€¸á€™á€Šá€º",
      m_annual: "á€”á€¾á€…á€ºá€…á€‰á€ºá€á€½á€„á€·á€º", m_half: "á€á€…á€ºá€á€€á€ºá€á€½á€„á€·á€º", m_sick: "á€¡á€•á€»á€±á€¬á€·á€á€½á€„á€·á€º", m_reason_ph: "á€¡á€€á€¼á€•á€¼á€á€»á€€á€º", m_submit_req: "á€á€„á€ºá€™á€Šá€º", m_req_hist: "á€á€±á€¬á€„á€ºá€¸á€á€¶á€™á€¾á€á€ºá€á€™á€ºá€¸",
      m_visit_title: "á€†á€­á€¯á€„á€ºá€á€½á€¬á€¸á€á€¼á€„á€ºá€¸", m_visit_sub: "á€•á€¶á€·á€•á€­á€¯á€¸á€™á€¾á€¯á€™á€¾á€á€ºá€á€™á€ºá€¸", m_visit_store: "á€†á€­á€¯á€„á€ºá€›á€½á€±á€¸á€•á€«", m_visit_purpose: "á€›á€Šá€ºá€›á€½á€šá€ºá€á€»á€€á€º",
      m_purpose_inspect: "ğŸ” á€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸", m_purpose_training: "ğŸ‘¨â€ğŸ« á€á€„á€ºá€á€”á€ºá€¸", m_purpose_urgent: "ğŸš¨ á€¡á€›á€±á€¸á€•á€±á€«á€º", m_purpose_meeting: "ğŸ¤ á€¡á€…á€Šá€ºá€¸á€¡á€á€±á€¸", m_purpose_etc: "á€¡á€á€¼á€¬á€¸",
      m_visit_start: "á€…á€á€„á€ºá€™á€Šá€º", m_visit_end: "á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€™á€Šá€º", m_today_visit_log: "á€šá€”á€±á€·á€á€½á€¬á€¸á€á€¼á€„á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸", m_loading_visit: "á€á€»á€­á€á€ºá€†á€±á€¬á€„á€ºá€”á€±á€á€Šá€º...",
      m_time: "á€¡á€á€»á€­á€”á€º", m_store: "á€†á€­á€¯á€„á€º", m_type: "á€¡á€™á€»á€­á€¯á€¸á€¡á€…á€¬á€¸", m_duration: "á€€á€¼á€¬á€á€»á€­á€”á€º", m_modal_later: "á€”á€±á€¬á€€á€ºá€™á€¾", m_modal_confirm: "á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€¼á€®á€¸",
      m_no_visit: "á€šá€”á€±á€·á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­", m_select_store_name: "á€†á€­á€¯á€„á€ºá€”á€¾á€„á€·á€ºá€¡á€™á€Šá€ºá€›á€½á€±á€¸á€•á€«", m_login_fail: "á€á€„á€ºá€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«: PIN á€…á€…á€ºá€•á€«",
      m_no_history: "á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­", m_no_records: "á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­", m_receive: "ğŸ“¥ á€œá€€á€ºá€á€¶á€™á€Šá€º", m_receive_confirm: "á€œá€€á€ºá€á€¶á€™á€œá€¬á€¸?", m_select_item: "á€•á€…á€¹á€…á€Šá€ºá€¸á€›á€½á€±á€¸á€•á€«!",
      m_app_title: "Choongman Chicken", m_admin_sub: "á€€á€¼á€±á€Šá€¬á€á€»á€€á€ºáŠ á€á€½á€„á€·á€ºá€”á€¾á€„á€·á€ºá€¡á€á€»á€­á€”á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸ á€¡á€á€Šá€ºá€•á€¼á€¯", m_admin_notice: "ğŸ“¢ á€€á€¼á€±á€Šá€¬á€á€»á€€á€ºá€•á€­á€¯á€·á€™á€Šá€º", m_admin_att: "ğŸ“… á€¡á€á€»á€­á€”á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸ (á€”á€±á€¬á€€á€ºá€€á€»/OT) á€¡á€á€Šá€ºá€•á€¼á€¯",
      label_subject: "á€á€±á€«á€„á€ºá€¸á€…á€‰á€º", label_content: "á€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€¡á€›á€¬", label_all: "á€¡á€¬á€¸á€œá€¯á€¶á€¸", leave_wait: "á€†á€­á€¯á€„á€ºá€¸á€„á€¶á€·", btn_query: "á€›á€¾á€¬á€™á€Šá€º"
    },
    la: {
      login_title: "CM ERP SYSTEM", btn_login: "à»€àº‚àº»à»‰àº²àºªàº¹à»ˆàº¥àº°àºšàº»àºš", m_processing: "àºàº³àº¥àº±àº‡àº”àº³à»€àº™àºµàº™àºàº²àº™...",
      m_select_store: "à»€àº¥àº·àº­àºàºªàº²àº‚àº²", m_select_name: "à»€àº¥àº·àº­àºàºŠàº·à»ˆ", m_pin_ph: "àº¥àº°àº«àº±àº” (PIN)",
      m_logout: "àº­àº­àºàºˆàº²àºàº¥àº°àºšàº»àºš", m_tab_home: "à»œà»‰àº²àº«àº¼àº±àº", m_tab_order: "àº­à»à»€àº”àºµ", m_tab_stock: "àºàº²àº™à»ƒàºŠà»‰", m_tab_hr: "àºšàº¸àºàº„àº°àº¥àº²àºàº­àº™", m_tab_visit: "à»„àº›àºªàº²àº‚àº²", m_tab_admin: "à»àº­àº”àº¡àº´àº™",
      m_welcome: "àºàº´àº™àº”àºµàº•à»‰àº­àº™àº®àº±àºš!", m_welcome_sub: "à»€àº®àº±àº”àº§àº½àºàº¢à»ˆàº²àº‡àº›àº­àº”à»„àº!", m_notice_board: "àº›àº°àºàº²àº”", m_loading_notices: "àºàº³àº¥àº±àº‡à»‚àº«àº¼àº”...", m_no_notices: "àºšà»à»ˆàº¡àºµàº›àº°àºàº²àº”",
      m_ord_new: "àº­à»à»€àº”àºµà»ƒà»à»ˆ", m_ord_hist: "àº›àº°àº«àº§àº±àº”", m_loading_items: "àºàº³àº¥àº±àº‡à»‚àº«àº¼àº”...", m_add_cart: "à»€àºàºµà»ˆàº¡à»ƒàºªà»ˆàºàº°àº•à»ˆàº²",
      m_item: "àº¥àº²àºàºàº²àº™", m_price: "àº¥àº²àº„àº²", m_qty: "àºˆàº³àº™àº§àº™", m_sub: "àºà»ˆàº­àº", m_subtotal: "àºà»ˆàº­àº:", m_vat: "VAT (7%):", m_total: "àº¥àº§àº¡:", m_place_order: "àºªàº±à»ˆàº‡àºŠàº·à»‰", m_search_hist: "àº„àº»à»‰àº™àº«àº²àº›àº°àº«àº§àº±àº”",
      m_use_new: "à»ƒàºŠà»‰à»ƒà»à»ˆ", m_use_hist: "àº›àº°àº«àº§àº±àº”", m_add_usage: "à»€àºàºµà»ˆàº¡àºàº²àº™à»ƒàºŠà»‰", m_items_used: "à»ƒàºŠà»‰à»àº¥à»‰àº§", m_confirm_usage: "àº¢àº·àº™àº¢àº±àº™", m_search_period: "àº„àº»à»‰àº™àº«àº²à»„àº¥àºàº°",
      m_user: "àºœàº¹à»‰à»ƒàºŠà»‰", m_att_in: "â˜€ï¸ à»€àº‚àº»à»‰àº²àº‡àº²àº™", m_att_out: "ğŸŒ™ àº­àº­àºàº‡àº²àº™", m_break: "â˜• àºàº±àº", m_resume: "â–¶ àºàº±àºšàº¡àº²",
      m_today_record: "àºšàº±àº™àº—àº¶àºàº¡àº·à»‰àº™àºµà»‰", m_att_help: "àºàº»àº”àº›àº¸à»ˆàº¡à»€àºàº·à»ˆàº­àºšàº±àº™àº—àº¶àº", m_leave_stats: "àºªàº°àº–àº´àº•àº´àº¥àº²àºàº±àº (àº›àºµàº™àºµà»‰)",
      m_used_ann: "à»ƒàºŠà»‰àº¥àº²àº›àº°àºˆàº³àº›àºµ", m_used_sick: "à»ƒàºŠà»‰àº¥àº²àº›à»ˆàº§àº", m_remain: "à»€àº«àº¼àº·àº­", m_leave_req: "àº‚à»àº¥àº²àºàº±àº",
      m_annual: "àº¥àº²àº›àº°àºˆàº³àº›àºµ", m_half: "àº¥àº²àº„àº»àº§àº¡àº·à»‰", m_sick: "àº¥àº²àº›à»ˆàº§àº", m_reason_ph: "à»€àº«àº”àºœàº»àº™", m_submit_req: "àºªàº»à»ˆàº‡àº„àº³àº‚à»", m_req_hist: "àº›àº°àº«àº§àº±àº”àº„àº³àº‚à»",
      m_visit_title: "à»„àº›àºªàº²àº‚àº²", m_visit_sub: "àºšàº±àº™àº—àº¶àºàºàº²àº™àºŠà»ˆàº§àºà»€àº«àº¼àº·àº­", m_visit_store: "à»€àº¥àº·àº­àºàºªàº²àº‚àº²", m_visit_purpose: "àºˆàº¸àº”àº›àº°àºªàº»àº‡",
      m_purpose_inspect: "ğŸ” àºàº§àº”àºªàº­àºš", m_purpose_training: "ğŸ‘¨â€ğŸ« àºàº¶àºàº­àº»àºšàº®àº»àº¡", m_purpose_urgent: "ğŸš¨ àº”à»ˆàº§àº™", m_purpose_meeting: "ğŸ¤ àº›àº°àºŠàº¸àº¡", m_purpose_etc: "àº­àº·à»ˆàº™à»†",
      m_visit_start: "à»€àº‚àº»à»‰àº²àº¡àº²", m_visit_end: "àº­àº­àºà»„àº›", m_today_visit_log: "àºšàº±àº™àº—àº¶àºàºàº²àº™à»„àº›àº¡àº·à»‰àº™àºµà»‰", m_loading_visit: "àºàº³àº¥àº±àº‡à»‚àº«àº¼àº”...",
      m_time: "à»€àº§àº¥àº²", m_store: "àºªàº²àº‚àº²", m_type: "àº›àº°à»€àºàº”", m_duration: "à»„àº¥àºàº°", m_modal_later: "àºàº²àºàº«àº¼àº±àº‡", m_modal_confirm: "àº¢àº·àº™àº¢àº±àº™",
      m_no_visit: "àºšà»à»ˆàº¡àºµàºšàº±àº™àº—àº¶àºàº¡àº·à»‰àº™àºµà»‰", m_select_store_name: "à»€àº¥àº·àº­àºàºªàº²àº‚àº²à»àº¥àº°àºŠàº·à»ˆ", m_login_fail: "à»€àº‚àº»à»‰àº²àºšà»à»ˆàºªàº³à»€àº¥àº±àº”: àºàº§àº” PIN",
      m_no_history: "àºšà»à»ˆàº¡àºµàº›àº°àº«àº§àº±àº”", m_no_records: "àºšà»à»ˆàºàº»àºšàº‚à»à»‰àº¡àº¹àº™", m_receive: "ğŸ“¥ àº®àº±àºš", m_receive_confirm: "àº®àº±àºšàºªàº´àº™àº„à»‰àº²?", m_select_item: "à»€àº¥àº·àº­àºàº¥àº²àºàºàº²àº™àºà»ˆàº­àº™!",
      m_app_title: "Choongman Chicken", m_admin_sub: "àº›àº°àºàº²àº”, àº­àº°àº™àº¸àº¡àº±àº”àº¥àº²àºàº±àº à»àº¥àº° àº¡àº²àº‡àº²àº™", m_admin_notice: "ğŸ“¢ àºªàº»à»ˆàº‡àº›àº°àºàº²àº”", m_admin_att: "ğŸ“… àº­àº°àº™àº¸àº¡àº±àº”àº¡àº²àº‡àº²àº™ (àºªàº²àº/OT)",
      label_subject: "àº«àº»àº§àº‚à»à»‰", label_content: "à»€àº™àº·à»‰àº­à»ƒàº™", label_all: "àº—àº±àº‡à»àº»àº”", leave_wait: "àº¥à»àº–à»‰àº²", btn_query: "àº„àº»à»‰àº™àº«àº²"
    }
  };

  function getTranslationLang() {
    var c = currentLang || "ko";
    if (c === "mm") return "my";
    if (c === "la") return "lo";
    return c;
  }
  function changeLanguage() {
    var sel = document.getElementById("langSelect");
    if (!sel) return;
    currentLang = sel.value || "ko";
    try { sessionStorage.setItem("cm_lang", currentLang); } catch (e) {}
    applyTranslations();
  }
  function applyTranslations() {
    var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : (I18N.ko || {});
    var root = document.body || document.documentElement;
    if (!root) return;
    var list = root.querySelectorAll ? root.querySelectorAll("[data-i18n]") : [];
    for (var i = 0; i < list.length; i++) {
      var el = list[i];
      var key = el.getAttribute("data-i18n");
      if (!key) continue;
      var text = lang[key];
      if (text === undefined) text = (I18N.ko && I18N.ko[key]) ? I18N.ko[key] : "";
      if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
        if (key.indexOf("_ph") >= 0 || el.placeholder !== undefined) el.placeholder = text;
        else if (el.type === "submit" || el.type === "button") el.value = text;
      } else {
        el.textContent = text;
      }
    }
    var s = document.getElementById("storeSelect");
    if (s && s.options.length && s.options[0]) s.options[0].text = (lang.m_select_store != null ? lang.m_select_store : "Select Store...");
    var n = document.getElementById("loginName");
    if (n && n.options.length && n.options[0]) n.options[0].text = (lang.m_select_name != null ? lang.m_select_name : "Select Name...");
  }

  /**
   * 2. ì‹¤ì‹œê°„ ì‹œê³„ (1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸)
   */
  setInterval(function() { 
    var clock = document.getElementById("live-clock");
    if(clock) clock.innerText = new Date().toLocaleTimeString('en-GB'); 
  }, 1000);

  /**
   * 3. [í•µì‹¬] í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë¡œì§
   */
  window.onload = function() {
    // [ë‹¤êµ­ì–´] ë¡œê·¸ì¸ í™”ë©´ ì–¸ì–´ ë³µì› ë° ì ìš© (ì €ì¥ëœ ì–¸ì–´ë¡œ ë“œë¡­ë‹¤ìš´ ë§ì¶¤ í›„ ë²ˆì—­ ì ìš©)
    var langSel = document.getElementById("langSelect");
    if (langSel) {
      if (currentLang) langSel.value = currentLang;
      else currentLang = langSel.value || "ko";
    }
    applyTranslations();

    // [ë‚ ì§œ ì´ˆê¸°í™”] ëª¨ë“  ë°ì´íŠ¸ ì…ë ¥ì¹¸ì„ ì˜¤ëŠ˜ë¡œ ì„¸íŒ…
    var today = new Date();
    var todayStr = today.toISOString().substring(0, 10);
    var dateIds = ['use-start', 'use-end', 'hist-start', 'hist-end', 'noticeStart', 'noticeEnd'];
    dateIds.forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = todayStr; });
    
    var tmr = new Date(today); tmr.setDate(tmr.getDate() + 1);
    if(document.getElementById('leaveDate')) document.getElementById('leaveDate').value = tmr.toISOString().substring(0, 10);

    // [ê¸°ì´ˆ ê³µì§€ ë¡œë“œ] í™ˆ í™”ë©´ ìƒë‹¨ ì•Œë¦¼
    google.script.run.withSuccessHandler(txt => { 
      if(txt && document.getElementById("home-notice-content")) document.getElementById("home-notice-content").innerText = txt; 
    }).getNotice();

    // [ë°ì´í„° í†µí•© ë¡œë“œ] ë§¤ì¥, ì§ì› ëª©ë¡ì„ ê°€ì ¸ì˜¨ í›„ UIë¥¼ êµ¬ì„±
    load(1);
    google.script.run.withSuccessHandler(d => { 
      load(0);
      loginData = d.users; // { "ë§¤ì¥ëª…": ["ì§ì›1", "ì§ì›2"], ... }
      
      fillStoreSelect("storeSelect");        // ë¡œê·¸ì¸ í™”ë©´ ë“œë¡­ë‹¤ìš´
      fillStoreSelect("visit-store-select"); // ë°©ë¬¸ ê¸°ë¡ í™”ë©´ ë“œë¡­ë‹¤ìš´

      // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ ë°©ë¬¸ ê¸°ë¡ í™•ì¸
      if(loggedInUser) checkActiveVisitStatus();

    }).withFailureHandler(err => { alert("Server Error: " + err); }).getLoginData(); 

    if(loggedInStore) {
        loadNotices();
        if(typeof loadTodayVisitLog === 'function') loadTodayVisitLog();
    }
  };

  /**
   * 4. ë¡œê·¸ì¸ ë° ë“œë¡­ë‹¤ìš´ ì—°ë™ ë¡œì§
   */
  // ë§¤ì¥ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
  function fillStoreSelect(id) {
    var s = document.getElementById(id);
    if(!s || !loginData) return;
    var txt = (I18N[currentLang] || I18N.ko).m_select_store || "Select Store...";
    s.innerHTML = "<option value=''>" + txt + "</option>";
    var officeKey = loginData["Office"] ? "Office" : (loginData["ë³¸ì‚¬"] ? "ë³¸ì‚¬" : null);
    if (officeKey) s.add(new Option("Office (ë³¸ì‚¬)", officeKey)); 
    for (var k in loginData) { if (k !== officeKey) s.add(new Option(k, k)); }
  }

  // [ì¤‘ìš”] ë§¤ì¥ ì„ íƒ ì‹œ í•´ë‹¹ ë§¤ì¥ ì§ì› ëª…ë‹¨ ì±„ìš°ê¸°
  function onStoreChange() { 
    var s = document.getElementById("storeSelect").value;
    var n = document.getElementById("loginName");
    if(!n) return;
    var txt = (I18N[currentLang] || I18N.ko).m_select_name || "Select Name...";
    n.innerHTML = "<option value=''>" + txt + "</option>";
    if(loginData[s]) { 
      loginData[s].forEach(name => { n.add(new Option(name, name)); }); 
    }
  }

  /**
 * [í†µí•©] ëª¨ë°”ì¼ ì•± ë¡œê·¸ì¸ ì‹œë„ ë° ê¶Œí•œ ì œì–´ í•¨ìˆ˜
 * ë¡œê·¸ì¸ í™”ë©´ì€ ì–¸ì–´ ì„ íƒ ì˜í–¥ ì—†ì´ ë²„íŠ¼ ë¬¸êµ¬ëŠ” í•­ìƒ ì˜ì–´(Login / Processing...) ì‚¬ìš©
 */
function tryLogin() {
  var s = document.getElementById("storeSelect").value;
  var n = document.getElementById("loginName").value;
  var p = document.getElementById("loginPw").value;
  var lang = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang] : {};
  if (!s || !n) return alert(lang.m_select_store_name || "Select Store and Name");

  var btn = document.getElementById("btn-login");
  if (btn) btn.innerText = "Processing...";

  google.script.run.withSuccessHandler(function(res) {
    if (btn) btn.innerText = "Login";
    if (res.success) {
      // 1. ë¡œê·¸ì¸ ìœ ì € ì •ë³´ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      loggedInStore = res.storeName; 
      loggedInUser = res.userName; 
      loggedInRole = res.role;
      
      // 2. í™”ë©´ ì „í™˜ ë° ìœ ì € ì´ë¦„ ì„¸íŒ…
      document.getElementById("login-screen").style.display = "none"; 
      document.getElementById("app-screen").style.display = "block";
      if (document.getElementById("hr-username")) {
        document.getElementById("hr-username").innerText = loggedInUser;
      }
      
      // 3. [ê¶Œí•œ ì œì–´] Visit íƒ­ ë…¸ì¶œ ì—¬ë¶€ ê²°ì • (Office/ë³¸ì‚¬ ì†Œì†ë§Œ ê°€ëŠ¥)
      var visitTab = document.getElementById("tab-store-visit");
      if (visitTab) {
        // ì†Œì† ë§¤ì¥ì´ Office ë˜ëŠ” ë³¸ì‚¬ì¸ ê²½ìš°ë§Œ hidden í´ë˜ìŠ¤ ì œê±°
        if (loggedInStore === "Office" || loggedInStore === "ë³¸ì‚¬") {
          visitTab.classList.remove("hidden");
        } else {
          visitTab.classList.add("hidden");
        }
      }
      
      // 4. [ê¶Œí•œ ì œì–´] Admin(ê´€ë¦¬ì) íƒ­ ë…¸ì¶œ ì—¬ë¶€ ê²°ì •
      var role = loggedInRole.toLowerCase();
      var adminRoles = ['manager', 'ceo', 'hr', 'director', 'officer'];
      if (adminRoles.some(r => role.includes(r))) {
        if (document.getElementById("tab-admin")) {
          document.getElementById("tab-admin").classList.remove("hidden");
        }
      }
      
      // 5. ì•± êµ¬ë™ì— í•„ìš”í•œ ë°ì´í„° ë¡œë“œ ë° ìƒíƒœ ì²´í¬
      loadData();               // ë¬¼ë¥˜ ë°ì´í„°
      loadNotices();            // ê³µì§€ì‚¬í•­
      checkActiveVisitStatus(); // í˜„ì¬ ë°©ë¬¸ ì¤‘ì¸ì§€ ì—¬ë¶€ ì²´í¬
      
      // ë¡œê·¸ì¸ í›„ ì„ íƒí•œ ì–¸ì–´ë¥¼ í™•ì‹¤íˆ ë°˜ì˜ (langSelectì—ì„œ ë‹¤ì‹œ ì½ê³ , í™”ë©´ í‘œì‹œ í›„ ë²ˆì—­ ì ìš©)
      var langSel = document.getElementById("langSelect");
      if (langSel && langSel.value) currentLang = langSel.value;
      try { if (typeof sessionStorage !== "undefined") sessionStorage.setItem("cm_lang", currentLang); } catch (e) {}
      setTimeout(function() { applyTranslations(); }, 150);
    } else {
      alert(lang.m_login_fail || "Login Failed: Check PIN.");
    }
  }).withFailureHandler(function(err) {
    if (btn) btn.innerText = "Login";
    alert("Server Error: " + (err && err.message ? err.message : String(err)));
  }).loginCheck(s, n, p);
}

  /**
   * 5. ë©”ì¸ íƒ­ ì „í™˜ ë° ë°ì´í„° ë¦¬ë¡œë“œ
   */
  function switchTab(m) {
  // âœ… ì—¬ê¸°ì— 'store-visit'ì´ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ ëª¨ë“  íƒ­ì´ ì •ìƒì ìœ¼ë¡œ êº¼ì§‘ë‹ˆë‹¤.
  var views = ['home', 'order', 'stock', 'hr', 'admin', 'store-visit']; 
  
  views.forEach(x => {
    var v = document.getElementById('view-' + x);
    var t = document.getElementById('tab-' + x);
    if (v) v.classList.add('hidden');
    if (t) t.classList.remove('active'); // ì—¬ê¸°ì„œ Visit íƒ­ì˜ ë¶ˆì„ ë•ë‹ˆë‹¤.
  });

  var targetView = document.getElementById('view-' + m);
  var targetTab = document.getElementById('tab-' + m);
  if (targetView) targetView.classList.remove('hidden');
  if (targetTab) targetTab.classList.add('active');

  // íƒ­ ì´ë™ ì‹œ ë°ì´í„° ë¡œë“œ ë¡œì§ ìœ ì§€
  if(m === 'stock') { if(typeof refreshStock === 'function') refreshStock(); }
  if(m === 'order') { if(allItems.length > 0) renderLists(); else loadData(); }
  if(m === 'hr') { if(typeof loadMyLeaveInfo === 'function') loadMyLeaveInfo(); }
  if(m === 'store-visit') { 
      if(typeof loadTodayVisitLog === 'function') loadTodayVisitLog(); 
      fillStoreSelect("visit-store-select"); 
  }
  if(m === 'admin') {
    if(typeof loadMobileAdminOptions === 'function') loadMobileAdminOptions();
  }
}

  /**
   * 6. ê³µì§€ì‚¬í•­ ë¡œì§
   */
  function loadNotices() {
    google.script.run.withSuccessHandler(list => {
      myNotices = list; renderNotices();
      var newNotice = list.find(n => n.status === 'New');
      if (newNotice) openNoticeModal(newNotice);
    }).getMyNotices(loggedInStore, loggedInRole, loggedInUser);
  }

  function renderNotices() {
    var box = document.getElementById("notice-list-box");
    if(!box) return; box.innerHTML = "";
    var lang = I18N[currentLang] || I18N.ko;
    var s = document.getElementById("noticeStart").value, e = document.getElementById("noticeEnd").value;
    var filtered = myNotices.filter(function(n){ return (!s || n.date >= s) && (!e || n.date <= e); });
    if (filtered.length === 0) { box.innerHTML = "<div class='text-center py-4 text-muted'>" + (lang.m_no_notices || "ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.") + "</div>"; return; }
    var texts = filtered.map(function(n){ return n.title || ""; });
    var targetLang = typeof getTranslationLang === "function" ? getTranslationLang() : "ko";
    if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
      filtered.forEach(function(n){ appendNoticeItem(box, n, n.title); });
      return;
    }
    google.script.run.withSuccessHandler(function(translated) {
      filtered.forEach(function(n, i){ appendNoticeItem(box, n, (translated && translated[i] !== undefined) ? translated[i] : n.title); });
    }).translateBatch(texts, targetLang);
  }

  function appendNoticeItem(box, n, titleText) {
    var badge = n.status === "New" ? "<span style='background:#F44336;color:white;font-size:10px;padding:2px 6px;border-radius:4px;'>NEW</span>" : "";
    var item = document.createElement("div");
    item.style.cssText = "border-bottom:1px solid #eee; padding:12px 0; cursor:pointer;";
    item.innerHTML = "<div style=\"display:flex;justify-content:space-between;\"><span>" + n.date + "</span>" + badge + "</div><div style=\"font-weight:bold;\">" + (titleText || "") + "</div>";
    item.onclick = function() { openNoticeModal(n); };
    box.appendChild(item);
  }

  function openNoticeModal(n) {
    document.getElementById("modalNoticeId").value = n.id;
    document.getElementById("modalDate").innerText = n.date + " (From: " + n.sender + ")";
    renderNoticeAttachments(n);
    var targetLang = typeof getTranslationLang === "function" ? getTranslationLang() : "ko";
    if (targetLang === "ko" || (!n.title && !n.content)) {
      document.getElementById("modalTitle").innerText = n.title || "";
      document.getElementById("modalContent").innerText = n.content || "";
      document.getElementById("noticeModal").style.display = "flex";
      return;
    }
    var texts = [n.title || "", n.content || ""];
    google.script.run.withSuccessHandler(function(translated) {
      document.getElementById("modalTitle").innerText = translated[0] !== undefined ? translated[0] : n.title;
      document.getElementById("modalContent").innerText = translated[1] !== undefined ? translated[1] : n.content;
      document.getElementById("noticeModal").style.display = "flex";
    }).translateBatch(texts, targetLang);
  }

  function renderNoticeAttachments(n) {
    var el = document.getElementById("modalAttachments");
    if (!el) return;
    el.innerHTML = "";
    if (!n.attachments || n.attachments.length === 0) return;
    var lang = I18N[currentLang] || I18N.ko;
    var label = (lang.notice_attach || "ğŸ“ ì²¨ë¶€íŒŒì¼").replace(/ğŸ“\s*/, "");
    var wrap = document.createElement("div");
    wrap.style.borderTop = "1px solid #eee";
    wrap.style.paddingTop = "10px";
    wrap.style.marginTop = "10px";
    var title = document.createElement("div");
    title.style.fontWeight = "bold";
    title.style.marginBottom = "8px";
    title.textContent = "ğŸ“ " + label;
    wrap.appendChild(title);
    n.attachments.forEach(function(a) {
      if (a.error) return;
      var isImg = (a.mime || "").indexOf("image/") === 0;
      if (isImg) {
        var img = document.createElement("img");
        img.src = a.url || ("https://drive.google.com/uc?export=view&id=" + (a.id || ""));
        img.alt = a.name || "";
        img.style.maxWidth = "100%";
        img.style.maxHeight = "180px";
        img.style.objectFit = "contain";
        img.style.borderRadius = "8px";
        img.style.marginBottom = "8px";
        wrap.appendChild(img);
      } else {
        var link = document.createElement("a");
        link.href = a.url || ("https://drive.google.com/uc?export=download&id=" + (a.id || ""));
        link.target = "_blank";
        link.rel = "noopener";
        link.textContent = a.name || "íŒŒì¼";
        link.style.display = "block";
        link.style.marginBottom = "6px";
        link.style.color = "#E65100";
        wrap.appendChild(link);
      }
    });
    el.appendChild(wrap);
  }

  function actNotice(action) {
    var id = document.getElementById("modalNoticeId").value;
    document.getElementById("noticeModal").style.display = "none";
    var target = myNotices.find(x => x.id == id);
    if (target) target.status = action; renderNotices();
    google.script.run.logNoticeRead(id, loggedInStore, loggedInUser, action);
  }

  /**
   * 7. ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° ë¡œë“œ
   */
  function load(on) { var el=document.getElementById("loading"); if(el) el.style.display=on?"flex":"none"; }
  
  function loadData() { 
    var loadingTxt = (I18N[currentLang] || I18N.ko).m_loading_items || "Loading...";
    if(document.getElementById("orderMenuWrapper")) document.getElementById("orderMenuWrapper").innerHTML = loadingTxt; 
    if(document.getElementById("stockListWrapper")) document.getElementById("stockListWrapper").innerHTML = loadingTxt;
    google.script.run.withSuccessHandler(function(res) { allItems = res.items; currentStock = res.stock || {}; if(typeof renderLists === "function") renderLists(); }).getAppData(loggedInStore); 
  }

  function convertDriveLink(url) {
    if (!url) return ""; var id = "";
    try { var match = url.match(/\/d\/([a-zA-Z0-9_-]+)/); if (match) id = match[1]; else if (url.indexOf("id=") > -1) id = url.split("id=")[1].split("&")[0]; } catch(e) {}
    return id ? "https://drive.google.com/uc?export=view&id=" + id : url;
  }

  /* ========== [ëª¨ë°”ì¼ Admin] ê³µì§€ ë°œì†¡ / ì—°ì°¨Â·ê·¼íƒœ ìŠ¹ì¸ ========== */
  var mobileAdminLeaveData = null;
  var mobileAdminAttData = null;

  function loadMobileAdminOptions() {
    google.script.run.withSuccessHandler(function(opt) {
      var stores = opt.stores || [];
      var roles = opt.roles || [];
      var allStoresText = (I18N[currentLang] && I18N[currentLang].label_all) ? I18N[currentLang].label_all : "ì „ì²´";
      var allRolesText = allStoresText;
      var storeSel = document.getElementById("admin-notice-stores");
      var roleSel = document.getElementById("admin-notice-roles");
      var leaveStoreSel = document.getElementById("admin-leave-store");
      var attStoreSel = document.getElementById("admin-att-store");
      function fillSelect(sel, list, allText, allVal) {
        if (!sel) return;
        sel.innerHTML = "";
        if (list.length > 1) { sel.add(new Option(allText, allVal || "ì „ì²´")); }
        list.forEach(function(s) { sel.add(new Option(s, s)); });
      }
      fillSelect(storeSel, stores, allStoresText, "ì „ì²´");
      fillSelect(roleSel, roles, allRolesText, "ì „ì²´");
      fillSelect(leaveStoreSel, stores, allStoresText, "All");
      fillSelect(attStoreSel, stores, allStoresText, "All");
      var today = new Date().toISOString().substring(0, 10);
      var startEl = document.getElementById("admin-att-start");
      var endEl = document.getElementById("admin-att-end");
      if (startEl && !startEl.value) startEl.value = today;
      if (endEl && !endEl.value) endEl.value = today;
    }).getNoticeOptionsForMobile(typeof loggedInStore !== "undefined" ? loggedInStore : "", typeof loggedInRole !== "undefined" ? loggedInRole : "");
  }

  function mobileSendNotice() {
    var title = document.getElementById("admin-notice-title") && document.getElementById("admin-notice-title").value;
    var content = document.getElementById("admin-notice-content") && document.getElementById("admin-notice-content").value;
    var targetStore = document.getElementById("admin-notice-stores") && document.getElementById("admin-notice-stores").value;
    var targetRole = document.getElementById("admin-notice-roles") && document.getElementById("admin-notice-roles").value;
    if (!title || !content) { alert((I18N[currentLang] && I18N[currentLang].label_subject) ? "ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." : "Enter title and content."); return; }
    var data = { title: title, content: content, targetStore: targetStore || "ì „ì²´", targetRole: targetRole || "ì „ì²´", sender: typeof loggedInUser !== "undefined" ? loggedInUser : "", attachments: [] };
    google.script.run.withSuccessHandler(function(msg) { alert(msg); document.getElementById("admin-notice-title").value = ""; document.getElementById("admin-notice-content").value = ""; }).withFailureHandler(function(err) { alert(err.message || "Failed"); }).adminSaveNotice(data, typeof loggedInRole !== "undefined" ? loggedInRole : "");
  }

  function mobileLoadLeaveList() {
    google.script.run.withSuccessHandler(function(raw) {
      mobileAdminLeaveData = raw;
      var storeFilter = document.getElementById("admin-leave-store") && document.getElementById("admin-leave-store").value;
      var statusFilter = document.getElementById("admin-leave-status") && document.getElementById("admin-leave-status").value;
      var list = (raw.leaves || []).filter(function(l) {
        var matchStore = !storeFilter || storeFilter === "All" || l.store === storeFilter;
        var matchStatus = !statusFilter || statusFilter === "All" || (l.status && String(l.status).trim() === statusFilter);
        return matchStore && matchStatus;
      });
      var box = document.getElementById("admin-leave-list");
      if (!box) return;
      if (!list.length) { box.innerHTML = "<div class='text-muted text-center py-4 small'>" + ((I18N[currentLang] && I18N[currentLang].leave_wait) ? "ëŒ€ê¸° ê±´ì´ ì—†ìŠµë‹ˆë‹¤." : "No pending items.") + "</div>"; return; }
      box.innerHTML = list.map(function(l) {
        return "<div class='border-bottom py-2 px-2' style='display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:6px;'>" +
          "<div><b>" + (l.store || "") + "</b> " + (l.name || "") + " Â· " + (l.type || "") + " " + (l.date || "") + "<br><small class='text-muted'>" + (l.reason || "") + " Â· " + (l.status || "") + "</small></div>" +
          (l.status === "ëŒ€ê¸°" || l.status === "Pending" ? "<div><button type='button' class='btn btn-sm' style='background:#4caf50;color:white;' onclick='mobileLeaveDecision(" + l.row + ",\"ìŠ¹ì¸\")'>ìŠ¹ì¸</button> <button type='button' class='btn btn-sm btn-danger' onclick='mobileLeaveDecision(" + l.row + ",\"ë°˜ë ¤\")'>ë°˜ë ¤</button></div>" : "") + "</div>";
      }).join("");
    }).withFailureHandler(function() { if (document.getElementById("admin-leave-list")) document.getElementById("admin-leave-list").innerHTML = "<div class='text-muted text-center py-4 small'>ì¡°íšŒ ì‹¤íŒ¨</div>"; }).getLeaveAllDataForMobile(typeof loggedInStore !== "undefined" ? loggedInStore : "", typeof loggedInRole !== "undefined" ? loggedInRole : "");
  }

  function mobileLeaveDecision(row, decision) {
    google.script.run.withSuccessHandler(function(msg) { alert(msg); mobileLoadLeaveList(); }).withFailureHandler(function(err) { alert(err.message || "Failed"); }).processLeaveDecisionMobile(row, decision, typeof loggedInStore !== "undefined" ? loggedInStore : "", typeof loggedInRole !== "undefined" ? loggedInRole : "");
  }

  function mobileLoadAttendancePending() {
    var startEl = document.getElementById("admin-att-start");
    var endEl = document.getElementById("admin-att-end");
    var storeEl = document.getElementById("admin-att-store");
    var start = startEl && startEl.value ? startEl.value : "";
    var end = endEl && endEl.value ? endEl.value : "";
    var storeFilter = storeEl && storeEl.value ? storeEl.value : "";
    google.script.run.withSuccessHandler(function(list) {
      mobileAdminAttData = list;
      var box = document.getElementById("admin-att-list");
      if (!box) return;
      if (!list || !list.length) { box.innerHTML = "<div class='text-muted text-center py-4 small'>" + ((I18N[currentLang] && I18N[currentLang].leave_wait) ? "ìŠ¹ì¸ ëŒ€ê¸° ê±´ì´ ì—†ìŠµë‹ˆë‹¤." : "No pending items.") + "</div>"; return; }
      box.innerHTML = list.map(function(a) {
        var label = (a.status === "ì§€ê°" ? "ì§€ê° " + (a.late || 0) + "ë¶„" : "") + (a.ot ? " OT " + (a.ot || 0) + "ë¶„" : "") || (a.status || a.type || "ëŒ€ê¸°");
        return "<div class='border-bottom py-2 px-2' style='display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:6px;'>" +
          "<div><b>" + (a.store || "") + "</b> " + (a.name || "") + " Â· " + (a.timestamp || "") + " " + (a.type || "") + "<br><small class='text-muted'>" + label + " Â· " + (a.reason || "") + "</small></div>" +
          "<div><button type='button' class='btn btn-sm' style='background:#2e7d32;color:white;' onclick='mobileAttDecision(" + a.row + ",\"ìŠ¹ì¸ì™„ë£Œ\")'>ìŠ¹ì¸</button> <button type='button' class='btn btn-sm btn-danger' onclick='mobileAttDecision(" + a.row + ",\"ë°˜ë ¤\")'>ë°˜ë ¤</button></div></div>";
      }).join("");
    }).withFailureHandler(function() { if (document.getElementById("admin-att-list")) document.getElementById("admin-att-list").innerHTML = "<div class='text-muted text-center py-4 small'>ì¡°íšŒ ì‹¤íŒ¨</div>"; }).getAttendancePendingForMobile(typeof loggedInStore !== "undefined" ? loggedInStore : "", typeof loggedInRole !== "undefined" ? loggedInRole : "", start, end, storeFilter === "All" ? "" : storeFilter);
  }

  function mobileAttDecision(row, decision) {
    google.script.run.withSuccessHandler(function(msg) { alert(msg); mobileLoadAttendancePending(); }).withFailureHandler(function(err) { alert(err.message || "Failed"); }).processAttendanceApprovalMobile(row, decision, typeof loggedInStore !== "undefined" ? loggedInStore : "", typeof loggedInRole !== "undefined" ? loggedInRole : "");
  }
</script>