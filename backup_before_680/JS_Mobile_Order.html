<script>

 function renderLists(){
      if(!allItems) return;
      renderCategoryView("orderMenuWrapper", "order");
      renderCategoryView("stockListWrapper", "stock");
    }
    
    // [ÏàòÏ†ï] Î™©Î°ù Í∑∏Î¶¨Í∏∞ (Î∞∞Ïó¥ Îç∞Ïù¥ÌÑ∞ Ïù∏Ïãù + Ïä¨Î¶º ÎîîÏûêÏù∏)
    function renderCategoryView(target, mode){
      var w=document.getElementById(target); if(!w) return; w.innerHTML=""; 
      
      // ‚òÖ ÌïµÏã¨ ÏàòÏ†ï: Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥(Array)Ïù¥ÎØÄÎ°ú Ïù∏Îç±Ïä§[1]Î°ú Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Ï∞æÏäµÎãàÎã§.
      var g={}; 
      allItems.forEach(r=>{ 
        var cat = r[1]; // 1Î≤à Ïπ∏Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨
        if(!g[cat]) g[cat]=[]; 
        g[cat].push(r); 
      });
      
      // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Í∞ÄÎÇòÎã§Ïàú Ï†ïÎ†¨
      var keys = Object.keys(g).sort();

      keys.forEach(c => {
        var h=document.createElement("div"); h.className="category-header"; h.innerHTML=`<span>${c}</span><span>‚ñº</span>`;
        var con=document.createElement("div"); con.className="menu-container"; con.style.display="none"; 
        var grid=document.createElement("div"); grid.className="menu-grid";
        
        g[c].forEach(r=>{
          var i=document.createElement("div"); i.className="menu-item";
          
          // Îç∞Ïù¥ÌÑ∞ Îß§Ìïë (Code.gs V108 Î∞∞Ïó¥ ÏàúÏÑú Í∏∞Ï§Ä)
          // 0:ÏΩîÎìú, 1:Ïπ¥ÌÖåÍ≥†Î¶¨, 2:Ïù¥Î¶Ñ, 3:Í∑úÍ≤©, 4:Í∞ÄÍ≤©, 6:Ïù¥ÎØ∏ÏßÄ, 8:ÏïàÏ†ÑÏû¨Í≥†, 9:Í≥ºÏÑ∏
          var code = r[0], name = r[2], spec = r[3], price = r[4], imgUrl = r[6], safe = r[8], tax = r[9];
          var qty = Number(currentStock[code])||0;
          
          var isLow = qty <= Number(safe||0);
          var badgeColor = isLow ? "#F44336" : "#4CAF50";
          var badgeText = isLow ? `Low:${qty}` : `Stock:${qty}`;
          
          // ÏÇ¨ÏßÑ Î≤ÑÌäº
          var photoBtn = "";
          if(imgUrl && imgUrl.length > 5) {
             photoBtn = `<button class="btn-photo" onclick="event.stopPropagation(); window.open('${imgUrl}', '_blank')">üì∑</button>`;
          }

          var rightHtml = "";
          if(mode==='order') rightHtml = `<div class="item-price">${Number(price).toLocaleString()} ‡∏ø</div>`;

          i.innerHTML = `
            <div class="item-left">
               ${photoBtn}
               <span class="item-name">${name}</span>
               <span class="item-spec">${spec ? '('+spec+')' : ''}</span>
               <span class="stock-badge" style="background:${badgeColor}">${badgeText}</span>
               ${(tax==='Î©¥ÏÑ∏') ? '<span class="stock-badge" style="background:#9E9E9E">Î©¥ÏÑ∏</span>' : ''}
            </div>
            <div class="item-right">
               ${rightHtml}
            </div>
          `;
          
          i.onclick=function(){ 
             document.querySelectorAll('#'+target+' .menu-item').forEach(e=>e.classList.remove('selected')); 
             i.classList.add('selected'); 
             if(mode==='order') selectedItem={code:code, name:name, price:price, tax:tax}; 
             else selectedUsageItem={code:code, name:name}; 
          };
          grid.appendChild(i);
        });
        
        con.appendChild(grid); 
        h.onclick=(function(ct){ return function(){ ct.style.display=ct.style.display==='none'?'block':'none'; } })(con);
        w.appendChild(h); w.appendChild(con);
      });
    }

    // [Í∏∞ÌÉÄ ÌÉ≠ Ï†ÑÌôò Î∞è Í∏∞Îä•Îì§

    function loadMyLeaveInfo() {
      google.script.run.withSuccessHandler(function(d) {
        document.getElementById("my-ann").innerText = d.stats.usedAnn;
        document.getElementById("my-sick").innerText = d.stats.usedSick;
        document.getElementById("my-remain").innerText = d.stats.remain;
        var listDiv = document.getElementById("my-leave-list");
        listDiv.innerHTML = "";
        var noRec = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_no_records : "No records found.";
        if (!d.history || d.history.length === 0) { listDiv.innerHTML = "<div style='text-align:center; color:#999; padding:10px;'>" + noRec + "</div>"; return; }
        var texts = d.history.map(function(item){ return item.reason || ""; });
        var targetLang = typeof getTranslationLang === "function" ? getTranslationLang() : "ko";
        if (targetLang === "ko" || texts.every(function(t){ return !t || !String(t).trim(); })) {
          d.history.forEach(function(item){ renderLeaveItem(listDiv, item, item.reason); });
          return;
        }
        google.script.run.withSuccessHandler(function(translated) {
          d.history.forEach(function(item, i){ renderLeaveItem(listDiv, item, (translated && translated[i] !== undefined) ? translated[i] : item.reason); });
        }).translateBatch(texts, targetLang);
      }).getMyLeaveInfo(loggedInStore, loggedInUser);
    }
    function renderLeaveItem(listDiv, item, reasonText) {
      var badgeColor = item.status === "ÏäπÏù∏" ? "#4CAF50" : (item.status === "Î∞òÎ†§" ? "#F44336" : "#9E9E9E");
      listDiv.innerHTML += "<div class=\"leave-item\"><div><div style=\"font-weight:bold; font-size:14px;\">" + item.date + " (" + item.type + ")</div><div style=\"font-size:12px; color:#666;\">" + (reasonText || "") + "</div></div><span style=\"background:" + badgeColor + "; color:white; padding:3px 8px; border-radius:5px; font-size:11px;\">" + item.status + "</span></div>";
    }
    function switchOrderTab(t){ document.getElementById('order-new-area').style.display = t==='new'?'block':'none'; document.getElementById('order-hist-area').style.display = t==='hist'?'block':'none'; document.getElementById('ord-sub-new').classList.toggle('active', t==='new'); document.getElementById('ord-sub-hist').classList.toggle('active', t==='hist'); if(t==='hist') loadHistory(); }
    
    function changeLanguage() { }
    function adjustQty(type, delta){ var id = type==='order' ? 'qtyInputOrder' : 'qtyInputUsage'; var el = document.getElementById(id); if(el) { var val = Number(el.value) + delta; if(val < 1) val = 1; el.value = val; } }
    function addToCart(type){ var msg = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_select_item : "Select an Item first!"; if(type==='order'){ if(!selectedItem) return alert(msg); var q=document.getElementById("qtyInputOrder").value; cart.push({...selectedItem, qty:q}); updateCart('order'); } else { if(!selectedUsageItem) return alert(msg); var q=document.getElementById("qtyInputUsage").value; usageCart.push({...selectedUsageItem, qty:q}); updateCart('usage'); } }

    /* [ÏàòÏ†ï] updateCart Ìï®Ïàò ÎÇ¥Î∂ÄÏùò Í≥ÑÏÇ∞ Î∂ÄÎ∂Ñ (ÏïΩ 275~280Ï§Ñ) */
function updateCart(type){ 
  if(type==='order'){ 
    var b=document.querySelector("#cartTable tbody"); 
    b.innerHTML=""; 
    var sub=0; 
    var vatTotal=0; // Î∂ÄÍ∞ÄÏÑ∏ ÎàÑÏ†Å Î≥ÄÏàò

    cart.forEach((i,idx)=>{ 
      var t=i.price*i.qty; 
      sub+=t; 
      
      // ‚òÖ ÌïµÏã¨: Í≥ºÏÑ∏(VAT) ÌíàÎ™©Îßå 7% Í≥ÑÏÇ∞, Î©¥ÏÑ∏Îäî 0Ïõê
      var itemTax = (i.tax === 'Î©¥ÏÑ∏') ? 0 : Math.round(t * 0.07);
      vatTotal += itemTax;

      b.innerHTML+=`<tr><td>${i.name}<br><small style='color:#999'>${i.tax||'VAT'}</small></td><td class="text-right">${Number(i.price).toLocaleString()}</td><td class="text-right">${i.qty}</td><td class="text-right">${t.toLocaleString()}</td><td onclick="cart.splice(${idx},1);updateCart('order')">‚ùå</td></tr>`; 
    }); 
    
    // Ìï©Í≥Ñ ÌëúÏãú
    document.getElementById("displaySub").textContent=sub.toLocaleString()+" ‡∏ø"; 
    document.getElementById("displayVat").textContent=vatTotal.toLocaleString()+" ‡∏ø"; 
    document.getElementById("displayTotal").textContent=(sub+vatTotal).toLocaleString()+" ‡∏ø"; 
  } else { 
    // (Usage Î∂ÄÎ∂ÑÏùÄ Í∑∏ÎåÄÎ°ú ÎëêÏÑ∏Ïöî)
    var b=document.querySelector("#usageCartTable tbody"); b.innerHTML=""; usageCart.forEach((i,idx)=>{ b.innerHTML+=`<tr><td>${i.name}</td><td class="text-right">${i.qty}</td><td class="text-right" onclick="usageCart.splice(${idx},1);updateCart('usage')">‚ùå</td></tr>`; }); 
  } 
}
    function submitOrder(){ if(!cart.length) return; google.script.run.withSuccessHandler(m=>{alert(m); cart=[]; updateCart('order');}).processOrder({storeName:loggedInStore,userName:loggedInUser,cart:cart}); }

/* 1. Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î∂àÎü¨Ïò§Í∏∞ */
  function loadHistory() { 
    var s = document.getElementById("hist-start").value; 
    var e = document.getElementById("hist-end").value; 
    var loadingTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_loading_items : "Loading...";
    document.getElementById("history-list-container").innerHTML = loadingTxt; 
    
    google.script.run.withSuccessHandler(function(l) { 
      var c = document.getElementById("history-list-container"); 
      c.innerHTML = ""; 
      var noHist = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_no_history : "No history";
      if(!l || !l.length){ c.innerHTML = noHist; return; } 
      var recTxt = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive : "üì• Receive";
      l.forEach(function(o) { 
        var btn = o.status == "Approved" ? "<button class=\"login-btn\" style=\"padding:8px;margin-top:5px;background:#E91E63;\" onclick=\"doReceive(" + o.id + ")\">" + recTxt + "</button>" : ""; 
        var items = "<div class='detail-list'>"; 
        o.items.forEach(function(i) { items += "<div class='detail-item'><span>" + i.name + "</span><span>x" + i.qty + "</span></div>"; }); 
        items += "</div>"; 
        c.innerHTML += "<div class=\"history-card\"><div class=\"history-header\"><span>" + o.date + "</span><span class=\"status-badge st-" + o.status + "\">" + o.status + "</span></div>" + items + "<div style=\"text-align:right;font-weight:bold;color:#E65100;\">" + Number(o.total).toLocaleString() + " ‡∏ø</div>" + btn + "</div>"; 
      }); 
    }).getMyOrderHistory(loggedInStore, s, e); 
  }

  /* 2. Î¨ºÌíà ÏàòÎ†π ÌôïÏù∏ Ï≤òÎ¶¨ */
  function doReceive(id) { 
    var msg = (typeof I18N !== "undefined" && I18N[currentLang]) ? I18N[currentLang].m_receive_confirm : "Receive items?";
    if(confirm(msg)) {
      google.script.run.withSuccessHandler(r => {
        alert(r);
        loadHistory();   // ÎÇ¥Ïó≠ ÏÉàÎ°úÍ≥†Ïπ®
        refreshStock();  // Ïû¨Í≥† ÌòÑÌô©Ìåê ÏÉàÎ°úÍ≥†Ïπ®
      }).processOrderReceive(id); 
    }
  }


 </script>