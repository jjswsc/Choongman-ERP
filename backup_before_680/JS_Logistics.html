<script>

  /* =================================================================
     ë¬¼ë¥˜/ì¬ê³  ê´€ë¦¬
     ================================================================= */ 

/* =========================================================
     [ê³µí†µ] í’ˆëª© ê²€ìƒ‰ ë° ë¦¬ìŠ¤íŠ¸
     ========================================================= */
  function openFinder(mode) {
      finderMode = mode;
      if(!itemModal) itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
      itemModal.show();
      document.getElementById("itm-finder-search").value = "";
      document.getElementById("itm-finder-list").innerHTML = "<tr><td colspan='3' class='text-muted p-4'>ê²€ìƒ‰ì–´ ì…ë ¥ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</td></tr>";
      if (!itemCache || itemCache.length === 0) {
          load(1);
          google.script.run.withSuccessHandler(function(l) {
              load(0); itemCache = l; 
              var cats = {}; l.forEach(i => { if(i.category) cats[i.category] = true; });
              var catSel = document.getElementById("itm-finder-cat");
              if(catSel) { catSel.innerHTML = "<option value=''>ì „ì²´ ì¹´í…Œê³ ë¦¬</option>"; Object.keys(cats).sort().forEach(c => catSel.add(new Option(c, c))); }
          }).getAdminItemsList();
      }
  }
  function filterModalItems() {
      var k = (document.getElementById("itm-finder-search").value || "").toLowerCase().trim();
      var c = document.getElementById("itm-finder-cat").value;
      var b = document.getElementById("itm-finder-list"); b.innerHTML = "";
      if (k === "" && c === "") { b.innerHTML = "<tr><td colspan='3' class='text-muted p-4'>ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ì„¸ìš”.</td></tr>"; return; }
      var count = 0;
      itemCache.forEach(function(item) {
          if (count > 50) return;
          var matchCat = (c === "" || item.category === c);
          var matchKey = (k === "" || String(item.code).toLowerCase().includes(k) || String(item.name).toLowerCase().includes(k));
          if (matchCat && matchKey) {
              b.innerHTML += `<tr style="cursor:pointer;" onclick="selectModalItem('${item.code}', '${item.name}')"><td>${item.code}</td><td class="text-start fw-bold">${item.name}</td><td class="text-end">${Number(item.price).toLocaleString()}</td></tr>`;
              count++;
          }
      });
      if (count === 0) b.innerHTML = "<tr><td colspan='3' class='text-center p-3'>ê²°ê³¼ ì—†ìŒ</td></tr>";
  }
  function selectModalItem(code, name) {
      if (finderMode === 'force') { document.getElementById("f-code").value = code; document.getElementById("f-name").value = name; document.getElementById("f-qty").focus(); }
      else if (finderMode === 'inbound') { document.getElementById("i-code").value = code; document.getElementById("i-name").value = name; document.getElementById("i-qty").focus(); }
      else if (finderMode === 'adj') { document.getElementById("a-code").value = code; document.getElementById("a-name").value = name; document.getElementById("a-new").focus(); }
      itemModal.hide();
  }
  /* [ìˆ˜ì •ë¨] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì¡°ì • ëª©ë¡ ë‚ ì§œ í‘œì‹œ ì¶”ê°€) */
function renderList(id, list) {
    var b = document.getElementById(id);
    b.innerHTML = "";
    
    list.forEach((i, idx) => {
        var rowHtml = "";
        
        if (id === 'force-cart') { // ì¶œê³ 
            rowHtml = `<td>${i.store}</td><td>${i.name}</td><td>${i.qty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        } else if (id === 'adj-cart') { // â˜… ì¡°ì • (ë‚ ì§œ ì¶”ê°€)
            rowHtml = `<td>${i.date}</td><td>${i.name}</td><td>${i.newQty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        } else { // ì…ê³  ë“±
            rowHtml = `<td>${i.name}</td><td>${i.qty||i.newQty}</td><td><button class="btn btn-sm btn-danger" onclick="delList('${id}',${idx})">X</button></td>`;
        }
        b.innerHTML += `<tr>${rowHtml}</tr>`;
    });
    
    var c = document.getElementById(id.replace("cart", "count"));
    if (c) c.innerText = list.length;
}
  function delList(id, idx){ 
      if(id=='inbound-cart') inboundList.splice(idx,1); else if(id=='force-cart') forceList.splice(idx,1); else adjList.splice(idx,1); 
      renderList(id, id=='inbound-cart'?inboundList:(id=='force-cart'?forceList:adjList)); 
  }

  /* =========================================================
     [ê¸°ëŠ¥ 6] ê¸°íƒ€ ê´€ë¦¬ (ì§ì›, ê±°ë˜ì²˜, ê³µì§€) - 6ì¹¸/8ì¹¸ ë§ì¶¤
     ========================================================= */


/* [ìˆ˜ì •] ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (í•„í„°ë§ ì•ˆì „ì¥ì¹˜ ì¶”ê°€) */
function renderVendors(list) { 
    var b = document.getElementById("vnd-list-body"); 
    b.innerHTML = ""; 
    
    // 1. í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ 'All'ë¡œ ê°„ì£¼)
    var filterEl = document.getElementById("filter-vnd-type");
    var f = filterEl ? filterEl.value : "All"; 
    
    // 2. í•„í„°ë§ (ì „ì²´ì´ê±°ë‚˜, íƒ€ì…ì´ ì¼ì¹˜í•˜ë©´ í†µê³¼)
    var fl = list.filter(function(v) {
        return (f === "All" || v.type === f);
    });
    
    // 3. ê²°ê³¼ ì—†ìŒ ì²˜ë¦¬
    if (!fl || fl.length === 0) { 
        b.innerHTML = "<tr><td colspan='6' class='text-center p-4 text-muted'>ê²€ìƒ‰ëœ ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    // 4. ëª©ë¡ ê·¸ë¦¬ê¸°
    fl.forEach(function(v) { 
        // ë±ƒì§€ ìƒ‰ìƒ
        var badge = '<span class="badge bg-secondary">ê¸°íƒ€</span>';
        if(v.type === 'ë§¤ì…ì²˜') badge = '<span class="badge bg-primary">ë§¤ì…ì²˜</span>';
        if(v.type === 'ë§¤ì¶œì²˜') badge = '<span class="badge bg-danger">ë§¤ì¶œì²˜</span>';
        
        // ì¸ë±ìŠ¤ ì°¾ê¸°
        var idx = vendorCache.findIndex(x => x.row === v.row);
        
        b.innerHTML += `
            <tr>
                <td>${badge}</td>
                <td class='fw-bold text-danger'>${v.code}</td>
                <td class='text-start ps-3'>${v.name}</td>
                <td>${v.manager}</td>
                <td class='text-end'>${Number(v.balance).toLocaleString()}</td>
                <td>
                    <button class='btn btn-sm btn-primary' onclick='editVendor(${idx})'>ìˆ˜ì •</button> 
                    <button class='btn btn-sm btn-danger' onclick='delVendor(${v.row})'>ì‚­ì œ</button>
                </td>
            </tr>`; 
    }); 
}
  function saveVendor() { 
      var d={ row:document.getElementById("vnd-row").value, type:document.getElementById("vnd-type").value, code:document.getElementById("vnd-code").value, name:document.getElementById("vnd-name").value, taxId:document.getElementById("vnd-tax").value, ceo:document.getElementById("vnd-ceo").value, addr:document.getElementById("vnd-addr").value, manager:document.getElementById("vnd-manager").value, phone:document.getElementById("vnd-phone").value, balance:document.getElementById("vnd-balance").value, memo:document.getElementById("vnd-memo").value }; 
      google.script.run.withSuccessHandler(r=>{alert(r);loadVendors();}).saveVendor(d); 
  }
  function editVendor(i) { var v=vendorCache[i]; document.getElementById("vnd-row").value=v.row; document.getElementById("vnd-type").value=v.type; document.getElementById("vnd-code").value=v.code; document.getElementById("vnd-name").value=v.name; document.getElementById("vnd-tax").value=v.taxId; document.getElementById("vnd-ceo").value=v.ceo; document.getElementById("vnd-addr").value=v.addr; document.getElementById("vnd-manager").value=v.manager; document.getElementById("vnd-phone").value=v.phone; document.getElementById("vnd-balance").value=v.balance; document.getElementById("vnd-memo").value=v.memo; }
  function delVendor(r) { if(confirm("ì‚­ì œ?")){load(1);google.script.run.withSuccessHandler(r=>{load(0);alert(r);loadVendors();}).deleteVendor(r);} }
  function createNewVendor() { document.getElementById("vnd-row").value="0"; document.getElementById("vnd-name").value=""; }

/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ì €ì¥ ë²„íŠ¼ (ë°˜ì‘ í™•ì¸ìš© ì•ˆì „ì¥ì¹˜ í¬í•¨) */
function saveAdjBatch() {
    // 1ë‹¨ê³„: ë²„íŠ¼ì´ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸
    // alert("ë²„íŠ¼ì´ ëˆŒë ¸ìŠµë‹ˆë‹¤! (ì—°ê²° ì„±ê³µ)"); // <-- ì´ ì°½ì´ ì•ˆ ëœ¨ë©´ ì˜¤íƒ€ê°€ ìˆëŠ” ê²ë‹ˆë‹¤.

    // 2ë‹¨ê³„: ëª©ë¡ í™•ì¸
    if (typeof adjList === 'undefined' || adjList.length === 0) {
        return alert("âŒ ì¡°ì •í•  í’ˆëª©ì´ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € 'ë‹´ê¸°'ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.");
    }

    // 3ë‹¨ê³„: ì‚¬ìš©ì í™•ì¸
    if (!confirm("ì´ " + adjList.length + "ê±´ì˜ ì¬ê³ ë¥¼ ì •ë§ë¡œ ì¡°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤)")) {
        return;
    }

    load(1); // ë¡œë”©í™”ë©´ ì¼œê¸°

    // 4ë‹¨ê³„: ì„œë²„ë¡œ ì „ì†¡
    google.script.run
        .withSuccessHandler(function(res) {
            load(0); // ë¡œë”© ë„ê¸°
            alert(res); // ê²°ê³¼ ë©”ì‹œì§€ (âœ… ì €ì¥ ì™„ë£Œ ë“±)

            // ì„±ê³µ ì‹œ ëª©ë¡ ë¹„ìš°ê¸°
            if (res && (res.includes("ì™„ë£Œ") || res.includes("âœ…") || res.includes("ì„±ê³µ"))) {
                adjList = [];
                renderList("adj-cart", []);
                
                // ì¬ê³  í˜„í™©íŒì´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                if(typeof loadStock === 'function') {
                    loadStock(false);
                }
            }
        })
        .withFailureHandler(function(err) {
            load(0); // ë¡œë”© ë„ê¸°
            alert("ğŸ”¥ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ:\n" + err.message);
        })
        .adjustStockBatch(adjList, userRole || "Unknown");
}
// [ìˆ˜ì •] í’ˆëª© ë°ì´í„° ë¡œë“œ (í™”ë©´ í‘œì‹œ X, ê²€ìƒ‰ ëŒ€ê¸° ìƒíƒœ)
function loadAdminItems() {
    load(1);
    google.script.run.withSuccessHandler(function(list) {
        load(0);
        itemCache = list || []; // ë°ì´í„°ëŠ” ë³€ìˆ˜ì— ì €ì¥ (ê²€ìƒ‰ìš©)
        
        // â˜… í•µì‹¬ ë³€ê²½: ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦¬ì§€ ì•Šê³  ì•ˆë‚´ ë¬¸êµ¬ë§Œ í‘œì‹œ (ë‹¤êµ­ì–´)
        var b = document.getElementById("itm-list-body");
        var itemGuideText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].item_guide) ? I18N[currentLang].item_guide : "ğŸ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥ í›„ [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        if(b) b.innerHTML = "<tr><td colspan='6' class='text-center p-5 text-muted'>ğŸ” " + itemGuideText + "</td></tr>";
        
        // (í•„ìˆ˜) ê²€ìƒ‰ì°½ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì€ ì±„ì›Œë†”ì•¼ ê²€ìƒ‰ì„ í•˜ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ìœ ì§€
        var cats = {};
        itemCache.forEach(i => { if(i.category) cats[i.category] = true; });
        
        // 1. ì…ë ¥ì°½ìš© ë°ì´í„°ë¦¬ìŠ¤íŠ¸
        var dl = document.getElementById("cat-list");
        if(dl) {
            dl.innerHTML = "";
            Object.keys(cats).sort().forEach(c => { 
                var op = document.createElement("option"); op.value = c; dl.appendChild(op); 
            });
        }
        // 2. ê²€ìƒ‰ì°½ìš© ì…€ë ‰íŠ¸ë°•ìŠ¤
        var searchCat = document.getElementById("itm-search-cat");
        if(searchCat) {
            var catAllText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].item_cat_all) ? I18N[currentLang].item_cat_all : "ì „ì²´ ì¹´í…Œê³ ë¦¬";
            searchCat.innerHTML = "<option value=''>" + catAllText + "</option>"; 
            Object.keys(cats).sort().forEach(c => searchCat.add(new Option(c, c)));
        }
        
    }).getAdminItemsList();
}

/* [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì´ë¯¸ì§€ ì•„ì´ì½˜ í‘œì‹œ) */
function renderAdminItems(list) {
    var b = document.getElementById("itm-list-body"); 
    b.innerHTML = "";
    
    if (!list || list.length === 0) { 
        b.innerHTML = "<tr><td colspan='6' class='text-center p-3 text-muted'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
        return; 
    }

    list.forEach(i => {
        var idx = itemCache.findIndex(x => x.row === i.row);
        var taxBadge = String(i.tax).includes("ë©´") ? '<span class="badge bg-secondary ms-1">ë©´ì„¸</span>' : '';
        
        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ 'ğŸ“·', ì—†ìœ¼ë©´ '-'
        var imgDisplay = i.image ? `<a href="${i.image}" target="_blank" style="text-decoration:none;">ğŸ“·</a>` : '-';

        b.innerHTML += `
            <tr>
                <td>${i.code}</td>
                <td>${imgDisplay}</td> <td class="text-start ps-3 fw-bold">${i.name} ${taxBadge}</td>
                <td>${i.spec||'-'}</td>
                <td class="text-end">${Number(i.price).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editItem(${idx})">ìˆ˜ì •</button> 
                    <button class="btn btn-sm btn-danger" onclick="delItem(${i.row})">ì‚­ì œ</button>
                </td>
            </tr>`;
    });
}

/* [ìˆ˜ì •] ìˆ˜ì • ëª¨ë“œ (ì´ë¯¸ì§€ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°) */
function editItem(idx) {
    var item = itemCache[idx];
    document.getElementById("itm-row").value = item.row;
    document.getElementById("itm-code").value = item.code;
    document.getElementById("itm-cat").value = item.category;
    document.getElementById("itm-name").value = item.name;
    document.getElementById("itm-spec").value = item.spec;
    document.getElementById("itm-price").value = item.price;
    document.getElementById("itm-cost").value = item.cost;
    
    // â˜… ì¶”ê°€ëœ ë¶€ë¶„
    document.getElementById("itm-image").value = item.image || "";   // Gì—´
    document.getElementById("itm-vendor").value = item.vendor || ""; // Hì—´
    
    document.getElementById("itm-tax").value = String(item.tax).includes("ë©´") ? "ë©´ì„¸" : "ê³¼ì„¸";
}

/* [ìˆ˜ì •] ì €ì¥ í•¨ìˆ˜ (ì´ë¯¸ì§€ ê°’ ì „ì†¡) */
function saveItem() {
    var taxVal = document.getElementById("itm-tax").value;
    var d = { 
        row: document.getElementById("itm-row").value, 
        code: document.getElementById("itm-code").value, 
        category: document.getElementById("itm-cat").value, 
        name: document.getElementById("itm-name").value, 
        spec: document.getElementById("itm-spec").value, 
        price: document.getElementById("itm-price").value, 
        cost: document.getElementById("itm-cost").value, 
        
        // â˜… ì¶”ê°€ëœ ë¶€ë¶„
        image: document.getElementById("itm-image").value,   // Gì—´
        vendor: document.getElementById("itm-vendor").value, // Hì—´
        
        tax: taxVal 
    };

    if (!d.code || !d.name) return alert("ì½”ë“œì™€ í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    
    load(1);
    google.script.run.withSuccessHandler(res => { 
        load(0); 
        alert(res); 
        loadAdminItems(); 
        createNewItem(); 
    }).saveAdminItem(d);
}

/* [ìˆ˜ì •] ì´ˆê¸°í™” (ì´ë¯¸ì§€ ì¹¸ ë¹„ìš°ê¸°) */
function createNewItem() {
    document.getElementById("itm-row").value = "0"; 
    document.getElementById("itm-code").value = ""; 
    document.getElementById("itm-name").value = ""; 
    document.getElementById("itm-cat").value = ""; 
    document.getElementById("itm-spec").value = ""; 
    document.getElementById("itm-price").value = ""; 
    document.getElementById("itm-cost").value = ""; 
    
    // â˜… ì¶”ê°€ëœ ë¶€ë¶„
    document.getElementById("itm-image").value = ""; 
    document.getElementById("itm-vendor").value = ""; 
    
    document.getElementById("itm-tax").value = "ê³¼ì„¸";
}

/* [ìˆ˜ì •] í’ˆëª© ê²€ìƒ‰ (ë¹ˆì¹¸ ì•ˆì „ì¥ì¹˜ ì¶”ê°€ ë²„ì „) */
function filterAdminItems() {
    var searchInput = document.getElementById("itm-search");
    var catInput = document.getElementById("itm-search-cat");
    
    // ì…ë ¥ì°½ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (ì—ëŸ¬ ë°©ì§€)
    if (!searchInput || !catInput) return;

    var k = searchInput.value.toLowerCase().trim(); // ê²€ìƒ‰ì–´ (ì†Œë¬¸ì, ê³µë°±ì œê±°)
    var c = catInput.value; // ì¹´í…Œê³ ë¦¬ ì„ íƒê°’
    
    // ë°ì´í„°ê°€ ì•„ì§ ë¡œë”© ì•ˆ ëìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
    if (!itemCache) itemCache = []; 

    var filtered = itemCache.filter(function(i) {
        // â˜… í•µì‹¬: ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë¹ˆ ë¬¸ìì—´("")ë¡œ ëŒ€ì²´
        var iCat = String(i.category || ""); 
        var iName = String(i.name || "").toLowerCase();
        var iCode = String(i.code || "").toLowerCase();
        
        // 1. ì¹´í…Œê³ ë¦¬ ê²€ì‚¬ (ì „ì²´ì´ê±°ë‚˜ ì¼ì¹˜í•˜ë©´ í†µê³¼)
        var matchCat = (c === "" || c === "All" || iCat === c);
        
        // 2. ê²€ìƒ‰ì–´ ê²€ì‚¬ (ì´ë¦„ì´ë‚˜ ì½”ë“œì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ë©´ í†µê³¼)
        var matchKey = (k === "" || iName.includes(k) || iCode.includes(k));
        
        return matchCat && matchKey;
    });
    
    renderAdminItems(filtered);
}

// 2. ì €ì¥ ë²„íŠ¼ (í•œê¸€ ê°’ 'ê³¼ì„¸'/'ë©´ì„¸' ê·¸ëŒ€ë¡œ ì „ì†¡)
/* [ìˆ˜ì •ë¨] ì €ì¥ ë²„íŠ¼ (ë³´ë‚´ëŠ” ê°’ í™•ì¸) */
function saveItem() {
    var taxEl = document.getElementById("itm-tax");
    var taxVal = taxEl.value; // "ê³¼ì„¸" ë˜ëŠ” "ë©´ì„¸"

    // â˜… ì•ˆì „ì¥ì¹˜: í˜¹ì‹œë¼ë„ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ë³´ê³  íŒë‹¨
    if (!taxVal) {
        var text = taxEl.options[taxEl.selectedIndex].text;
        if (text.includes("ë©´ì„¸")) taxVal = "ë©´ì„¸";
        else taxVal = "ê³¼ì„¸";
    }

    var d = {
        row: document.getElementById("itm-row").value,
        code: document.getElementById("itm-code").value,
        category: document.getElementById("itm-cat").value,
        name: document.getElementById("itm-name").value,
        spec: document.getElementById("itm-spec").value,
        price: document.getElementById("itm-price").value,
        cost: document.getElementById("itm-cost").value,
        tax: taxVal
    };
    
    if (!d.code || !d.name) return alert("ì½”ë“œì™€ í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    
    // ì €ì¥ ì‹œì‘ ì•Œë¦¼ (ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)
    load(1);
    
    google.script.run.withSuccessHandler(function(res) {
        load(0);
        alert(res); // ì—¬ê¸°ì— "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ë©´ì„¸)" ë¼ê³  ë– ì•¼ ì„±ê³µì…ë‹ˆë‹¤.
        loadAdminItems(); 
        createNewItem();
    }).saveAdminItem(d);
}

// 3. ìˆ˜ì • ë²„íŠ¼ (ì…ë ¥ì°½ì— ê°’ ì •í™•íˆ ì„¸íŒ…)
function editItem(idx) {
    var item = itemCache[idx];
    document.getElementById("itm-row").value = item.row;
    document.getElementById("itm-code").value = item.code;
    document.getElementById("itm-cat").value = item.category;
    document.getElementById("itm-name").value = item.name;
    document.getElementById("itm-spec").value = item.spec;
    document.getElementById("itm-price").value = item.price;
    document.getElementById("itm-cost").value = item.cost;
    
    // â˜… í•µì‹¬: ê°€ì ¸ì˜¨ ê°’ì´ 'ë©´ì„¸'ë©´ ë©´ì„¸ ì„ íƒ, ì•„ë‹ˆë©´ ë¬´ì¡°ê±´ 'ê³¼ì„¸' ì„ íƒ
    // (ì‹œíŠ¸ì— ë¹ˆì¹¸ì´ì–´ë„ 'ê³¼ì„¸'ë¡œ ê°„ì£¼í•˜ì—¬ ì„ íƒë˜ê²Œ í•¨)
    if (item.tax && item.tax.trim() === "ë©´ì„¸") {
        document.getElementById("itm-tax").value = "ë©´ì„¸";
    } else {
        document.getElementById("itm-tax").value = "ê³¼ì„¸";
    }
}

// 6. ì‹ ê·œ ë“±ë¡ ë²„íŠ¼ (ì´ˆê¸°í™”)
function createNewItem() {
    document.getElementById("itm-row").value = "0";
    document.getElementById("itm-code").value = "";
    document.getElementById("itm-name").value = "";
    document.getElementById("itm-spec").value = "";
    document.getElementById("itm-price").value = "";
    document.getElementById("itm-cost").value = "";
    document.getElementById("itm-cat").value = "";
    document.getElementById("itm-tax").value = "VAT";
}
/* [Code.gs] í’ˆëª© ì €ì¥ (Jì—´ ê°•ì œ ì €ì¥ ê°•í™” ë²„ì „) */
function saveAdminItem(data) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("í’ˆëª©");
  if (!sheet) return "âŒ ì˜¤ë¥˜: 'í’ˆëª©' ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
  
  try {
    var row = Number(data.row);
    
    // 1. ì‹ ê·œ ë“±ë¡ì¸ ê²½ìš° (ë§¨ ì•„ë˜ ì¤„ ì¶”ê°€)
    if (row === 0) {
      row = sheet.getLastRow() + 1;
    }
    
    // 2. ê¸°ë³¸ ì •ë³´ ì €ì¥ (Aì—´ ~ Fì—´)
    // ìˆœì„œ: ì½”ë“œ(1), ì¹´í…Œê³ ë¦¬(2), í’ˆëª©ëª…(3), ê·œê²©(4), íŒë§¤ê°€(5), ì›ê°€(6)
    sheet.getRange(row, 1, 1, 6).setValues([[
      data.code,
      data.category,
      data.name,
      data.spec,
      Number(data.price) || 0,
      Number(data.cost) || 0
    ]]);

    // 3. ê³¼ì„¸ ì •ë³´ ì €ì¥ (â˜… Jì—´: 10ë²ˆì§¸ ì¹¸)
    // ì‹œíŠ¸ì˜ ì»¬ëŸ¼ì´ 10ê°œë³´ë‹¤ ì ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¹¸ì„ ëŠ˜ë ¤ì„œë¼ë„ ì €ì¥
    if (sheet.getMaxColumns() < 10) {
      sheet.insertColumnsAfter(sheet.getMaxColumns(), 10 - sheet.getMaxColumns());
    }
    
    // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ "ê³¼ì„¸"ë¡œ ì²˜ë¦¬
    var taxValue = (data.tax && data.tax !== "") ? String(data.tax) : "ê³¼ì„¸";
    
    // Jì—´ì— í™•ì‹¤í•˜ê²Œ ì“°ê¸°
    sheet.getRange(row, 10).setValue(taxValue);
    
    // ì €ì¥ í›„ ê²°ê³¼ ë©”ì‹œì§€ì— ê³¼ì„¸ ì •ë³´ë¥¼ í¬í•¨í•´ì„œ ë³´ì—¬ì¤Œ (í™•ì¸ìš©)
    return "âœ… ì €ì¥ ì™„ë£Œ! (" + taxValue + ")";
    
  } catch (e) {
    return "âŒ ì €ì¥ ì‹¤íŒ¨: " + e.message;
  }
}

/* [ìˆ˜ì •] ê±°ë˜ì²˜ ë°ì´í„° ë¡œë“œ (ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ëª©ë¡ í‘œì‹œ) */
function loadVendors(isSearch) { 
    load(1); // ë¡œë”© ì‹œì‘
    
    google.script.run.withSuccessHandler(function(list) { 
        load(0); // ë¡œë”© ë
        
        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚¬ì„ ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
        vendorCache = list || []; 
        
        // â˜… í•µì‹¬: isSearchê°€ true(ë²„íŠ¼ í´ë¦­)ì¼ ë•Œë§Œ ëª©ë¡ì„ ê·¸ë¦¼
        if (isSearch) {
            renderVendors(vendorCache);
        } else {
            // ë©”ë‰´ ì²˜ìŒ ë“¤ì–´ê°”ì„ ë• ì•ˆë‚´ ë¬¸êµ¬ë§Œ
            var b = document.getElementById("vnd-list-body");
            if(b) b.innerHTML = "<tr><td colspan='6' class='text-center p-5 text-muted'>ğŸ”„ êµ¬ë¶„ ì„ íƒ ë˜ëŠ” [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>";
        }
    }).getVendorManagementList(); 
}
/* [ìµœì¢… ìˆ˜ì •] íƒ­ ì „í™˜ í•¨ìˆ˜ (í™”ë©´ ì„ì„ ë°©ì§€ + ë²„íŠ¼ í™œì„±í™”) */
  function showStockTab(t){ 
      // 1. ëª¨ë“  íƒ­ í™”ë©´ì„ ê°•ì œë¡œ ìˆ¨ê¹€ (IDë¡œ ì§ì ‘ ì§€ì • -> ê°€ì¥ ì•ˆì „í•¨)
      document.getElementById("stock-tab-status").style.display = "none";
      document.getElementById("stock-tab-adjust").style.display = "none";
      document.getElementById("stock-tab-history").style.display = "none";
      
      // 2. ì„ íƒí•œ íƒ­ë§Œ ë³´ì´ê¸°
      var target = document.getElementById("stock-tab-" + t);
      if(target) target.style.display = "block";
      
      // 3. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active ìƒíƒœ)
      // ìš°ì„  ëª¨ë“  ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœë¥¼ ë”
      document.getElementById("stock-nav-status").classList.remove("active");
      document.getElementById("stock-nav-adjust").classList.remove("active");
      document.getElementById("stock-nav-history").classList.remove("active");
      
      // í´ë¦­í•œ ë²„íŠ¼ë§Œ í™œì„±í™” (ìƒ‰ìƒ ì¼œê¸°)
      var btn = document.getElementById("stock-nav-" + t);
      if(btn) btn.classList.add("active");

      // 4. ë°ì´í„° ë¡œë“œ (í•„ìš”í•  ë•Œë§Œ)
      if(t==='history') loadAdjHistory();
      if(t==='status') loadStock(false);
  }

  /* [ìˆ˜ì •] ì¬ê³  í˜„í™© ë¡œë“œ (ì—´ ë„ˆë¹„ ê°•ì œ ê³ ì •) */
  function loadStock(useDate) { 
      var s=document.getElementById("stock-store-selector").value; 
      if(!s) return;
      
      load(1); 
      google.script.run.withSuccessHandler(d=>{ 
          load(0); 
          var c=document.getElementById("stock-container"); 
          c.innerHTML=""; 
          
          var gt=0; var g={}; 
          d.forEach(i=>{
              gt+=i.total; 
              if(!g[i.category]) g[i.category]=[]; 
              g[i.category].push(i); 
          }); 
          
          document.getElementById("stock-grand-total").innerText=gt.toLocaleString()+" à¸¿"; 
          
          // ì¹´í…Œê³ ë¦¬ë³„ í…Œì´ë¸” ìƒì„±
          for(var cat in g){ 
              // ì ‘ê¸°/í´ê¸° í—¤ë”
              var h = `<div class="p-2 bg-secondary text-white fw-bold d-flex justify-content-between" onclick="toggleCat('${cat}')" style="cursor:pointer; border-bottom:1px solid #ddd;">
                          <span>${cat} (${g[cat].length})</span> <span>â–¼</span>
                       </div>
                       <div id="cat-${cat}" style="display:block;">
                       <table class="table table-bordered text-center mb-0 align-middle" style="table-layout: fixed;">
                           <tbody>`; 
              
              g[cat].forEach(i=>{ 
                  var safeInput = `<div class="input-group input-group-sm justify-content-center"><input type="number" id="safe-${i.code}" class="form-control text-center p-0" value="${i.safe}" placeholder="0" style="max-width:60px;"><button class="btn btn-outline-dark" onclick="saveSafeQty('${s}', '${i.code}', document.getElementById('safe-${i.code}').value)">ğŸ’¾</button></div>`; 
                  
                  // â˜… í•µì‹¬: style="width: XX%"ë¡œ ì¹¸ í¬ê¸° ê°•ì œ ê³ ì • (í—¤ë”ì™€ ë™ì¼í•˜ê²Œ)
                  h+=`<tr>
                          <td style="width: 15%;" class="text-muted small">${i.code}</td>
                          <td style="width: 35%;" class="text-start ps-2 text-truncate">${i.name}</td>
                          <td style="width: 20%;">${safeInput}</td>
                          <td style="width: 15%; font-weight:bold; color:${i.qty<=i.safe?'red':'blue'}">${i.qty}</td>
                          <td style="width: 15%;" class="text-end pe-2 small">${Number(i.total).toLocaleString()}</td>
                      </tr>`; 
              }); 
              h+=`</tbody></table></div>`; 
              c.innerHTML+=h; 
          } 
      }).getStockStatusAdmin(s, useDate?document.getElementById("stock-date").value:""); 
  }
  
  // (ì¹´í…Œê³ ë¦¬ ì ‘ê¸°/í´ê¸° ê¸°ëŠ¥)
  function toggleCat(id){ 
      var el=document.getElementById("cat-"+id); 
      el.style.display = (el.style.display==='none' ? 'block' : 'none'); 
  }
 
  function saveSafeQty(s,c,v){ google.script.run.withSuccessHandler(r=>console.log(r)).saveStoreSafetyStock(s,c,v); }

/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ë‚´ì—­ í™”ë©´ (ê·œê²© ì¶”ê°€) */
function loadAdjHistory() {
    var s = document.getElementById("adj-start").value;
    var e = document.getElementById("adj-end").value;
    var st = document.getElementById("adj-store-selector").value;
    if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; }

    load(1);
    google.script.run.withSuccessHandler(list => {
        load(0); 
        var b = document.getElementById("adj-list"); 
        b.innerHTML = "";
        
        if(!list.length){ b.innerHTML="<tr><td colspan='5'>ë‚´ì—­ ì—†ìŒ</td></tr>"; return; }
        
        var groups={}; 
        list.forEach(i=>{ 
            var k=i.date+"_"+i.store; 
            if(!groups[k]) groups[k]={date:i.date, store:i.store, items:[]}; 
            groups[k].items.push(i); 
        });
        
        var idx=0;
        for(var k in groups){
            var g=groups[k]; 
            var rid="adj-row-"+idx;
            // ë©”ì¸ í–‰
            b.innerHTML+=`
                <tr style="cursor:pointer;" onclick="toggleRow('${rid}')">
                    <td>${g.date}</td>
                    <td class="fw-bold">${g.store}</td>
                    <td class="text-start ps-3">â–¼ ${g.items[0].item} ì™¸ ${g.items.length-1}ê±´</td>
                    <td colspan="2">${g.items.length}ê±´ ì¡°ì •</td>
                </tr>`;
            
            // â˜… ìƒì„¸ í–‰ (ê·œê²© ì¶”ê°€ë¨)
            var dets = g.items.map(i => {
                var diffVal = Number(i.diff);
                var diffStr = isNaN(diffVal) ? "ì˜¤ë¥˜" : (diffVal>0 ? "+"+diffVal : diffVal);
                var diffClass = diffVal>0 ? "text-primary" : "text-danger";
                
                return `
                    <tr>
                        <td class="text-start ps-4">${i.item}</td>
                        <td class="text-muted small">${i.spec}</td> <td class="fw-bold ${diffClass}">${diffStr}</td>
                        <td class="small text-muted">${i.reason}</td>
                    </tr>`;
            }).join("");
            
            b.innerHTML+=`
                <tr id="${rid}" style="display:none; background-color:#f8f9fa;">
                    <td colspan="5">
                        <table class="table table-sm table-bordered bg-white w-90 mx-auto mb-2">
                            <thead class="table-light"><tr><th>í’ˆëª©</th><th>ê·œê²©</th><th>ì¡°ì •</th><th>ì‚¬ìœ </th></tr></thead>
                            <tbody>${dets}</tbody>
                        </table>
                    </td>
                </tr>`;
            idx++;
        }
    }).getAdjustmentHistory(s, e, st);
}
/* [ìˆ˜ì •ë¨] ì¬ê³  ì¡°ì • ë‹´ê¸° (ë‚ ì§œ í¬í•¨) */
function addAdjList() {
    // 1. ê°’ ê°€ì ¸ì˜¤ê¸°
    var dateVal = document.getElementById("a-date").value;
    var store = document.getElementById("a-store").value;
    var code = document.getElementById("a-code").value;
    var name = document.getElementById("a-name").value;
    var curQty = document.getElementById("a-cur").value; 
    var newQty = document.getElementById("a-new").value; 
    var reason = document.getElementById("a-reason").value;

    // 2. ë‚ ì§œ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ì±„ì›€
    if (!dateVal) {
        dateVal = new Date().toISOString().substring(0,10);
        document.getElementById("a-date").value = dateVal;
    }

    if (!code) return alert("í’ˆëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (newQty === "") return alert("ì‹¤ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    // 3. ë¦¬ìŠ¤íŠ¸ì— ë‹´ê¸°
    adjList.push({
        date: dateVal, // â˜… ë‚ ì§œ ì¶”ê°€ë¨
        store: store,
        code: code,
        name: name,
        curQty: curQty,
        newQty: newQty,
        reason: reason
    });

    renderList("adj-cart", adjList);
    
    // ì…ë ¥ì°½ ë¹„ìš°ê¸°
    document.getElementById("a-new").value = "";
    document.getElementById("a-reason").value = "";
    document.getElementById("a-new").focus();
}
  /* =========================================================
     [ê¸°ëŠ¥ 3] ì£¼ë¬¸ ìŠ¹ì¸ ê´€ë¦¬ (ë§¤ì¥ í•„í„°ë§ í¬í•¨)
     ========================================================= */
  var officeStockCache = {};
  function loadOrders() {
      var s=document.getElementById("ord-start").value, e=document.getElementById("ord-end").value;
      if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; document.getElementById("ord-start").value=t; document.getElementById("ord-end").value=t; }
      load(1);
      google.script.run.withSuccessHandler(function(res){
          load(0);
          orderListCache = (res && res.list) ? res.list : (Array.isArray(res) ? res : []);
          officeStockCache = (res && res.officeStock) ? res.officeStock : {};
          renderOrderList();
      }).getAdminOrders(s, e);
  }
  
  function renderOrderList() { 
      var k=document.getElementById("ord-search-keyword").value.toLowerCase();
      var st=document.getElementById("ord-status-filter").value;
      var storeEl=document.getElementById("ord-store-selector");
      var sf=storeEl?storeEl.value:"All";
      
      var b=document.getElementById("order-list"); b.innerHTML=""; 
      if(!orderListCache || !orderListCache.length) { b.innerHTML="<tr><td colspan='7' class='text-center p-4 text-muted'>ë°ì´í„° ì—†ìŒ</td></tr>"; return; }
      
      var f=orderListCache.filter(o=>(sf==="All"||o.store===sf)&&(st==="All"||o.status===st)&&o.store.toLowerCase().includes(k));
      if(!f.length) { b.innerHTML="<tr><td colspan='7' class='text-center p-4 text-muted'>ê²°ê³¼ ì—†ìŒ</td></tr>"; return; }

      f.forEach(o=>{ 
          var bc = o.status==='Pending'?'bg-warning text-dark':(o.status==='Approved'?'bg-success':'bg-danger');
          b.innerHTML+=`<tr class="ord-data-row" style="cursor:pointer;" data-row="${o.row}"><td class="text-center" onclick="event.stopPropagation()"><input type="checkbox" class="form-check-input ord-invoice-chk" checked title="ì¸ì‡„ í¬í•¨"></td><td class="text-center" onclick="toggleRow('ord-row-${o.row}')">â–¼</td><td class="text-center">${o.date}</td><td class="fw-bold text-center">${o.store}</td><td>${o.summary}</td><td class="text-end fw-bold text-primary">${Number(o.total).toLocaleString()} à¸¿</td><td class="text-center"><span class="badge ${bc}">${o.status}</span></td></tr><tr id="ord-row-${o.row}" class="ord-detail-row" style="display:none; background-color:#f8f9fa;"><td colspan="7" class="p-3">${buildOrderDetailHtml(o)}</td></tr>`; 
      });
      var allChk = document.getElementById("ord-print-all");
      if (allChk) allChk.checked = true;
  }
/* [ìˆ˜ì •ë¨] ì£¼ë¬¸ ìƒì„¸ í™”ë©´ (ê³¼ì„¸/ë©´ì„¸ í‘œì‹œ ë° ê³„ì‚°) */
function buildOrderDetailHtml(o) {
    if (!o.items || o.items.length === 0) {
        return `<div class="p-3 text-center text-muted">ìƒì„¸ í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    var itemRows = "";
    o.items.forEach((item, idx) => {
        var taxBadge = (item.taxType === "ë©´ì„¸") ? '<span class="badge bg-secondary" style="font-size:10px;">ë©´ì„¸</span>' : '';
        var finalAmt = Math.round(item.lineTotal);
        var officeQty = (typeof officeStockCache !== "undefined" && item.code && officeStockCache[item.code] != null) ? Number(officeStockCache[item.code]) : "-";

        itemRows += `
            <tr>
                <td class="text-center align-middle">
                    <input type="checkbox" class="form-check-input order-item-check-${o.row}" data-idx="${idx}" checked>
                </td>
                <td class="align-middle text-start">
                    ${item.name}${taxBadge ? ' <br>' + taxBadge : ''}
                </td>
                <td class="align-middle text-center text-muted small">${(item.spec || '').trim() || '-'}</td>
                <td class="align-middle text-end">${Number(item.price).toLocaleString()}</td>
                <td class="align-middle text-center fw-bold">${item.qty}</td>
                <td class="align-middle text-center office-stock-cell">${officeQty}</td>
                <td class="align-middle text-end fw-bold">${finalAmt.toLocaleString()}</td>
            </tr>`;
    });

    var btns = `
        <div class="d-flex justify-content-end gap-2 mt-3 pt-2 border-top">
            <button class="btn btn-secondary btn-sm" onclick="processOrderInline('${o.row}','Hold')">ë³´ë¥˜</button>
            <button class="btn btn-danger btn-sm" onclick="processOrderInline('${o.row}','Rejected')">ê±°ì ˆ</button>
            <button class="btn btn-success btn-sm fw-bold" onclick="processOrderInline('${o.row}','Approved')">ìŠ¹ì¸</button>
        </div>`;

    return `
        <div class="card p-3 border-0 shadow-sm" style="background-color: #fff;">
            <h6 class="fw-bold mb-2">ğŸ“‹ ì£¼ë¬¸ ìƒì„¸ (ë¶€ê°€ì„¸ í¬í•¨)</h6>
            <table class="table table-sm table-bordered bg-white mb-0">
                <thead class="table-light text-center">
                    <tr>
                        <th style="width:30px;">V</th>
                        <th>í’ˆëª©ëª…</th>
                        <th style="width:10%;">ê·œê²©</th>
                        <th style="width:10%;">ë‹¨ê°€(ì„¸ì „)</th>
                        <th style="width:8%;">ìˆ˜ëŸ‰</th>
                        <th class="office-stock-header" style="width:9%;">Office ì¬ê³ </th>
                        <th style="width:14%;">í•©ê³„(ì„¸í›„)</th>
                    </tr>
                </thead>
                <tbody>${itemRows}</tbody>
            </table>
            ${btns}
        </div>`;
}
  function processOrderInline(row, decision) {
      if(decision!=='Approved' && !confirm(decision+" ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      var checkboxes = document.querySelectorAll('.order-item-check-' + row);
      var originalOrder = orderListCache.find(x => String(x.row) === String(row));
      var newCart = [];
      checkboxes.forEach(cb => { if(cb.checked) newCart.push(originalOrder.items[cb.getAttribute("data-idx")]); });
      
      load(1);
      google.script.run.withSuccessHandler(res => { load(0); alert(res); loadOrders(); }).processOrderDecision(row, decision, newCart);
  }
  function toggleRow(id) { var el = document.getElementById(id); if(el) el.style.display = (el.style.display === 'none') ? 'table-row' : 'none'; }
  function toggleAllOrderPrint(headerChk) {
    var list = document.getElementById("order-list");
    if (!list) return;
    list.querySelectorAll(".ord-invoice-chk").forEach(function(cb) { cb.checked = !!headerChk.checked; });
  }

  /** ì¶œê³  ë‚´ì—­ í•œ ê±´(ê·¸ë£¹) ì¸ë³´ì´ìŠ¤ HTML - ë§¤ì¥ë³„ ì¥ êµ¬ë¶„ìš© (pageBreakWhenNewStore) */
  function buildForceDeliveryNoteHtml(group, companyInfo, clientInfo, pageBreakBefore) {
    var docNo = (group.invoiceNo && String(group.invoiceNo).trim()) ? group.invoiceNo : ("IV-" + (group.date || "").replace(/\D/g, ""));
    var dateStr = (group.date || "").split(" ")[0] || "";
    var d = dateStr.replace(/-/g, "/");
    if (d.length === 10) d = d.slice(5, 7) + "/" + d.slice(8, 10) + "/" + d.slice(0, 4);
    var totalBaht = Number(group.totalAmt) || 0;
    var vat7 = Math.round(totalBaht * 0.07 / 1.07);
    var exclVat = totalBaht - vat7;
    var companyName = (companyInfo && companyInfo.companyName) ? companyInfo.companyName : "";
    var address = (companyInfo && companyInfo.address) ? companyInfo.address : "";
    var taxId = (companyInfo && companyInfo.taxId) ? companyInfo.taxId : "";
    var phone = (companyInfo && companyInfo.phone) ? companyInfo.phone : "";
    var bankInfo = (companyInfo && companyInfo.bankInfo) ? companyInfo.bankInfo : "";
    var clientName = (clientInfo && clientInfo.companyName) ? clientInfo.companyName : (group.target || "-");
    var clientAddr = (clientInfo && clientInfo.address) || "";
    var clientTaxId = (clientInfo && clientInfo.taxId) || "";
    var clientPhone = (clientInfo && clientInfo.phone) || "";
    var rows = "";
    (group.items || []).forEach(function(it, idx) {
      var amt = Math.round(Math.abs(Number(it.amount)) || 0);
      rows += "<tr><td class=\"text-center\">" + (idx + 1) + "</td><td>" + (it.name || "-") + "</td><td class=\"text-center\">" + (it.qty || 0) + "</td><td class=\"text-end\">" + (it.spec || "-") + "</td><td class=\"text-end\">" + amt.toLocaleString() + "</td></tr>";
    });
    var tableStyle = "width:100%; border-collapse: collapse; border: 1px solid #e2e8f0; margin: 8px 0;";
    var thStyle = "background: #0369a1; color: #fff; padding: 6px 8px; text-align: center; border: 1px solid #0369a1;";
    var pageBreak = pageBreakBefore ? " page-break-before: always;" : "";
    return "<div class=\"delivery-note-invoice\" style=\"max-width:210mm; margin:0 auto 24px; padding:16px; background:#fff; border:1px solid #e2e8f0; page-break-after:always;" + pageBreak + " font-family:'Noto Sans KR','Noto Sans Thai',sans-serif; font-size:12px; color:#0f172a;\">" +
      "<div style=\"display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;\">" +
        "<h2 style=\"margin:0; font-size:1.25rem;\">Delivery Note / Tax Invoice</h2>" +
        "<div style=\"text-align:right; font-size:11px;\">" +
          "<div><strong>Document No.:</strong> " + docNo + "</div>" +
          "<div><strong>Date:</strong> " + d + "</div>" +
          "<div><strong>Store:</strong> " + clientName + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">" +
        "<div style=\"flex:1;\"><div style=\"font-weight:700;\">" + companyName + "</div><div style=\"font-size:11px; color:#475569;\">" + address + "<br>Tax ID " + taxId + " | " + phone + "</div></div>" +
        "<div style=\"flex:1; padding-left:16px;\"><div style=\"font-weight:700;\">Client (ë§¤ì¶œì²˜)</div><div style=\"font-size:11px; color:#475569;\">" + clientName + (clientAddr ? "<br>" + clientAddr : "") + "</div></div>" +
      "</div>" +
      "<table style=\"" + tableStyle + "\"><thead><tr><th style=\"" + thStyle + "\">#</th><th style=\"" + thStyle + "\">Description</th><th style=\"" + thStyle + "\">Qty</th><th style=\"" + thStyle + "\">Spec</th><th style=\"" + thStyle + "\">Amount</th></tr></thead><tbody>" + rows + "</tbody></table>" +
      "<div style=\"margin-top:12px; text-align:right;\"><strong>Grand Total: " + totalBaht.toLocaleString() + " THB</strong></div>" +
      "<div style=\"margin-top:16px; font-size:11px; color:#475569;\"><strong>Remarks:</strong> " + bankInfo + "</div>" +
    "</div>";
  }

  function printForceHistoryInvoice() {
    var list = document.getElementById("fh-list");
    if (!list) { alert("ì¶œê³  ë‚´ì—­ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    if (!window.forceHistoryGroups || !Array.isArray(window.forceHistoryGroups)) {
      alert("ì¶œê³  ë‚´ì—­ì„ ë¨¼ì € ì¡°íšŒí•œ ë’¤ ì¸ë³´ì´ìŠ¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return;
    }
    var checked = [];
    list.querySelectorAll("tr.fh-data-row").forEach(function(tr) {
      var chk = tr.querySelector(".fh-invoice-chk");
      if (chk && chk.checked) {
        var idxStr = tr.getAttribute("data-group-index");
        if (idxStr !== null && idxStr !== undefined) {
          var idxNum = parseInt(idxStr, 10);
          if (!isNaN(idxNum) && checked.indexOf(idxNum) === -1) checked.push(idxNum);
        }
      }
    });
    if (checked.length === 0) { alert("ì¸ì‡„í•  ì¶œê³  ë‚´ì—­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. (ì²´í¬ë°•ìŠ¤)"); return; }
    var groups = window.forceHistoryGroups.filter(function(g, i) { return checked.indexOf(i) !== -1; });
    if (groups.length === 0) { alert("ì„ íƒí•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°íšŒ í›„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    groups.sort(function(a, b) { var ta = (a.target || "").localeCompare(b.target || ""); return ta !== 0 ? ta : ((a.date || "").localeCompare(b.date || "")); });
    google.script.run.withSuccessHandler(function(data) {
      var area = document.getElementById("invoice-print-area");
      if (!area) { alert("ì¸ë³´ì´ìŠ¤ ì¸ì‡„ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      var companyInfo = (data && data.company) ? data.company : {};
      var clientsMap = (data && data.clients) ? data.clients : {};
      var html = "";
      var prevTarget = "";
      for (var i = 0; i < groups.length; i++) {
        var g = groups[i];
        var pageBreakBefore = (i > 0 && (g.target || "") !== prevTarget);
        prevTarget = g.target || "";
        var clientInfo = clientsMap[g.target] || { companyName: g.target || "-" };
        html += buildForceDeliveryNoteHtml(g, companyInfo, clientInfo, pageBreakBefore);
      }
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() { document.body.classList.remove("invoice-printing"); area.classList.add("d-none"); area.innerHTML = ""; window.onafterprint = null; };
      window.print();
    }).withFailureHandler(function() {
      var area = document.getElementById("invoice-print-area");
      if (!area) return;
      var html = ""; var prevTarget = "";
      for (var i = 0; i < groups.length; i++) {
        var g = groups[i];
        var pageBreakBefore = (i > 0 && (g.target || "") !== prevTarget);
        prevTarget = g.target || "";
        html += buildForceDeliveryNoteHtml(g, {}, { companyName: g.target || "-" }, pageBreakBefore);
      }
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() { document.body.classList.remove("invoice-printing"); area.classList.add("d-none"); area.innerHTML = ""; window.onafterprint = null; };
      window.print();
    }).getInvoiceData();
  }

  /** Delivery Note/Tax Invoice í•œ ê±´ HTML ìƒì„± (ì¸ì‡„ ì–‘ì‹). clientInfo=ê±°ë˜ì²˜ ì‹œíŠ¸ ë§¤ì¶œì²˜, isFirstPage=trueë©´ í˜ì´ì§€ ëŠê¸° ì—†ìŒ */
  function buildDeliveryNoteInvoiceHtml(order, companyInfo, clientInfo, isFirstPage) {
    var docNo = (order.invoiceNo && String(order.invoiceNo).trim()) ? order.invoiceNo : (order.orderId || ("IV" + (order.date || "").replace(/\D/g, "").slice(0, 8) + String(order.row).padStart(2, "0")) || "IV-");
    var dateStr = (order.date || "").split(" ")[0] || new Date().toISOString().slice(0, 10);
    var d = dateStr.replace(/-/g, "/");
    if (d.length === 10) d = d.slice(5, 7) + "/" + d.slice(8, 10) + "/" + d.slice(0, 4);
    var totalBaht = Number(order.total) || 0;
    var vat7 = Math.round(totalBaht * 0.07 / 1.07);
    var exclVat = totalBaht - vat7;
    var discount = 0;
    var totalAfterDiscount = totalBaht;
    var companyName = (companyInfo && companyInfo.companyName) || "à¸šà¸£à¸´à¸©à¸±à¸— à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥ à¸ˆà¸³à¸à¸±à¸” (Head Office)";
    var address = (companyInfo && companyInfo.address) || "";
    var taxId = (companyInfo && companyInfo.taxId) || "";
    var phone = (companyInfo && companyInfo.phone) || "";
    var bankInfo = (companyInfo && companyInfo.bankInfo) || "à¸˜à¸™à¸²à¸„à¸²à¸£à¸à¸ªà¸´à¸à¸£à¹„à¸—à¸¢ à¹€à¸¥à¸‚à¸—à¸µà¹ˆ 166-2-97079-0 à¸Šà¸·à¹ˆà¸­à¸šà¸±à¸à¸Šà¸µ à¸šà¸ˆà¸. à¹€à¸­à¸ªà¹à¸­à¸™à¸”à¹Œà¹€à¸ˆ à¹‚à¸à¸¥à¸šà¸­à¸¥";
    var projectName = (companyInfo && companyInfo.projectName) || "CM True Digital Park";
    var clientName = (clientInfo && clientInfo.companyName) || order.store || "-";
    var clientAddr = (clientInfo && clientInfo.address) ? (clientInfo.address + "") : "";
    var clientTaxId = (clientInfo && clientInfo.taxId) ? (clientInfo.taxId + "") : "";
    var clientPhone = (clientInfo && clientInfo.phone) ? (clientInfo.phone + "") : "";

    var rows = "";
    (order.items || []).forEach(function(it, idx) {
      var amt = Math.round(Number(it.lineTotal) || 0);
      rows += "<tr><td class=\"text-center\">" + (idx + 1) + "</td><td>" + (it.name || "-") + "</td><td class=\"text-center\">" + (it.qty || 0) + "</td><td class=\"text-end\">" + Number(it.price || 0).toLocaleString() + "</td><td class=\"text-end\">0</td><td class=\"text-end\">" + amt.toLocaleString() + "</td></tr>";
    });

    var grandWords = "( " + totalBaht.toLocaleString() + " baht only )";
    var tableStyle = "width:100%; border-collapse: collapse; border: 1px solid #e2e8f0; margin: 8px 0;";
    var thStyle = "background: #0369a1; color: #fff; padding: 6px 8px; text-align: center; border: 1px solid #0369a1;";
    var pageBreak = isFirstPage ? "" : " page-break-before: always;";

    return "<div class=\"delivery-note-invoice\" style=\"max-width:210mm; margin:0 auto 24px; padding:16px; background:#fff; border:1px solid #e2e8f0; page-break-after:always;" + pageBreak + " font-family:'Noto Sans KR','Noto Sans Thai',sans-serif; font-size:12px; color:#0f172a;\">" +
      "<div style=\"display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;\">" +
        "<h2 style=\"margin:0; font-size:1.25rem;\">Delivery Note / Tax Invoice</h2>" +
        "<div style=\"text-align:right; font-size:11px;\">" +
          "<div>Copy (Set Document)</div>" +
          "<div><strong>Document No.:</strong> " + docNo + "</div>" +
          "<div><strong>Date:</strong> " + d + "</div>" +
          "<div><strong>Due Date:</strong> " + d + "</div>" +
          "<div><strong>Reference:</strong> " + (order.orderId || "-") + "</div>" +
          "<div><strong>Project Name:</strong> " + projectName + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"display:flex; justify-content:space-between; margin-bottom:12px;\">" +
        "<div style=\"flex:1;\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">" + companyName + "</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + (address || "-") + "<br>Tax ID " + taxId + " | " + phone + "</div>" +
        "</div>" +
        "<div style=\"flex:1; padding-left:16px;\">" +
          "<div style=\"font-weight:700; margin-bottom:4px;\">Client (ë§¤ì¶œì²˜)</div>" +
          "<div style=\"font-size:11px; color:#475569;\">" + clientName + (clientAddr ? "<br>" + clientAddr : "") + (clientTaxId || clientPhone ? "<br>Tax ID " + clientTaxId + (clientPhone ? " | " + clientPhone : "") : "") + "</div>" +
        "</div>" +
      "</div>" +
      "<table class=\"table table-bordered\" style=\"" + tableStyle + "\">" +
        "<thead><tr>" +
          "<th style=\"" + thStyle + "\">#</th>" +
          "<th style=\"" + thStyle + "\">Description</th>" +
          "<th style=\"" + thStyle + "\">Quantity</th>" +
          "<th style=\"" + thStyle + "\">Unit Price</th>" +
          "<th style=\"" + thStyle + "\">Discount</th>" +
          "<th style=\"" + thStyle + "\">Amount</th>" +
        "</tr></thead><tbody>" + rows + "</tbody></table>" +
      "<div style=\"display:flex; justify-content:flex-end;\">" +
        "<div style=\"text-align:right; font-size:12px; min-width:200px;\">" +
          "<div>Total: " + totalBaht.toLocaleString() + " THB</div>" +
          "<div>Discount: " + discount.toLocaleString() + " THB</div>" +
          "<div>Total after discount: " + totalAfterDiscount.toLocaleString() + " THB</div>" +
          "<div>VAT 7%: " + vat7.toLocaleString() + " THB</div>" +
          "<div>Total Excluding VAT: " + exclVat.toLocaleString() + " THB</div>" +
          "<div style=\"font-weight:700;\">Grand Total: " + totalBaht.toLocaleString() + " THB</div>" +
          "<div style=\"font-size:11px; margin-top:4px;\">" + grandWords + "</div>" +
        "</div>" +
      "</div>" +
      "<div style=\"margin-top:16px; font-size:11px; color:#475569;\"><strong>Remarks:</strong> " + bankInfo + "</div>" +
      "<div style=\"margin-top:20px; display:flex; justify-content:space-between; font-size:11px;\">" +
        "<div><strong>" + clientName + "</strong><br>Received by ________________  Date ______</div>" +
        "<div><strong>" + companyName.split(" ")[0] + "</strong><br>Approved by ________________  Date ______</div>" +
      "</div>" +
    "</div>";
  }

  function printOrderDeliveryNoteInvoice() {
    var list = document.getElementById("order-list");
    if (!list) { alert("ì£¼ë¬¸ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
    var checkedRows = [];
    list.querySelectorAll("tr.ord-data-row").forEach(function(tr) {
      var chk = tr.querySelector(".ord-invoice-chk");
      if (chk && chk.checked) checkedRows.push(tr.getAttribute("data-row"));
    });
    if (checkedRows.length === 0) { alert("ì¸ì‡„í•  ì£¼ë¬¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. (ëª©ë¡ì—ì„œ ì²´í¬)"); return; }
    var ordersToPrint = (orderListCache || []).filter(function(o) { return checkedRows.indexOf(String(o.row)) !== -1; });
    if (ordersToPrint.length === 0) { alert("ì„ íƒí•œ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°íšŒ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."); return; }

    google.script.run.withSuccessHandler(function(data) {
      var area = document.getElementById("invoice-print-area");
      if (!area) { alert("ì¸ë³´ì´ìŠ¤ ì¸ì‡„ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
      var companyInfo = (data && data.company) ? data.company : {};
      var clientsMap = (data && data.clients) ? data.clients : {};
      var html = "";
      ordersToPrint.forEach(function(o, idx) {
        var clientInfo = clientsMap[o.store] || { companyName: o.store || "-" };
        html += buildDeliveryNoteInvoiceHtml(o, companyInfo, clientInfo, idx === 0);
      });
      area.innerHTML = html;
      area.classList.remove("d-none");
      document.body.classList.add("invoice-printing");
      window.onafterprint = function() {
        document.body.classList.remove("invoice-printing");
        area.classList.add("d-none");
        area.innerHTML = "";
        window.onafterprint = null;
      };
      window.print();
    }).withFailureHandler(function(err) {
      var area = document.getElementById("invoice-print-area");
      var companyInfo = {};
      var clientsMap = {};
      var html = "";
      ordersToPrint.forEach(function(o, idx) {
        var clientInfo = clientsMap[o.store] || { companyName: o.store || "-" };
        html += buildDeliveryNoteInvoiceHtml(o, companyInfo, clientInfo, idx === 0);
      });
      if (area) { area.innerHTML = html; area.classList.remove("d-none"); document.body.classList.add("invoice-printing"); }
      window.onafterprint = function() { document.body.classList.remove("invoice-printing"); if (area) { area.classList.add("d-none"); area.innerHTML = ""; } window.onafterprint = null; };
      window.print();
    }).getInvoiceData();
  }

  /* =========================================================
     [ê¸°ëŠ¥ 4] ì…ê³  ë“±ë¡ ë° ë‚´ì—­
     ========================================================= */
  /* [ìˆ˜ì •ë¨] ì…ê³  ëª©ë¡ ë‹´ê¸° (ë§¤ì…ì²˜ í¬í•¨) */
function addInboundList() {
    // 1. í™”ë©´ì˜ ì…ë ¥ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
    var dateVal = document.getElementById("i-date").value;
    var vendorVal = document.getElementById("i-vendor").value; // â˜… ë§¤ì…ì²˜ ê°’ ê°€ì ¸ì˜¤ê¸°
    var codeVal = document.getElementById("i-code").value;
    var nameVal = document.getElementById("i-name").value;
    var qtyVal = document.getElementById("i-qty").value;

    // 2. í•„ìˆ˜ ì…ë ¥ ì²´í¬
    if (!codeVal) return alert("í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (!qtyVal) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!vendorVal) return alert("ë§¤ì…ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); // â˜… ë§¤ì…ì²˜ ì„ íƒ ê°•ì œ

    // 3. ëª©ë¡ì— ë‹´ê¸° (vendor ì†ì„± ì¶”ê°€)
    inboundList.push({
        date: dateVal,
        vendor: vendorVal, // â˜… ì—¬ê¸°ì— ë§¤ì…ì²˜ë¥¼ ê¼­ ë„£ì–´ì¤˜ì•¼ ì €ì¥ë©ë‹ˆë‹¤!
        code: codeVal,
        name: nameVal,
        qty: qtyVal
    });

    // 4. í™”ë©´ ê°±ì‹ 
    renderList("inbound-cart", inboundList);
    
    // 5. í¸ì˜ ê¸°ëŠ¥: ì…ë ¥ í›„ í’ˆëª©/ìˆ˜ëŸ‰ë§Œ ë¹„ìš°ê¸° (ë§¤ì…ì²˜ëŠ” ìœ ì§€)
    document.getElementById("i-name").value = "";
    document.getElementById("i-code").value = "";
    document.getElementById("i-qty").value = "";
    document.getElementById("i-name").focus(); // ë°”ë¡œ ë‹¤ìŒ í’ˆëª© ê²€ìƒ‰í•˜ë„ë¡ í¬ì»¤ìŠ¤ ì´ë™
}
  function saveInboundBatch(){ if(confirm("ì €ì¥?")) google.script.run.withSuccessHandler(r=>{alert(r);inboundList=[];renderList("inbound-cart",[]);}).registerInboundBatch(inboundList); }
/* [ìˆ˜ì •] ì…ê³  íƒ­ ì „í™˜ (ë²„íŠ¼ í™œì„±í™” ì¶”ê°€) */
function showInTab(t) { 
    // 1. í™”ë©´ ì „í™˜
    document.getElementById("in-tab-new").style.display = "none";
    document.getElementById("in-tab-hist").style.display = "none";
    document.getElementById("in-tab-" + t).style.display = "block";
    
    // 2. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active)
    document.getElementById("in-nav-new").classList.remove("active");
    document.getElementById("in-nav-hist").classList.remove("active");
    document.getElementById("in-nav-" + t).classList.add("active");

    // 3. ë°ì´í„° ë¡œë“œ (ë‚´ì—­ íƒ­ì¼ ë•Œë§Œ)
    if(t === 'hist') loadInboundHistory(); 
}

/* [ìˆ˜ì •ë¨] ì…ê³  ì €ì¥ ë²„íŠ¼ (ìˆ«ì ë³€í™˜ + ìƒˆë¡œê³ ì¹¨) */
function saveInboundBatch() {
    if (inboundList.length === 0) return alert("ì €ì¥í•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    if (!confirm("ì´ " + inboundList.length + "ê±´ì„ ì…ê³  ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    load(1);
    google.script.run.withSuccessHandler(function(res) {
        load(0);
        alert(res);
        // ì„±ê³µ ì‹œ ëª©ë¡ ë¹„ìš°ê³  ì´ˆê¸°í™”
        if(res.includes("âœ…") || res.includes("ì™„ë£Œ")) {
            inboundList = [];
            renderList("inbound-cart", []);
            // ì €ì¥ í›„ ë‚´ì—­ íƒ­ìœ¼ë¡œ ì´ë™í•´ì„œ ë³´ì—¬ì¤„ê¹Œìš”? (ì„ íƒì‚¬í•­)
            // showInTab('hist'); 
        }
    }).registerInboundBatch(inboundList);
}
  
  /* [ìˆ˜ì •ë¨] ì…ê³  ë‚´ì—­ í™”ë©´ (ê¸ˆì•¡ ì—´ ì¶”ê°€) */
function loadInboundHistory() {
    var s = document.getElementById("ih-start").value;
    var e = document.getElementById("ih-end").value;
    var v = document.getElementById("ih-vendor-selector").value;

    if(!s){ var t=new Date().toISOString().substring(0,10); s=t; e=t; }
    
    load(1);
    google.script.run.withSuccessHandler(list => {
        load(0); 
        var b = document.getElementById("ih-list"); 
        b.innerHTML = "";
        
        if(!list.length){ b.innerHTML="<tr><td colspan='5'>ë‚´ì—­ ì—†ìŒ</td></tr>"; return; }
        
        // ê·¸ë£¹í™”
        var groups={}; 
        list.forEach(i=>{ 
            var k=i.date+"_"+i.vendor; 
            if(!groups[k]) groups[k]={date:i.date, vendor:i.vendor, totalQty:0, totalAmt:0, items:[]}; 
            groups[k].items.push(i); 
            groups[k].totalQty += Number(i.qty);
            groups[k].totalAmt += Number(i.amount);
        });

        var idx=0;
        // í…Œì´ë¸” í—¤ë”ë„ 5ì¹¸ìœ¼ë¡œ ë§ì¶°ì•¼ í•˜ë¯€ë¡œ HTML êµ¬ì¡°ì—ì„œ í—¤ë” ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
        // ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í—¤ë”ë¥¼ ê±´ë“œë¦¬ì§€ ì•Šìœ¼ë¯€ë¡œ, ì•„ë˜ ìƒì„¸ í–‰ì—ì„œ ì¹¸ ìˆ˜ë¥¼ ë§ì¶¤
        for(var k in groups){
            var g=groups[k]; 
            var rid="ib-row-"+idx;
            
            // ë©”ì¸ í–‰: ë‚ ì§œ | ë§¤ì…ì²˜ | ë‚´ìš© | ìˆ˜ëŸ‰ | ê¸ˆì•¡ (ì´ 5ì¹¸)
            b.innerHTML += `
                <tr style="cursor:pointer;" onclick="toggleRow('${rid}')">
                    <td>${g.date}</td>
                    <td class="fw-bold">${g.vendor}</td>
                    <td class="text-start ps-3">â–¼ ${g.items[0].name} ì™¸ ${g.items.length-1}ê±´</td>
                    <td class="fw-bold">${g.totalQty.toLocaleString()}</td>
                    <td class="fw-bold text-primary">${g.totalAmt.toLocaleString()}</td>
                </tr>`;
            
            // ìƒì„¸ í–‰
            var dets = g.items.map(i => `
                <tr>
                    <td class="text-start ps-4">${i.name}</td>
                    <td class="small text-muted">${i.spec||'-'}</td>
                    <td class="fw-bold">${Number(i.qty).toLocaleString()}</td>
                    <td class="text-end pe-3">${Number(i.amount).toLocaleString()}</td>
                </tr>`).join("");
                
            b.innerHTML += `
                <tr id="${rid}" style="display:none; background-color:#f8f9fa;">
                    <td colspan="5">
                        <table class="table table-sm table-bordered bg-white w-90 mx-auto mb-2">
                            <thead class="table-light"><tr><th>í’ˆëª©</th><th>ê·œê²©</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th></tr></thead>
                            <tbody>${dets}</tbody>
                        </table>
                    </td>
                </tr>`;
            idx++;
        }
    }).getInboundHistory(s, e, v);
}

  /* =========================================================
     [ê¸°ëŠ¥ 5] ì¶œê³  ë‚´ì—­ (ê°•ì œ+ì£¼ë¬¸ìŠ¹ì¸ í†µí•©)
     ========================================================= */
  function initForceSection() {
      google.script.run.withSuccessHandler(function(list) {
          var s = document.getElementById("f-store");
          var sh = document.getElementById("fh-vendor");
          s.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
          if(sh) sh.innerHTML = "<option value='All'>ì „ì²´ ë§¤ì¶œì²˜</option>";
          list.forEach(function(name) {
              s.add(new Option(name, name));
              if(sh) sh.add(new Option(name, name));
          });
      }).getAllOutboundTargets();
  }
  /* [ìˆ˜ì •] ì¶œê³  íƒ­ ì „í™˜ (ë²„íŠ¼ í™œì„±í™” ì¶”ê°€) */
function showForceTab(t) { 
    // 1. í™”ë©´ ì „í™˜
    document.getElementById("force-tab-new").style.display = "none";
    document.getElementById("force-tab-hist").style.display = "none";
    document.getElementById("force-tab-" + t).style.display = "block";
    
    // 2. ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (Active)
    document.getElementById("force-nav-new").classList.remove("active");
    document.getElementById("force-nav-hist").classList.remove("active");
    document.getElementById("force-nav-" + t).classList.add("active");

    // 3. ë°ì´í„° ë¡œë“œ (ë‚´ì—­ íƒ­ì¼ ë•Œë§Œ)
    if(t === 'hist') loadForceHistory(); 
}
/* [ìˆ˜ì •ë¨] ì¶œê³  ë‚´ì—­ í™”ë©´ (ì¸ë³´ì´ìŠ¤ë²ˆí˜¸ ê·¸ë£¹ + ê²€ìƒ‰ + ì¸ë³´ì´ìŠ¤ ì¸ì‡„ìš© ê·¸ë£¹ ì €ì¥) */
window.forceHistoryGroups = [];
function loadForceHistory() {
    var s = document.getElementById("fh-start").value;
    var e = document.getElementById("fh-end").value;
    var v = document.getElementById("fh-vendor").value;
    var t = document.getElementById("fh-type") ? document.getElementById("fh-type").value : "All";
    
    if(!s){ var today = new Date().toISOString().substring(0,10); s=today; e=today; }
    
    load(1);
    google.script.run.withSuccessHandler(function(list) {
        load(0); 
        var b = document.getElementById("fh-list"); 
        b.innerHTML = "";
        window.forceHistoryGroups = [];
        
        if (!list || list.length === 0) { 
            b.innerHTML = "<tr><td colspan='8' class='text-center p-4 text-muted'>ë‚´ì—­ ì—†ìŒ</td></tr>"; 
            return; 
        }
        
        var groups = {};
        list.forEach(item => {
            var invNo = (item.invoiceNo && String(item.invoiceNo).trim()) ? String(item.invoiceNo).trim() : "";
            var key = invNo ? invNo : (item.date + "_" + item.target + "_" + item.type);
            if (!groups[key]) groups[key] = { 
                date: item.date, target: item.target, type: item.type, invoiceNo: invNo,
                totalQty: 0, totalAmt: 0, items: [] 
            };
            groups[key].items.push(item); 
            groups[key].totalQty += Math.abs(Number(item.qty));
            groups[key].totalAmt += Math.abs(Number(item.amount));
        });

        var idx = 0;
        var groupKeys = Object.keys(groups).sort().reverse();
        groupKeys.forEach(key => {
            var g = groups[key];
            window.forceHistoryGroups.push(g);
            var badgeClass = g.type.includes("ê°•ì œ") ? "bg-danger" : "bg-success";
            var summary = g.items[0].name + (g.items.length > 1 ? " ì™¸ " + (g.items.length - 1) + "ê±´" : "");
            var rowId = "force-row-" + idx;
            var invDisplay = g.invoiceNo || "-";
            
            b.innerHTML += `
                <tr class="fh-data-row" style="cursor:pointer;" data-rowid="${rowId}" data-group-index="${idx}" data-invoice-no="${(g.invoiceNo || "").replace(/"/g, "&quot;")}">
                    <td class="text-center" onclick="event.stopPropagation()"><input type="checkbox" class="form-check-input fh-invoice-chk" checked title="ì¸ì‡„ í¬í•¨"></td>
                    <td class="text-center small" onclick="toggleRow('${rowId}')">${invDisplay}</td>
                    <td onclick="toggleRow('${rowId}')">${g.date}</td>
                    <td onclick="toggleRow('${rowId}')"><span class="badge ${badgeClass}">${g.type}</span></td>
                    <td class="fw-bold" onclick="toggleRow('${rowId}')">${g.target}</td>
                    <td class="text-start ps-3" onclick="toggleRow('${rowId}')">â–¼ ${summary}</td>
                    <td class="text-danger fw-bold" onclick="toggleRow('${rowId}')">-${g.totalQty.toLocaleString()}</td>
                    <td class="fw-bold text-primary" onclick="toggleRow('${rowId}')">-${g.totalAmt.toLocaleString()}</td>
                </tr>`;
            
            var detailRows = g.items.map(i => {
                var absQty = Math.abs(Number(i.qty));
                var absAmt = Math.abs(Number(i.amount));
                return "<tr><td class=\"text-start ps-4\">" + i.name + "</td><td class=\"text-center text-muted small\">" + (i.spec || "-") + "</td><td class=\"text-end fw-bold text-danger\">-" + absQty.toLocaleString() + "</td><td class=\"text-end pe-3 text-muted\">-" + absAmt.toLocaleString() + "</td></tr>";
            }).join("");
                
            b.innerHTML += "<tr id=\"" + rowId + "\" class=\"fh-detail-row\" style=\"display:none; background-color: #f8f9fa;\"><td colspan=\"8\" class=\"p-0\"><div class=\"p-3\"><table class=\"table table-sm table-bordered bg-white mb-0\" style=\"width: 95%; margin: 0 auto;\"><thead class=\"table-light text-center\"><tr><th style=\"width: 40%;\">í’ˆëª©ëª…</th><th style=\"width: 20%;\">ê·œê²©</th><th style=\"width: 15%;\">ìˆ˜ëŸ‰</th><th style=\"width: 25%;\">ê¸ˆì•¡</th></tr></thead><tbody class=\"align-middle\">" + detailRows + "</tbody></table></div></td></tr>";
            idx++;
        });
    }).getCombinedOutboundHistory(s, e, v, t);
}

  function filterForceHistoryByInvoice() {
    var q = (document.getElementById("fh-invoice-search") || {}).value ? String(document.getElementById("fh-invoice-search").value).trim().toLowerCase() : "";
    var list = document.getElementById("fh-list");
    if (!list) return;
    list.querySelectorAll("tr.fh-data-row").forEach(function(tr) {
      var inv = (tr.getAttribute("data-invoice-no") || "").toLowerCase();
      var show = !q || inv.indexOf(q) !== -1;
      tr.style.display = show ? "" : "none";
      var next = tr.nextElementSibling;
      if (next && next.classList && next.classList.contains("fh-detail-row")) next.style.display = show ? (next.style.display === "none" ? "none" : "table-row") : "none";
    });
  }

  function addForceList() { 
      var st = document.getElementById("f-store").value, cd = document.getElementById("f-code").value, nm = document.getElementById("f-name").value, qt = document.getElementById("f-qty").value, dt = document.getElementById("f-date").value;
      if(!st || !cd || !qt) return alert("í•„ìˆ˜ í•­ëª© ì…ë ¥");
      forceList.push({ date:dt, store:st, code:cd, name:nm, qty:qt }); renderList("force-cart", forceList); 
      document.getElementById("f-name").value = ""; document.getElementById("f-code").value = ""; document.getElementById("f-qty").value = "";
  }
  function saveForceBatch() { if(confirm("ì¶œê³  í™•ì •?")){ load(1); google.script.run.withSuccessHandler(r=>{load(0);alert(r);forceList=[];renderList("force-cart",[]);}).forceOutboundBatch(forceList); } }

/* [ìˆ˜ì • 2] ì¶œê³ ì²˜(ë§¤ì¶œì²˜) ëª©ë¡ ì±„ìš°ê¸° í•¨ìˆ˜ */
function loadOutboundDropdowns() {
    // ë¡œë”© í‘œì‹œ (ì„ íƒí•˜ì„¸ìš” ëŒ€ì‹  'ë¡œë”©ì¤‘...' í‘œì‹œ)
    var fStore = document.getElementById("f-store");
    if(fStore) fStore.innerHTML = "<option>ë¡œë”© ì¤‘...</option>";

    google.script.run.withSuccessHandler(function(list) {
        console.log("ê°€ì ¸ì˜¨ ë§¤ì¶œì²˜ ëª©ë¡:", list); // F12 ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥

        // 1. ì¶œê³  ì…ë ¥ íƒ­ (#f-store)
        if (fStore) {
            fStore.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
            list.forEach(function(v) {
                fStore.add(new Option(v, v));
            });
        }

        // 2. ë‚´ì—­ ì¡°íšŒ íƒ­ (#fh-vendor)
        var fhVendor = document.getElementById("fh-vendor");
        if (fhVendor) {
            fhVendor.innerHTML = "<option value='All'>ì „ì²´ ì¶œê³ ì²˜</option>";
            list.forEach(function(v) {
                fhVendor.add(new Option(v, v));
            });
        }
    }).getVendorNamesByType("ë§¤ì¶œì²˜"); // ì„œë²„ì— "ë§¤ì¶œì²˜" ë‹¬ë¼ê³  ìš”ì²­
}

/* [ë³µêµ¬] ë§¤ì…ì²˜ ëª©ë¡ ì±„ìš°ê¸° (ì…ê³  ë“±ë¡ + í’ˆëª© ê´€ë¦¬ìš©) */
function loadVendorDropdowns() {
    // ë¡œë”© í‘œì‹œ
    var iVendor = document.getElementById("i-vendor");
    if(iVendor) iVendor.innerHTML = "<option>ë¡œë”© ì¤‘...</option>";

    google.script.run.withSuccessHandler(function(list) {
        console.log("ê°€ì ¸ì˜¨ ë§¤ì…ì²˜ ëª©ë¡:", list); // í™•ì¸ìš© ë¡œê·¸

        // 1. ì…ê³  ë“±ë¡ í™”ë©´ (#i-vendor)
        if(iVendor) {
            iVendor.innerHTML = "<option value=''>ì„ íƒí•˜ì„¸ìš”</option>";
            list.forEach(function(v) { iVendor.add(new Option(v, v)); });
        }
        
        // 2. ì…ê³  ë‚´ì—­ ì¡°íšŒ í™”ë©´ (#ih-vendor-selector)
        var ihVendor = document.getElementById("ih-vendor-selector");
        if(ihVendor) {
            ihVendor.innerHTML = "<option value='All'>ì „ì²´ ë§¤ì…ì²˜</option>";
            list.forEach(function(v) { ihVendor.add(new Option(v, v)); });
        }

        // 3. í’ˆëª© ê´€ë¦¬ í™”ë©´ ìë™ì™„ì„± (#vendor-options)
        var itmVendorList = document.getElementById("vendor-options");
        if(itmVendorList) {
            itmVendorList.innerHTML = ""; 
            list.forEach(function(v) {
                var op = document.createElement("option");
                op.value = v;
                itmVendorList.appendChild(op);
            });
        }
    }).getVendorNamesByType("ë§¤ì…ì²˜"); // â˜… ì„œë²„ì— "ë§¤ì…ì²˜" ìš”ì²­ (ì¶œê³ ëŠ” "ë§¤ì¶œì²˜")
}

function loadStoreOptions(elementId) {
    var select = document.getElementById(elementId);
    if (!select) return;
    
    // ì´ë¯¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ë‹¤ë©´ ë‹¤ì‹œ ë¶€ë¥´ì§€ ì•ŠìŒ (ì¤‘ë³µ ë°©ì§€)
    if (select.classList.contains('loaded')) return;

    google.script.run.withSuccessHandler(function(list) {
        select.innerHTML = "";
        
        var allStoresText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].store_all_stores) ? I18N[currentLang].store_all_stores : "ì „ì²´ ë§¤ì¥";
        var selectPhText = (typeof I18N !== "undefined" && typeof currentLang !== "undefined" && I18N[currentLang] && I18N[currentLang].store_select_ph) ? I18N[currentLang].store_select_ph : "ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”";
        if (elementId.includes('filter') || elementId.includes('hist') || elementId === 'eval-list-store') {
            select.add(new Option(allStoresText, "All"));
        } else {
            select.add(new Option(selectPhText, ""));
        }
        
        // <ê±°ë˜ì²˜> ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ë§¤ì¥ ëª©ë¡ ì¶”ê°€
        list.forEach(function(s) {
            select.add(new Option(s, s));
        });
        
        select.classList.add('loaded'); // ë¡œë”© ì™„ë£Œ í‘œì‹œ
    }).getStoreListFromK();
}

/** ì„¤ì • í˜ì´ì§€: ë³¸ì‚¬ ì •ë³´ í¼ì— í˜„ì¬ ê°’ ë¡œë“œ */
function loadHeadOfficeInfo() {
    google.script.run
        .withSuccessHandler(function(info) {
            if (!info) return;
            var el = function(id) { return document.getElementById(id); };
            if (el('settings-company-name')) el('settings-company-name').value = info.companyName || '';
            if (el('settings-tax-id')) el('settings-tax-id').value = info.taxId || '';
            if (el('settings-address')) el('settings-address').value = info.address || '';
            if (el('settings-phone')) el('settings-phone').value = info.phone || '';
            if (el('settings-bank-info')) el('settings-bank-info').value = info.bankInfo || '';
        })
        .withFailureHandler(function() {})
        .getInvoiceCompanyInfo();
}

/** ì„¤ì • í˜ì´ì§€: ë³¸ì‚¬ ì •ë³´ ì €ì¥ */
function saveHeadOfficeInfo() {
    var d = {
        companyName: document.getElementById('settings-company-name') ? document.getElementById('settings-company-name').value : '',
        taxId: document.getElementById('settings-tax-id') ? document.getElementById('settings-tax-id').value : '',
        address: document.getElementById('settings-address') ? document.getElementById('settings-address').value : '',
        phone: document.getElementById('settings-phone') ? document.getElementById('settings-phone').value : '',
        bankInfo: document.getElementById('settings-bank-info') ? document.getElementById('settings-bank-info').value : ''
    };
    google.script.run
        .withSuccessHandler(function(msg) { alert(msg); })
        .withFailureHandler(function(err) { alert('ì €ì¥ ì‹¤íŒ¨: ' + (err && err.message ? err.message : err)); })
        .saveHeadOfficeInfoToSheet(d);
}

</script>